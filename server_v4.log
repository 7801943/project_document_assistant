2025-08-11 12:04:47.822 | INFO     | __main__:<module>:35 - Loguru 日志系统已初始化。
2025-08-11 12:04:47.823 | INFO     | __main__:<module>:36 - 项目根目录配置为: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:04:47.823 | INFO     | __main__:<module>:37 - 数据库路径配置为: data/document_service.db
2025-08-11 12:04:47.823 | INFO     | __main__:<module>:38 - 表格列读取配置已加载: {'变电站安装工程概算表': (2, 6), '变电站建筑工程概算表': (2, 6), '电缆输电线路安装工程概算表': (2, 6), '电缆输电线路建筑工程概算表': (2, 6)}
2025-08-11 12:04:47.823 | INFO     | __main__:<module>:39 - kkFileView 服务地址配置为: http://127.0.0.1:8012/kkfileview
2025-08-11 12:04:47.823 | INFO     | __main__:<module>:42 - Dify Agent API Key: ********kGHe
2025-08-11 12:04:47.823 | INFO     | __main__:<module>:43 - Session Secret Key: ********d529
2025-08-11 12:04:47.823 | INFO     | __main__:<module>:44 - 服务器ipv6地址为: http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8888
2025-08-11 12:04:47.824 | INFO     | __main__:<module>:151 - FastAPI 应用已实例化并注册到 app_state。
2025-08-11 12:04:47.824 | INFO     | __main__:<module>:154 - CORS中间件已添加，允许所有来源。
2025-08-11 12:04:47.833 | INFO     | __main__:<module>:174 - MCP 服务器 '项目文件检索服务器' 已挂载到 FastAPI 应用的 '/mcp/' 路径。
2025-08-11 12:04:47.851 | INFO     | __main__:combined_lifespan:64 - COMBINED LIFESPAN START - PID: 1862746 - 服务器启动中...
2025-08-11 12:04:47.886 | INFO     | __main__:combined_lifespan:69 - HTTPX 客户端已创建并注册到 app_state。
2025-08-11 12:04:47.886 | INFO     | utils.utils:check_embedding_service_health:28 - 正在检查嵌入模型服务，目标URL: http://127.0.0.1:8001/v1/models
2025-08-11 12:04:47.893 | INFO     | utils.utils:check_embedding_service_health:37 - 嵌入模型服务可用，模型列表: ['/home/zhouxiang/models/BAAI_bge-m3']
2025-08-11 12:04:47.894 | INFO     | core.session:__init__:79 - SessionStateManager已初始化。整体HTTP不活动超时: 3600秒
2025-08-11 12:04:47.894 | INFO     | __main__:combined_lifespan:77 - SessionStateManager 已实例化并注册到 app_state。
2025-08-11 12:04:47.894 | INFO     | database.document_service:__init__:164 - 有效文档根目录: {'项目文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/Projects1'), '规范文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/规程规范'), '管理文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/管理文件')}
2025-08-11 12:04:47.894 | DEBUG    | database.document_service:_init_db:180 - 初始化数据库
2025-08-11 12:04:47.894 | DEBUG    | database.document_service:_init_db:201 - 数据库初始化完成
2025-08-11 12:04:47.895 | INFO     | database.document_service:__init__:177 - DocumentQueryService 初始化完成
2025-08-11 12:04:47.895 | INFO     | database.document_service:full_scan:324 - 开始全量扫描...
2025-08-11 12:04:47.895 | INFO     | database.document_service:full_scan:327 - 正在扫描 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:04:55.861 | INFO     | database.document_service:full_scan:327 - 正在扫描 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 12:04:56.295 | INFO     | database.document_service:full_scan:327 - 正在扫描 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 12:04:56.296 | INFO     | database.document_service:full_scan:332 - 全量扫描完成，共处理文件数: 1581
2025-08-11 12:04:56.296 | DEBUG    | database.document_service:_start_watchdog:335 - 启动文件监控 Watchdog
2025-08-11 12:04:56.296 | INFO     | database.document_service:_start_watchdog:421 - 正在监控 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:04:56.296 | INFO     | database.document_service:_start_watchdog:421 - 正在监控 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 12:04:56.296 | INFO     | database.document_service:_start_watchdog:421 - 正在监控 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 12:04:56.314 | INFO     | database.document_service:_start_watchdog:423 - Watchdog 已启动
2025-08-11 12:04:56.314 | INFO     | database.document_service:start:465 - DocumentQueryService 已启动
2025-08-11 12:04:56.314 | INFO     | __main__:combined_lifespan:83 - 统一文档查询服务 (DocumentQueryService) 已启动。
2025-08-11 12:04:56.314 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/Projects1', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 12:04:56.314 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/规程规范', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 12:04:56.314 | INFO     | __main__:combined_lifespan:88 - 项目和规程的文件服务已初始化。
2025-08-11 12:04:56.315 | INFO     | __main__:combined_lifespan:93 - AsyncIOScheduler 已实例化并注册到 app_state。
2025-08-11 12:04:56.315 | INFO     | __main__:combined_lifespan:97 - FastMCP lifespan context entered.
2025-08-11 12:04:56.316 | INFO     | __main__:combined_lifespan:117 - 处理不活动用户会话任务已添加到APScheduler (每 60s)。
2025-08-11 12:04:56.316 | INFO     | __main__:combined_lifespan:120 - 清理用户会话中已打开文件token任务已添加到APScheduler (每 120s)。
2025-08-11 12:04:56.316 | INFO     | __main__:combined_lifespan:123 - APScheduler 调度器已启动。
2025-08-11 12:04:56.316 | INFO     | __main__:combined_lifespan:124 - 所有初始化完成... yield
2025-08-11 12:04:56.317 | DEBUG    | database.document_service:_debounced_update_loop:426 - 启动去抖更新循环
2025-08-11 12:13:02.816 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: 0c552303-71a1-47d0-bcf6-4d6e0ad85865, IP: 240e:479:668:3c1c:e8c4:feaf:5d4:560a) 登录/状态更新成功。
2025-08-11 12:13:02.816 | INFO     | api.route:login:76 - 用户 'admin' (IP: 240e:479:668:3c1c:e8c4:feaf:5d4:560a, Session: 0c552303-71a1-47d0-bcf6-4d6e0ad85865) 登录成功。
2025-08-11 12:13:03.003 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: 0c552303-71a1-47d0-bcf6-4d6e0ad85865) 的 WebSocket 已连接并关联。
2025-08-11 12:13:03.089 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-11 12:13:04.801 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:e8c4:feaf:5d4:560a'.
2025-08-11 12:13:09.674 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:e8c4:feaf:5d4:560a'.
2025-08-11 12:13:09.675 | INFO     | api.admin:update_admin_config:164 - 从服务商 'zhipu' 的预设中加载了 API Key。
2025-08-11 12:13:09.675 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_API_BASE_URL' 已更新为: https://open.bigmodel.cn/api/paas/v4/
2025-08-11 12:13:09.675 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_MODEL_NAME' 已更新为: GLM-4.5-Flash
2025-08-11 12:13:09.675 | INFO     | api.admin:update_admin_config:180 - 运行时配置 'OPENAI_API_KEY' 已更新为: ******Yj8a
2025-08-11 12:13:09.688 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:e8c4:feaf:5d4:560a'.
2025-08-11 12:13:16.332 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:13:16.332 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 0c552303-71a1-47d0-bcf6-4d6e0ad85865, 对话ID: 8823e7da-7823-4759-bc1a-d40cc2ec6a96, 查询: 帮我找下二次的规范
2025-08-11 12:13:16.332 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:qwen3-235b-a22b-instruct-2507
2025-08-11 12:13:18.094 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': '5', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "/ALL", "category": "二次"}'}}]
2025-08-11 12:13:18.094 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "/ALL", "category": "二次"}
2025-08-11 12:13:18.142 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '/ALL', 类别: '二次', 读取文件: False, Top N: 10
2025-08-11 12:13:18.143 | DEBUG    | database.document_service:_db_query:550 - 查询规范文件分类 (适配器): 二次
2025-08-11 12:13:18.143 | INFO     | database.document_service:_db_query:571 - 查询到 '二次' 分类的规范共 16 条
2025-08-11 12:13:18.144 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:870 - 用户请求 '二次' 类别下的所有规范。
2025-08-11 12:13:18.149 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:qwen3-235b-a22b-instruct-2507
2025-08-11 12:13:48.483 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:13:48.483 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 0c552303-71a1-47d0-bcf6-4d6e0ad85865, 对话ID: 8823e7da-7823-4759-bc1a-d40cc2ec6a96, 查询: 打开规范16
2025-08-11 12:13:48.484 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:qwen3-235b-a22b-instruct-2507
2025-08-11 12:13:51.810 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': '16', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "QGDW 10688-2024 变电站辅助监控系统设计规范.pdf", "category": "二次", "read_file": true}'}}]
2025-08-11 12:13:51.810 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "QGDW 10688-2024 变电站辅助监控系统设计规范.pdf", "category": "二次", "read_file": true}
2025-08-11 12:13:51.857 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: 'QGDW 10688-2024 变电站辅助监控系统设计规范.pdf', 类别: '二次', 读取文件: True, Top N: 10
2025-08-11 12:13:51.858 | DEBUG    | database.document_service:_db_query:550 - 查询规范文件分类 (适配器): 二次
2025-08-11 12:13:51.859 | INFO     | database.document_service:_db_query:571 - 查询到 '二次' 分类的规范共 16 条
2025-08-11 12:13:51.859 | DEBUG    | my_mcp_tools.mcp_tools:_get_embeddings:171 - 正在调用嵌入模型: base_url='http://127.0.0.1:8001/v1', model='/home/zhouxiang/models/BAAI_bge-m3'
2025-08-11 12:13:52.036 | DEBUG    | my_mcp_tools.mcp_tools:_find_similar_items_with_scores:201 - 向量检索 Top-10 结果: [('变电站辅助设备监控系统设计规范', 0.8566247354161971), ('QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范', 0.7720567818063309), ('NBT 11315-2023 变电站辅助控制系统设计规程', 0.7528453259574495), ('QGDW 12301-2023 变电站硬压板在线监测技术规范', 0.734938129858665), ('QGDW 10536-2021-变压器油中溶解气体在线监测装置技术规范', 0.7015110365035193), ('QGDW10347-2023电能计量装置通用设计', 0.6967753863715769), ('QGDW 11486-2022 继电保护和安全自动装置验收规范', 0.6910570725901276), ('IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13', 0.6602855554377536), ('GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范', 0.618537642450107), ('GB∕T 36572-2018 电力监控系统网络安全防护导则', 0.6151618646500622)]
2025-08-11 12:13:52.036 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:895 - 最匹配文件 '二次/变电站辅助设备监控系统设计规范/QGDW 10688-2024 变电站辅助监控系统设计规范.pdf' 相似度(0.8566) > 0.7，准备读取内容。
2025-08-11 12:13:52.036 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/变电站辅助设备监控系统设计规范/QGDW 10688-2024 变电站辅助监控系统设计规范.pdf (相对路径: 二次/变电站辅助设备监控系统设计规范/QGDW 10688-2024 变电站辅助监控系统设计规范.pdf)，分隔符: '
'
2025-08-11 12:14:00.334 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: QGDW 10688-2024 变电站辅助监控系统设计规范.pdf, 内容长度: 25215
2025-08-11 12:14:00.334 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '二次/变电站辅助设备监控系统设计规范/QGDW 10688-2024 变电站辅助监控系统设计规范.pdf' (token: b6c3b2a12f0846539c6f56c23adaf429), 有效期至: Mon Aug 11 20:14:00 2025
2025-08-11 12:14:00.346 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:qwen3-235b-a22b-instruct-2507
2025-08-11 12:14:00.357 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/b6c3b2a12f0846539c6f56c23adaf429/QGDW 10688-2024 变电站辅助监控系统设计规范.pdf
2025-08-11 12:14:00.553 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 'QGDW 10688-2024 变电站辅助监控系统设计规范_f13119e6.pdf' 与Token关联文件名 'QGDW 10688-2024 变电站辅助监控系统设计规范.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 12:14:00.553 | DEBUG    | api.route:download_file_via_token:193 - Token 'b6c3b2a12f0846539c6f56c23adaf429' 验证成功。准备下载文件: 'QGDW 10688-2024 变电站辅助监控系统设计规范.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/规程规范/二次/变电站辅助设备监控系统设计规范/QGDW 10688-2024 变电站辅助监控系统设计规范.pdf', URL文件名: 'QGDW 10688-2024 变电站辅助监控系统设计规范_f13119e6.pdf')
2025-08-11 12:14:00.555 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 'QGDW 10688-2024 变电站辅助监控系统设计规范_f13119e6.pdf' 与Token关联文件名 'QGDW 10688-2024 变电站辅助监控系统设计规范.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 12:14:00.555 | DEBUG    | api.route:download_file_via_token:193 - Token 'b6c3b2a12f0846539c6f56c23adaf429' 验证成功。准备下载文件: 'QGDW 10688-2024 变电站辅助监控系统设计规范.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/规程规范/二次/变电站辅助设备监控系统设计规范/QGDW 10688-2024 变电站辅助监控系统设计规范.pdf', URL文件名: 'QGDW 10688-2024 变电站辅助监控系统设计规范_f13119e6.pdf')
2025-08-11 12:14:17.252 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:14:17.252 | INFO     | sse_proxy.sse2websocket1:run:265 - 会话 0c552303-71a1-47d0-bcf6-4d6e0ad85865 用户 admin 中止响应流任务
2025-08-11 12:14:17.252 | INFO     | sse_proxy.sse2websocket1:_start:101 - 会话 0c552303-71a1-47d0-bcf6-4d6e0ad85865 被取消
2025-08-11 12:14:26.115 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:14:26.115 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 0c552303-71a1-47d0-bcf6-4d6e0ad85865, 对话ID: 8823e7da-7823-4759-bc1a-d40cc2ec6a96, 查询: 找下电流互感器的规范
2025-08-11 12:14:26.115 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:qwen3-235b-a22b-instruct-2507
2025-08-11 12:14:31.030 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': '22', 'type': 'function', 'function': {'name': 'query_specification_knowledge_base', 'arguments': '{"user_query": "电流互感器的规范", "knowledge_base_name": "二次", "top_k": 5}'}}]
2025-08-11 12:14:31.030 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_specification_knowledge_base with args: {"user_query": "电流互感器的规范", "knowledge_base_name": "二次", "top_k": 5}
2025-08-11 12:14:31.073 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:266 - 工具调用: query_specification_knowledge_base, 知识库: 二次, 用户查询: '电流互感器的规范...', top_k: 5
2025-08-11 12:14:31.073 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:279 - 正在从 http://127.0.0.1/v1/datasets 获取知识库ID，参数: {'keyword': '二次', 'page': 1, 'limit': 10}
2025-08-11 12:14:31.379 | INFO     | my_mcp_tools.mcp_tools:query_specification_knowledge_base:293 - 成功获取到知识库 '二次' 的ID: eaee81cc-3cb5-4649-89b0-9e702a659131
2025-08-11 12:14:31.379 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:307 - 正在向 http://127.0.0.1/v1/datasets/eaee81cc-3cb5-4649-89b0-9e702a659131/retrieve 发起检索请求。Payload (部分): query='电流互感器的规范...', top_k=5
2025-08-11 12:14:31.585 | INFO     | my_mcp_tools.mcp_tools:query_specification_knowledge_base:314 - 从知识库 '二次' 检索到 4 条结果。
2025-08-11 12:14:31.592 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:qwen3-235b-a22b-instruct-2507
2025-08-11 12:14:41.744 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:14:41.744 | INFO     | sse_proxy.sse2websocket1:run:265 - 会话 0c552303-71a1-47d0-bcf6-4d6e0ad85865 用户 admin 中止响应流任务
2025-08-11 12:14:41.744 | INFO     | sse_proxy.sse2websocket1:_start:101 - 会话 0c552303-71a1-47d0-bcf6-4d6e0ad85865 被取消
2025-08-11 12:14:47.493 | INFO     | sse_proxy.sse2websocket1:run:276 - 收到新对话开始事件，对话ID: b2a9f8f2-af14-43d7-9ebf-3b272cbf64d5。清空历史记录。
2025-08-11 12:14:58.679 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:14:58.679 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 0c552303-71a1-47d0-bcf6-4d6e0ad85865, 对话ID: b2a9f8f2-af14-43d7-9ebf-3b272cbf64d5, 查询: 找下电流互感器的规范
2025-08-11 12:14:58.679 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:15:04.197 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_NRjAsYs3RKOSpScMaKY0UQ', 'type': 'function', 'function': {'name': 'query_specification_knowledge_base', 'arguments': '{"user_query": "电流互感器", "knowledge_base_name": "电气", "top_k": 5}'}}]
2025-08-11 12:15:04.197 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_specification_knowledge_base with args: {"user_query": "电流互感器", "knowledge_base_name": "电气", "top_k": 5}
2025-08-11 12:15:04.245 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:266 - 工具调用: query_specification_knowledge_base, 知识库: 电气, 用户查询: '电流互感器...', top_k: 5
2025-08-11 12:15:04.245 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:279 - 正在从 http://127.0.0.1/v1/datasets 获取知识库ID，参数: {'keyword': '电气', 'page': 1, 'limit': 10}
2025-08-11 12:15:04.335 | INFO     | my_mcp_tools.mcp_tools:query_specification_knowledge_base:293 - 成功获取到知识库 '电气' 的ID: 95bde3ad-88fe-4994-8599-34f155626984
2025-08-11 12:15:04.336 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:307 - 正在向 http://127.0.0.1/v1/datasets/95bde3ad-88fe-4994-8599-34f155626984/retrieve 发起检索请求。Payload (部分): query='电流互感器...', top_k=5
2025-08-11 12:15:04.544 | INFO     | my_mcp_tools.mcp_tools:query_specification_knowledge_base:314 - 从知识库 '电气' 检索到 5 条结果。
2025-08-11 12:15:04.551 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:15:20.860 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:15:20.860 | INFO     | sse_proxy.sse2websocket1:run:265 - 会话 0c552303-71a1-47d0-bcf6-4d6e0ad85865 用户 admin 中止响应流任务
2025-08-11 12:15:20.861 | INFO     | sse_proxy.sse2websocket1:_start:101 - 会话 0c552303-71a1-47d0-bcf6-4d6e0ad85865 被取消
2025-08-11 12:15:26.993 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:15:26.993 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 0c552303-71a1-47d0-bcf6-4d6e0ad85865, 对话ID: b2a9f8f2-af14-43d7-9ebf-3b272cbf64d5, 查询: 从打开规范里找
2025-08-11 12:15:26.993 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:15:33.445 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_Q4nMZ9l8TbCugWcOER2xkQ', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "电流互感器", "category": "电气", "read_file": true, "top_n": 10}'}}]
2025-08-11 12:15:33.445 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "电流互感器", "category": "电气", "read_file": true, "top_n": 10}
2025-08-11 12:15:33.492 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '电流互感器', 类别: '电气', 读取文件: True, Top N: 10
2025-08-11 12:15:33.492 | DEBUG    | database.document_service:_db_query:550 - 查询规范文件分类 (适配器): 电气
2025-08-11 12:15:33.493 | INFO     | database.document_service:_db_query:571 - 查询到 '电气' 分类的规范共 2 条
2025-08-11 12:15:33.494 | WARNING  | my_mcp_tools.mcp_tools:open_specification_files:866 - 在专业类别 '电气' 下未找到可供检索的文档文件（如PDF, MD, DOCX等）。
2025-08-11 12:15:33.500 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:15:39.281 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_c71AwnLbTgilxRgxgwn90g', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "DLT-5222-2021_导体和电器选择设计规程", "category": "电气", "read_file": true, "top_n": 10}'}}]
2025-08-11 12:15:39.282 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "DLT-5222-2021_导体和电器选择设计规程", "category": "电气", "read_file": true, "top_n": 10}
2025-08-11 12:15:39.330 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: 'DLT-5222-2021_导体和电器选择设计规程', 类别: '电气', 读取文件: True, Top N: 10
2025-08-11 12:15:39.330 | DEBUG    | database.document_service:_db_query:550 - 查询规范文件分类 (适配器): 电气
2025-08-11 12:15:39.331 | INFO     | database.document_service:_db_query:571 - 查询到 '电气' 分类的规范共 2 条
2025-08-11 12:15:39.331 | WARNING  | my_mcp_tools.mcp_tools:open_specification_files:866 - 在专业类别 '电气' 下未找到可供检索的文档文件（如PDF, MD, DOCX等）。
2025-08-11 12:15:39.337 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:15:43.998 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_VJ-ONRyEQ1Ku-3-TEthSYg', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "电流互感器选择及计算规程", "category": "电气", "read_file": true, "top_n": 10}'}}]
2025-08-11 12:15:43.998 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "电流互感器选择及计算规程", "category": "电气", "read_file": true, "top_n": 10}
2025-08-11 12:15:44.042 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '电流互感器选择及计算规程', 类别: '电气', 读取文件: True, Top N: 10
2025-08-11 12:15:44.042 | DEBUG    | database.document_service:_db_query:550 - 查询规范文件分类 (适配器): 电气
2025-08-11 12:15:44.043 | INFO     | database.document_service:_db_query:571 - 查询到 '电气' 分类的规范共 2 条
2025-08-11 12:15:44.043 | WARNING  | my_mcp_tools.mcp_tools:open_specification_files:866 - 在专业类别 '电气' 下未找到可供检索的文档文件（如PDF, MD, DOCX等）。
2025-08-11 12:15:44.048 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:15:45.835 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_YowFq3CuTq243gDDBQjcEA', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "/ALL", "category": "电气", "read_file": false, "top_n": 10}'}}]
2025-08-11 12:15:45.835 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "/ALL", "category": "电气", "read_file": false, "top_n": 10}
2025-08-11 12:15:45.880 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '/ALL', 类别: '电气', 读取文件: False, Top N: 10
2025-08-11 12:15:45.880 | DEBUG    | database.document_service:_db_query:550 - 查询规范文件分类 (适配器): 电气
2025-08-11 12:15:45.881 | INFO     | database.document_service:_db_query:571 - 查询到 '电气' 分类的规范共 2 条
2025-08-11 12:15:45.881 | WARNING  | my_mcp_tools.mcp_tools:open_specification_files:866 - 在专业类别 '电气' 下未找到可供检索的文档文件（如PDF, MD, DOCX等）。
2025-08-11 12:15:45.886 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:15:48.702 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_XV1ANPSXQjKWCpaEHXYB6A', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "/ALL", "category": "二次", "read_file": false, "top_n": 10}'}}]
2025-08-11 12:15:48.702 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "/ALL", "category": "二次", "read_file": false, "top_n": 10}
2025-08-11 12:15:48.752 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '/ALL', 类别: '二次', 读取文件: False, Top N: 10
2025-08-11 12:15:48.752 | DEBUG    | database.document_service:_db_query:550 - 查询规范文件分类 (适配器): 二次
2025-08-11 12:15:48.753 | INFO     | database.document_service:_db_query:571 - 查询到 '二次' 分类的规范共 16 条
2025-08-11 12:15:48.753 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:870 - 用户请求 '二次' 类别下的所有规范。
2025-08-11 12:15:48.759 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:15:52.184 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_c91ec8aa96a544ecbdada3b8', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "/ALL", "category": "线路", "read_file": false, "top_n": 10}'}}]
2025-08-11 12:15:52.184 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "/ALL", "category": "线路", "read_file": false, "top_n": 10}
2025-08-11 12:15:52.236 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '/ALL', 类别: '线路', 读取文件: False, Top N: 10
2025-08-11 12:15:52.237 | DEBUG    | database.document_service:_db_query:550 - 查询规范文件分类 (适配器): 线路
2025-08-11 12:15:52.238 | INFO     | database.document_service:_db_query:571 - 查询到 '线路' 分类的规范共 0 条
2025-08-11 12:15:52.238 | WARNING  | my_mcp_tools.mcp_tools:open_specification_files:854 - 在专业类别 '线路' 下未找到任何规程规范文件。
2025-08-11 12:15:52.244 | WARNING  | sse_proxy.sse2websocket1:_handle_stream:115 - 递归深度超过最大限制(5)，终止工具调用
2025-08-11 12:32:07.398 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 0c552303-71a1-47d0-bcf6-4d6e0ad85865 用户 admin 断开连接
2025-08-11 12:32:07.398 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:32:07.398 | INFO     | core.session:disconnect_websocket:108 - 用户 'admin' 的 WebSocket 已断开。
2025-08-11 12:32:07.499 | INFO     | __main__:combined_lifespan:130 - COMBINED LIFESPAN END - PID: 1862746 - 服务器关闭中...
2025-08-11 12:32:07.499 | INFO     | database.document_service:shutdown:469 - 正在关闭 DocumentQueryService...
2025-08-11 12:32:07.509 | INFO     | database.document_service:shutdown:474 - Watchdog 监控已停止。
2025-08-11 12:32:07.509 | INFO     | database.document_service:shutdown:482 - 后台更新任务已取消。
2025-08-11 12:32:07.509 | INFO     | database.document_service:shutdown:487 - 数据库连接已关闭。
2025-08-11 12:32:07.509 | INFO     | database.document_service:shutdown:489 - DocumentQueryService 已成功关闭。
2025-08-11 12:32:07.509 | INFO     | __main__:combined_lifespan:134 - 统一文档查询服务已关闭。
2025-08-11 12:32:07.509 | INFO     | __main__:combined_lifespan:139 - APScheduler 调度器已关闭。
2025-08-11 12:32:07.509 | INFO     | __main__:combined_lifespan:140 - Custom application resources cleaned up.
2025-08-11 12:32:11.014 | INFO     | __main__:<module>:35 - Loguru 日志系统已初始化。
2025-08-11 12:32:11.014 | INFO     | __main__:<module>:36 - 项目根目录配置为: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:32:11.015 | INFO     | __main__:<module>:37 - 数据库路径配置为: data/document_service.db
2025-08-11 12:32:11.015 | INFO     | __main__:<module>:38 - 表格列读取配置已加载: {'变电站安装工程概算表': (2, 6), '变电站建筑工程概算表': (2, 6), '电缆输电线路安装工程概算表': (2, 6), '电缆输电线路建筑工程概算表': (2, 6)}
2025-08-11 12:32:11.015 | INFO     | __main__:<module>:39 - kkFileView 服务地址配置为: http://127.0.0.1:8012/kkfileview
2025-08-11 12:32:11.015 | INFO     | __main__:<module>:42 - Dify Agent API Key: ********kGHe
2025-08-11 12:32:11.015 | INFO     | __main__:<module>:43 - Session Secret Key: ********8b6c
2025-08-11 12:32:11.015 | INFO     | __main__:<module>:44 - 服务器ipv6地址为: http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8888
2025-08-11 12:32:11.015 | INFO     | __main__:<module>:151 - FastAPI 应用已实例化并注册到 app_state。
2025-08-11 12:32:11.016 | INFO     | __main__:<module>:154 - CORS中间件已添加，允许所有来源。
2025-08-11 12:32:11.024 | INFO     | __main__:<module>:174 - MCP 服务器 '项目文件检索服务器' 已挂载到 FastAPI 应用的 '/mcp/' 路径。
2025-08-11 12:32:11.041 | INFO     | __main__:combined_lifespan:64 - COMBINED LIFESPAN START - PID: 1893979 - 服务器启动中...
2025-08-11 12:32:11.074 | INFO     | __main__:combined_lifespan:69 - HTTPX 客户端已创建并注册到 app_state。
2025-08-11 12:32:11.074 | INFO     | utils.utils:check_embedding_service_health:28 - 正在检查嵌入模型服务，目标URL: http://127.0.0.1:8001/v1/models
2025-08-11 12:32:11.080 | INFO     | utils.utils:check_embedding_service_health:37 - 嵌入模型服务可用，模型列表: ['/home/zhouxiang/models/BAAI_bge-m3']
2025-08-11 12:32:11.081 | INFO     | core.session:__init__:79 - SessionStateManager已初始化。整体HTTP不活动超时: 3600秒
2025-08-11 12:32:11.081 | INFO     | __main__:combined_lifespan:77 - SessionStateManager 已实例化并注册到 app_state。
2025-08-11 12:32:11.081 | INFO     | database.document_service:__init__:164 - 有效文档根目录: {'项目文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/Projects1'), '规范文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/规程规范'), '管理文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/管理文件')}
2025-08-11 12:32:11.081 | DEBUG    | database.document_service:_init_db:180 - 初始化数据库
2025-08-11 12:32:11.081 | DEBUG    | database.document_service:_init_db:201 - 数据库初始化完成
2025-08-11 12:32:11.081 | INFO     | database.document_service:__init__:177 - DocumentQueryService 初始化完成
2025-08-11 12:32:11.081 | INFO     | database.document_service:full_scan:324 - 开始全量扫描...
2025-08-11 12:32:11.081 | INFO     | database.document_service:full_scan:327 - 正在扫描 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:32:16.342 | INFO     | database.document_service:full_scan:327 - 正在扫描 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 12:32:16.675 | INFO     | database.document_service:full_scan:327 - 正在扫描 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 12:32:16.676 | INFO     | database.document_service:full_scan:332 - 全量扫描完成，共处理文件数: 1581
2025-08-11 12:32:16.676 | DEBUG    | database.document_service:_start_watchdog:335 - 启动文件监控 Watchdog
2025-08-11 12:32:16.676 | INFO     | database.document_service:_start_watchdog:421 - 正在监控 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:32:16.676 | INFO     | database.document_service:_start_watchdog:421 - 正在监控 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 12:32:16.676 | INFO     | database.document_service:_start_watchdog:421 - 正在监控 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 12:32:16.692 | INFO     | database.document_service:_start_watchdog:423 - Watchdog 已启动
2025-08-11 12:32:16.695 | INFO     | database.document_service:start:465 - DocumentQueryService 已启动
2025-08-11 12:32:16.695 | INFO     | __main__:combined_lifespan:83 - 统一文档查询服务 (DocumentQueryService) 已启动。
2025-08-11 12:32:16.695 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/Projects1', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 12:32:16.695 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/规程规范', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 12:32:16.695 | INFO     | __main__:combined_lifespan:88 - 项目和规程的文件服务已初始化。
2025-08-11 12:32:16.696 | INFO     | __main__:combined_lifespan:93 - AsyncIOScheduler 已实例化并注册到 app_state。
2025-08-11 12:32:16.696 | INFO     | __main__:combined_lifespan:97 - FastMCP lifespan context entered.
2025-08-11 12:32:16.697 | INFO     | __main__:combined_lifespan:117 - 处理不活动用户会话任务已添加到APScheduler (每 60s)。
2025-08-11 12:32:16.697 | INFO     | __main__:combined_lifespan:120 - 清理用户会话中已打开文件token任务已添加到APScheduler (每 120s)。
2025-08-11 12:32:16.697 | INFO     | __main__:combined_lifespan:123 - APScheduler 调度器已启动。
2025-08-11 12:32:16.697 | INFO     | __main__:combined_lifespan:124 - 所有初始化完成... yield
2025-08-11 12:32:16.697 | DEBUG    | database.document_service:_debounced_update_loop:426 - 启动去抖更新循环
2025-08-11 12:32:24.553 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: a5d4f431-4b12-446c-859b-9c7d646c8ece, IP: 240e:479:668:3c1c:e8c4:feaf:5d4:560a) 登录/状态更新成功。
2025-08-11 12:32:24.553 | INFO     | api.route:login:76 - 用户 'admin' (IP: 240e:479:668:3c1c:e8c4:feaf:5d4:560a, Session: a5d4f431-4b12-446c-859b-9c7d646c8ece) 登录成功。
2025-08-11 12:32:24.687 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: a5d4f431-4b12-446c-859b-9c7d646c8ece) 的 WebSocket 已连接并关联。
2025-08-11 12:32:24.770 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-11 12:32:30.443 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:e8c4:feaf:5d4:560a'.
2025-08-11 12:32:35.110 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:e8c4:feaf:5d4:560a'.
2025-08-11 12:32:35.111 | INFO     | api.admin:update_admin_config:164 - 从服务商 'zhipu' 的预设中加载了 API Key。
2025-08-11 12:32:35.111 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_API_BASE_URL' 已更新为: https://open.bigmodel.cn/api/paas/v4/
2025-08-11 12:32:35.111 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_MODEL_NAME' 已更新为: GLM-4.5-Flash
2025-08-11 12:32:35.111 | INFO     | api.admin:update_admin_config:180 - 运行时配置 'OPENAI_API_KEY' 已更新为: ******Yj8a
2025-08-11 12:32:35.131 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:e8c4:feaf:5d4:560a'.
2025-08-11 12:32:37.332 | INFO     | sse_proxy.sse2websocket1:run:276 - 收到新对话开始事件，对话ID: c0dacd61-7153-4343-9a02-7e03aa4a9085。清空历史记录。
2025-08-11 12:32:54.432 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:32:54.432 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 a5d4f431-4b12-446c-859b-9c7d646c8ece, 对话ID: c0dacd61-7153-4343-9a02-7e03aa4a9085, 查询: 在二次的规范里打开电流互感器的规范
2025-08-11 12:32:54.432 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:33:00.971 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_xsvQBdlBTnOaC-aRwouuUA', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "电流互感器的规范", "category": "二次", "read_file": true}'}}]
2025-08-11 12:33:00.971 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "电流互感器的规范", "category": "二次", "read_file": true}
2025-08-11 12:33:01.015 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '电流互感器的规范', 类别: '二次', 读取文件: True, Top N: 10
2025-08-11 12:33:01.015 | DEBUG    | database.document_service:_db_query:550 - 查询规范文件分类 (适配器): 二次
2025-08-11 12:33:01.016 | INFO     | database.document_service:_db_query:571 - 查询到 '二次' 分类的规范共 16 条:{'45_DLT-559-2018《220kV～750kV电网继电保护装置运行整定规程》_md': '二次/45_DLT-559-2018《220kV～750kV电网继电保护装置运行整定规程》_md/images/01930a72-0c64-7cdb-a401-2ec51e0c6a0c_19_1142_1062_132_174_0.jpg', 'DL∕T 448-2016 电能计量装置技术管理规程': '二次/DL∕T 448-2016 电能计量装置技术管理规程/DL∕T 448-2016 电能计量装置技术管理规程.pdf', 'GB∕T 36572-2018 电力监控系统网络安全防护导则': '二次/GB∕T 36572-2018 电力监控系统网络安全防护导则/GB∕T 36572-2018 电力监控系统网络安全防护导则.pdf', 'GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范': '二次/GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范/GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范.pdf', 'GB∕T 38435-2019 牵引站供电线路的继电保护配置及整定计算原则': '二次/GB∕T 38435-2019 牵引站供电线路的继电保护配置及整定计算原则/GB∕T 38435-2019 牵引站供电线路的继电保护配置及整定计算原则.pdf', 'GB∕T 38969-2020 电力系统技术导则': '二次/GB∕T 38969-2020 电力系统技术导则/GB∕T 38969-2020 电力系统技术导则.pdf', 'GB∕T_40581-2021 电力系统安全稳定计算规范': '二次/GB∕T_40581-2021 电力系统安全稳定计算规范/GB∕T_40581-2021 电力系统安全稳定计算规范.pdf', 'GB／T-14285—2023《继电保护和安全自动装置技术规程》_md': '二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_93_324_268_737_1834_0.jpg', 'IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13': '二次/IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13/IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13.pdf', 'NBT 11315-2023 变电站辅助控制系统设计规程': '二次/NBT 11315-2023 变电站辅助控制系统设计规程/NBT 11315-2023 变电站辅助控制系统设计规程.pdf', 'QGDW 10536-2021-变压器油中溶解气体在线监测装置技术规范': '二次/QGDW 10536-2021-变压器油中溶解气体在线监测装置技术规范/QGDW 10536-2021-变压器油中溶解气体在线监测装置技术规范.pdf', 'QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范': '二次/QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范/QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范.pdf', 'QGDW 11486-2022 继电保护和安全自动装置验收规范': '二次/QGDW 11486-2022 继电保护和安全自动装置验收规范/QGDW 11486-2022 继电保护和安全自动装置验收规范.pdf', 'QGDW 12301-2023 变电站硬压板在线监测技术规范': '二次/QGDW 12301-2023 变电站硬压板在线监测技术规范/QGDW 12301-2023 变电站硬压板在线监测技术规范.pdf', 'QGDW10347-2023电能计量装置通用设计': '二次/QGDW10347-2023电能计量装置通用设计/QGDW10347-2023电能计量装置通用设计.pdf', '变电站辅助设备监控系统设计规范': '二次/变电站辅助设备监控系统设计规范/QGDW 10688-2024 变电站辅助监控系统设计规范.pdf'}
2025-08-11 12:33:01.017 | DEBUG    | my_mcp_tools.mcp_tools:_get_embeddings:171 - 正在调用嵌入模型: base_url='http://127.0.0.1:8001/v1', model='/home/zhouxiang/models/BAAI_bge-m3'
2025-08-11 12:33:01.204 | DEBUG    | my_mcp_tools.mcp_tools:_find_similar_items_with_scores:201 - 向量检索 Top-10 结果: [('变电站辅助设备监控系统设计规范', 0.6210404661231986), ('QGDW 10536-2021-变压器油中溶解气体在线监测装置技术规范', 0.5567942411246587), ('QGDW 12301-2023 变电站硬压板在线监测技术规范', 0.5457815216125181), ('DL∕T 448-2016 电能计量装置技术管理规程', 0.5437113255448214), ('NBT 11315-2023 变电站辅助控制系统设计规程', 0.5414074860989889), ('QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范', 0.5412992826025399), ('QGDW10347-2023电能计量装置通用设计', 0.5384789144569181), ('GB∕T_40581-2021 电力系统安全稳定计算规范', 0.5228369138716766), ('GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范', 0.5199645772843047), ('IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13', 0.49984640424691784)]
2025-08-11 12:33:01.204 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:933 - 最匹配文件 '二次/变电站辅助设备监控系统设计规范/QGDW 10688-2024 变电站辅助监控系统设计规范.pdf' 相似度(0.6210) 不足 0.7，不读取文件内容，返回列表。
2025-08-11 12:33:01.210 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:33:15.242 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_c83d1cc759764848a89d4b90', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "DL∕T 448-2016 电能计量装置技术管理规程", "category": "二次", "read_file": true}'}}]
2025-08-11 12:33:15.242 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "DL∕T 448-2016 电能计量装置技术管理规程", "category": "二次", "read_file": true}
2025-08-11 12:33:15.286 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: 'DL∕T 448-2016 电能计量装置技术管理规程', 类别: '二次', 读取文件: True, Top N: 10
2025-08-11 12:33:15.287 | DEBUG    | database.document_service:_db_query:550 - 查询规范文件分类 (适配器): 二次
2025-08-11 12:33:15.288 | INFO     | database.document_service:_db_query:571 - 查询到 '二次' 分类的规范共 16 条:{'45_DLT-559-2018《220kV～750kV电网继电保护装置运行整定规程》_md': '二次/45_DLT-559-2018《220kV～750kV电网继电保护装置运行整定规程》_md/images/01930a72-0c64-7cdb-a401-2ec51e0c6a0c_19_1142_1062_132_174_0.jpg', 'DL∕T 448-2016 电能计量装置技术管理规程': '二次/DL∕T 448-2016 电能计量装置技术管理规程/DL∕T 448-2016 电能计量装置技术管理规程.pdf', 'GB∕T 36572-2018 电力监控系统网络安全防护导则': '二次/GB∕T 36572-2018 电力监控系统网络安全防护导则/GB∕T 36572-2018 电力监控系统网络安全防护导则.pdf', 'GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范': '二次/GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范/GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范.pdf', 'GB∕T 38435-2019 牵引站供电线路的继电保护配置及整定计算原则': '二次/GB∕T 38435-2019 牵引站供电线路的继电保护配置及整定计算原则/GB∕T 38435-2019 牵引站供电线路的继电保护配置及整定计算原则.pdf', 'GB∕T 38969-2020 电力系统技术导则': '二次/GB∕T 38969-2020 电力系统技术导则/GB∕T 38969-2020 电力系统技术导则.pdf', 'GB∕T_40581-2021 电力系统安全稳定计算规范': '二次/GB∕T_40581-2021 电力系统安全稳定计算规范/GB∕T_40581-2021 电力系统安全稳定计算规范.pdf', 'GB／T-14285—2023《继电保护和安全自动装置技术规程》_md': '二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_93_324_268_737_1834_0.jpg', 'IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13': '二次/IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13/IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13.pdf', 'NBT 11315-2023 变电站辅助控制系统设计规程': '二次/NBT 11315-2023 变电站辅助控制系统设计规程/NBT 11315-2023 变电站辅助控制系统设计规程.pdf', 'QGDW 10536-2021-变压器油中溶解气体在线监测装置技术规范': '二次/QGDW 10536-2021-变压器油中溶解气体在线监测装置技术规范/QGDW 10536-2021-变压器油中溶解气体在线监测装置技术规范.pdf', 'QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范': '二次/QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范/QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范.pdf', 'QGDW 11486-2022 继电保护和安全自动装置验收规范': '二次/QGDW 11486-2022 继电保护和安全自动装置验收规范/QGDW 11486-2022 继电保护和安全自动装置验收规范.pdf', 'QGDW 12301-2023 变电站硬压板在线监测技术规范': '二次/QGDW 12301-2023 变电站硬压板在线监测技术规范/QGDW 12301-2023 变电站硬压板在线监测技术规范.pdf', 'QGDW10347-2023电能计量装置通用设计': '二次/QGDW10347-2023电能计量装置通用设计/QGDW10347-2023电能计量装置通用设计.pdf', '变电站辅助设备监控系统设计规范': '二次/变电站辅助设备监控系统设计规范/QGDW 10688-2024 变电站辅助监控系统设计规范.pdf'}
2025-08-11 12:33:15.288 | DEBUG    | my_mcp_tools.mcp_tools:_get_embeddings:171 - 正在调用嵌入模型: base_url='http://127.0.0.1:8001/v1', model='/home/zhouxiang/models/BAAI_bge-m3'
2025-08-11 12:33:15.455 | DEBUG    | my_mcp_tools.mcp_tools:_find_similar_items_with_scores:201 - 向量检索 Top-10 结果: [('DL∕T 448-2016 电能计量装置技术管理规程', 1.0), ('GB∕T 38969-2020 电力系统技术导则', 0.6710243044734492), ('QGDW10347-2023电能计量装置通用设计', 0.6567422349921666), ('GB∕T_40581-2021 电力系统安全稳定计算规范', 0.6369072333474866), ('GB∕T 36572-2018 电力监控系统网络安全防护导则', 0.6177673634447302), ('变电站辅助设备监控系统设计规范', 0.5896911011004369), ('GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范', 0.5808915666531725), ('QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范', 0.5789329521991341), ('NBT 11315-2023 变电站辅助控制系统设计规程', 0.5756133827429872), ('QGDW 11486-2022 继电保护和安全自动装置验收规范', 0.5728003128882341)]
2025-08-11 12:33:15.455 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:895 - 最匹配文件 '二次/DL∕T 448-2016 电能计量装置技术管理规程/DL∕T 448-2016 电能计量装置技术管理规程.pdf' 相似度(1.0000) > 0.7，准备读取内容。
2025-08-11 12:33:15.455 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/DL∕T 448-2016 电能计量装置技术管理规程/DL∕T 448-2016 电能计量装置技术管理规程.pdf (相对路径: 二次/DL∕T 448-2016 电能计量装置技术管理规程/DL∕T 448-2016 电能计量装置技术管理规程.pdf)，分隔符: '
'
2025-08-11 12:33:15.536 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: DL∕T 448-2016 电能计量装置技术管理规程.pdf, 内容长度: 153
2025-08-11 12:33:15.537 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '二次/DL∕T 448-2016 电能计量装置技术管理规程/DL∕T 448-2016 电能计量装置技术管理规程.pdf' (token: 2460df672a7b42028535e82eabfa5650), 有效期至: Mon Aug 11 20:33:15 2025
2025-08-11 12:33:15.543 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:33:15.550 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/2460df672a7b42028535e82eabfa5650/DL∕T 448-2016 电能计量装置技术管理规程.pdf
2025-08-11 12:33:15.727 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 'DL∕T 448-2016 电能计量装置技术管理规程_73d11181.pdf' 与Token关联文件名 'DL∕T 448-2016 电能计量装置技术管理规程.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 12:33:15.727 | DEBUG    | api.route:download_file_via_token:193 - Token '2460df672a7b42028535e82eabfa5650' 验证成功。准备下载文件: 'DL∕T 448-2016 电能计量装置技术管理规程.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/规程规范/二次/DL∕T 448-2016 电能计量装置技术管理规程/DL∕T 448-2016 电能计量装置技术管理规程.pdf', URL文件名: 'DL∕T 448-2016 电能计量装置技术管理规程_73d11181.pdf')
2025-08-11 12:33:15.729 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 'DL∕T 448-2016 电能计量装置技术管理规程_73d11181.pdf' 与Token关联文件名 'DL∕T 448-2016 电能计量装置技术管理规程.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 12:33:15.729 | DEBUG    | api.route:download_file_via_token:193 - Token '2460df672a7b42028535e82eabfa5650' 验证成功。准备下载文件: 'DL∕T 448-2016 电能计量装置技术管理规程.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/规程规范/二次/DL∕T 448-2016 电能计量装置技术管理规程/DL∕T 448-2016 电能计量装置技术管理规程.pdf', URL文件名: 'DL∕T 448-2016 电能计量装置技术管理规程_73d11181.pdf')
2025-08-11 12:33:19.338 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_MdgEBI9GTDK59BQ3cqSKbg', 'type': 'function', 'function': {'name': 'query_specification_knowledge_base', 'arguments': '{"user_query": "电流互感器技术规范", "knowledge_base_name": "二次", "top_k": 5}'}}]
2025-08-11 12:33:19.338 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_specification_knowledge_base with args: {"user_query": "电流互感器技术规范", "knowledge_base_name": "二次", "top_k": 5}
2025-08-11 12:33:19.381 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:266 - 工具调用: query_specification_knowledge_base, 知识库: 二次, 用户查询: '电流互感器技术规范...', top_k: 5
2025-08-11 12:33:19.381 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:279 - 正在从 http://127.0.0.1/v1/datasets 获取知识库ID，参数: {'keyword': '二次', 'page': 1, 'limit': 10}
2025-08-11 12:33:19.485 | INFO     | my_mcp_tools.mcp_tools:query_specification_knowledge_base:293 - 成功获取到知识库 '二次' 的ID: eaee81cc-3cb5-4649-89b0-9e702a659131
2025-08-11 12:33:19.486 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:307 - 正在向 http://127.0.0.1/v1/datasets/eaee81cc-3cb5-4649-89b0-9e702a659131/retrieve 发起检索请求。Payload (部分): query='电流互感器技术规范...', top_k=5
2025-08-11 12:33:19.670 | INFO     | my_mcp_tools.mcp_tools:query_specification_knowledge_base:314 - 从知识库 '二次' 检索到 5 条结果。
2025-08-11 12:33:19.677 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:34:45.866 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:34:45.866 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 a5d4f431-4b12-446c-859b-9c7d646c8ece, 对话ID: c0dacd61-7153-4343-9a02-7e03aa4a9085, 查询: 找下电气专业的所有规范
2025-08-11 12:34:45.867 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:34:49.517 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_dFIHKnY6SY624wmSBiizXQ', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "/ALL", "category": "电气", "read_file": false, "top_n": 50}'}}]
2025-08-11 12:34:49.517 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "/ALL", "category": "电气", "read_file": false, "top_n": 50}
2025-08-11 12:34:49.563 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '/ALL', 类别: '电气', 读取文件: False, Top N: 50
2025-08-11 12:34:49.563 | DEBUG    | database.document_service:_db_query:550 - 查询规范文件分类 (适配器): 电气
2025-08-11 12:34:49.565 | INFO     | database.document_service:_db_query:571 - 查询到 '电气' 分类的规范共 2 条:{'DLT-866-2015 电流互感器和电压互感器选择及计算规程_md': '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/images/0192c8e0-9c9d-7840-a544-288f16eaf20f_63_747_821_223_122_0.jpg', '33-GB-50217-2018-电力工程电缆设计标准_md': '电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_32_287_1311_1133_384_0.jpg'}
2025-08-11 12:34:49.565 | WARNING  | my_mcp_tools.mcp_tools:open_specification_files:866 - 在专业类别 '电气' 下未找到可供检索的文档文件（如PDF, MD, DOCX等）。
2025-08-11 12:34:49.570 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:34:51.500 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_2181GV0zSYaZd0GVU_VYcw', 'type': 'function', 'function': {'name': 'query_specification_knowledge_base', 'arguments': '{"user_query": "电气专业规范", "knowledge_base_name": "电气", "top_k": 50}'}}]
2025-08-11 12:34:51.500 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_specification_knowledge_base with args: {"user_query": "电气专业规范", "knowledge_base_name": "电气", "top_k": 50}
2025-08-11 12:34:51.543 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:266 - 工具调用: query_specification_knowledge_base, 知识库: 电气, 用户查询: '电气专业规范...', top_k: 50
2025-08-11 12:34:51.543 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:279 - 正在从 http://127.0.0.1/v1/datasets 获取知识库ID，参数: {'keyword': '电气', 'page': 1, 'limit': 10}
2025-08-11 12:34:51.638 | INFO     | my_mcp_tools.mcp_tools:query_specification_knowledge_base:293 - 成功获取到知识库 '电气' 的ID: 95bde3ad-88fe-4994-8599-34f155626984
2025-08-11 12:34:51.638 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:307 - 正在向 http://127.0.0.1/v1/datasets/95bde3ad-88fe-4994-8599-34f155626984/retrieve 发起检索请求。Payload (部分): query='电气专业规范...', top_k=50
2025-08-11 12:34:52.281 | INFO     | my_mcp_tools.mcp_tools:query_specification_knowledge_base:314 - 从知识库 '电气' 检索到 31 条结果。
2025-08-11 12:34:52.292 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:40:59.306 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 a5d4f431-4b12-446c-859b-9c7d646c8ece 用户 admin 断开连接
2025-08-11 12:40:59.307 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:40:59.307 | INFO     | core.session:disconnect_websocket:108 - 用户 'admin' 的 WebSocket 已断开。
2025-08-11 12:40:59.408 | INFO     | __main__:combined_lifespan:130 - COMBINED LIFESPAN END - PID: 1893979 - 服务器关闭中...
2025-08-11 12:40:59.408 | INFO     | database.document_service:shutdown:469 - 正在关闭 DocumentQueryService...
2025-08-11 12:40:59.417 | INFO     | database.document_service:shutdown:474 - Watchdog 监控已停止。
2025-08-11 12:40:59.417 | INFO     | database.document_service:shutdown:482 - 后台更新任务已取消。
2025-08-11 12:40:59.417 | INFO     | database.document_service:shutdown:487 - 数据库连接已关闭。
2025-08-11 12:40:59.417 | INFO     | database.document_service:shutdown:489 - DocumentQueryService 已成功关闭。
2025-08-11 12:40:59.417 | INFO     | __main__:combined_lifespan:134 - 统一文档查询服务已关闭。
2025-08-11 12:40:59.417 | INFO     | __main__:combined_lifespan:139 - APScheduler 调度器已关闭。
2025-08-11 12:40:59.418 | INFO     | __main__:combined_lifespan:140 - Custom application resources cleaned up.
2025-08-11 12:42:23.700 | INFO     | __main__:<module>:35 - Loguru 日志系统已初始化。
2025-08-11 12:42:23.701 | INFO     | __main__:<module>:36 - 项目根目录配置为: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:42:23.701 | INFO     | __main__:<module>:37 - 数据库路径配置为: data/document_service.db
2025-08-11 12:42:23.701 | INFO     | __main__:<module>:38 - 表格列读取配置已加载: {'变电站安装工程概算表': (2, 6), '变电站建筑工程概算表': (2, 6), '电缆输电线路安装工程概算表': (2, 6), '电缆输电线路建筑工程概算表': (2, 6)}
2025-08-11 12:42:23.701 | INFO     | __main__:<module>:39 - kkFileView 服务地址配置为: http://127.0.0.1:8012/kkfileview
2025-08-11 12:42:23.701 | INFO     | __main__:<module>:42 - Dify Agent API Key: ********kGHe
2025-08-11 12:42:23.701 | INFO     | __main__:<module>:43 - Session Secret Key: ********cc34
2025-08-11 12:42:23.701 | INFO     | __main__:<module>:44 - 服务器ipv6地址为: http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8888
2025-08-11 12:42:23.702 | INFO     | __main__:<module>:151 - FastAPI 应用已实例化并注册到 app_state。
2025-08-11 12:42:23.702 | INFO     | __main__:<module>:154 - CORS中间件已添加，允许所有来源。
2025-08-11 12:42:23.712 | INFO     | __main__:<module>:174 - MCP 服务器 '项目文件检索服务器' 已挂载到 FastAPI 应用的 '/mcp/' 路径。
2025-08-11 12:42:23.728 | INFO     | __main__:combined_lifespan:64 - COMBINED LIFESPAN START - PID: 1905781 - 服务器启动中...
2025-08-11 12:42:23.761 | INFO     | __main__:combined_lifespan:69 - HTTPX 客户端已创建并注册到 app_state。
2025-08-11 12:42:23.762 | INFO     | utils.utils:check_embedding_service_health:28 - 正在检查嵌入模型服务，目标URL: http://127.0.0.1:8001/v1/models
2025-08-11 12:42:23.768 | INFO     | utils.utils:check_embedding_service_health:37 - 嵌入模型服务可用，模型列表: ['/home/zhouxiang/models/BAAI_bge-m3']
2025-08-11 12:42:23.768 | INFO     | core.session:__init__:79 - SessionStateManager已初始化。整体HTTP不活动超时: 3600秒
2025-08-11 12:42:23.768 | INFO     | __main__:combined_lifespan:77 - SessionStateManager 已实例化并注册到 app_state。
2025-08-11 12:42:23.768 | INFO     | database.document_service:__init__:164 - 有效文档根目录: {'项目文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/Projects1'), '规范文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/规程规范'), '管理文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/管理文件')}
2025-08-11 12:42:23.769 | DEBUG    | database.document_service:_init_db:180 - 初始化数据库
2025-08-11 12:42:23.770 | DEBUG    | database.document_service:_init_db:201 - 数据库初始化完成
2025-08-11 12:42:23.770 | INFO     | database.document_service:__init__:177 - DocumentQueryService 初始化完成
2025-08-11 12:42:23.770 | INFO     | database.document_service:full_scan:333 - 开始全量扫描...
2025-08-11 12:42:23.770 | INFO     | database.document_service:full_scan:336 - 正在扫描 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:42:28.968 | INFO     | database.document_service:full_scan:336 - 正在扫描 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 12:42:29.289 | INFO     | database.document_service:full_scan:336 - 正在扫描 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 12:42:29.289 | INFO     | database.document_service:full_scan:341 - 全量扫描完成，共处理文件数: 1581
2025-08-11 12:42:29.289 | DEBUG    | database.document_service:_start_watchdog:344 - 启动文件监控 Watchdog
2025-08-11 12:42:29.290 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:42:29.290 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 12:42:29.290 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 12:42:29.311 | INFO     | database.document_service:_start_watchdog:432 - Watchdog 已启动
2025-08-11 12:42:29.311 | INFO     | database.document_service:start:474 - DocumentQueryService 已启动
2025-08-11 12:42:29.311 | INFO     | __main__:combined_lifespan:83 - 统一文档查询服务 (DocumentQueryService) 已启动。
2025-08-11 12:42:29.311 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/Projects1', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 12:42:29.311 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/规程规范', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 12:42:29.311 | INFO     | __main__:combined_lifespan:88 - 项目和规程的文件服务已初始化。
2025-08-11 12:42:29.313 | INFO     | __main__:combined_lifespan:93 - AsyncIOScheduler 已实例化并注册到 app_state。
2025-08-11 12:42:29.313 | INFO     | __main__:combined_lifespan:97 - FastMCP lifespan context entered.
2025-08-11 12:42:29.313 | INFO     | __main__:combined_lifespan:117 - 处理不活动用户会话任务已添加到APScheduler (每 60s)。
2025-08-11 12:42:29.313 | INFO     | __main__:combined_lifespan:120 - 清理用户会话中已打开文件token任务已添加到APScheduler (每 120s)。
2025-08-11 12:42:29.314 | INFO     | __main__:combined_lifespan:123 - APScheduler 调度器已启动。
2025-08-11 12:42:29.314 | INFO     | __main__:combined_lifespan:124 - 所有初始化完成... yield
2025-08-11 12:42:29.314 | DEBUG    | database.document_service:_debounced_update_loop:435 - 启动去抖更新循环
2025-08-11 12:42:38.946 | INFO     | api.route:logout:87 - HTTP会话已清除 (用户: 未知)。
2025-08-11 12:42:39.986 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: 16861dbb-1ebd-4ee0-a4e5-41a35261e265, IP: 240e:479:668:3c1c:e8c4:feaf:5d4:560a) 登录/状态更新成功。
2025-08-11 12:42:39.986 | INFO     | api.route:login:76 - 用户 'admin' (IP: 240e:479:668:3c1c:e8c4:feaf:5d4:560a, Session: 16861dbb-1ebd-4ee0-a4e5-41a35261e265) 登录成功。
2025-08-11 12:42:40.113 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: 16861dbb-1ebd-4ee0-a4e5-41a35261e265) 的 WebSocket 已连接并关联。
2025-08-11 12:42:40.193 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-11 12:42:45.179 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:e8c4:feaf:5d4:560a'.
2025-08-11 12:42:45.180 | INFO     | api.admin:update_admin_config:164 - 从服务商 'zhipu' 的预设中加载了 API Key。
2025-08-11 12:42:45.180 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_API_BASE_URL' 已更新为: https://open.bigmodel.cn/api/paas/v4/
2025-08-11 12:42:45.180 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_MODEL_NAME' 已更新为: GLM-4.5-Flash
2025-08-11 12:42:45.180 | INFO     | api.admin:update_admin_config:180 - 运行时配置 'OPENAI_API_KEY' 已更新为: ******Yj8a
2025-08-11 12:42:45.189 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:e8c4:feaf:5d4:560a'.
2025-08-11 12:42:47.507 | INFO     | sse_proxy.sse2websocket1:run:276 - 收到新对话开始事件，对话ID: f5b1fc7f-0181-48ca-91b1-5b69966e2bcf。清空历史记录。
2025-08-11 12:43:00.942 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:43:00.942 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 16861dbb-1ebd-4ee0-a4e5-41a35261e265, 对话ID: f5b1fc7f-0181-48ca-91b1-5b69966e2bcf, 查询: 找一下电气里有哪些规范
2025-08-11 12:43:00.943 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:43:07.907 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_NU-UFzEhTfy1i7lt16CTnA', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "/ALL", "category": "电气", "read_file": false, "top_n": 20}'}}]
2025-08-11 12:43:07.907 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "/ALL", "category": "电气", "read_file": false, "top_n": 20}
2025-08-11 12:43:07.952 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '/ALL', 类别: '电气', 读取文件: False, Top N: 20
2025-08-11 12:43:07.952 | DEBUG    | database.document_service:_db_query:559 - 查询规范文件分类 (适配器): 电气
2025-08-11 12:43:07.953 | INFO     | database.document_service:_db_query:580 - 查询到 '电气' 分类的规范共 2 条:{'DLT-866-2015 电流互感器和电压互感器选择及计算规程_md': '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md', '33-GB-50217-2018-电力工程电缆设计标准_md': '电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md'}
2025-08-11 12:43:07.953 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:870 - 用户请求 '电气' 类别下的所有规范。
2025-08-11 12:43:07.959 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:43:30.433 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:43:30.433 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 16861dbb-1ebd-4ee0-a4e5-41a35261e265, 对话ID: f5b1fc7f-0181-48ca-91b1-5b69966e2bcf, 查询: 打开1
2025-08-11 12:43:30.433 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:43:35.967 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_-qGo94LqQtG_M41TVI3Mmg', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md", "category": "电气", "read_file": true, "top_n": 1}'}}]
2025-08-11 12:43:35.967 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md", "category": "电气", "read_file": true, "top_n": 1}
2025-08-11 12:43:36.013 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md', 类别: '电气', 读取文件: True, Top N: 1
2025-08-11 12:43:36.013 | DEBUG    | database.document_service:_db_query:559 - 查询规范文件分类 (适配器): 电气
2025-08-11 12:43:36.014 | INFO     | database.document_service:_db_query:580 - 查询到 '电气' 分类的规范共 2 条:{'DLT-866-2015 电流互感器和电压互感器选择及计算规程_md': '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md', '33-GB-50217-2018-电力工程电缆设计标准_md': '电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md'}
2025-08-11 12:43:36.015 | DEBUG    | my_mcp_tools.mcp_tools:_get_embeddings:171 - 正在调用嵌入模型: base_url='http://127.0.0.1:8001/v1', model='/home/zhouxiang/models/BAAI_bge-m3'
2025-08-11 12:43:36.113 | DEBUG    | my_mcp_tools.mcp_tools:_find_similar_items_with_scores:201 - 向量检索 Top-1 结果: [('DLT-866-2015 电流互感器和电压互感器选择及计算规程_md', 0.9316110905616869)]
2025-08-11 12:43:36.113 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:895 - 最匹配文件 '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' 相似度(0.9316) > 0.7，准备读取内容。
2025-08-11 12:43:36.113 | DEBUG    | my_mcp_tools.mcp_tools:_get_spec_file_content:96 - MCP Tool: 尝试读取规程文件: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md
2025-08-11 12:43:36.115 | DEBUG    | my_mcp_tools.mcp_tools:_get_spec_file_content:100 - MCP Tool: 读取完成，文件: DLT-866-2015 电流互感器和电压互感器选择及计算规程.md, 内容长度: 262961
2025-08-11 12:43:36.115 | WARNING  | my_mcp_tools.mcp_tools:open_specification_files:914 - 文件 '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' 内容过长，可能超过模型上下文窗口。
2025-08-11 12:43:36.115 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' (token: 52b345f2545844a9bf8f77492efa87bb), 有效期至: Mon Aug 11 20:43:36 2025
2025-08-11 12:43:36.121 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:43:36.263 | DEBUG    | api.route:download_file_via_token:193 - Token '52b345f2545844a9bf8f77492efa87bb' 验证成功。准备下载文件: 'DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' (路径: '/media/zhouxiang/FC7C74827C743A0A/规程规范/电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md', URL文件名: 'DLT-866-2015 电流互感器和电压互感器选择及计算规程.md')
2025-08-11 12:54:10.336 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 16861dbb-1ebd-4ee0-a4e5-41a35261e265 用户 admin 断开连接
2025-08-11 12:54:10.336 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:54:10.336 | INFO     | core.session:disconnect_websocket:108 - 用户 'admin' 的 WebSocket 已断开。
2025-08-11 12:54:10.437 | INFO     | __main__:combined_lifespan:130 - COMBINED LIFESPAN END - PID: 1905781 - 服务器关闭中...
2025-08-11 12:54:10.437 | INFO     | database.document_service:shutdown:478 - 正在关闭 DocumentQueryService...
2025-08-11 12:54:10.445 | INFO     | database.document_service:shutdown:483 - Watchdog 监控已停止。
2025-08-11 12:54:10.445 | INFO     | database.document_service:shutdown:491 - 后台更新任务已取消。
2025-08-11 12:54:10.445 | INFO     | database.document_service:shutdown:496 - 数据库连接已关闭。
2025-08-11 12:54:10.446 | INFO     | database.document_service:shutdown:498 - DocumentQueryService 已成功关闭。
2025-08-11 12:54:10.446 | INFO     | __main__:combined_lifespan:134 - 统一文档查询服务已关闭。
2025-08-11 12:54:10.446 | INFO     | __main__:combined_lifespan:139 - APScheduler 调度器已关闭。
2025-08-11 12:54:10.446 | INFO     | __main__:combined_lifespan:140 - Custom application resources cleaned up.
2025-08-11 12:54:14.768 | INFO     | __main__:<module>:35 - Loguru 日志系统已初始化。
2025-08-11 12:54:14.768 | INFO     | __main__:<module>:36 - 项目根目录配置为: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:54:14.768 | INFO     | __main__:<module>:37 - 数据库路径配置为: data/document_service.db
2025-08-11 12:54:14.768 | INFO     | __main__:<module>:38 - 表格列读取配置已加载: {'变电站安装工程概算表': (2, 6), '变电站建筑工程概算表': (2, 6), '电缆输电线路安装工程概算表': (2, 6), '电缆输电线路建筑工程概算表': (2, 6)}
2025-08-11 12:54:14.768 | INFO     | __main__:<module>:39 - kkFileView 服务地址配置为: http://127.0.0.1:8012/kkfileview
2025-08-11 12:54:14.768 | INFO     | __main__:<module>:42 - Dify Agent API Key: ********kGHe
2025-08-11 12:54:14.768 | INFO     | __main__:<module>:43 - Session Secret Key: ********7597
2025-08-11 12:54:14.768 | INFO     | __main__:<module>:44 - 服务器ipv6地址为: http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8888
2025-08-11 12:54:14.769 | INFO     | __main__:<module>:151 - FastAPI 应用已实例化并注册到 app_state。
2025-08-11 12:54:14.769 | INFO     | __main__:<module>:154 - CORS中间件已添加，允许所有来源。
2025-08-11 12:54:14.779 | INFO     | __main__:<module>:174 - MCP 服务器 '项目文件检索服务器' 已挂载到 FastAPI 应用的 '/mcp/' 路径。
2025-08-11 12:54:14.794 | INFO     | __main__:combined_lifespan:64 - COMBINED LIFESPAN START - PID: 1919085 - 服务器启动中...
2025-08-11 12:54:14.828 | INFO     | __main__:combined_lifespan:69 - HTTPX 客户端已创建并注册到 app_state。
2025-08-11 12:54:14.828 | INFO     | utils.utils:check_embedding_service_health:28 - 正在检查嵌入模型服务，目标URL: http://127.0.0.1:8001/v1/models
2025-08-11 12:54:14.835 | INFO     | utils.utils:check_embedding_service_health:37 - 嵌入模型服务可用，模型列表: ['/home/zhouxiang/models/BAAI_bge-m3']
2025-08-11 12:54:14.835 | INFO     | core.session:__init__:79 - SessionStateManager已初始化。整体HTTP不活动超时: 3600秒
2025-08-11 12:54:14.835 | INFO     | __main__:combined_lifespan:77 - SessionStateManager 已实例化并注册到 app_state。
2025-08-11 12:54:14.835 | INFO     | database.document_service:__init__:164 - 有效文档根目录: {'项目文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/Projects1'), '规范文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/规程规范'), '管理文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/管理文件')}
2025-08-11 12:54:14.835 | DEBUG    | database.document_service:_init_db:180 - 初始化数据库
2025-08-11 12:54:14.836 | DEBUG    | database.document_service:_init_db:201 - 数据库初始化完成
2025-08-11 12:54:14.836 | INFO     | database.document_service:__init__:177 - DocumentQueryService 初始化完成
2025-08-11 12:54:14.836 | INFO     | database.document_service:full_scan:333 - 开始全量扫描...
2025-08-11 12:54:14.836 | INFO     | database.document_service:full_scan:336 - 正在扫描 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:54:20.093 | INFO     | database.document_service:full_scan:336 - 正在扫描 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 12:54:20.413 | INFO     | database.document_service:full_scan:336 - 正在扫描 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 12:54:20.414 | INFO     | database.document_service:full_scan:341 - 全量扫描完成，共处理文件数: 1581
2025-08-11 12:54:20.414 | DEBUG    | database.document_service:_start_watchdog:344 - 启动文件监控 Watchdog
2025-08-11 12:54:20.414 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:54:20.414 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 12:54:20.414 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 12:54:20.432 | INFO     | database.document_service:_start_watchdog:432 - Watchdog 已启动
2025-08-11 12:54:20.432 | INFO     | database.document_service:start:474 - DocumentQueryService 已启动
2025-08-11 12:54:20.433 | INFO     | __main__:combined_lifespan:83 - 统一文档查询服务 (DocumentQueryService) 已启动。
2025-08-11 12:54:20.433 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/Projects1', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 12:54:20.433 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/规程规范', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 12:54:20.433 | INFO     | __main__:combined_lifespan:88 - 项目和规程的文件服务已初始化。
2025-08-11 12:54:20.435 | INFO     | __main__:combined_lifespan:93 - AsyncIOScheduler 已实例化并注册到 app_state。
2025-08-11 12:54:20.435 | INFO     | __main__:combined_lifespan:97 - FastMCP lifespan context entered.
2025-08-11 12:54:20.435 | INFO     | __main__:combined_lifespan:117 - 处理不活动用户会话任务已添加到APScheduler (每 60s)。
2025-08-11 12:54:20.435 | INFO     | __main__:combined_lifespan:120 - 清理用户会话中已打开文件token任务已添加到APScheduler (每 120s)。
2025-08-11 12:54:20.436 | INFO     | __main__:combined_lifespan:123 - APScheduler 调度器已启动。
2025-08-11 12:54:20.436 | INFO     | __main__:combined_lifespan:124 - 所有初始化完成... yield
2025-08-11 12:54:20.436 | DEBUG    | database.document_service:_debounced_update_loop:435 - 启动去抖更新循环
2025-08-11 12:54:20.777 | INFO     | api.route:logout:87 - HTTP会话已清除 (用户: 未知)。
2025-08-11 12:54:22.702 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: fbe6b156-e579-4fb7-8e3b-8937cb114664, IP: 240e:479:668:3c1c:e8c4:feaf:5d4:560a) 登录/状态更新成功。
2025-08-11 12:54:22.703 | INFO     | api.route:login:76 - 用户 'admin' (IP: 240e:479:668:3c1c:e8c4:feaf:5d4:560a, Session: fbe6b156-e579-4fb7-8e3b-8937cb114664) 登录成功。
2025-08-11 12:54:22.812 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: fbe6b156-e579-4fb7-8e3b-8937cb114664) 的 WebSocket 已连接并关联。
2025-08-11 12:54:22.887 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-11 12:54:26.687 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:e8c4:feaf:5d4:560a'.
2025-08-11 12:54:30.690 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:e8c4:feaf:5d4:560a'.
2025-08-11 12:54:30.691 | INFO     | api.admin:update_admin_config:164 - 从服务商 'zhipu' 的预设中加载了 API Key。
2025-08-11 12:54:30.691 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_API_BASE_URL' 已更新为: https://open.bigmodel.cn/api/paas/v4/
2025-08-11 12:54:30.691 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_MODEL_NAME' 已更新为: GLM-4.5-Flash
2025-08-11 12:54:30.691 | INFO     | api.admin:update_admin_config:180 - 运行时配置 'OPENAI_API_KEY' 已更新为: ******Yj8a
2025-08-11 12:54:30.707 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:e8c4:feaf:5d4:560a'.
2025-08-11 12:54:33.787 | INFO     | sse_proxy.sse2websocket1:run:276 - 收到新对话开始事件，对话ID: 639f3c6b-276c-42fe-873c-807c53556ca6。清空历史记录。
2025-08-11 12:54:45.542 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:54:45.542 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 fbe6b156-e579-4fb7-8e3b-8937cb114664, 对话ID: 639f3c6b-276c-42fe-873c-807c53556ca6, 查询: 打开电流互感器的规范
2025-08-11 12:54:45.542 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:55:10.829 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:55:10.829 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 fbe6b156-e579-4fb7-8e3b-8937cb114664, 对话ID: 639f3c6b-276c-42fe-873c-807c53556ca6, 查询: 用户名是admin
2025-08-11 12:55:10.830 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:55:14.903 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_6ba4c9b6e2924e118fef2c7b', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "电流互感器", "category": "电气", "read_file": true, "top_n": 10}'}}]
2025-08-11 12:55:14.903 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "电流互感器", "category": "电气", "read_file": true, "top_n": 10}
2025-08-11 12:55:14.948 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '电流互感器', 类别: '电气', 读取文件: True, Top N: 10
2025-08-11 12:55:14.948 | DEBUG    | database.document_service:_db_query:559 - 查询规范文件分类 (适配器): 电气
2025-08-11 12:55:14.949 | INFO     | database.document_service:_db_query:580 - 查询到 '电气' 分类的规范共 2 条:{'DLT-866-2015 电流互感器和电压互感器选择及计算规程_md': '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md', '33-GB-50217-2018-电力工程电缆设计标准_md': '电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md'}
2025-08-11 12:55:14.949 | DEBUG    | my_mcp_tools.mcp_tools:_get_embeddings:171 - 正在调用嵌入模型: base_url='http://127.0.0.1:8001/v1', model='/home/zhouxiang/models/BAAI_bge-m3'
2025-08-11 12:55:15.037 | DEBUG    | my_mcp_tools.mcp_tools:_find_similar_items_with_scores:201 - 向量检索 Top-10 结果: [('DLT-866-2015 电流互感器和电压互感器选择及计算规程_md', 0.7736216098040591), ('33-GB-50217-2018-电力工程电缆设计标准_md', 0.42026014073960044)]
2025-08-11 12:55:15.037 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:895 - 最匹配文件 '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' 相似度(0.7736) > 0.7，准备读取内容。
2025-08-11 12:55:15.037 | DEBUG    | my_mcp_tools.mcp_tools:_get_spec_file_content:96 - MCP Tool: 尝试读取规程文件: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md
2025-08-11 12:55:15.039 | DEBUG    | my_mcp_tools.mcp_tools:_get_spec_file_content:100 - MCP Tool: 读取完成，文件: DLT-866-2015 电流互感器和电压互感器选择及计算规程.md, 内容长度: 262961
2025-08-11 12:55:15.039 | WARNING  | my_mcp_tools.mcp_tools:open_specification_files:914 - 文件 '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' 内容过长，可能超过模型上下文窗口。
2025-08-11 12:55:15.039 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' (token: 81221eda0906436ca95a1b6db867e8d4), 有效期至: Mon Aug 11 20:55:15 2025
2025-08-11 12:55:15.046 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 12:55:15.182 | DEBUG    | api.route:download_file_via_token:193 - Token '81221eda0906436ca95a1b6db867e8d4' 验证成功。准备下载文件: 'DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' (路径: '/media/zhouxiang/FC7C74827C743A0A/规程规范/电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md', URL文件名: 'DLT-866-2015 电流互感器和电压互感器选择及计算规程.md')
2025-08-11 12:58:12.936 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 fbe6b156-e579-4fb7-8e3b-8937cb114664 用户 admin 断开连接
2025-08-11 12:58:12.936 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 12:58:12.936 | INFO     | core.session:disconnect_websocket:108 - 用户 'admin' 的 WebSocket 已断开。
2025-08-11 12:58:13.037 | INFO     | __main__:combined_lifespan:130 - COMBINED LIFESPAN END - PID: 1919085 - 服务器关闭中...
2025-08-11 12:58:13.037 | INFO     | database.document_service:shutdown:478 - 正在关闭 DocumentQueryService...
2025-08-11 12:58:13.051 | INFO     | database.document_service:shutdown:483 - Watchdog 监控已停止。
2025-08-11 12:58:13.051 | INFO     | database.document_service:shutdown:491 - 后台更新任务已取消。
2025-08-11 12:58:13.051 | INFO     | database.document_service:shutdown:496 - 数据库连接已关闭。
2025-08-11 12:58:13.051 | INFO     | database.document_service:shutdown:498 - DocumentQueryService 已成功关闭。
2025-08-11 12:58:13.051 | INFO     | __main__:combined_lifespan:134 - 统一文档查询服务已关闭。
2025-08-11 12:58:13.052 | INFO     | __main__:combined_lifespan:139 - APScheduler 调度器已关闭。
2025-08-11 12:58:13.052 | INFO     | __main__:combined_lifespan:140 - Custom application resources cleaned up.
2025-08-11 12:58:18.083 | INFO     | __main__:<module>:35 - Loguru 日志系统已初始化。
2025-08-11 12:58:18.083 | INFO     | __main__:<module>:36 - 项目根目录配置为: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:58:18.083 | INFO     | __main__:<module>:37 - 数据库路径配置为: data/document_service.db
2025-08-11 12:58:18.083 | INFO     | __main__:<module>:38 - 表格列读取配置已加载: {'变电站安装工程概算表': (2, 6), '变电站建筑工程概算表': (2, 6), '电缆输电线路安装工程概算表': (2, 6), '电缆输电线路建筑工程概算表': (2, 6)}
2025-08-11 12:58:18.083 | INFO     | __main__:<module>:39 - kkFileView 服务地址配置为: http://127.0.0.1:8012/kkfileview
2025-08-11 12:58:18.083 | INFO     | __main__:<module>:42 - Dify Agent API Key: ********kGHe
2025-08-11 12:58:18.083 | INFO     | __main__:<module>:43 - Session Secret Key: ********cd55
2025-08-11 12:58:18.084 | INFO     | __main__:<module>:44 - 服务器ipv6地址为: http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8888
2025-08-11 12:58:18.084 | INFO     | __main__:<module>:151 - FastAPI 应用已实例化并注册到 app_state。
2025-08-11 12:58:18.084 | INFO     | __main__:<module>:154 - CORS中间件已添加，允许所有来源。
2025-08-11 12:58:18.096 | INFO     | __main__:<module>:174 - MCP 服务器 '项目文件检索服务器' 已挂载到 FastAPI 应用的 '/mcp/' 路径。
2025-08-11 12:58:18.112 | INFO     | __main__:combined_lifespan:64 - COMBINED LIFESPAN START - PID: 1923812 - 服务器启动中...
2025-08-11 12:58:18.145 | INFO     | __main__:combined_lifespan:69 - HTTPX 客户端已创建并注册到 app_state。
2025-08-11 12:58:18.145 | INFO     | utils.utils:check_embedding_service_health:28 - 正在检查嵌入模型服务，目标URL: http://127.0.0.1:8001/v1/models
2025-08-11 12:58:18.151 | INFO     | utils.utils:check_embedding_service_health:37 - 嵌入模型服务可用，模型列表: ['/home/zhouxiang/models/BAAI_bge-m3']
2025-08-11 12:58:18.151 | INFO     | core.session:__init__:79 - SessionStateManager已初始化。整体HTTP不活动超时: 3600秒
2025-08-11 12:58:18.151 | INFO     | __main__:combined_lifespan:77 - SessionStateManager 已实例化并注册到 app_state。
2025-08-11 12:58:18.151 | INFO     | database.document_service:__init__:164 - 有效文档根目录: {'项目文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/Projects1'), '规范文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/规程规范'), '管理文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/管理文件')}
2025-08-11 12:58:18.152 | DEBUG    | database.document_service:_init_db:180 - 初始化数据库
2025-08-11 12:58:18.152 | DEBUG    | database.document_service:_init_db:201 - 数据库初始化完成
2025-08-11 12:58:18.152 | INFO     | database.document_service:__init__:177 - DocumentQueryService 初始化完成
2025-08-11 12:58:18.152 | INFO     | database.document_service:full_scan:333 - 开始全量扫描...
2025-08-11 12:58:18.152 | INFO     | database.document_service:full_scan:336 - 正在扫描 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:58:23.385 | INFO     | database.document_service:full_scan:336 - 正在扫描 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 12:58:23.701 | INFO     | database.document_service:full_scan:336 - 正在扫描 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 12:58:23.702 | INFO     | database.document_service:full_scan:341 - 全量扫描完成，共处理文件数: 1581
2025-08-11 12:58:23.702 | DEBUG    | database.document_service:_start_watchdog:344 - 启动文件监控 Watchdog
2025-08-11 12:58:23.702 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 12:58:23.702 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 12:58:23.703 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 12:58:23.721 | INFO     | database.document_service:_start_watchdog:432 - Watchdog 已启动
2025-08-11 12:58:23.721 | INFO     | database.document_service:start:474 - DocumentQueryService 已启动
2025-08-11 12:58:23.721 | INFO     | __main__:combined_lifespan:83 - 统一文档查询服务 (DocumentQueryService) 已启动。
2025-08-11 12:58:23.721 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/Projects1', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 12:58:23.722 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/规程规范', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 12:58:23.722 | INFO     | __main__:combined_lifespan:88 - 项目和规程的文件服务已初始化。
2025-08-11 12:58:23.723 | INFO     | __main__:combined_lifespan:93 - AsyncIOScheduler 已实例化并注册到 app_state。
2025-08-11 12:58:23.723 | INFO     | __main__:combined_lifespan:97 - FastMCP lifespan context entered.
2025-08-11 12:58:23.724 | INFO     | __main__:combined_lifespan:117 - 处理不活动用户会话任务已添加到APScheduler (每 60s)。
2025-08-11 12:58:23.724 | INFO     | __main__:combined_lifespan:120 - 清理用户会话中已打开文件token任务已添加到APScheduler (每 120s)。
2025-08-11 12:58:23.724 | INFO     | __main__:combined_lifespan:123 - APScheduler 调度器已启动。
2025-08-11 12:58:23.725 | INFO     | __main__:combined_lifespan:124 - 所有初始化完成... yield
2025-08-11 12:58:23.725 | DEBUG    | database.document_service:_debounced_update_loop:435 - 启动去抖更新循环
2025-08-11 12:58:53.747 | INFO     | __main__:combined_lifespan:130 - COMBINED LIFESPAN END - PID: 1923812 - 服务器关闭中...
2025-08-11 12:58:53.747 | INFO     | database.document_service:shutdown:478 - 正在关闭 DocumentQueryService...
2025-08-11 12:58:53.757 | INFO     | database.document_service:shutdown:483 - Watchdog 监控已停止。
2025-08-11 12:58:53.757 | INFO     | database.document_service:shutdown:491 - 后台更新任务已取消。
2025-08-11 12:58:53.758 | INFO     | database.document_service:shutdown:496 - 数据库连接已关闭。
2025-08-11 12:58:53.758 | INFO     | database.document_service:shutdown:498 - DocumentQueryService 已成功关闭。
2025-08-11 12:58:53.758 | INFO     | __main__:combined_lifespan:134 - 统一文档查询服务已关闭。
2025-08-11 12:58:53.758 | INFO     | __main__:combined_lifespan:139 - APScheduler 调度器已关闭。
2025-08-11 12:58:53.758 | INFO     | __main__:combined_lifespan:140 - Custom application resources cleaned up.
2025-08-11 13:04:41.668 | INFO     | __main__:<module>:35 - Loguru 日志系统已初始化。
2025-08-11 13:04:41.669 | INFO     | __main__:<module>:36 - 项目根目录配置为: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 13:04:41.669 | INFO     | __main__:<module>:37 - 数据库路径配置为: data/document_service.db
2025-08-11 13:04:41.669 | INFO     | __main__:<module>:38 - 表格列读取配置已加载: {'变电站安装工程概算表': (2, 6), '变电站建筑工程概算表': (2, 6), '电缆输电线路安装工程概算表': (2, 6), '电缆输电线路建筑工程概算表': (2, 6)}
2025-08-11 13:04:41.669 | INFO     | __main__:<module>:39 - kkFileView 服务地址配置为: http://127.0.0.1:8012/kkfileview
2025-08-11 13:04:41.669 | INFO     | __main__:<module>:42 - Dify Agent API Key: ********kGHe
2025-08-11 13:04:41.669 | INFO     | __main__:<module>:43 - Session Secret Key: ********fcc5
2025-08-11 13:04:41.669 | INFO     | __main__:<module>:44 - 服务器ipv6地址为: http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8888
2025-08-11 13:04:41.670 | INFO     | __main__:<module>:151 - FastAPI 应用已实例化并注册到 app_state。
2025-08-11 13:04:41.670 | INFO     | __main__:<module>:154 - CORS中间件已添加，允许所有来源。
2025-08-11 13:04:41.681 | INFO     | __main__:<module>:174 - MCP 服务器 '项目文件检索服务器' 已挂载到 FastAPI 应用的 '/mcp/' 路径。
2025-08-11 13:04:41.698 | INFO     | __main__:combined_lifespan:64 - COMBINED LIFESPAN START - PID: 1931059 - 服务器启动中...
2025-08-11 13:04:41.733 | INFO     | __main__:combined_lifespan:69 - HTTPX 客户端已创建并注册到 app_state。
2025-08-11 13:04:41.733 | INFO     | utils.utils:check_embedding_service_health:28 - 正在检查嵌入模型服务，目标URL: http://127.0.0.1:8001/v1/models
2025-08-11 13:04:41.740 | INFO     | utils.utils:check_embedding_service_health:37 - 嵌入模型服务可用，模型列表: ['/home/zhouxiang/models/BAAI_bge-m3']
2025-08-11 13:04:41.740 | INFO     | core.session:__init__:79 - SessionStateManager已初始化。整体HTTP不活动超时: 3600秒
2025-08-11 13:04:41.740 | INFO     | __main__:combined_lifespan:77 - SessionStateManager 已实例化并注册到 app_state。
2025-08-11 13:04:41.740 | INFO     | database.document_service:__init__:164 - 有效文档根目录: {'项目文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/Projects1'), '规范文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/规程规范'), '管理文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/管理文件')}
2025-08-11 13:04:41.741 | DEBUG    | database.document_service:_init_db:180 - 初始化数据库
2025-08-11 13:04:41.741 | DEBUG    | database.document_service:_init_db:201 - 数据库初始化完成
2025-08-11 13:04:41.741 | INFO     | database.document_service:__init__:177 - DocumentQueryService 初始化完成
2025-08-11 13:04:41.741 | INFO     | database.document_service:full_scan:333 - 开始全量扫描...
2025-08-11 13:04:41.741 | INFO     | database.document_service:full_scan:336 - 正在扫描 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 13:04:47.112 | INFO     | database.document_service:full_scan:336 - 正在扫描 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 13:04:47.429 | INFO     | database.document_service:full_scan:336 - 正在扫描 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 13:04:47.430 | INFO     | database.document_service:full_scan:341 - 全量扫描完成，共处理文件数: 1581
2025-08-11 13:04:47.430 | DEBUG    | database.document_service:_start_watchdog:344 - 启动文件监控 Watchdog
2025-08-11 13:04:47.430 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 13:04:47.430 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 13:04:47.430 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 13:04:47.452 | INFO     | database.document_service:_start_watchdog:432 - Watchdog 已启动
2025-08-11 13:04:47.453 | INFO     | database.document_service:start:474 - DocumentQueryService 已启动
2025-08-11 13:04:47.453 | INFO     | __main__:combined_lifespan:83 - 统一文档查询服务 (DocumentQueryService) 已启动。
2025-08-11 13:04:47.453 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/Projects1', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 13:04:47.453 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/规程规范', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 13:04:47.453 | INFO     | __main__:combined_lifespan:88 - 项目和规程的文件服务已初始化。
2025-08-11 13:04:47.454 | INFO     | __main__:combined_lifespan:93 - AsyncIOScheduler 已实例化并注册到 app_state。
2025-08-11 13:04:47.454 | INFO     | __main__:combined_lifespan:97 - FastMCP lifespan context entered.
2025-08-11 13:04:47.455 | INFO     | __main__:combined_lifespan:117 - 处理不活动用户会话任务已添加到APScheduler (每 60s)。
2025-08-11 13:04:47.455 | INFO     | __main__:combined_lifespan:120 - 清理用户会话中已打开文件token任务已添加到APScheduler (每 120s)。
2025-08-11 13:04:47.455 | INFO     | __main__:combined_lifespan:123 - APScheduler 调度器已启动。
2025-08-11 13:04:47.455 | INFO     | __main__:combined_lifespan:124 - 所有初始化完成... yield
2025-08-11 13:04:47.455 | DEBUG    | database.document_service:_debounced_update_loop:435 - 启动去抖更新循环
2025-08-11 13:04:50.524 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: 953520b1-476f-4eb7-a6a7-8777c2af707b, IP: 240e:479:668:3c1c:e8c4:feaf:5d4:560a) 登录/状态更新成功。
2025-08-11 13:04:50.524 | INFO     | api.route:login:76 - 用户 'admin' (IP: 240e:479:668:3c1c:e8c4:feaf:5d4:560a, Session: 953520b1-476f-4eb7-a6a7-8777c2af707b) 登录成功。
2025-08-11 13:04:50.650 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: 953520b1-476f-4eb7-a6a7-8777c2af707b) 的 WebSocket 已连接并关联。
2025-08-11 13:04:50.730 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-11 13:04:55.638 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:e8c4:feaf:5d4:560a'.
2025-08-11 13:04:55.639 | INFO     | api.admin:update_admin_config:164 - 从服务商 'zhipu' 的预设中加载了 API Key。
2025-08-11 13:04:55.639 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_API_BASE_URL' 已更新为: https://open.bigmodel.cn/api/paas/v4/
2025-08-11 13:04:55.639 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_MODEL_NAME' 已更新为: GLM-4.5-Flash
2025-08-11 13:04:55.640 | INFO     | api.admin:update_admin_config:180 - 运行时配置 'OPENAI_API_KEY' 已更新为: ******Yj8a
2025-08-11 13:04:55.655 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:e8c4:feaf:5d4:560a'.
2025-08-11 13:04:57.500 | INFO     | sse_proxy.sse2websocket1:run:276 - 收到新对话开始事件，对话ID: 52bd660a-8253-45c9-ba55-14776c09230d。清空历史记录。
2025-08-11 13:05:05.870 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 13:05:05.870 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 953520b1-476f-4eb7-a6a7-8777c2af707b, 对话ID: 52bd660a-8253-45c9-ba55-14776c09230d, 查询: 打开电流互感器的规范
2025-08-11 13:05:05.871 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 13:05:12.014 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_YQvKx1ErSFSZnopdXAF5UQ', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "电流互感器", "category": "电气", "read_file": true, "top_n": 10}'}}]
2025-08-11 13:05:12.014 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "电流互感器", "category": "电气", "read_file": true, "top_n": 10}
2025-08-11 13:05:12.057 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '电流互感器', 类别: '电气', 读取文件: True, Top N: 10
2025-08-11 13:05:12.057 | DEBUG    | database.document_service:_db_query:559 - 查询规范文件分类 (适配器): 电气
2025-08-11 13:05:12.058 | INFO     | database.document_service:_db_query:580 - 查询到 '电气' 分类的规范共 2 条:{'DLT-866-2015 电流互感器和电压互感器选择及计算规程_md': '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md', '33-GB-50217-2018-电力工程电缆设计标准_md': '电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md'}
2025-08-11 13:05:12.059 | DEBUG    | my_mcp_tools.mcp_tools:_get_embeddings:171 - 正在调用嵌入模型: base_url='http://127.0.0.1:8001/v1', model='/home/zhouxiang/models/BAAI_bge-m3'
2025-08-11 13:05:12.144 | DEBUG    | my_mcp_tools.mcp_tools:_find_similar_items_with_scores:201 - 向量检索 Top-10 结果: [('DLT-866-2015 电流互感器和电压互感器选择及计算规程_md', 0.7736216098040591), ('33-GB-50217-2018-电力工程电缆设计标准_md', 0.42026014073960044)]
2025-08-11 13:05:12.144 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:895 - 最匹配文件 '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' 相似度(0.7736) > 0.7，准备读取内容。
2025-08-11 13:05:12.144 | DEBUG    | my_mcp_tools.mcp_tools:_get_spec_file_content:96 - MCP Tool: 尝试读取规程文件: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md
2025-08-11 13:05:12.146 | DEBUG    | my_mcp_tools.mcp_tools:_get_spec_file_content:100 - MCP Tool: 读取完成，文件: DLT-866-2015 电流互感器和电压互感器选择及计算规程.md, 内容长度: 262961
2025-08-11 13:05:12.146 | WARNING  | my_mcp_tools.mcp_tools:open_specification_files:914 - 文件 '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' 内容过长，可能超过模型上下文窗口。
2025-08-11 13:05:12.146 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' (token: d08e515b004644bda481ec7bf216b701), 有效期至: Mon Aug 11 21:05:12 2025
2025-08-11 13:05:12.152 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 13:05:12.300 | DEBUG    | api.route:download_file_via_token:193 - Token 'd08e515b004644bda481ec7bf216b701' 验证成功。准备下载文件: 'DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' (路径: '/media/zhouxiang/FC7C74827C743A0A/规程规范/电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md', URL文件名: 'DLT-866-2015 电流互感器和电压互感器选择及计算规程.md')
2025-08-11 13:06:36.838 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 13:06:36.838 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 953520b1-476f-4eb7-a6a7-8777c2af707b, 对话ID: 52bd660a-8253-45c9-ba55-14776c09230d, 查询: 再打开二次的规范看看你有哪些
2025-08-11 13:06:36.839 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 13:06:39.871 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_tErGv0BxR7GWgifrOHMD5A', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "/ALL", "category": "二次", "read_file": false, "top_n": 20}'}}]
2025-08-11 13:06:39.871 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "/ALL", "category": "二次", "read_file": false, "top_n": 20}
2025-08-11 13:06:39.914 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '/ALL', 类别: '二次', 读取文件: False, Top N: 20
2025-08-11 13:06:39.914 | DEBUG    | database.document_service:_db_query:559 - 查询规范文件分类 (适配器): 二次
2025-08-11 13:06:39.915 | INFO     | database.document_service:_db_query:580 - 查询到 '二次' 分类的规范共 16 条:{'45_DLT-559-2018《220kV～750kV电网继电保护装置运行整定规程》_md': '二次/45_DLT-559-2018《220kV～750kV电网继电保护装置运行整定规程》_md/45_DLT-559-2018《220kV～750kV电网继电保护装置运行整定规程》.md', 'DL∕T 448-2016 电能计量装置技术管理规程': '二次/DL∕T 448-2016 电能计量装置技术管理规程/DL∕T 448-2016 电能计量装置技术管理规程.pdf', 'GB∕T 36572-2018 电力监控系统网络安全防护导则': '二次/GB∕T 36572-2018 电力监控系统网络安全防护导则/GB∕T 36572-2018 电力监控系统网络安全防护导则.pdf', 'GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范': '二次/GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范/GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范.pdf', 'GB∕T 38435-2019 牵引站供电线路的继电保护配置及整定计算原则': '二次/GB∕T 38435-2019 牵引站供电线路的继电保护配置及整定计算原则/GB∕T 38435-2019 牵引站供电线路的继电保护配置及整定计算原则.pdf', 'GB∕T 38969-2020 电力系统技术导则': '二次/GB∕T 38969-2020 电力系统技术导则/GB∕T 38969-2020 电力系统技术导则.pdf', 'GB∕T_40581-2021 电力系统安全稳定计算规范': '二次/GB∕T_40581-2021 电力系统安全稳定计算规范/GB∕T_40581-2021 电力系统安全稳定计算规范.pdf', 'GB／T-14285—2023《继电保护和安全自动装置技术规程》_md': '二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/GB／T-14285—2023《继电保护和安全自动装置技术规程》.md', 'IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13': '二次/IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13/IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13.pdf', 'NBT 11315-2023 变电站辅助控制系统设计规程': '二次/NBT 11315-2023 变电站辅助控制系统设计规程/NBT 11315-2023 变电站辅助控制系统设计规程.pdf', 'QGDW 10536-2021-变压器油中溶解气体在线监测装置技术规范': '二次/QGDW 10536-2021-变压器油中溶解气体在线监测装置技术规范/QGDW 10536-2021-变压器油中溶解气体在线监测装置技术规范.pdf', 'QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范': '二次/QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范/QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范.pdf', 'QGDW 11486-2022 继电保护和安全自动装置验收规范': '二次/QGDW 11486-2022 继电保护和安全自动装置验收规范/QGDW 11486-2022 继电保护和安全自动装置验收规范.pdf', 'QGDW 12301-2023 变电站硬压板在线监测技术规范': '二次/QGDW 12301-2023 变电站硬压板在线监测技术规范/QGDW 12301-2023 变电站硬压板在线监测技术规范.pdf', 'QGDW10347-2023电能计量装置通用设计': '二次/QGDW10347-2023电能计量装置通用设计/QGDW10347-2023电能计量装置通用设计.pdf', '变电站辅助设备监控系统设计规范': '二次/变电站辅助设备监控系统设计规范/QGDW 10688-2024 变电站辅助监控系统设计规范.pdf'}
2025-08-11 13:06:39.916 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:870 - 用户请求 '二次' 类别下的所有规范。
2025-08-11 13:06:39.922 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 13:06:57.184 | DEBUG    | core.session:logout_user:152 - 用户 'admin' (会话: 953520b1-476f-4eb7-a6a7-8777c2af707b) 已从状态管理器登出。
2025-08-11 13:06:57.184 | DEBUG    | core.session:logout_user:154 - 用户 'admin' 登出时，其WebSocket连接处于活动状态，将尝试关闭。
2025-08-11 13:06:57.201 | INFO     | api.route:logout:87 - HTTP会话已清除 (用户: admin)。
2025-08-11 13:06:57.202 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 953520b1-476f-4eb7-a6a7-8777c2af707b 用户 admin 断开连接
2025-08-11 13:06:57.202 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 13:07:12.914 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: 33d1c3f2-5ab4-467a-a2c0-d3e3b10aaacf, IP: 127.0.0.1) 登录/状态更新成功。
2025-08-11 13:07:12.914 | INFO     | api.route:login:76 - 用户 'admin' (IP: 127.0.0.1, Session: 33d1c3f2-5ab4-467a-a2c0-d3e3b10aaacf) 登录成功。
2025-08-11 13:07:12.996 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: 33d1c3f2-5ab4-467a-a2c0-d3e3b10aaacf) 的 WebSocket 已连接并关联。
2025-08-11 13:07:13.105 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-11 13:07:25.994 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 13:07:25.994 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 33d1c3f2-5ab4-467a-a2c0-d3e3b10aaacf, 对话ID: 7c9b2b78-009b-4534-b0f9-ac1cc889fc24, 查询: 打开电气的规范
2025-08-11 13:07:25.994 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 13:07:33.734 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_Q4lQxyQTTb-xTcnUJaU05Q', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "/ALL", "category": "电气", "read_file": false, "top_n": 10}'}}]
2025-08-11 13:07:33.734 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "/ALL", "category": "电气", "read_file": false, "top_n": 10}
2025-08-11 13:07:33.776 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '/ALL', 类别: '电气', 读取文件: False, Top N: 10
2025-08-11 13:07:33.776 | DEBUG    | database.document_service:_db_query:559 - 查询规范文件分类 (适配器): 电气
2025-08-11 13:07:33.777 | INFO     | database.document_service:_db_query:580 - 查询到 '电气' 分类的规范共 2 条:{'DLT-866-2015 电流互感器和电压互感器选择及计算规程_md': '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md', '33-GB-50217-2018-电力工程电缆设计标准_md': '电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md'}
2025-08-11 13:07:33.777 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:870 - 用户请求 '电气' 类别下的所有规范。
2025-08-11 13:07:33.782 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 13:07:41.010 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 13:07:41.010 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 33d1c3f2-5ab4-467a-a2c0-d3e3b10aaacf, 对话ID: 7c9b2b78-009b-4534-b0f9-ac1cc889fc24, 查询: 打开1
2025-08-11 13:07:41.010 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 13:07:45.100 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_f85d42388ab1406c9059f544', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "DLT-866-2015 电流互感器和电压互感器选择及计算规程", "category": "电气", "read_file": true, "top_n": 1}'}}]
2025-08-11 13:07:45.100 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "DLT-866-2015 电流互感器和电压互感器选择及计算规程", "category": "电气", "read_file": true, "top_n": 1}
2025-08-11 13:07:45.150 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: 'DLT-866-2015 电流互感器和电压互感器选择及计算规程', 类别: '电气', 读取文件: True, Top N: 1
2025-08-11 13:07:45.150 | DEBUG    | database.document_service:_db_query:559 - 查询规范文件分类 (适配器): 电气
2025-08-11 13:07:45.151 | INFO     | database.document_service:_db_query:580 - 查询到 '电气' 分类的规范共 2 条:{'DLT-866-2015 电流互感器和电压互感器选择及计算规程_md': '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md', '33-GB-50217-2018-电力工程电缆设计标准_md': '电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md'}
2025-08-11 13:07:45.152 | DEBUG    | my_mcp_tools.mcp_tools:_get_embeddings:171 - 正在调用嵌入模型: base_url='http://127.0.0.1:8001/v1', model='/home/zhouxiang/models/BAAI_bge-m3'
2025-08-11 13:07:45.242 | DEBUG    | my_mcp_tools.mcp_tools:_find_similar_items_with_scores:201 - 向量检索 Top-1 结果: [('DLT-866-2015 电流互感器和电压互感器选择及计算规程_md', 0.983848741099412)]
2025-08-11 13:07:45.242 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:895 - 最匹配文件 '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' 相似度(0.9838) > 0.7，准备读取内容。
2025-08-11 13:07:45.242 | DEBUG    | my_mcp_tools.mcp_tools:_get_spec_file_content:96 - MCP Tool: 尝试读取规程文件: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md
2025-08-11 13:07:45.244 | DEBUG    | my_mcp_tools.mcp_tools:_get_spec_file_content:100 - MCP Tool: 读取完成，文件: DLT-866-2015 电流互感器和电压互感器选择及计算规程.md, 内容长度: 262961
2025-08-11 13:07:45.244 | WARNING  | my_mcp_tools.mcp_tools:open_specification_files:914 - 文件 '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' 内容过长，可能超过模型上下文窗口。
2025-08-11 13:07:45.244 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' (token: 429dbfbb1cf24a5682b49098f13b4071), 有效期至: Mon Aug 11 21:07:45 2025
2025-08-11 13:07:45.254 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 13:07:47.590 | DEBUG    | api.route:download_file_via_token:193 - Token '429dbfbb1cf24a5682b49098f13b4071' 验证成功。准备下载文件: 'DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' (路径: '/media/zhouxiang/FC7C74827C743A0A/规程规范/电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md', URL文件名: 'DLT-866-2015 电流互感器和电压互感器选择及计算规程.md')
2025-08-11 13:55:53.208 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 33d1c3f2-5ab4-467a-a2c0-d3e3b10aaacf 用户 admin 断开连接
2025-08-11 13:55:53.208 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 13:55:53.209 | INFO     | core.session:disconnect_websocket:108 - 用户 'admin' 的 WebSocket 已断开。
2025-08-11 13:55:53.309 | INFO     | __main__:combined_lifespan:130 - COMBINED LIFESPAN END - PID: 1931059 - 服务器关闭中...
2025-08-11 13:55:53.309 | INFO     | database.document_service:shutdown:478 - 正在关闭 DocumentQueryService...
2025-08-11 13:55:53.314 | INFO     | database.document_service:shutdown:483 - Watchdog 监控已停止。
2025-08-11 13:55:53.315 | INFO     | database.document_service:shutdown:491 - 后台更新任务已取消。
2025-08-11 13:55:53.315 | INFO     | database.document_service:shutdown:496 - 数据库连接已关闭。
2025-08-11 13:55:53.315 | INFO     | database.document_service:shutdown:498 - DocumentQueryService 已成功关闭。
2025-08-11 13:55:53.315 | INFO     | __main__:combined_lifespan:134 - 统一文档查询服务已关闭。
2025-08-11 13:55:53.315 | INFO     | __main__:combined_lifespan:139 - APScheduler 调度器已关闭。
2025-08-11 13:55:53.315 | INFO     | __main__:combined_lifespan:140 - Custom application resources cleaned up.
2025-08-11 13:55:56.350 | INFO     | __main__:<module>:35 - Loguru 日志系统已初始化。
2025-08-11 13:55:56.350 | INFO     | __main__:<module>:36 - 项目根目录配置为: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 13:55:56.351 | INFO     | __main__:<module>:37 - 数据库路径配置为: data/document_service.db
2025-08-11 13:55:56.351 | INFO     | __main__:<module>:38 - 表格列读取配置已加载: {'变电站安装工程概算表': (2, 6), '变电站建筑工程概算表': (2, 6), '电缆输电线路安装工程概算表': (2, 6), '电缆输电线路建筑工程概算表': (2, 6)}
2025-08-11 13:55:56.351 | INFO     | __main__:<module>:39 - kkFileView 服务地址配置为: http://127.0.0.1:8012/kkfileview
2025-08-11 13:55:56.351 | INFO     | __main__:<module>:42 - Dify Agent API Key: ********kGHe
2025-08-11 13:55:56.351 | INFO     | __main__:<module>:43 - Session Secret Key: ********56ee
2025-08-11 13:55:56.351 | INFO     | __main__:<module>:44 - 服务器ipv6地址为: http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8888
2025-08-11 13:55:56.352 | INFO     | __main__:<module>:151 - FastAPI 应用已实例化并注册到 app_state。
2025-08-11 13:55:56.352 | INFO     | __main__:<module>:154 - CORS中间件已添加，允许所有来源。
2025-08-11 13:55:56.363 | INFO     | __main__:<module>:189 - MCP 服务器 '项目文件检索服务器' 已挂载到 FastAPI 应用的 '/mcp/' 路径。
2025-08-11 13:55:56.379 | INFO     | __main__:combined_lifespan:64 - COMBINED LIFESPAN START - PID: 1987951 - 服务器启动中...
2025-08-11 13:55:56.429 | INFO     | __main__:combined_lifespan:69 - HTTPX 客户端已创建并注册到 app_state。
2025-08-11 13:55:56.429 | INFO     | utils.utils:check_embedding_service_health:28 - 正在检查嵌入模型服务，目标URL: http://127.0.0.1:8001/v1/models
2025-08-11 13:55:56.437 | INFO     | utils.utils:check_embedding_service_health:37 - 嵌入模型服务可用，模型列表: ['/home/zhouxiang/models/BAAI_bge-m3']
2025-08-11 13:55:56.437 | INFO     | core.session:__init__:79 - SessionStateManager已初始化。整体HTTP不活动超时: 3600秒
2025-08-11 13:55:56.437 | INFO     | __main__:combined_lifespan:77 - SessionStateManager 已实例化并注册到 app_state。
2025-08-11 13:55:56.437 | INFO     | database.document_service:__init__:164 - 有效文档根目录: {'项目文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/Projects1'), '规范文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/规程规范'), '管理文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/管理文件')}
2025-08-11 13:55:56.437 | DEBUG    | database.document_service:_init_db:180 - 初始化数据库
2025-08-11 13:55:56.438 | DEBUG    | database.document_service:_init_db:201 - 数据库初始化完成
2025-08-11 13:55:56.438 | INFO     | database.document_service:__init__:177 - DocumentQueryService 初始化完成
2025-08-11 13:55:56.438 | INFO     | database.document_service:full_scan:333 - 开始全量扫描...
2025-08-11 13:55:56.438 | INFO     | database.document_service:full_scan:336 - 正在扫描 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 13:56:01.761 | INFO     | database.document_service:full_scan:336 - 正在扫描 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 13:56:02.077 | INFO     | database.document_service:full_scan:336 - 正在扫描 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 13:56:02.078 | INFO     | database.document_service:full_scan:341 - 全量扫描完成，共处理文件数: 1581
2025-08-11 13:56:02.078 | DEBUG    | database.document_service:_start_watchdog:344 - 启动文件监控 Watchdog
2025-08-11 13:56:02.078 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 13:56:02.078 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 13:56:02.078 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 13:56:02.096 | INFO     | database.document_service:_start_watchdog:432 - Watchdog 已启动
2025-08-11 13:56:02.096 | INFO     | database.document_service:start:474 - DocumentQueryService 已启动
2025-08-11 13:56:02.096 | INFO     | __main__:combined_lifespan:83 - 统一文档查询服务 (DocumentQueryService) 已启动。
2025-08-11 13:56:02.096 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/Projects1', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 13:56:02.096 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/规程规范', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 13:56:02.096 | INFO     | __main__:combined_lifespan:88 - 项目和规程的文件服务已初始化。
2025-08-11 13:56:02.097 | INFO     | __main__:combined_lifespan:93 - AsyncIOScheduler 已实例化并注册到 app_state。
2025-08-11 13:56:02.098 | INFO     | __main__:combined_lifespan:97 - FastMCP lifespan context entered.
2025-08-11 13:56:02.098 | INFO     | __main__:combined_lifespan:117 - 处理不活动用户会话任务已添加到APScheduler (每 60s)。
2025-08-11 13:56:02.098 | INFO     | __main__:combined_lifespan:120 - 清理用户会话中已打开文件token任务已添加到APScheduler (每 120s)。
2025-08-11 13:56:02.099 | INFO     | __main__:combined_lifespan:123 - APScheduler 调度器已启动。
2025-08-11 13:56:02.099 | INFO     | __main__:combined_lifespan:124 - 所有初始化完成... yield
2025-08-11 13:56:02.099 | DEBUG    | database.document_service:_debounced_update_loop:435 - 启动去抖更新循环
2025-08-11 13:56:05.788 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: 48ac5e6f-1b00-4610-80d0-ff70b4a36a42, IP: 127.0.0.1) 登录/状态更新成功。
2025-08-11 13:56:05.789 | INFO     | api.route:login:76 - 用户 'admin' (IP: 127.0.0.1, Session: 48ac5e6f-1b00-4610-80d0-ff70b4a36a42) 登录成功。
2025-08-11 13:56:05.879 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: 48ac5e6f-1b00-4610-80d0-ff70b4a36a42) 的 WebSocket 已连接并关联。
2025-08-11 13:56:05.993 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-11 13:56:11.039 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '127.0.0.1'.
2025-08-11 13:56:15.740 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '127.0.0.1'.
2025-08-11 13:56:15.740 | INFO     | api.admin:update_admin_config:164 - 从服务商 'zhipu' 的预设中加载了 API Key。
2025-08-11 13:56:15.741 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_API_BASE_URL' 已更新为: https://open.bigmodel.cn/api/paas/v4/
2025-08-11 13:56:15.741 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_MODEL_NAME' 已更新为: GLM-4.5-Flash
2025-08-11 13:56:15.741 | INFO     | api.admin:update_admin_config:180 - 运行时配置 'OPENAI_API_KEY' 已更新为: ******Yj8a
2025-08-11 13:56:15.744 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '127.0.0.1'.
2025-08-11 13:59:00.207 | DEBUG    | core.session:logout_user:152 - 用户 'admin' (会话: 48ac5e6f-1b00-4610-80d0-ff70b4a36a42) 已从状态管理器登出。
2025-08-11 13:59:00.207 | DEBUG    | core.session:logout_user:154 - 用户 'admin' 登出时，其WebSocket连接处于活动状态，将尝试关闭。
2025-08-11 13:59:00.208 | INFO     | api.route:logout:87 - HTTP会话已清除 (用户: admin)。
2025-08-11 13:59:00.208 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 48ac5e6f-1b00-4610-80d0-ff70b4a36a42 用户 admin 断开连接
2025-08-11 13:59:00.208 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 13:59:00.268 | DEBUG    | core.auth:verify_active_session:24 - verify_active_session: HTTP session中缺少用户名或session_id。
2025-08-11 13:59:02.444 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: 3f2e6017-7bc9-4ce9-aa6c-481f47fadf2d, IP: 127.0.0.1) 登录/状态更新成功。
2025-08-11 13:59:02.444 | INFO     | api.route:login:76 - 用户 'admin' (IP: 127.0.0.1, Session: 3f2e6017-7bc9-4ce9-aa6c-481f47fadf2d) 登录成功。
2025-08-11 13:59:02.509 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: 3f2e6017-7bc9-4ce9-aa6c-481f47fadf2d) 的 WebSocket 已连接并关联。
2025-08-11 13:59:02.593 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-11 13:59:20.021 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 13:59:20.021 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 3f2e6017-7bc9-4ce9-aa6c-481f47fadf2d, 对话ID: 7c9b2b78-009b-4534-b0f9-ac1cc889fc24, 查询: 帮我打开14285 即电保护规范
2025-08-11 13:59:20.021 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 13:59:26.831 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_13dece1e08604ad88950906d', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "14285 即电保护规范", "category": "电气", "read_file": true, "top_n": 10}'}}]
2025-08-11 13:59:26.831 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "14285 即电保护规范", "category": "电气", "read_file": true, "top_n": 10}
2025-08-11 13:59:26.880 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '14285 即电保护规范', 类别: '电气', 读取文件: True, Top N: 10
2025-08-11 13:59:26.881 | DEBUG    | database.document_service:_db_query:559 - 查询规范文件分类 (适配器): 电气
2025-08-11 13:59:26.882 | INFO     | database.document_service:_db_query:580 - 查询到 '电气' 分类的规范共 2 条:{'DLT-866-2015 电流互感器和电压互感器选择及计算规程_md': '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md', '33-GB-50217-2018-电力工程电缆设计标准_md': '电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md'}
2025-08-11 13:59:26.882 | DEBUG    | my_mcp_tools.mcp_tools:_get_embeddings:171 - 正在调用嵌入模型: base_url='http://127.0.0.1:8001/v1', model='/home/zhouxiang/models/BAAI_bge-m3'
2025-08-11 13:59:26.968 | DEBUG    | my_mcp_tools.mcp_tools:_find_similar_items_with_scores:201 - 向量检索 Top-10 结果: [('DLT-866-2015 电流互感器和电压互感器选择及计算规程_md', 0.5312496780011763), ('33-GB-50217-2018-电力工程电缆设计标准_md', 0.5193202631231508)]
2025-08-11 13:59:26.968 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:933 - 最匹配文件 '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md' 相似度(0.5312) 不足 0.7，不读取文件内容，返回列表。
2025-08-11 13:59:26.974 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 13:59:39.701 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 13:59:39.701 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 3f2e6017-7bc9-4ce9-aa6c-481f47fadf2d, 对话ID: 7c9b2b78-009b-4534-b0f9-ac1cc889fc24, 查询: 区二次里找
2025-08-11 13:59:39.702 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 13:59:42.824 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_THlxmn2FSyWMAC6nf5BTYg', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "14285 即电保护规范", "category": "二次", "read_file": true, "top_n": 10}'}}]
2025-08-11 13:59:42.824 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "14285 即电保护规范", "category": "二次", "read_file": true, "top_n": 10}
2025-08-11 13:59:42.876 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: '14285 即电保护规范', 类别: '二次', 读取文件: True, Top N: 10
2025-08-11 13:59:42.876 | DEBUG    | database.document_service:_db_query:559 - 查询规范文件分类 (适配器): 二次
2025-08-11 13:59:42.878 | INFO     | database.document_service:_db_query:580 - 查询到 '二次' 分类的规范共 16 条:{'45_DLT-559-2018《220kV～750kV电网继电保护装置运行整定规程》_md': '二次/45_DLT-559-2018《220kV～750kV电网继电保护装置运行整定规程》_md/45_DLT-559-2018《220kV～750kV电网继电保护装置运行整定规程》.md', 'DL∕T 448-2016 电能计量装置技术管理规程': '二次/DL∕T 448-2016 电能计量装置技术管理规程/DL∕T 448-2016 电能计量装置技术管理规程.pdf', 'GB∕T 36572-2018 电力监控系统网络安全防护导则': '二次/GB∕T 36572-2018 电力监控系统网络安全防护导则/GB∕T 36572-2018 电力监控系统网络安全防护导则.pdf', 'GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范': '二次/GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范/GB∕T 37755-2019 智能变电站光纤回路建模及编码技术规范.pdf', 'GB∕T 38435-2019 牵引站供电线路的继电保护配置及整定计算原则': '二次/GB∕T 38435-2019 牵引站供电线路的继电保护配置及整定计算原则/GB∕T 38435-2019 牵引站供电线路的继电保护配置及整定计算原则.pdf', 'GB∕T 38969-2020 电力系统技术导则': '二次/GB∕T 38969-2020 电力系统技术导则/GB∕T 38969-2020 电力系统技术导则.pdf', 'GB∕T_40581-2021 电力系统安全稳定计算规范': '二次/GB∕T_40581-2021 电力系统安全稳定计算规范/GB∕T_40581-2021 电力系统安全稳定计算规范.pdf', 'GB／T-14285—2023《继电保护和安全自动装置技术规程》_md': '二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/GB／T-14285—2023《继电保护和安全自动装置技术规程》.md', 'IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13': '二次/IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13/IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13.pdf', 'NBT 11315-2023 变电站辅助控制系统设计规程': '二次/NBT 11315-2023 变电站辅助控制系统设计规程/NBT 11315-2023 变电站辅助控制系统设计规程.pdf', 'QGDW 10536-2021-变压器油中溶解气体在线监测装置技术规范': '二次/QGDW 10536-2021-变压器油中溶解气体在线监测装置技术规范/QGDW 10536-2021-变压器油中溶解气体在线监测装置技术规范.pdf', 'QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范': '二次/QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范/QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范.pdf', 'QGDW 11486-2022 继电保护和安全自动装置验收规范': '二次/QGDW 11486-2022 继电保护和安全自动装置验收规范/QGDW 11486-2022 继电保护和安全自动装置验收规范.pdf', 'QGDW 12301-2023 变电站硬压板在线监测技术规范': '二次/QGDW 12301-2023 变电站硬压板在线监测技术规范/QGDW 12301-2023 变电站硬压板在线监测技术规范.pdf', 'QGDW10347-2023电能计量装置通用设计': '二次/QGDW10347-2023电能计量装置通用设计/QGDW10347-2023电能计量装置通用设计.pdf', '变电站辅助设备监控系统设计规范': '二次/变电站辅助设备监控系统设计规范/QGDW 10688-2024 变电站辅助监控系统设计规范.pdf'}
2025-08-11 13:59:42.878 | DEBUG    | my_mcp_tools.mcp_tools:_get_embeddings:171 - 正在调用嵌入模型: base_url='http://127.0.0.1:8001/v1', model='/home/zhouxiang/models/BAAI_bge-m3'
2025-08-11 13:59:43.075 | DEBUG    | my_mcp_tools.mcp_tools:_find_similar_items_with_scores:201 - 向量检索 Top-10 结果: [('GB／T-14285—2023《继电保护和安全自动装置技术规程》_md', 0.7021812327238738), ('QGDW 11486-2022 继电保护和安全自动装置验收规范', 0.6440381089575484), ('45_DLT-559-2018《220kV～750kV电网继电保护装置运行整定规程》_md', 0.6258700164868238), ('GB∕T_40581-2021 电力系统安全稳定计算规范', 0.6169514637949601), ('GB∕T 38435-2019 牵引站供电线路的继电保护配置及整定计算原则', 0.6134885781063243), ('IEEE 移相变压器继电保护应用指南 双语对照-2024-12-31-20-34-13', 0.6119184839046613), ('GB∕T 36572-2018 电力监控系统网络安全防护导则', 0.6015908256412654), ('变电站辅助设备监控系统设计规范', 0.5974228397038381), ('QGDW 10766-2024 10kV～110（66）kV 线路保护及辅助装置标准化设计规范', 0.594113099780062), ('NBT 11315-2023 变电站辅助控制系统设计规程', 0.585603773546755)]
2025-08-11 13:59:43.075 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:895 - 最匹配文件 '二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/GB／T-14285—2023《继电保护和安全自动装置技术规程》.md' 相似度(0.7022) > 0.7，准备读取内容。
2025-08-11 13:59:43.075 | DEBUG    | my_mcp_tools.mcp_tools:_get_spec_file_content:96 - MCP Tool: 尝试读取规程文件: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/GB／T-14285—2023《继电保护和安全自动装置技术规程》.md
2025-08-11 13:59:43.076 | DEBUG    | my_mcp_tools.mcp_tools:_get_spec_file_content:100 - MCP Tool: 读取完成，文件: GB／T-14285—2023《继电保护和安全自动装置技术规程》.md, 内容长度: 117664
2025-08-11 13:59:43.076 | WARNING  | my_mcp_tools.mcp_tools:open_specification_files:914 - 文件 '二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/GB／T-14285—2023《继电保护和安全自动装置技术规程》.md' 内容过长，可能超过模型上下文窗口。
2025-08-11 13:59:43.076 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/GB／T-14285—2023《继电保护和安全自动装置技术规程》.md' (token: 1c4b235fb2404832aed02851cfc43ef1), 有效期至: Mon Aug 11 21:59:43 2025
2025-08-11 13:59:43.083 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 13:59:43.232 | DEBUG    | api.route:download_file_via_token:193 - Token '1c4b235fb2404832aed02851cfc43ef1' 验证成功。准备下载文件: 'GB／T-14285—2023《继电保护和安全自动装置技术规程》.md' (路径: '/media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/GB／T-14285—2023《继电保护和安全自动装置技术规程》.md', URL文件名: 'GB／T-14285—2023《继电保护和安全自动装置技术规程》.md')
2025-08-11 13:59:43.765 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_67_179_250_1020_1864_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_67_179_250_1020_1864_0.jpg'
2025-08-11 13:59:43.766 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_67_179_250_1020_1864_0.jpg
2025-08-11 13:59:43.766 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_67_179_250_1020_1864_0.jpg']
2025-08-11 13:59:43.767 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_68_163_248_1019_1887_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_68_163_248_1019_1887_0.jpg'
2025-08-11 13:59:43.769 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_68_163_248_1019_1887_0.jpg
2025-08-11 13:59:43.769 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_69_257_392_1118_414_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_69_257_392_1118_414_0.jpg'
2025-08-11 13:59:43.769 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_68_163_248_1019_1887_0.jpg']
2025-08-11 13:59:43.770 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_69_235_1053_1153_960_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_69_235_1053_1153_960_0.jpg'
2025-08-11 13:59:43.770 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_70_227_383_1163_510_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_70_227_383_1163_510_0.jpg'
2025-08-11 13:59:43.770 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_67_179_250_1020_1864_0.jpg
2025-08-11 13:59:43.771 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_69_257_392_1118_414_0.jpg
2025-08-11 13:59:43.771 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_69_235_1053_1153_960_0.jpg
2025-08-11 13:59:43.771 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_69_257_392_1118_414_0.jpg']
2025-08-11 13:59:43.771 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_69_235_1053_1153_960_0.jpg']
2025-08-11 13:59:43.772 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_70_227_383_1163_510_0.jpg
2025-08-11 13:59:43.772 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_70_227_383_1163_510_0.jpg']
2025-08-11 13:59:43.772 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_70_234_1152_1146_503_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_70_234_1152_1146_503_0.jpg'
2025-08-11 13:59:43.773 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_70_234_1152_1146_503_0.jpg
2025-08-11 13:59:43.773 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_70_234_1152_1146_503_0.jpg']
2025-08-11 13:59:43.774 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_68_163_248_1019_1887_0.jpg
2025-08-11 13:59:43.774 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_69_257_392_1118_414_0.jpg
2025-08-11 13:59:43.775 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_69_235_1053_1153_960_0.jpg
2025-08-11 13:59:43.776 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_70_227_383_1163_510_0.jpg
2025-08-11 13:59:43.776 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_70_234_1152_1146_503_0.jpg
2025-08-11 13:59:43.785 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_71_416_1374_824_646_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_71_416_1374_824_646_0.jpg'
2025-08-11 13:59:43.786 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_71_416_1374_824_646_0.jpg
2025-08-11 13:59:43.786 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_71_416_1374_824_646_0.jpg']
2025-08-11 13:59:43.787 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_73_362_1146_917_618_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_73_362_1146_917_618_0.jpg'
2025-08-11 13:59:43.787 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_74_573_1274_462_123_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_74_573_1274_462_123_0.jpg'
2025-08-11 13:59:43.788 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_73_362_1146_917_618_0.jpg
2025-08-11 13:59:43.788 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_74_573_1274_462_123_0.jpg
2025-08-11 13:59:43.788 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_73_362_1146_917_618_0.jpg']
2025-08-11 13:59:43.788 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_74_573_1274_462_123_0.jpg']
2025-08-11 13:59:43.790 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_71_416_1374_824_646_0.jpg
2025-08-11 13:59:43.791 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_76_248_1224_1104_782_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_76_248_1224_1104_782_0.jpg'
2025-08-11 13:59:43.791 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_78_242_276_1113_842_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_78_242_276_1113_842_0.jpg'
2025-08-11 13:59:43.792 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_76_248_1224_1104_782_0.jpg
2025-08-11 13:59:43.792 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_78_242_276_1113_842_0.jpg
2025-08-11 13:59:43.792 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_76_248_1224_1104_782_0.jpg']
2025-08-11 13:59:43.793 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_80_347_280_898_515_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_80_347_280_898_515_0.jpg'
2025-08-11 13:59:43.793 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_78_242_276_1113_842_0.jpg']
2025-08-11 13:59:43.793 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_73_362_1146_917_618_0.jpg
2025-08-11 13:59:43.794 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_74_573_1274_462_123_0.jpg
2025-08-11 13:59:43.794 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_80_347_280_898_515_0.jpg
2025-08-11 13:59:43.795 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_80_347_280_898_515_0.jpg']
2025-08-11 13:59:43.795 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_76_248_1224_1104_782_0.jpg
2025-08-11 13:59:43.796 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_78_242_276_1113_842_0.jpg
2025-08-11 13:59:43.797 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_80_347_280_898_515_0.jpg
2025-08-11 13:59:43.803 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_86_210_747_1187_915_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_86_210_747_1187_915_0.jpg'
2025-08-11 13:59:43.804 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_86_210_747_1187_915_0.jpg
2025-08-11 13:59:43.804 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_87_238_256_1180_936_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_87_238_256_1180_936_0.jpg'
2025-08-11 13:59:43.804 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_86_210_747_1187_915_0.jpg']
2025-08-11 13:59:43.805 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_87_238_256_1180_936_0.jpg
2025-08-11 13:59:43.806 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_91_256_269_1156_955_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_91_256_269_1156_955_0.jpg'
2025-08-11 13:59:43.806 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_87_238_256_1180_936_0.jpg']
2025-08-11 13:59:43.806 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_92_232_301_1140_940_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_92_232_301_1140_940_0.jpg'
2025-08-11 13:59:43.806 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_91_256_269_1156_955_0.jpg
2025-08-11 13:59:43.807 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_92_232_301_1140_940_0.jpg
2025-08-11 13:59:43.807 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_91_256_269_1156_955_0.jpg']
2025-08-11 13:59:43.808 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_92_232_301_1140_940_0.jpg']
2025-08-11 13:59:43.809 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_92_233_1466_1147_602_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_92_233_1466_1147_602_0.jpg'
2025-08-11 13:59:43.809 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_86_210_747_1187_915_0.jpg
2025-08-11 13:59:43.810 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_92_233_1466_1147_602_0.jpg
2025-08-11 13:59:43.810 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_92_233_1466_1147_602_0.jpg']
2025-08-11 13:59:43.811 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0192c7f5-081b-72f2-a3c6-178676ec608a_93_324_268_737_1834_0.jpg' -> '/spec_images/0192c7f5-081b-72f2-a3c6-178676ec608a_93_324_268_737_1834_0.jpg'
2025-08-11 13:59:43.812 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0192c7f5-081b-72f2-a3c6-178676ec608a_93_324_268_737_1834_0.jpg
2025-08-11 13:59:43.812 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0192c7f5-081b-72f2-a3c6-178676ec608a_93_324_268_737_1834_0.jpg']
2025-08-11 13:59:43.812 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_87_238_256_1180_936_0.jpg
2025-08-11 13:59:43.813 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_91_256_269_1156_955_0.jpg
2025-08-11 13:59:43.813 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_92_233_1466_1147_602_0.jpg
2025-08-11 13:59:43.813 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_92_232_301_1140_940_0.jpg
2025-08-11 13:59:43.814 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/二次/GB／T-14285—2023《继电保护和安全自动装置技术规程》_md/images/0192c7f5-081b-72f2-a3c6-178676ec608a_93_324_268_737_1834_0.jpg
2025-08-11 14:01:15.505 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 14:01:15.506 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 3f2e6017-7bc9-4ce9-aa6c-481f47fadf2d, 对话ID: 7c9b2b78-009b-4534-b0f9-ac1cc889fc24, 查询: 再帮我打开GB-50217
2025-08-11 14:01:15.506 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:01:19.576 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_m4Zt6DfwQd2YkKtHd-Ke6g', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "GB-50217", "category": "电气", "read_file": true, "top_n": 10}'}}]
2025-08-11 14:01:19.577 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "GB-50217", "category": "电气", "read_file": true, "top_n": 10}
2025-08-11 14:01:19.622 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: 'GB-50217', 类别: '电气', 读取文件: True, Top N: 10
2025-08-11 14:01:19.622 | DEBUG    | database.document_service:_db_query:559 - 查询规范文件分类 (适配器): 电气
2025-08-11 14:01:19.624 | INFO     | database.document_service:_db_query:580 - 查询到 '电气' 分类的规范共 2 条:{'DLT-866-2015 电流互感器和电压互感器选择及计算规程_md': '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md', '33-GB-50217-2018-电力工程电缆设计标准_md': '电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md'}
2025-08-11 14:01:19.625 | DEBUG    | my_mcp_tools.mcp_tools:_get_embeddings:171 - 正在调用嵌入模型: base_url='http://127.0.0.1:8001/v1', model='/home/zhouxiang/models/BAAI_bge-m3'
2025-08-11 14:01:19.703 | DEBUG    | my_mcp_tools.mcp_tools:_find_similar_items_with_scores:201 - 向量检索 Top-10 结果: [('33-GB-50217-2018-电力工程电缆设计标准_md', 0.6269872325718288), ('DLT-866-2015 电流互感器和电压互感器选择及计算规程_md', 0.4049916552438909)]
2025-08-11 14:01:19.703 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:933 - 最匹配文件 '电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md' 相似度(0.6270) 不足 0.7，不读取文件内容，返回列表。
2025-08-11 14:01:19.710 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:01:23.569 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_ab6mp4WuSnmqp0oUrVUlvg', 'type': 'function', 'function': {'name': 'open_specification_files', 'arguments': '{"user": "admin", "query_spec_filename": "GB 50217-2018 电力工程电缆设计标准", "category": "电气", "read_file": true, "top_n": 10}'}}]
2025-08-11 14:01:23.570 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: open_specification_files with args: {"user": "admin", "query_spec_filename": "GB 50217-2018 电力工程电缆设计标准", "category": "电气", "read_file": true, "top_n": 10}
2025-08-11 14:01:23.619 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:835 - 工具调用: open_specification_files, 查询: 'GB 50217-2018 电力工程电缆设计标准', 类别: '电气', 读取文件: True, Top N: 10
2025-08-11 14:01:23.619 | DEBUG    | database.document_service:_db_query:559 - 查询规范文件分类 (适配器): 电气
2025-08-11 14:01:23.620 | INFO     | database.document_service:_db_query:580 - 查询到 '电气' 分类的规范共 2 条:{'DLT-866-2015 电流互感器和电压互感器选择及计算规程_md': '电气/DLT-866-2015 电流互感器和电压互感器选择及计算规程_md/DLT-866-2015 电流互感器和电压互感器选择及计算规程.md', '33-GB-50217-2018-电力工程电缆设计标准_md': '电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md'}
2025-08-11 14:01:23.620 | DEBUG    | my_mcp_tools.mcp_tools:_get_embeddings:171 - 正在调用嵌入模型: base_url='http://127.0.0.1:8001/v1', model='/home/zhouxiang/models/BAAI_bge-m3'
2025-08-11 14:01:23.688 | DEBUG    | my_mcp_tools.mcp_tools:_find_similar_items_with_scores:201 - 向量检索 Top-10 结果: [('33-GB-50217-2018-电力工程电缆设计标准_md', 0.9103247939765802), ('DLT-866-2015 电流互感器和电压互感器选择及计算规程_md', 0.5215518531237241)]
2025-08-11 14:01:23.689 | INFO     | my_mcp_tools.mcp_tools:open_specification_files:895 - 最匹配文件 '电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md' 相似度(0.9103) > 0.7，准备读取内容。
2025-08-11 14:01:23.689 | DEBUG    | my_mcp_tools.mcp_tools:_get_spec_file_content:96 - MCP Tool: 尝试读取规程文件: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md
2025-08-11 14:01:23.690 | DEBUG    | my_mcp_tools.mcp_tools:_get_spec_file_content:100 - MCP Tool: 读取完成，文件: 33-GB 50217-2018 电力工程电缆设计标准.md, 内容长度: 184583
2025-08-11 14:01:23.690 | WARNING  | my_mcp_tools.mcp_tools:open_specification_files:914 - 文件 '电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md' 内容过长，可能超过模型上下文窗口。
2025-08-11 14:01:23.691 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md' (token: 1cf750cbf8d148d6afcaf3e918150fef), 有效期至: Mon Aug 11 22:01:23 2025
2025-08-11 14:01:23.701 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:01:23.833 | DEBUG    | api.route:download_file_via_token:193 - Token '1cf750cbf8d148d6afcaf3e918150fef' 验证成功。准备下载文件: '33-GB 50217-2018 电力工程电缆设计标准.md' (路径: '/media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB 50217-2018 电力工程电缆设计标准.md', URL文件名: '33-GB 50217-2018 电力工程电缆设计标准.md')
2025-08-11 14:01:25.444 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_0_1237_154_289_162_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_0_1237_154_289_162_0.jpg'
2025-08-11 14:01:25.445 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_0_1237_154_289_162_0.jpg
2025-08-11 14:01:25.445 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_0_1237_154_289_162_0.jpg']
2025-08-11 14:01:25.446 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_0_1237_154_289_162_0.jpg
2025-08-11 14:01:25.447 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_32_361_435_977_304_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_32_361_435_977_304_0.jpg'
2025-08-11 14:01:25.448 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_32_361_435_977_304_0.jpg
2025-08-11 14:01:25.448 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_32_616_930_468_258_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_32_616_930_468_258_0.jpg'
2025-08-11 14:01:25.448 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_32_361_435_977_304_0.jpg']
2025-08-11 14:01:25.451 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_32_287_1311_1133_384_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_32_287_1311_1133_384_0.jpg'
2025-08-11 14:01:25.451 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_68_304_320_1113_638_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_68_304_320_1113_638_0.jpg'
2025-08-11 14:01:25.451 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_68_287_1114_1128_645_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_68_287_1114_1128_645_0.jpg'
2025-08-11 14:01:25.452 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_32_616_930_468_258_0.jpg
2025-08-11 14:01:25.452 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_32_287_1311_1133_384_0.jpg
2025-08-11 14:01:25.452 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_32_616_930_468_258_0.jpg']
2025-08-11 14:01:25.453 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_68_304_320_1113_638_0.jpg
2025-08-11 14:01:25.453 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_32_287_1311_1133_384_0.jpg']
2025-08-11 14:01:25.453 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_68_287_1114_1128_645_0.jpg
2025-08-11 14:01:25.453 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_68_304_320_1113_638_0.jpg']
2025-08-11 14:01:25.454 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_68_287_1114_1128_645_0.jpg']
2025-08-11 14:01:25.455 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_32_361_435_977_304_0.jpg
2025-08-11 14:01:25.456 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_32_616_930_468_258_0.jpg
2025-08-11 14:01:25.457 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_68_304_320_1113_638_0.jpg
2025-08-11 14:01:25.457 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_68_304_320_1113_638_0.jpg
2025-08-11 14:01:25.457 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_68_287_1114_1128_645_0.jpg
2025-08-11 14:01:25.467 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_69_214_315_1133_645_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_69_214_315_1133_645_0.jpg'
2025-08-11 14:01:25.468 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_69_220_1122_1142_645_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_69_220_1122_1142_645_0.jpg'
2025-08-11 14:01:25.468 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_70_299_324_1134_642_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_70_299_324_1134_642_0.jpg'
2025-08-11 14:01:25.469 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_69_214_315_1133_645_0.jpg
2025-08-11 14:01:25.469 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_69_220_1122_1142_645_0.jpg
2025-08-11 14:01:25.469 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_69_214_315_1133_645_0.jpg']
2025-08-11 14:01:25.470 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_70_299_324_1134_642_0.jpg
2025-08-11 14:01:25.470 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_69_220_1122_1142_645_0.jpg']
2025-08-11 14:01:25.470 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_70_287_1119_1136_651_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_70_287_1119_1136_651_0.jpg'
2025-08-11 14:01:25.471 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_70_299_324_1134_642_0.jpg']
2025-08-11 14:01:25.471 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_71_203_320_1145_655_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_71_203_320_1145_655_0.jpg'
2025-08-11 14:01:25.472 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_70_287_1119_1136_651_0.jpg
2025-08-11 14:01:25.472 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_71_203_320_1145_655_0.jpg
2025-08-11 14:01:25.473 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_70_287_1119_1136_651_0.jpg']
2025-08-11 14:01:25.473 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_71_203_320_1145_655_0.jpg']
2025-08-11 14:01:25.474 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_71_227_1129_1130_645_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_71_227_1129_1130_645_0.jpg'
2025-08-11 14:01:25.474 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_71_227_1129_1130_645_0.jpg
2025-08-11 14:01:25.475 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_71_227_1129_1130_645_0.jpg']
2025-08-11 14:01:25.475 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_69_220_1122_1142_645_0.jpg
2025-08-11 14:01:25.475 | WARNING  | api.route:get_spec_image:214 - 在规范文件库中未找到图片: 0193193b-d97d-7cb4-99d2-4c7216026569_70_287_1119_1136_651_0.jpg
2025-08-11 14:01:25.475 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_69_214_315_1133_645_0.jpg
2025-08-11 14:01:25.476 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_70_299_324_1134_642_0.jpg
2025-08-11 14:01:25.476 | WARNING  | api.route:get_spec_image:214 - 在规范文件库中未找到图片: 0193193b-d97d-7cb4-99d2-4c7216026569_71_227_1129_1130_645_0.jpg
2025-08-11 14:01:25.477 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_71_203_320_1145_655_0.jpg
2025-08-11 14:01:25.485 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_72_306_322_1119_646_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_72_306_322_1119_646_0.jpg'
2025-08-11 14:01:25.485 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_72_306_322_1119_646_0.jpg
2025-08-11 14:01:25.486 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_72_290_1126_1125_656_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_72_290_1126_1125_656_0.jpg'
2025-08-11 14:01:25.486 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_72_306_322_1119_646_0.jpg']
2025-08-11 14:01:25.486 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_72_290_1126_1125_656_0.jpg
2025-08-11 14:01:25.487 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_72_290_1126_1125_656_0.jpg']
2025-08-11 14:01:25.489 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_73_212_221_1133_659_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_73_212_221_1133_659_0.jpg'
2025-08-11 14:01:25.489 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_73_212_221_1133_659_0.jpg
2025-08-11 14:01:25.490 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_73_212_221_1133_659_0.jpg']
2025-08-11 14:01:25.490 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_72_306_322_1119_646_0.jpg
2025-08-11 14:01:25.491 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_73_225_1049_1127_636_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_73_225_1049_1127_636_0.jpg'
2025-08-11 14:01:25.491 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_141_253_704_552_467_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_141_253_704_552_467_0.jpg'
2025-08-11 14:01:25.491 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_141_884_684_459_455_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_141_884_684_459_455_0.jpg'
2025-08-11 14:01:25.491 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_72_290_1126_1125_656_0.jpg
2025-08-11 14:01:25.492 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_73_225_1049_1127_636_0.jpg
2025-08-11 14:01:25.492 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_141_253_704_552_467_0.jpg
2025-08-11 14:01:25.492 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_73_225_1049_1127_636_0.jpg']
2025-08-11 14:01:25.493 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_141_884_684_459_455_0.jpg
2025-08-11 14:01:25.493 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_141_253_704_552_467_0.jpg']
2025-08-11 14:01:25.493 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_141_884_684_459_455_0.jpg']
2025-08-11 14:01:25.493 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_73_212_221_1133_659_0.jpg
2025-08-11 14:01:25.494 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_73_225_1049_1127_636_0.jpg
2025-08-11 14:01:25.496 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_141_253_704_552_467_0.jpg
2025-08-11 14:01:25.496 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_141_884_684_459_455_0.jpg
2025-08-11 14:01:25.504 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_143_500_318_578_556_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_143_500_318_578_556_0.jpg'
2025-08-11 14:01:25.505 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_143_500_318_578_556_0.jpg
2025-08-11 14:01:25.505 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_143_500_318_578_556_0.jpg']
2025-08-11 14:01:25.506 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_146_315_228_1095_400_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_146_315_228_1095_400_0.jpg'
2025-08-11 14:01:25.506 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_150_286_250_1129_814_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_150_286_250_1129_814_0.jpg'
2025-08-11 14:01:25.507 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_152_388_215_897_435_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_152_388_215_897_435_0.jpg'
2025-08-11 14:01:25.507 | DEBUG    | __main__:rewrite_spec_images_middleware:167 - 中间件重写路径: '/static/images/0193193b-d97d-7cb4-99d2-4c7216026569_152_248_725_1164_564_0.jpg' -> '/spec_images/0193193b-d97d-7cb4-99d2-4c7216026569_152_248_725_1164_564_0.jpg'
2025-08-11 14:01:25.507 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_146_315_228_1095_400_0.jpg
2025-08-11 14:01:25.508 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_150_286_250_1129_814_0.jpg
2025-08-11 14:01:25.508 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_146_315_228_1095_400_0.jpg']
2025-08-11 14:01:25.508 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_152_388_215_897_435_0.jpg
2025-08-11 14:01:25.508 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_150_286_250_1129_814_0.jpg']
2025-08-11 14:01:25.509 | DEBUG    | api.route:get_spec_image:205 - 收到图片请求: 0193193b-d97d-7cb4-99d2-4c7216026569_152_248_725_1164_564_0.jpg
2025-08-11 14:01:25.509 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_152_388_215_897_435_0.jpg']
2025-08-11 14:01:25.509 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND file_name = ? with params: ['规范文件', '0193193b-d97d-7cb4-99d2-4c7216026569_152_248_725_1164_564_0.jpg']
2025-08-11 14:01:25.510 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_143_500_318_578_556_0.jpg
2025-08-11 14:01:25.510 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_146_315_228_1095_400_0.jpg
2025-08-11 14:01:25.511 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_152_388_215_897_435_0.jpg
2025-08-11 14:01:25.513 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_152_388_215_897_435_0.jpg
2025-08-11 14:01:25.513 | INFO     | api.route:get_spec_image:238 - 成功找到并返回图片: /media/zhouxiang/FC7C74827C743A0A/规程规范/电气/33-GB-50217-2018-电力工程电缆设计标准_md/33-GB-50217-2018-电力工程电缆设计标准_md/images/0193193b-d97d-7cb4-99d2-4c7216026569_152_248_725_1164_564_0.jpg
2025-08-11 14:05:21.733 | INFO     | sse_proxy.sse2websocket1:run:276 - 收到新对话开始事件，对话ID: 902302e5-000b-4936-85e0-4bdb24025660。清空历史记录。
2025-08-11 14:05:27.514 | DEBUG    | api.route:search_project_files:319 - 在 /api/projects/search 中，用户 'admin' 的WebSocket连接状态: connected=True, websocket_obj_exists=True
2025-08-11 14:05:27.514 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') LIKE ? with params: ['项目文件', '%船闸%']
2025-08-11 14:05:27.515 | DEBUG    | api.route:search_project_files:332 - find_params={'document_type': '项目文件', 'project_name': '%船闸%'}, find_document nums:77
2025-08-11 14:05:27.516 | INFO     | api.route:search_project_files:357 - len(project_list) == 1
2025-08-11 14:05:27.516 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 14:05:27.517 | DEBUG    | api.route:search_project_files:369 - 即将为用户 'admin' 更新工作目录 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 77 个文件。
2025-08-11 14:05:27.517 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 77 个文件。
2025-08-11 14:05:27.518 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-11 14:05:37.978 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 14:05:37.978 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 3f2e6017-7bc9-4ce9-aa6c-481f47fadf2d, 对话ID: 902302e5-000b-4936-85e0-4bdb24025660, 查询: 你能看到船闸的项目文件吗
2025-08-11 14:05:37.978 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:05:42.753 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_pfoiKfvLQFmu8F0xD-850Q', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "船闸"}'}}]
2025-08-11 14:05:42.754 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "船闸"}
2025-08-11 14:05:42.803 | INFO     | my_mcp_tools.mcp_tools:query_project_files:738 - 工具调用 (新版): query_project_files, 项目关键字='船闸', 年份='None'
2025-08-11 14:05:42.804 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-11 14:05:42.816 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:767 - 模糊匹配查询到 1 个项目: ['江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 14:05:42.816 | INFO     | my_mcp_tools.mcp_tools:query_project_files:771 - 模糊匹配到唯一项目: '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'
2025-08-11 14:05:42.817 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 14:05:42.819 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 77 个文件。
2025-08-11 14:05:42.820 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-11 14:05:42.829 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:06:12.474 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 14:06:12.475 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 3f2e6017-7bc9-4ce9-aa6c-481f47fadf2d, 对话ID: 902302e5-000b-4936-85e0-4bdb24025660, 查询: 帮我生成评审意见
2025-08-11 14:06:12.475 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:06:28.724 | ERROR    | sse_proxy.sse2websocket1:_handle_stream:137 - 调用OpenAI API失败: Request timed out.
2025-08-11 14:07:50.366 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 14:07:50.366 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 3f2e6017-7bc9-4ce9-aa6c-481f47fadf2d, 对话ID: 902302e5-000b-4936-85e0-4bdb24025660, 查询: 继续
2025-08-11 14:07:50.366 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:07:58.662 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_f5da071409bd4b699baf8fa4', 'type': 'function', 'function': {'name': 'write_review_doc', 'arguments': '{"user": "admin", "template_type": "主变扩建工程模板", "get_manual": true}'}}]
2025-08-11 14:07:58.662 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: write_review_doc with args: {"user": "admin", "template_type": "主变扩建工程模板", "get_manual": true}
2025-08-11 14:07:58.717 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:08:06.628 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_nLWtVIi-TYKlhvxnSHhrTQ', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf", "file_category": "普通文档"}'}}]
2025-08-11 14:08:06.629 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf", "file_category": "普通文档"}
2025-08-11 14:08:06.682 | INFO     | my_mcp_tools.mcp_tools:read_project_file:647 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', Category: '普通文档'
2025-08-11 14:08:06.682 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf (相对路径: 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf)，分隔符: '	'
2025-08-11 14:08:16.511 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: 382-B230168C-A-01 初步设计说明书.pdf, 内容长度: 57141
2025-08-11 14:08:16.511 | INFO     | my_mcp_tools.mcp_tools:read_project_file:706 - 从文件 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf成功读取（预览100字）:文 件 编 号
382-B230168C-A-01
船闸 千伏变电站 号 号主变扩建
110 2 3
工程
初步设计说明书
智 方 设 计 股 份 有 限 公 司
工 程 设 计 证 书 ： 甲 级 
2025-08-11 14:08:16.511 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf' (token: c90dd83628fd42c5bf3dcaf43d333295), 有效期至: Mon Aug 11 22:08:16 2025
2025-08-11 14:08:16.512 | DEBUG    | my_mcp_tools.mcp_tools:read_project_file:719 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf' 已在会话中注册, token: c90dd83628fd42c5bf3dcaf43d333295
2025-08-11 14:08:16.522 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/c90dd83628fd42c5bf3dcaf43d333295/382-B230168C-A-01 初步设计说明书.pdf
2025-08-11 14:08:16.538 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:08:16.785 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-01 初步设计说明书_56f078c5.pdf' 与Token关联文件名 '382-B230168C-A-01 初步设计说明书.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 14:08:16.785 | DEBUG    | api.route:download_file_via_token:193 - Token 'c90dd83628fd42c5bf3dcaf43d333295' 验证成功。准备下载文件: '382-B230168C-A-01 初步设计说明书.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', URL文件名: '382-B230168C-A-01 初步设计说明书_56f078c5.pdf')
2025-08-11 14:08:16.788 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-01 初步设计说明书_56f078c5.pdf' 与Token关联文件名 '382-B230168C-A-01 初步设计说明书.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 14:08:16.788 | DEBUG    | api.route:download_file_via_token:193 - Token 'c90dd83628fd42c5bf3dcaf43d333295' 验证成功。准备下载文件: '382-B230168C-A-01 初步设计说明书.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', URL文件名: '382-B230168C-A-01 初步设计说明书_56f078c5.pdf')
2025-08-11 14:08:34.992 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_6-gXbC9wTJCBIBVO3uTPOA', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf", "file_category": "普通文档"}'}}]
2025-08-11 14:08:34.992 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf", "file_category": "普通文档"}
2025-08-11 14:08:35.038 | INFO     | my_mcp_tools.mcp_tools:read_project_file:647 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf', Category: '普通文档'
2025-08-11 14:08:35.038 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf (相对路径: 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf)，分隔符: '	'
2025-08-11 14:08:37.121 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: 382-B230168C-A-02 主要设备材料清册.pdf, 内容长度: 14465
2025-08-11 14:08:37.122 | INFO     | my_mcp_tools.mcp_tools:read_project_file:706 - 从文件 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf成功读取（预览100字）:文 件 编 号
382-B230168C-A-02
船闸 110 千伏变电站 2 号 3 号主变扩建工程
初步设计
要设备材料清册
智方设计股份有限公司
工程设计证书：甲级第 A132005184 号
2025-08-11 14:08:37.122 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf' (token: a1d50a0876994b1fa58c73306e645eb2), 有效期至: Mon Aug 11 22:08:37 2025
2025-08-11 14:08:37.123 | DEBUG    | my_mcp_tools.mcp_tools:read_project_file:719 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf' 已在会话中注册, token: a1d50a0876994b1fa58c73306e645eb2
2025-08-11 14:08:37.129 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/a1d50a0876994b1fa58c73306e645eb2/382-B230168C-A-02 主要设备材料清册.pdf
2025-08-11 14:08:37.137 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:08:37.274 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-02 主要设备材料清册_10086cc1.pdf' 与Token关联文件名 '382-B230168C-A-02 主要设备材料清册.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 14:08:37.274 | DEBUG    | api.route:download_file_via_token:193 - Token 'a1d50a0876994b1fa58c73306e645eb2' 验证成功。准备下载文件: '382-B230168C-A-02 主要设备材料清册.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf', URL文件名: '382-B230168C-A-02 主要设备材料清册_10086cc1.pdf')
2025-08-11 14:08:37.277 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-02 主要设备材料清册_10086cc1.pdf' 与Token关联文件名 '382-B230168C-A-02 主要设备材料清册.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 14:08:37.277 | DEBUG    | api.route:download_file_via_token:193 - Token 'a1d50a0876994b1fa58c73306e645eb2' 验证成功。准备下载文件: '382-B230168C-A-02 主要设备材料清册.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf', URL文件名: '382-B230168C-A-02 主要设备材料清册_10086cc1.pdf')
2025-08-11 14:08:56.411 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_RlXRjE5jTj6o7OQ1Qde3kA', 'type': 'function', 'function': {'name': 'write_review_doc', 'arguments': '{"user": "admin", "template_type": "主变扩建工程模板", "project_name": "江苏苏州船闸110千伏变电站2号3号主变扩建工程", "content": "{\\"line_protection_model_config\\": \\"110kV胥口～石湖T接船闸变110千伏线路：胥口侧配置光纤纵联电流差动保护1套，对侧保护利旧。110kV胥口～新峰线T接船闸变110千伏线路：两侧各配置三端光纤纵联电流差动保护1套。110kV胥口～木镇线T接船闸变110千伏线路：两侧各配置三端光纤纵联电流差动保护1套。\\", \\"fault_recorder_config\\": \\"配置故障录波器柜1面，或配置故障录波器系统1套\\", \\"substation_name\\": \\"船闸变\\", \\"energy_terminal_config\\": \\"主变各侧配置0.2s级模拟量（或数字量）单表，10kV各配置0.5s级模拟量单表，本期完善电能量采集终端装置1套\\", \\"switch_config\\": \\"完善间隔层、过程层交换机。\\", \\"protection_config\\": \\"本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能。\\", \\"MV_LV_equipment_config\\": \\"本期10kV线路、分段、接地变、站用变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置。\\", \\"online_monitoring\\": \\"本期主变油色谱在线监测装置，视频监控系统扩容。\\", \\"Miscellaneous\\": \\"本期随水消防改造站用电，本期将二次设备搬迁至新二次设备室\\", \\"hint\\": \\"你在生成以上内容中，有1.不清楚的。2有疑问的。3.需要注意或用户确认的。4.文件前后矛盾的。5.以上未包含但设计文件中具备，需要补充的。全部写在这里。\\"}", "get_manual": false}'}}]
2025-08-11 14:08:56.411 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: write_review_doc with args: {"user": "admin", "template_type": "主变扩建工程模板", "project_name": "江苏苏州船闸110千伏变电站2号3号主变扩建工程", "content": "{\"line_protection_model_config\": \"110kV胥口～石湖T接船闸变110千伏线路：胥口侧配置光纤纵联电流差动保护1套，对侧保护利旧。110kV胥口～新峰线T接船闸变110千伏线路：两侧各配置三端光纤纵联电流差动保护1套。110kV胥口～木镇线T接船闸变110千伏线路：两侧各配置三端光纤纵联电流差动保护1套。\", \"fault_recorder_config\": \"配置故障录波器柜1面，或配置故障录波器系统1套\", \"substation_name\": \"船闸变\", \"energy_terminal_config\": \"主变各侧配置0.2s级模拟量（或数字量）单表，10kV各配置0.5s级模拟量单表，本期完善电能量采集终端装置1套\", \"switch_config\": \"完善间隔层、过程层交换机。\", \"protection_config\": \"本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能。\", \"MV_LV_equipment_config\": \"本期10kV线路、分段、接地变、站用变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置。\", \"online_monitoring\": \"本期主变油色谱在线监测装置，视频监控系统扩容。\", \"Miscellaneous\": \"本期随水消防改造站用电，本期将二次设备搬迁至新二次设备室\", \"hint\": \"你在生成以上内容中，有1.不清楚的。2有疑问的。3.需要注意或用户确认的。4.文件前后矛盾的。5.以上未包含但设计文件中具备，需要补充的。全部写在这里。\"}", "get_manual": false}
2025-08-11 14:08:56.459 | DEBUG    | my_mcp_tools.mcp_tools:write_review_doc:993 - 获取到的content：{"line_protection_model_config": "110kV胥口～石湖T接船闸变110千伏线路：胥口侧配置光纤纵联电流差动保护1套，对侧保护利旧。110kV胥口～新峰线T接船闸变110千伏线路：两侧各配置三端光纤纵联电流差动保护1套。110kV胥口～木镇线T接船闸变110千伏线路：两侧各配置三端光纤纵联电流差动保护1套。", "fault_recorder_config": "配置故障录波器柜1面，或配置故障录波器系统1套", "substation_name": "船闸变", "energy_terminal_config": "主变各侧配置0.2s级模拟量（或数字量）单表，10kV各配置0.5s级模拟量单表，本期完善电能量采集终端装置1套", "switch_config": "完善间隔层、过程层交换机。", "protection_config": "本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能。", "MV_LV_equipment_config": "本期10kV线路、分段、接地变、站用变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置。", "online_monitoring": "本期主变油色谱在线监测装置，视频监控系统扩容。", "Miscellaneous": "本期随水消防改造站用电，本期将二次设备搬迁至新二次设备室", "hint": "你在生成以上内容中，有1.不清楚的。2有疑问的。3.需要注意或用户确认的。4.文件前后矛盾的。5.以上未包含但设计文件中具备，需要补充的。全部写在这里。"}
2025-08-11 14:08:56.515 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' (token: 801472036e784587a0bedc3b2ccf7190), 有效期至: Mon Aug 11 22:08:56 2025
2025-08-11 14:08:56.516 | INFO     | my_mcp_tools.mcp_tools:write_review_doc:1035 - 成功生成评审意见文档: 江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx
2025-08-11 14:08:56.522 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/801472036e784587a0bedc3b2ccf7190/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx
2025-08-11 14:08:56.527 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:08:56.537 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见_e73b6cbe.docx' 与Token关联文件名 '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' 不匹配。将使用Token关联文件名。
2025-08-11 14:08:56.537 | ERROR    | api.route:download_file_via_token:185 - Token '801472036e784587a0bedc3b2ccf7190' 指向的文件路径不存在或不是文件: '/media/zhouxiang/FC7C74827C743A0A/Projects1/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' (关联文件名: （二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx)
2025-08-11 14:09:51.097 | DEBUG    | api.route:search_project_files:319 - 在 /api/projects/search 中，用户 'admin' 的WebSocket连接状态: connected=True, websocket_obj_exists=True
2025-08-11 14:09:51.097 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') LIKE ? with params: ['项目文件', '%船闸%']
2025-08-11 14:09:51.098 | DEBUG    | api.route:search_project_files:332 - find_params={'document_type': '项目文件', 'project_name': '%船闸%'}, find_document nums:77
2025-08-11 14:09:51.099 | INFO     | api.route:search_project_files:357 - len(project_list) == 1
2025-08-11 14:09:51.099 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 14:09:51.100 | DEBUG    | api.route:search_project_files:369 - 即将为用户 'admin' 更新工作目录 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 77 个文件。
2025-08-11 14:09:51.101 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 77 个文件。
2025-08-11 14:09:51.102 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-11 14:10:01.498 | ERROR    | api.route:download_file_via_token:185 - Token '801472036e784587a0bedc3b2ccf7190' 指向的文件路径不存在或不是文件: '/media/zhouxiang/FC7C74827C743A0A/Projects1/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' (关联文件名: （二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx)
2025-08-11 14:26:52.791 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 3f2e6017-7bc9-4ce9-aa6c-481f47fadf2d 用户 admin 断开连接
2025-08-11 14:26:52.791 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 14:26:52.791 | INFO     | core.session:disconnect_websocket:108 - 用户 'admin' 的 WebSocket 已断开。
2025-08-11 14:26:52.892 | INFO     | __main__:combined_lifespan:130 - COMBINED LIFESPAN END - PID: 1987951 - 服务器关闭中...
2025-08-11 14:26:52.892 | INFO     | database.document_service:shutdown:478 - 正在关闭 DocumentQueryService...
2025-08-11 14:26:52.901 | INFO     | database.document_service:shutdown:483 - Watchdog 监控已停止。
2025-08-11 14:26:52.901 | INFO     | database.document_service:shutdown:491 - 后台更新任务已取消。
2025-08-11 14:26:52.901 | INFO     | database.document_service:shutdown:496 - 数据库连接已关闭。
2025-08-11 14:26:52.901 | INFO     | database.document_service:shutdown:498 - DocumentQueryService 已成功关闭。
2025-08-11 14:26:52.901 | INFO     | __main__:combined_lifespan:134 - 统一文档查询服务已关闭。
2025-08-11 14:26:52.901 | INFO     | __main__:combined_lifespan:139 - APScheduler 调度器已关闭。
2025-08-11 14:26:52.901 | INFO     | __main__:combined_lifespan:140 - Custom application resources cleaned up.
2025-08-11 14:27:00.480 | INFO     | __main__:<module>:35 - Loguru 日志系统已初始化。
2025-08-11 14:27:00.480 | INFO     | __main__:<module>:36 - 项目根目录配置为: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 14:27:00.480 | INFO     | __main__:<module>:37 - 数据库路径配置为: data/document_service.db
2025-08-11 14:27:00.480 | INFO     | __main__:<module>:38 - 表格列读取配置已加载: {'变电站安装工程概算表': (2, 6), '变电站建筑工程概算表': (2, 6), '电缆输电线路安装工程概算表': (2, 6), '电缆输电线路建筑工程概算表': (2, 6)}
2025-08-11 14:27:00.480 | INFO     | __main__:<module>:39 - kkFileView 服务地址配置为: http://127.0.0.1:8012/kkfileview
2025-08-11 14:27:00.480 | INFO     | __main__:<module>:42 - Dify Agent API Key: ********kGHe
2025-08-11 14:27:00.480 | INFO     | __main__:<module>:43 - Session Secret Key: ********e8ac
2025-08-11 14:27:00.481 | INFO     | __main__:<module>:44 - 服务器ipv6地址为: http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8888
2025-08-11 14:27:00.482 | INFO     | __main__:<module>:151 - FastAPI 应用已实例化并注册到 app_state。
2025-08-11 14:27:00.482 | INFO     | __main__:<module>:154 - CORS中间件已添加，允许所有来源。
2025-08-11 14:27:00.492 | INFO     | __main__:<module>:189 - MCP 服务器 '项目文件检索服务器' 已挂载到 FastAPI 应用的 '/mcp/' 路径。
2025-08-11 14:27:00.508 | INFO     | __main__:combined_lifespan:64 - COMBINED LIFESPAN START - PID: 2022956 - 服务器启动中...
2025-08-11 14:27:00.541 | INFO     | __main__:combined_lifespan:69 - HTTPX 客户端已创建并注册到 app_state。
2025-08-11 14:27:00.541 | INFO     | utils.utils:check_embedding_service_health:28 - 正在检查嵌入模型服务，目标URL: http://127.0.0.1:8001/v1/models
2025-08-11 14:27:00.548 | INFO     | utils.utils:check_embedding_service_health:37 - 嵌入模型服务可用，模型列表: ['/home/zhouxiang/models/BAAI_bge-m3']
2025-08-11 14:27:00.548 | INFO     | core.session:__init__:79 - SessionStateManager已初始化。整体HTTP不活动超时: 3600秒
2025-08-11 14:27:00.548 | INFO     | __main__:combined_lifespan:77 - SessionStateManager 已实例化并注册到 app_state。
2025-08-11 14:27:00.548 | INFO     | database.document_service:__init__:164 - 有效文档根目录: {'项目文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/Projects1'), '规范文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/规程规范'), '管理文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/管理文件')}
2025-08-11 14:27:00.549 | DEBUG    | database.document_service:_init_db:180 - 初始化数据库
2025-08-11 14:27:00.549 | DEBUG    | database.document_service:_init_db:201 - 数据库初始化完成
2025-08-11 14:27:00.549 | INFO     | database.document_service:__init__:177 - DocumentQueryService 初始化完成
2025-08-11 14:27:00.549 | INFO     | database.document_service:full_scan:333 - 开始全量扫描...
2025-08-11 14:27:00.549 | INFO     | database.document_service:full_scan:336 - 正在扫描 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 14:27:07.432 | INFO     | database.document_service:full_scan:336 - 正在扫描 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 14:27:07.856 | INFO     | database.document_service:full_scan:336 - 正在扫描 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 14:27:07.857 | INFO     | database.document_service:full_scan:341 - 全量扫描完成，共处理文件数: 1581
2025-08-11 14:27:07.857 | DEBUG    | database.document_service:_start_watchdog:344 - 启动文件监控 Watchdog
2025-08-11 14:27:07.857 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 14:27:07.857 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 14:27:07.857 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 14:27:07.879 | INFO     | database.document_service:_start_watchdog:432 - Watchdog 已启动
2025-08-11 14:27:07.879 | INFO     | database.document_service:start:474 - DocumentQueryService 已启动
2025-08-11 14:27:07.879 | INFO     | __main__:combined_lifespan:83 - 统一文档查询服务 (DocumentQueryService) 已启动。
2025-08-11 14:27:07.879 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/Projects1', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 14:27:07.880 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/规程规范', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 14:27:07.880 | INFO     | __main__:combined_lifespan:88 - 项目和规程的文件服务已初始化。
2025-08-11 14:27:07.881 | INFO     | __main__:combined_lifespan:93 - AsyncIOScheduler 已实例化并注册到 app_state。
2025-08-11 14:27:07.881 | INFO     | __main__:combined_lifespan:97 - FastMCP lifespan context entered.
2025-08-11 14:27:07.882 | INFO     | __main__:combined_lifespan:117 - 处理不活动用户会话任务已添加到APScheduler (每 60s)。
2025-08-11 14:27:07.882 | INFO     | __main__:combined_lifespan:120 - 清理用户会话中已打开文件token任务已添加到APScheduler (每 120s)。
2025-08-11 14:27:07.883 | INFO     | __main__:combined_lifespan:123 - APScheduler 调度器已启动。
2025-08-11 14:27:07.883 | INFO     | __main__:combined_lifespan:124 - 所有初始化完成... yield
2025-08-11 14:27:07.883 | DEBUG    | database.document_service:_debounced_update_loop:435 - 启动去抖更新循环
2025-08-11 14:27:11.809 | INFO     | api.route:logout:87 - HTTP会话已清除 (用户: 未知)。
2025-08-11 14:27:12.774 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: b822c273-31dd-43de-9b04-f5d58b813b4c, IP: 127.0.0.1) 登录/状态更新成功。
2025-08-11 14:27:12.774 | INFO     | api.route:login:76 - 用户 'admin' (IP: 127.0.0.1, Session: b822c273-31dd-43de-9b04-f5d58b813b4c) 登录成功。
2025-08-11 14:27:12.834 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: b822c273-31dd-43de-9b04-f5d58b813b4c) 的 WebSocket 已连接并关联。
2025-08-11 14:27:12.919 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-11 14:27:28.765 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 14:27:28.765 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 b822c273-31dd-43de-9b04-f5d58b813b4c, 对话ID: 7c9b2b78-009b-4534-b0f9-ac1cc889fc24, 查询: 帮我生成船闸项目的评审意见
2025-08-11 14:27:28.765 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:27:34.837 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_zGqsGtXxT22H85uRYi1v9g', 'type': 'function', 'function': {'name': 'write_review_doc', 'arguments': '{"user": "admin", "get_manual": true, "template_type": "主变扩建工程模板"}'}}]
2025-08-11 14:27:34.838 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: write_review_doc with args: {"user": "admin", "get_manual": true, "template_type": "主变扩建工程模板"}
2025-08-11 14:27:34.894 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:27:58.069 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 14:27:58.069 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 b822c273-31dd-43de-9b04-f5d58b813b4c, 对话ID: 7c9b2b78-009b-4534-b0f9-ac1cc889fc24, 查询: 检索项目文件后生成
2025-08-11 14:27:58.069 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:28:02.216 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_ZfNB3keHRwSxziVtzHlxLw', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "船闸"}'}}]
2025-08-11 14:28:02.216 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "船闸"}
2025-08-11 14:28:02.263 | INFO     | my_mcp_tools.mcp_tools:query_project_files:738 - 工具调用 (新版): query_project_files, 项目关键字='船闸', 年份='None'
2025-08-11 14:28:02.264 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-11 14:28:02.276 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:767 - 模糊匹配查询到 1 个项目: ['江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 14:28:02.276 | INFO     | my_mcp_tools.mcp_tools:query_project_files:771 - 模糊匹配到唯一项目: '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'
2025-08-11 14:28:02.277 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 14:28:02.278 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 77 个文件。
2025-08-11 14:28:02.279 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-11 14:28:02.287 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:28:13.170 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_kX1ddI2vSNSBPc2QQ5de-Q', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf", "file_category": "普通文档"}'}}]
2025-08-11 14:28:13.170 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf", "file_category": "普通文档"}
2025-08-11 14:28:13.223 | INFO     | my_mcp_tools.mcp_tools:read_project_file:647 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', Category: '普通文档'
2025-08-11 14:28:13.223 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf (相对路径: 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf)，分隔符: '	'
2025-08-11 14:28:22.963 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: 382-B230168C-A-01 初步设计说明书.pdf, 内容长度: 57141
2025-08-11 14:28:22.963 | INFO     | my_mcp_tools.mcp_tools:read_project_file:706 - 从文件 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf成功读取（预览100字）:文 件 编 号
382-B230168C-A-01
船闸 千伏变电站 号 号主变扩建
110 2 3
工程
初步设计说明书
智 方 设 计 股 份 有 限 公 司
工 程 设 计 证 书 ： 甲 级 
2025-08-11 14:28:22.964 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf' (token: 39427117c30e469f8f5bfe54d8e225f7), 有效期至: Mon Aug 11 22:28:22 2025
2025-08-11 14:28:22.964 | DEBUG    | my_mcp_tools.mcp_tools:read_project_file:719 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf' 已在会话中注册, token: 39427117c30e469f8f5bfe54d8e225f7
2025-08-11 14:28:22.974 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/39427117c30e469f8f5bfe54d8e225f7/382-B230168C-A-01 初步设计说明书.pdf
2025-08-11 14:28:22.986 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:28:23.242 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-01 初步设计说明书_19f5dd18.pdf' 与Token关联文件名 '382-B230168C-A-01 初步设计说明书.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 14:28:23.242 | DEBUG    | api.route:download_file_via_token:193 - Token '39427117c30e469f8f5bfe54d8e225f7' 验证成功。准备下载文件: '382-B230168C-A-01 初步设计说明书.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', URL文件名: '382-B230168C-A-01 初步设计说明书_19f5dd18.pdf')
2025-08-11 14:28:23.292 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-01 初步设计说明书_19f5dd18.pdf' 与Token关联文件名 '382-B230168C-A-01 初步设计说明书.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 14:28:23.292 | DEBUG    | api.route:download_file_via_token:193 - Token '39427117c30e469f8f5bfe54d8e225f7' 验证成功。准备下载文件: '382-B230168C-A-01 初步设计说明书.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', URL文件名: '382-B230168C-A-01 初步设计说明书_19f5dd18.pdf')
2025-08-11 14:28:36.442 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_e-biw53PRyOvJMGg8wD_2g', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf", "file_category": "普通文档"}'}}]
2025-08-11 14:28:36.442 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf", "file_category": "普通文档"}
2025-08-11 14:28:36.494 | INFO     | my_mcp_tools.mcp_tools:read_project_file:647 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf', Category: '普通文档'
2025-08-11 14:28:36.494 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf (相对路径: 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf)，分隔符: '	'
2025-08-11 14:28:38.522 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: 382-B230168C-A-02 主要设备材料清册.pdf, 内容长度: 14465
2025-08-11 14:28:38.522 | INFO     | my_mcp_tools.mcp_tools:read_project_file:706 - 从文件 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf成功读取（预览100字）:文 件 编 号
382-B230168C-A-02
船闸 110 千伏变电站 2 号 3 号主变扩建工程
初步设计
要设备材料清册
智方设计股份有限公司
工程设计证书：甲级第 A132005184 号
2025-08-11 14:28:38.523 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf' (token: e0de30850e054a4cb08c09f16fb6776a), 有效期至: Mon Aug 11 22:28:38 2025
2025-08-11 14:28:38.523 | DEBUG    | my_mcp_tools.mcp_tools:read_project_file:719 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf' 已在会话中注册, token: e0de30850e054a4cb08c09f16fb6776a
2025-08-11 14:28:38.528 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/e0de30850e054a4cb08c09f16fb6776a/382-B230168C-A-02 主要设备材料清册.pdf
2025-08-11 14:28:38.536 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:28:38.673 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-02 主要设备材料清册_27d63baa.pdf' 与Token关联文件名 '382-B230168C-A-02 主要设备材料清册.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 14:28:38.673 | DEBUG    | api.route:download_file_via_token:193 - Token 'e0de30850e054a4cb08c09f16fb6776a' 验证成功。准备下载文件: '382-B230168C-A-02 主要设备材料清册.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf', URL文件名: '382-B230168C-A-02 主要设备材料清册_27d63baa.pdf')
2025-08-11 14:28:38.676 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-02 主要设备材料清册_27d63baa.pdf' 与Token关联文件名 '382-B230168C-A-02 主要设备材料清册.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 14:28:38.676 | DEBUG    | api.route:download_file_via_token:193 - Token 'e0de30850e054a4cb08c09f16fb6776a' 验证成功。准备下载文件: '382-B230168C-A-02 主要设备材料清册.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf', URL文件名: '382-B230168C-A-02 主要设备材料清册_27d63baa.pdf')
2025-08-11 14:29:35.187 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_f55f2cc199994b3794695b79', 'type': 'function', 'function': {'name': 'write_review_doc', 'arguments': '{"user": "admin", "project_name": "江苏苏州船闸110千伏变电站2号3号主变扩建工程", "template_type": "主变扩建工程模板", "content": "{\\n    \\"line_protection_model_config\\": \\"110kV胥口～石湖T接船闸变电站110千伏线路：胥口侧配置光纤纵联电流差动保护1套，对侧保护利旧。\\",\\n    \\"fault_recorder_config\\": \\"配置故障录波器柜1面\\",\\n    \\"substation_name\\": \\"船闸变\\",\\n    \\"energy_terminal_config\\": \\"主变各侧配置0.2s级模拟量单表，10kV各配置0.5s级模拟量单表，本期完善电能量采集终端装置1套\\",\\n    \\"switch_config\\": \\"完善间隔层、过程层交换机\\",\\n    \\"protection_config\\": \\"本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能\\",\\n    \\"MV_LV_equipment_config\\": \\"本期10kV线路、分段、接地变、站用变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置\\",\\n    \\"online_monitoring\\": \\"本期主变油色谱在线监测装置，视频监控系统扩容\\",\\n    \\"Miscellaneous\\": \\"本期随水消防改造站用电，本期将二次设备搬迁至新二次设备室\\",\\n    \\"hint\\": \\"1.不清楚的。2有疑问的。3.需要注意或用户确认的。4.文件前后矛盾的。5.以上未包含但设计文件中具备，需要补充的。全部写在这里。\\"\\n}", "get_manual": false}'}}]
2025-08-11 14:29:35.187 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: write_review_doc with args: {"user": "admin", "project_name": "江苏苏州船闸110千伏变电站2号3号主变扩建工程", "template_type": "主变扩建工程模板", "content": "{\n    \"line_protection_model_config\": \"110kV胥口～石湖T接船闸变电站110千伏线路：胥口侧配置光纤纵联电流差动保护1套，对侧保护利旧。\",\n    \"fault_recorder_config\": \"配置故障录波器柜1面\",\n    \"substation_name\": \"船闸变\",\n    \"energy_terminal_config\": \"主变各侧配置0.2s级模拟量单表，10kV各配置0.5s级模拟量单表，本期完善电能量采集终端装置1套\",\n    \"switch_config\": \"完善间隔层、过程层交换机\",\n    \"protection_config\": \"本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能\",\n    \"MV_LV_equipment_config\": \"本期10kV线路、分段、接地变、站用变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置\",\n    \"online_monitoring\": \"本期主变油色谱在线监测装置，视频监控系统扩容\",\n    \"Miscellaneous\": \"本期随水消防改造站用电，本期将二次设备搬迁至新二次设备室\",\n    \"hint\": \"1.不清楚的。2有疑问的。3.需要注意或用户确认的。4.文件前后矛盾的。5.以上未包含但设计文件中具备，需要补充的。全部写在这里。\"\n}", "get_manual": false}
2025-08-11 14:29:35.235 | DEBUG    | my_mcp_tools.mcp_tools:write_review_doc:993 - 获取到的content：{
    "line_protection_model_config": "110kV胥口～石湖T接船闸变电站110千伏线路：胥口侧配置光纤纵联电流差动保护1套，对侧保护利旧。",
    "fault_recorder_config": "配置故障录波器柜1面",
    "substation_name": "船闸变",
    "energy_terminal_config": "主变各侧配置0.2s级模拟量单表，10kV各配置0.5s级模拟量单表，本期完善电能量采集终端装置1套",
    "switch_config": "完善间隔层、过程层交换机",
    "protection_config": "本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能",
    "MV_LV_equipment_config": "本期10kV线路、分段、接地变、站用变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置",
    "online_monitoring": "本期主变油色谱在线监测装置，视频监控系统扩容",
    "Miscellaneous": "本期随水消防改造站用电，本期将二次设备搬迁至新二次设备室",
    "hint": "1.不清楚的。2有疑问的。3.需要注意或用户确认的。4.文件前后矛盾的。5.以上未包含但设计文件中具备，需要补充的。全部写在这里。"
}
2025-08-11 14:29:35.235 | DEBUG    | my_mcp_tools.mcp_tools:write_review_doc:1005 - 评审意见输出目标江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计
2025-08-11 14:29:35.286 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' (token: b13e69fb5cfe4dfbb47597b5f3cecd66), 有效期至: Mon Aug 11 22:29:35 2025
2025-08-11 14:29:35.286 | INFO     | my_mcp_tools.mcp_tools:write_review_doc:1036 - 成功生成评审意见文档: 江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx
2025-08-11 14:29:35.293 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/b13e69fb5cfe4dfbb47597b5f3cecd66/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx
2025-08-11 14:29:35.305 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:29:35.314 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见_519ae0ea.docx' 与Token关联文件名 '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' 不匹配。将使用Token关联文件名。
2025-08-11 14:29:35.314 | ERROR    | api.route:download_file_via_token:185 - Token 'b13e69fb5cfe4dfbb47597b5f3cecd66' 指向的文件路径不存在或不是文件: '/media/zhouxiang/FC7C74827C743A0A/Projects1/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' (关联文件名: （二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx)
2025-08-11 14:36:23.693 | DEBUG    | api.route:search_project_files:319 - 在 /api/projects/search 中，用户 'admin' 的WebSocket连接状态: connected=True, websocket_obj_exists=True
2025-08-11 14:36:23.693 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') LIKE ? with params: ['项目文件', '%丹华%']
2025-08-11 14:36:23.695 | DEBUG    | api.route:search_project_files:332 - find_params={'document_type': '项目文件', 'project_name': '%丹华%'}, find_document nums:153
2025-08-11 14:36:23.696 | INFO     | api.route:search_project_files:357 - len(project_list) == 1
2025-08-11 14:36:23.696 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '丹华初设']
2025-08-11 14:36:23.700 | DEBUG    | api.route:search_project_files:369 - 即将为用户 'admin' 更新工作目录 '2025/丹华初设'，包含 153 个文件。
2025-08-11 14:36:23.701 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2025/丹华初设'，包含 153 个文件。
2025-08-11 14:36:23.703 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-11 14:36:29.907 | DEBUG    | api.route:search_project_files:319 - 在 /api/projects/search 中，用户 'admin' 的WebSocket连接状态: connected=True, websocket_obj_exists=True
2025-08-11 14:36:29.908 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') LIKE ? with params: ['项目文件', '%船闸%']
2025-08-11 14:36:29.910 | DEBUG    | api.route:search_project_files:332 - find_params={'document_type': '项目文件', 'project_name': '%船闸%'}, find_document nums:77
2025-08-11 14:36:29.910 | INFO     | api.route:search_project_files:357 - len(project_list) == 1
2025-08-11 14:36:29.910 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 14:36:29.912 | DEBUG    | api.route:search_project_files:369 - 即将为用户 'admin' 更新工作目录 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 77 个文件。
2025-08-11 14:36:29.913 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 77 个文件。
2025-08-11 14:36:29.914 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-11 14:43:46.340 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 b822c273-31dd-43de-9b04-f5d58b813b4c 用户 admin 断开连接
2025-08-11 14:43:46.340 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 14:43:46.340 | INFO     | core.session:disconnect_websocket:108 - 用户 'admin' 的 WebSocket 已断开。
2025-08-11 14:43:46.442 | INFO     | __main__:combined_lifespan:130 - COMBINED LIFESPAN END - PID: 2022956 - 服务器关闭中...
2025-08-11 14:43:46.442 | INFO     | database.document_service:shutdown:478 - 正在关闭 DocumentQueryService...
2025-08-11 14:43:46.451 | INFO     | database.document_service:shutdown:483 - Watchdog 监控已停止。
2025-08-11 14:43:46.451 | INFO     | database.document_service:shutdown:491 - 后台更新任务已取消。
2025-08-11 14:43:46.451 | INFO     | database.document_service:shutdown:496 - 数据库连接已关闭。
2025-08-11 14:43:46.451 | INFO     | database.document_service:shutdown:498 - DocumentQueryService 已成功关闭。
2025-08-11 14:43:46.452 | INFO     | __main__:combined_lifespan:134 - 统一文档查询服务已关闭。
2025-08-11 14:43:46.452 | INFO     | __main__:combined_lifespan:139 - APScheduler 调度器已关闭。
2025-08-11 14:43:46.452 | INFO     | __main__:combined_lifespan:140 - Custom application resources cleaned up.
2025-08-11 14:43:56.116 | INFO     | __main__:<module>:35 - Loguru 日志系统已初始化。
2025-08-11 14:43:56.116 | INFO     | __main__:<module>:36 - 项目根目录配置为: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 14:43:56.117 | INFO     | __main__:<module>:37 - 数据库路径配置为: data/document_service.db
2025-08-11 14:43:56.117 | INFO     | __main__:<module>:38 - 表格列读取配置已加载: {'变电站安装工程概算表': (2, 6), '变电站建筑工程概算表': (2, 6), '电缆输电线路安装工程概算表': (2, 6), '电缆输电线路建筑工程概算表': (2, 6)}
2025-08-11 14:43:56.117 | INFO     | __main__:<module>:39 - kkFileView 服务地址配置为: http://127.0.0.1:8012/kkfileview
2025-08-11 14:43:56.117 | INFO     | __main__:<module>:42 - Dify Agent API Key: ********kGHe
2025-08-11 14:43:56.117 | INFO     | __main__:<module>:43 - Session Secret Key: ********5bab
2025-08-11 14:43:56.117 | INFO     | __main__:<module>:44 - 服务器ipv6地址为: http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8888
2025-08-11 14:43:56.118 | INFO     | __main__:<module>:151 - FastAPI 应用已实例化并注册到 app_state。
2025-08-11 14:43:56.118 | INFO     | __main__:<module>:154 - CORS中间件已添加，允许所有来源。
2025-08-11 14:43:56.131 | INFO     | __main__:<module>:189 - MCP 服务器 '项目文件检索服务器' 已挂载到 FastAPI 应用的 '/mcp/' 路径。
2025-08-11 14:43:56.149 | INFO     | __main__:combined_lifespan:64 - COMBINED LIFESPAN START - PID: 2042530 - 服务器启动中...
2025-08-11 14:43:56.190 | INFO     | __main__:combined_lifespan:69 - HTTPX 客户端已创建并注册到 app_state。
2025-08-11 14:43:56.190 | INFO     | utils.utils:check_embedding_service_health:28 - 正在检查嵌入模型服务，目标URL: http://127.0.0.1:8001/v1/models
2025-08-11 14:43:56.198 | INFO     | utils.utils:check_embedding_service_health:37 - 嵌入模型服务可用，模型列表: ['/home/zhouxiang/models/BAAI_bge-m3']
2025-08-11 14:43:56.198 | INFO     | core.session:__init__:79 - SessionStateManager已初始化。整体HTTP不活动超时: 3600秒
2025-08-11 14:43:56.198 | INFO     | __main__:combined_lifespan:77 - SessionStateManager 已实例化并注册到 app_state。
2025-08-11 14:43:56.198 | INFO     | database.document_service:__init__:164 - 有效文档根目录: {'项目文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/Projects1'), '规范文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/规程规范'), '管理文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/管理文件')}
2025-08-11 14:43:56.199 | DEBUG    | database.document_service:_init_db:180 - 初始化数据库
2025-08-11 14:43:56.199 | DEBUG    | database.document_service:_init_db:201 - 数据库初始化完成
2025-08-11 14:43:56.199 | INFO     | database.document_service:__init__:177 - DocumentQueryService 初始化完成
2025-08-11 14:43:56.199 | INFO     | database.document_service:full_scan:333 - 开始全量扫描...
2025-08-11 14:43:56.199 | INFO     | database.document_service:full_scan:336 - 正在扫描 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 14:44:01.476 | INFO     | database.document_service:full_scan:336 - 正在扫描 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 14:44:01.790 | INFO     | database.document_service:full_scan:336 - 正在扫描 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 14:44:01.791 | INFO     | database.document_service:full_scan:341 - 全量扫描完成，共处理文件数: 1581
2025-08-11 14:44:01.791 | DEBUG    | database.document_service:_start_watchdog:344 - 启动文件监控 Watchdog
2025-08-11 14:44:01.791 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 14:44:01.791 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 14:44:01.791 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 14:44:01.809 | INFO     | database.document_service:_start_watchdog:432 - Watchdog 已启动
2025-08-11 14:44:01.809 | INFO     | database.document_service:start:474 - DocumentQueryService 已启动
2025-08-11 14:44:01.809 | INFO     | __main__:combined_lifespan:83 - 统一文档查询服务 (DocumentQueryService) 已启动。
2025-08-11 14:44:01.809 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/Projects1', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 14:44:01.809 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/规程规范', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 14:44:01.809 | INFO     | __main__:combined_lifespan:88 - 项目和规程的文件服务已初始化。
2025-08-11 14:44:01.811 | INFO     | __main__:combined_lifespan:93 - AsyncIOScheduler 已实例化并注册到 app_state。
2025-08-11 14:44:01.811 | INFO     | __main__:combined_lifespan:97 - FastMCP lifespan context entered.
2025-08-11 14:44:01.811 | INFO     | __main__:combined_lifespan:117 - 处理不活动用户会话任务已添加到APScheduler (每 60s)。
2025-08-11 14:44:01.811 | INFO     | __main__:combined_lifespan:120 - 清理用户会话中已打开文件token任务已添加到APScheduler (每 120s)。
2025-08-11 14:44:01.812 | INFO     | __main__:combined_lifespan:123 - APScheduler 调度器已启动。
2025-08-11 14:44:01.812 | INFO     | __main__:combined_lifespan:124 - 所有初始化完成... yield
2025-08-11 14:44:01.812 | DEBUG    | database.document_service:_debounced_update_loop:435 - 启动去抖更新循环
2025-08-11 14:46:15.504 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: d7972682-088b-4f3f-8414-de89040bcc0f, IP: 127.0.0.1) 登录/状态更新成功。
2025-08-11 14:46:15.504 | INFO     | api.route:login:76 - 用户 'admin' (IP: 127.0.0.1, Session: d7972682-088b-4f3f-8414-de89040bcc0f) 登录成功。
2025-08-11 14:46:15.577 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: d7972682-088b-4f3f-8414-de89040bcc0f) 的 WebSocket 已连接并关联。
2025-08-11 14:46:15.669 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-11 14:48:13.064 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 14:48:13.065 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 d7972682-088b-4f3f-8414-de89040bcc0f, 对话ID: 7c9b2b78-009b-4534-b0f9-ac1cc889fc24, 查询: 帮我打开船闸的项目
2025-08-11 14:48:13.065 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 14:48:17.931 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_vCZ5QNrzS7qkgngIFgxIuA', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "船闸"}'}}]
2025-08-11 14:48:17.931 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "船闸"}
2025-08-11 14:48:17.979 | INFO     | my_mcp_tools.mcp_tools:query_project_files:745 - 工具调用 (新版): query_project_files, 项目关键字='船闸', 年份='None'
2025-08-11 14:48:17.980 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-11 14:48:17.992 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:774 - 模糊匹配查询到 1 个项目: ['2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 14:48:17.992 | INFO     | my_mcp_tools.mcp_tools:query_project_files:778 - 模糊匹配到唯一项目: '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'
2025-08-11 14:48:17.992 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 14:48:17.993 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 0 个文件。
2025-08-11 14:48:17.993 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-11 14:48:18.001 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:37:30.746 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 d7972682-088b-4f3f-8414-de89040bcc0f 用户 admin 断开连接
2025-08-11 15:37:30.747 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 15:37:30.747 | INFO     | core.session:disconnect_websocket:108 - 用户 'admin' 的 WebSocket 已断开。
2025-08-11 15:37:30.848 | INFO     | __main__:combined_lifespan:130 - COMBINED LIFESPAN END - PID: 2042530 - 服务器关闭中...
2025-08-11 15:37:30.848 | INFO     | database.document_service:shutdown:478 - 正在关闭 DocumentQueryService...
2025-08-11 15:37:30.858 | INFO     | database.document_service:shutdown:483 - Watchdog 监控已停止。
2025-08-11 15:37:30.858 | INFO     | database.document_service:shutdown:491 - 后台更新任务已取消。
2025-08-11 15:37:30.858 | INFO     | database.document_service:shutdown:496 - 数据库连接已关闭。
2025-08-11 15:37:30.858 | INFO     | database.document_service:shutdown:498 - DocumentQueryService 已成功关闭。
2025-08-11 15:37:30.858 | INFO     | __main__:combined_lifespan:134 - 统一文档查询服务已关闭。
2025-08-11 15:37:30.858 | INFO     | __main__:combined_lifespan:139 - APScheduler 调度器已关闭。
2025-08-11 15:37:30.859 | INFO     | __main__:combined_lifespan:140 - Custom application resources cleaned up.
2025-08-11 15:37:33.833 | INFO     | __main__:<module>:35 - Loguru 日志系统已初始化。
2025-08-11 15:37:33.833 | INFO     | __main__:<module>:36 - 项目根目录配置为: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 15:37:33.834 | INFO     | __main__:<module>:37 - 数据库路径配置为: data/document_service.db
2025-08-11 15:37:33.834 | INFO     | __main__:<module>:38 - 表格列读取配置已加载: {'变电站安装工程概算表': (2, 6), '变电站建筑工程概算表': (2, 6), '电缆输电线路安装工程概算表': (2, 6), '电缆输电线路建筑工程概算表': (2, 6)}
2025-08-11 15:37:33.834 | INFO     | __main__:<module>:39 - kkFileView 服务地址配置为: http://127.0.0.1:8012/kkfileview
2025-08-11 15:37:33.834 | INFO     | __main__:<module>:42 - Dify Agent API Key: ********kGHe
2025-08-11 15:37:33.834 | INFO     | __main__:<module>:43 - Session Secret Key: ********a813
2025-08-11 15:37:33.834 | INFO     | __main__:<module>:44 - 服务器ipv6地址为: http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8888
2025-08-11 15:37:33.835 | INFO     | __main__:<module>:151 - FastAPI 应用已实例化并注册到 app_state。
2025-08-11 15:37:33.835 | INFO     | __main__:<module>:154 - CORS中间件已添加，允许所有来源。
2025-08-11 15:37:33.852 | INFO     | __main__:<module>:189 - MCP 服务器 '项目文件检索服务器' 已挂载到 FastAPI 应用的 '/mcp/' 路径。
2025-08-11 15:37:33.868 | INFO     | __main__:combined_lifespan:64 - COMBINED LIFESPAN START - PID: 2102534 - 服务器启动中...
2025-08-11 15:37:33.904 | INFO     | __main__:combined_lifespan:69 - HTTPX 客户端已创建并注册到 app_state。
2025-08-11 15:37:33.904 | INFO     | utils.utils:check_embedding_service_health:28 - 正在检查嵌入模型服务，目标URL: http://127.0.0.1:8001/v1/models
2025-08-11 15:37:33.910 | INFO     | utils.utils:check_embedding_service_health:37 - 嵌入模型服务可用，模型列表: ['/home/zhouxiang/models/BAAI_bge-m3']
2025-08-11 15:37:33.910 | INFO     | core.session:__init__:79 - SessionStateManager已初始化。整体HTTP不活动超时: 3600秒
2025-08-11 15:37:33.911 | INFO     | __main__:combined_lifespan:77 - SessionStateManager 已实例化并注册到 app_state。
2025-08-11 15:37:33.911 | INFO     | database.document_service:__init__:164 - 有效文档根目录: {'项目文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/Projects1'), '规范文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/规程规范'), '管理文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/管理文件')}
2025-08-11 15:37:33.911 | DEBUG    | database.document_service:_init_db:180 - 初始化数据库
2025-08-11 15:37:33.911 | DEBUG    | database.document_service:_init_db:201 - 数据库初始化完成
2025-08-11 15:37:33.911 | INFO     | database.document_service:__init__:177 - DocumentQueryService 初始化完成
2025-08-11 15:37:33.911 | INFO     | database.document_service:full_scan:333 - 开始全量扫描...
2025-08-11 15:37:33.911 | INFO     | database.document_service:full_scan:336 - 正在扫描 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 15:37:39.182 | INFO     | database.document_service:full_scan:336 - 正在扫描 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 15:37:39.503 | INFO     | database.document_service:full_scan:336 - 正在扫描 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 15:37:39.504 | INFO     | database.document_service:full_scan:341 - 全量扫描完成，共处理文件数: 1581
2025-08-11 15:37:39.504 | DEBUG    | database.document_service:_start_watchdog:344 - 启动文件监控 Watchdog
2025-08-11 15:37:39.504 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 15:37:39.504 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 15:37:39.504 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 15:37:39.528 | INFO     | database.document_service:_start_watchdog:432 - Watchdog 已启动
2025-08-11 15:37:39.528 | INFO     | database.document_service:start:474 - DocumentQueryService 已启动
2025-08-11 15:37:39.528 | INFO     | __main__:combined_lifespan:83 - 统一文档查询服务 (DocumentQueryService) 已启动。
2025-08-11 15:37:39.529 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/Projects1', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 15:37:39.529 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/规程规范', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 15:37:39.529 | INFO     | __main__:combined_lifespan:88 - 项目和规程的文件服务已初始化。
2025-08-11 15:37:39.530 | INFO     | __main__:combined_lifespan:93 - AsyncIOScheduler 已实例化并注册到 app_state。
2025-08-11 15:37:39.531 | INFO     | __main__:combined_lifespan:97 - FastMCP lifespan context entered.
2025-08-11 15:37:39.531 | INFO     | __main__:combined_lifespan:117 - 处理不活动用户会话任务已添加到APScheduler (每 60s)。
2025-08-11 15:37:39.531 | INFO     | __main__:combined_lifespan:120 - 清理用户会话中已打开文件token任务已添加到APScheduler (每 120s)。
2025-08-11 15:37:39.532 | INFO     | __main__:combined_lifespan:123 - APScheduler 调度器已启动。
2025-08-11 15:37:39.532 | INFO     | __main__:combined_lifespan:124 - 所有初始化完成... yield
2025-08-11 15:37:39.532 | DEBUG    | database.document_service:_debounced_update_loop:435 - 启动去抖更新循环
2025-08-11 15:38:04.615 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: cfa20915-f068-4847-9876-68dc85470fad, IP: 127.0.0.1) 登录/状态更新成功。
2025-08-11 15:38:04.615 | INFO     | api.route:login:76 - 用户 'admin' (IP: 127.0.0.1, Session: cfa20915-f068-4847-9876-68dc85470fad) 登录成功。
2025-08-11 15:38:04.673 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: cfa20915-f068-4847-9876-68dc85470fad) 的 WebSocket 已连接并关联。
2025-08-11 15:38:04.762 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-11 15:38:15.427 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 15:38:15.427 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 cfa20915-f068-4847-9876-68dc85470fad, 对话ID: 7c9b2b78-009b-4534-b0f9-ac1cc889fc24, 查询: 打开船闸的项目文件
2025-08-11 15:38:15.428 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:38:21.079 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_lAh0nZgoQhKCxGCtYO7HLQ', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "船闸"}'}}]
2025-08-11 15:38:21.079 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "船闸"}
2025-08-11 15:38:21.125 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='船闸', 年份='None'
2025-08-11 15:38:21.126 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-11 15:38:21.138 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:755 - 模糊匹配查询到 1 个项目: ['江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 15:38:21.138 | INFO     | my_mcp_tools.mcp_tools:query_project_files:759 - 模糊匹配到唯一项目: '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'
2025-08-11 15:38:21.139 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 15:38:21.141 | ERROR    | my_mcp_tools.mcp_tools:query_project_files:803 - 处理 query_project_files (新版) 时发生未知错误: '船闸'
2025-08-11 15:38:21.147 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:38:24.361 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_cc87f4711ba647de96fd192d', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "/ALL"}'}}]
2025-08-11 15:38:24.361 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "/ALL"}
2025-08-11 15:38:24.415 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='/ALL', 年份='None'
2025-08-11 15:38:24.416 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-11 15:38:24.427 | INFO     | my_mcp_tools.mcp_tools:query_project_files:735 - 收到全部项目查询请求
2025-08-11 15:38:24.433 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:38:26.732 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_HrExjK63RTiAfZAE3mdNdw', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "江苏苏州船闸110千伏变电站2号3号主变扩建工程"}'}}]
2025-08-11 15:38:26.732 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "江苏苏州船闸110千伏变电站2号3号主变扩建工程"}
2025-08-11 15:38:26.784 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='江苏苏州船闸110千伏变电站2号3号主变扩建工程', 年份='None'
2025-08-11 15:38:26.784 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-11 15:38:26.797 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:755 - 模糊匹配查询到 1 个项目: ['江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 15:38:26.797 | INFO     | my_mcp_tools.mcp_tools:query_project_files:759 - 模糊匹配到唯一项目: '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'
2025-08-11 15:38:26.798 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 15:38:26.799 | ERROR    | my_mcp_tools.mcp_tools:query_project_files:803 - 处理 query_project_files (新版) 时发生未知错误: '江苏苏州船闸110千伏变电站2号3号主变扩建工程'
2025-08-11 15:38:26.805 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:38:28.148 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_4gTJrUOqTQSn6Lh97EkyYw', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "船闸", "year": 2024}'}}]
2025-08-11 15:38:28.148 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "船闸", "year": 2024}
2025-08-11 15:38:28.282 | ERROR    | sse_proxy.sse2websocket1:_execute_tool_calls:203 - 执行工具 'query_project_files' 时发生异常: Error calling tool 'query_project_files': 1 validation error for call[query_project_files]
year
  Input should be a valid string [type=string_type, input_value=2024, input_type=int]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-08-11 15:38:28.283 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:38:29.680 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_QRAwuXktR8CMwDqxLqA3Bg', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project名称": "船闸", "year": "2024"}'}}]
2025-08-11 15:38:29.680 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project名称": "船闸", "year": "2024"}
2025-08-11 15:45:03.300 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 cfa20915-f068-4847-9876-68dc85470fad 用户 admin 断开连接
2025-08-11 15:45:03.300 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 15:45:03.301 | INFO     | core.session:disconnect_websocket:108 - 用户 'admin' 的 WebSocket 已断开。
2025-08-11 15:45:03.401 | INFO     | __main__:combined_lifespan:130 - COMBINED LIFESPAN END - PID: 2102534 - 服务器关闭中...
2025-08-11 15:45:03.401 | INFO     | database.document_service:shutdown:478 - 正在关闭 DocumentQueryService...
2025-08-11 15:45:03.411 | INFO     | database.document_service:shutdown:483 - Watchdog 监控已停止。
2025-08-11 15:45:03.411 | INFO     | database.document_service:shutdown:491 - 后台更新任务已取消。
2025-08-11 15:45:03.412 | INFO     | database.document_service:shutdown:496 - 数据库连接已关闭。
2025-08-11 15:45:03.412 | INFO     | database.document_service:shutdown:498 - DocumentQueryService 已成功关闭。
2025-08-11 15:45:03.412 | INFO     | __main__:combined_lifespan:134 - 统一文档查询服务已关闭。
2025-08-11 15:45:03.412 | INFO     | __main__:combined_lifespan:139 - APScheduler 调度器已关闭。
2025-08-11 15:45:03.412 | INFO     | __main__:combined_lifespan:140 - Custom application resources cleaned up.
2025-08-11 15:45:07.001 | INFO     | __main__:<module>:35 - Loguru 日志系统已初始化。
2025-08-11 15:45:07.001 | INFO     | __main__:<module>:36 - 项目根目录配置为: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 15:45:07.001 | INFO     | __main__:<module>:37 - 数据库路径配置为: data/document_service.db
2025-08-11 15:45:07.002 | INFO     | __main__:<module>:38 - 表格列读取配置已加载: {'变电站安装工程概算表': (2, 6), '变电站建筑工程概算表': (2, 6), '电缆输电线路安装工程概算表': (2, 6), '电缆输电线路建筑工程概算表': (2, 6)}
2025-08-11 15:45:07.002 | INFO     | __main__:<module>:39 - kkFileView 服务地址配置为: http://127.0.0.1:8012/kkfileview
2025-08-11 15:45:07.002 | INFO     | __main__:<module>:42 - Dify Agent API Key: ********kGHe
2025-08-11 15:45:07.002 | INFO     | __main__:<module>:43 - Session Secret Key: ********3271
2025-08-11 15:45:07.002 | INFO     | __main__:<module>:44 - 服务器ipv6地址为: http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8888
2025-08-11 15:45:07.003 | INFO     | __main__:<module>:151 - FastAPI 应用已实例化并注册到 app_state。
2025-08-11 15:45:07.003 | INFO     | __main__:<module>:154 - CORS中间件已添加，允许所有来源。
2025-08-11 15:45:07.014 | INFO     | __main__:<module>:189 - MCP 服务器 '项目文件检索服务器' 已挂载到 FastAPI 应用的 '/mcp/' 路径。
2025-08-11 15:45:07.030 | INFO     | __main__:combined_lifespan:64 - COMBINED LIFESPAN START - PID: 2111105 - 服务器启动中...
2025-08-11 15:45:07.063 | INFO     | __main__:combined_lifespan:69 - HTTPX 客户端已创建并注册到 app_state。
2025-08-11 15:45:07.064 | INFO     | utils.utils:check_embedding_service_health:28 - 正在检查嵌入模型服务，目标URL: http://127.0.0.1:8001/v1/models
2025-08-11 15:45:07.070 | INFO     | utils.utils:check_embedding_service_health:37 - 嵌入模型服务可用，模型列表: ['/home/zhouxiang/models/BAAI_bge-m3']
2025-08-11 15:45:07.071 | INFO     | core.session:__init__:79 - SessionStateManager已初始化。整体HTTP不活动超时: 3600秒
2025-08-11 15:45:07.071 | INFO     | __main__:combined_lifespan:77 - SessionStateManager 已实例化并注册到 app_state。
2025-08-11 15:45:07.071 | INFO     | database.document_service:__init__:164 - 有效文档根目录: {'项目文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/Projects1'), '规范文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/规程规范'), '管理文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/管理文件')}
2025-08-11 15:45:07.071 | DEBUG    | database.document_service:_init_db:180 - 初始化数据库
2025-08-11 15:45:07.071 | DEBUG    | database.document_service:_init_db:201 - 数据库初始化完成
2025-08-11 15:45:07.072 | INFO     | database.document_service:__init__:177 - DocumentQueryService 初始化完成
2025-08-11 15:45:07.072 | INFO     | database.document_service:full_scan:333 - 开始全量扫描...
2025-08-11 15:45:07.072 | INFO     | database.document_service:full_scan:336 - 正在扫描 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 15:45:12.548 | INFO     | database.document_service:full_scan:336 - 正在扫描 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 15:45:12.873 | INFO     | database.document_service:full_scan:336 - 正在扫描 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 15:45:12.873 | INFO     | database.document_service:full_scan:341 - 全量扫描完成，共处理文件数: 1581
2025-08-11 15:45:12.873 | DEBUG    | database.document_service:_start_watchdog:344 - 启动文件监控 Watchdog
2025-08-11 15:45:12.874 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 15:45:12.874 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 15:45:12.874 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 15:45:12.893 | INFO     | database.document_service:_start_watchdog:432 - Watchdog 已启动
2025-08-11 15:45:12.894 | INFO     | database.document_service:start:474 - DocumentQueryService 已启动
2025-08-11 15:45:12.894 | INFO     | __main__:combined_lifespan:83 - 统一文档查询服务 (DocumentQueryService) 已启动。
2025-08-11 15:45:12.894 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/Projects1', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 15:45:12.894 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/规程规范', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 15:45:12.894 | INFO     | __main__:combined_lifespan:88 - 项目和规程的文件服务已初始化。
2025-08-11 15:45:12.895 | INFO     | __main__:combined_lifespan:93 - AsyncIOScheduler 已实例化并注册到 app_state。
2025-08-11 15:45:12.896 | INFO     | __main__:combined_lifespan:97 - FastMCP lifespan context entered.
2025-08-11 15:45:12.896 | INFO     | __main__:combined_lifespan:117 - 处理不活动用户会话任务已添加到APScheduler (每 60s)。
2025-08-11 15:45:12.896 | INFO     | __main__:combined_lifespan:120 - 清理用户会话中已打开文件token任务已添加到APScheduler (每 120s)。
2025-08-11 15:45:12.897 | INFO     | __main__:combined_lifespan:123 - APScheduler 调度器已启动。
2025-08-11 15:45:12.897 | INFO     | __main__:combined_lifespan:124 - 所有初始化完成... yield
2025-08-11 15:45:12.897 | DEBUG    | database.document_service:_debounced_update_loop:435 - 启动去抖更新循环
2025-08-11 15:45:14.129 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: 7d323df2-8760-4cc5-83c4-4dd64424d8c8, IP: 127.0.0.1) 登录/状态更新成功。
2025-08-11 15:45:14.129 | INFO     | api.route:login:76 - 用户 'admin' (IP: 127.0.0.1, Session: 7d323df2-8760-4cc5-83c4-4dd64424d8c8) 登录成功。
2025-08-11 15:45:14.216 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: 7d323df2-8760-4cc5-83c4-4dd64424d8c8) 的 WebSocket 已连接并关联。
2025-08-11 15:45:14.307 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-11 15:45:24.688 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 15:45:24.688 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 7d323df2-8760-4cc5-83c4-4dd64424d8c8, 对话ID: 7c9b2b78-009b-4534-b0f9-ac1cc889fc24, 查询: 打开船闸这个项目
2025-08-11 15:45:24.688 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:45:28.585 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_dx4SsL5vRlSx2Uw6nABfXA', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "船闸"}'}}]
2025-08-11 15:45:28.585 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "船闸"}
2025-08-11 15:45:28.629 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='船闸', 年份='None'
2025-08-11 15:45:28.629 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-11 15:45:28.642 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:755 - 模糊匹配查询到 1 个项目: ['江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 15:45:28.642 | INFO     | my_mcp_tools.mcp_tools:query_project_files:759 - 模糊匹配到唯一项目: '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'
2025-08-11 15:45:28.643 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 15:45:28.644 | ERROR    | my_mcp_tools.mcp_tools:query_project_files:803 - 处理 query_project_files (新版) 时发生未知错误: '船闸'
2025-08-11 15:45:28.650 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:45:30.222 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_dc9d03c9f46048f0a388a889', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"project_name": "船闸", "user": "admin"}'}}]
2025-08-11 15:45:30.222 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"project_name": "船闸", "user": "admin"}
2025-08-11 15:45:30.269 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='船闸', 年份='None'
2025-08-11 15:45:30.269 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-11 15:45:30.280 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:755 - 模糊匹配查询到 1 个项目: ['江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 15:45:30.280 | INFO     | my_mcp_tools.mcp_tools:query_project_files:759 - 模糊匹配到唯一项目: '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'
2025-08-11 15:45:30.281 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 15:45:30.283 | ERROR    | my_mcp_tools.mcp_tools:query_project_files:803 - 处理 query_project_files (新版) 时发生未知错误: '船闸'
2025-08-11 15:45:30.290 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:45:31.736 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_auBYfeaeSieRtfxPFTw34A', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "/ALL"}'}}]
2025-08-11 15:45:31.736 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "/ALL"}
2025-08-11 15:45:31.780 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='/ALL', 年份='None'
2025-08-11 15:45:31.781 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-11 15:45:31.792 | INFO     | my_mcp_tools.mcp_tools:query_project_files:735 - 收到全部项目查询请求
2025-08-11 15:45:31.799 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:45:35.650 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_aEQGJB3cQDiFBCXuheJfxA', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计"}'}}]
2025-08-11 15:45:35.650 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计"}
2025-08-11 15:45:35.701 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计', 年份='None'
2025-08-11 15:45:35.701 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-11 15:45:35.712 | INFO     | my_mcp_tools.mcp_tools:query_project_files:744 - 精确匹配到项目: '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'
2025-08-11 15:45:35.713 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 15:45:35.715 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 77 个文件。
2025-08-11 15:45:35.716 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-11 15:45:35.724 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:45:45.889 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_9J8jv1yLTAKSrHoMxXxURg', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf", "file_category": "普通文档"}'}}]
2025-08-11 15:45:45.890 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf", "file_category": "普通文档"}
2025-08-11 15:45:45.944 | INFO     | my_mcp_tools.mcp_tools:read_project_file:635 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', Category: '普通文档'
2025-08-11 15:45:45.944 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf (相对路径: 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf)，分隔符: '	'
2025-08-11 15:45:55.919 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: 382-B230168C-A-01 初步设计说明书.pdf, 内容长度: 57141
2025-08-11 15:45:55.919 | INFO     | my_mcp_tools.mcp_tools:read_project_file:694 - 从文件 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf成功读取（预览100字）:文 件 编 号
382-B230168C-A-01
船闸 千伏变电站 号 号主变扩建
110 2 3
工程
初步设计说明书
智 方 设 计 股 份 有 限 公 司
工 程 设 计 证 书 ： 甲 级 
2025-08-11 15:45:55.919 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf' (token: 4ab16ee5317943868a981c3da507ba24), 有效期至: Mon Aug 11 23:45:55 2025
2025-08-11 15:45:55.920 | DEBUG    | my_mcp_tools.mcp_tools:read_project_file:707 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf' 已在会话中注册, token: 4ab16ee5317943868a981c3da507ba24
2025-08-11 15:45:55.932 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/4ab16ee5317943868a981c3da507ba24/382-B230168C-A-01 初步设计说明书.pdf
2025-08-11 15:45:55.946 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:45:56.212 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-01 初步设计说明书_2ea2410d.pdf' 与Token关联文件名 '382-B230168C-A-01 初步设计说明书.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 15:45:56.212 | DEBUG    | api.route:download_file_via_token:193 - Token '4ab16ee5317943868a981c3da507ba24' 验证成功。准备下载文件: '382-B230168C-A-01 初步设计说明书.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', URL文件名: '382-B230168C-A-01 初步设计说明书_2ea2410d.pdf')
2025-08-11 15:45:56.215 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-01 初步设计说明书_2ea2410d.pdf' 与Token关联文件名 '382-B230168C-A-01 初步设计说明书.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 15:45:56.215 | DEBUG    | api.route:download_file_via_token:193 - Token '4ab16ee5317943868a981c3da507ba24' 验证成功。准备下载文件: '382-B230168C-A-01 初步设计说明书.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', URL文件名: '382-B230168C-A-01 初步设计说明书_2ea2410d.pdf')
2025-08-11 15:48:34.964 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 7d323df2-8760-4cc5-83c4-4dd64424d8c8 用户 admin 断开连接
2025-08-11 15:48:34.965 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 15:48:34.965 | INFO     | core.session:disconnect_websocket:108 - 用户 'admin' 的 WebSocket 已断开。
2025-08-11 15:48:35.066 | INFO     | __main__:combined_lifespan:130 - COMBINED LIFESPAN END - PID: 2111105 - 服务器关闭中...
2025-08-11 15:48:35.066 | INFO     | database.document_service:shutdown:478 - 正在关闭 DocumentQueryService...
2025-08-11 15:48:35.076 | INFO     | database.document_service:shutdown:483 - Watchdog 监控已停止。
2025-08-11 15:48:35.076 | INFO     | database.document_service:shutdown:491 - 后台更新任务已取消。
2025-08-11 15:48:35.076 | INFO     | database.document_service:shutdown:496 - 数据库连接已关闭。
2025-08-11 15:48:35.076 | INFO     | database.document_service:shutdown:498 - DocumentQueryService 已成功关闭。
2025-08-11 15:48:35.076 | INFO     | __main__:combined_lifespan:134 - 统一文档查询服务已关闭。
2025-08-11 15:48:35.076 | INFO     | __main__:combined_lifespan:139 - APScheduler 调度器已关闭。
2025-08-11 15:48:35.076 | INFO     | __main__:combined_lifespan:140 - Custom application resources cleaned up.
2025-08-11 15:48:38.461 | INFO     | __main__:<module>:35 - Loguru 日志系统已初始化。
2025-08-11 15:48:38.461 | INFO     | __main__:<module>:36 - 项目根目录配置为: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 15:48:38.461 | INFO     | __main__:<module>:37 - 数据库路径配置为: data/document_service.db
2025-08-11 15:48:38.461 | INFO     | __main__:<module>:38 - 表格列读取配置已加载: {'变电站安装工程概算表': (2, 6), '变电站建筑工程概算表': (2, 6), '电缆输电线路安装工程概算表': (2, 6), '电缆输电线路建筑工程概算表': (2, 6)}
2025-08-11 15:48:38.461 | INFO     | __main__:<module>:39 - kkFileView 服务地址配置为: http://127.0.0.1:8012/kkfileview
2025-08-11 15:48:38.461 | INFO     | __main__:<module>:42 - Dify Agent API Key: ********kGHe
2025-08-11 15:48:38.461 | INFO     | __main__:<module>:43 - Session Secret Key: ********e6a6
2025-08-11 15:48:38.462 | INFO     | __main__:<module>:44 - 服务器ipv6地址为: http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8888
2025-08-11 15:48:38.462 | INFO     | __main__:<module>:151 - FastAPI 应用已实例化并注册到 app_state。
2025-08-11 15:48:38.462 | INFO     | __main__:<module>:154 - CORS中间件已添加，允许所有来源。
2025-08-11 15:48:38.473 | INFO     | __main__:<module>:189 - MCP 服务器 '项目文件检索服务器' 已挂载到 FastAPI 应用的 '/mcp/' 路径。
2025-08-11 15:48:38.488 | INFO     | __main__:combined_lifespan:64 - COMBINED LIFESPAN START - PID: 2115361 - 服务器启动中...
2025-08-11 15:48:38.529 | INFO     | __main__:combined_lifespan:69 - HTTPX 客户端已创建并注册到 app_state。
2025-08-11 15:48:38.529 | INFO     | utils.utils:check_embedding_service_health:28 - 正在检查嵌入模型服务，目标URL: http://127.0.0.1:8001/v1/models
2025-08-11 15:48:38.536 | INFO     | utils.utils:check_embedding_service_health:37 - 嵌入模型服务可用，模型列表: ['/home/zhouxiang/models/BAAI_bge-m3']
2025-08-11 15:48:38.537 | INFO     | core.session:__init__:79 - SessionStateManager已初始化。整体HTTP不活动超时: 3600秒
2025-08-11 15:48:38.537 | INFO     | __main__:combined_lifespan:77 - SessionStateManager 已实例化并注册到 app_state。
2025-08-11 15:48:38.537 | INFO     | database.document_service:__init__:164 - 有效文档根目录: {'项目文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/Projects1'), '规范文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/规程规范'), '管理文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/管理文件')}
2025-08-11 15:48:38.537 | DEBUG    | database.document_service:_init_db:180 - 初始化数据库
2025-08-11 15:48:38.537 | DEBUG    | database.document_service:_init_db:201 - 数据库初始化完成
2025-08-11 15:48:38.537 | INFO     | database.document_service:__init__:177 - DocumentQueryService 初始化完成
2025-08-11 15:48:38.537 | INFO     | database.document_service:full_scan:333 - 开始全量扫描...
2025-08-11 15:48:38.537 | INFO     | database.document_service:full_scan:336 - 正在扫描 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 15:48:43.794 | INFO     | database.document_service:full_scan:336 - 正在扫描 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 15:48:44.110 | INFO     | database.document_service:full_scan:336 - 正在扫描 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 15:48:44.111 | INFO     | database.document_service:full_scan:341 - 全量扫描完成，共处理文件数: 1581
2025-08-11 15:48:44.111 | DEBUG    | database.document_service:_start_watchdog:344 - 启动文件监控 Watchdog
2025-08-11 15:48:44.111 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 15:48:44.111 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 15:48:44.111 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 15:48:44.130 | INFO     | database.document_service:_start_watchdog:432 - Watchdog 已启动
2025-08-11 15:48:44.130 | INFO     | database.document_service:start:474 - DocumentQueryService 已启动
2025-08-11 15:48:44.131 | INFO     | __main__:combined_lifespan:83 - 统一文档查询服务 (DocumentQueryService) 已启动。
2025-08-11 15:48:44.131 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/Projects1', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 15:48:44.131 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/规程规范', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 15:48:44.131 | INFO     | __main__:combined_lifespan:88 - 项目和规程的文件服务已初始化。
2025-08-11 15:48:44.132 | INFO     | __main__:combined_lifespan:93 - AsyncIOScheduler 已实例化并注册到 app_state。
2025-08-11 15:48:44.132 | INFO     | __main__:combined_lifespan:97 - FastMCP lifespan context entered.
2025-08-11 15:48:44.133 | INFO     | __main__:combined_lifespan:117 - 处理不活动用户会话任务已添加到APScheduler (每 60s)。
2025-08-11 15:48:44.133 | INFO     | __main__:combined_lifespan:120 - 清理用户会话中已打开文件token任务已添加到APScheduler (每 120s)。
2025-08-11 15:48:44.133 | INFO     | __main__:combined_lifespan:123 - APScheduler 调度器已启动。
2025-08-11 15:48:44.134 | INFO     | __main__:combined_lifespan:124 - 所有初始化完成... yield
2025-08-11 15:48:44.134 | DEBUG    | database.document_service:_debounced_update_loop:435 - 启动去抖更新循环
2025-08-11 15:49:03.932 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: 62a80425-c19e-449a-834c-5ff0ea64fe8f, IP: 127.0.0.1) 登录/状态更新成功。
2025-08-11 15:49:03.932 | INFO     | api.route:login:76 - 用户 'admin' (IP: 127.0.0.1, Session: 62a80425-c19e-449a-834c-5ff0ea64fe8f) 登录成功。
2025-08-11 15:49:03.993 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: 62a80425-c19e-449a-834c-5ff0ea64fe8f) 的 WebSocket 已连接并关联。
2025-08-11 15:49:04.096 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-11 15:49:12.939 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 15:49:12.940 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 62a80425-c19e-449a-834c-5ff0ea64fe8f, 对话ID: 7c9b2b78-009b-4534-b0f9-ac1cc889fc24, 查询: 打开船闸的项目文件
2025-08-11 15:49:12.940 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:49:32.371 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 15:49:32.371 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 62a80425-c19e-449a-834c-5ff0ea64fe8f, 对话ID: 7c9b2b78-009b-4534-b0f9-ac1cc889fc24, 查询: admin
2025-08-11 15:49:32.371 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:49:37.130 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_e3vlA4EaR9q1ytrtG-Ds5Q', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "船闸"}'}}]
2025-08-11 15:49:37.130 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "船闸"}
2025-08-11 15:49:37.180 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='船闸', 年份='None'
2025-08-11 15:49:37.181 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-11 15:49:37.196 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:755 - 模糊匹配查询到 1 个项目: ['江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 15:49:37.196 | INFO     | my_mcp_tools.mcp_tools:query_project_files:759 - 模糊匹配到唯一项目: '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'
2025-08-11 15:49:37.197 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 15:49:37.198 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 77 个文件。
2025-08-11 15:49:37.199 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-11 15:49:37.208 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:49:54.595 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 15:49:54.595 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 62a80425-c19e-449a-834c-5ff0ea64fe8f, 对话ID: 7c9b2b78-009b-4534-b0f9-ac1cc889fc24, 查询: 帮我生成评审意见
2025-08-11 15:49:54.595 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:49:58.364 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_z1VvSN2xTya7puwyGTYsHQ', 'type': 'function', 'function': {'name': 'write_review_doc', 'arguments': '{"user": "admin", "get_manual": true, "template_type": "主变扩建工程模板"}'}}]
2025-08-11 15:49:58.364 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: write_review_doc with args: {"user": "admin", "get_manual": true, "template_type": "主变扩建工程模板"}
2025-08-11 15:49:58.415 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:50:02.538 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_N5t5P-xbTHqX32ngp53SwQ', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf", "file_category": "普通文档"}'}}]
2025-08-11 15:50:02.538 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf", "file_category": "普通文档"}
2025-08-11 15:50:02.583 | INFO     | my_mcp_tools.mcp_tools:read_project_file:635 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', Category: '普通文档'
2025-08-11 15:50:02.583 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf (相对路径: 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf)，分隔符: '	'
2025-08-11 15:50:12.419 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: 382-B230168C-A-01 初步设计说明书.pdf, 内容长度: 57141
2025-08-11 15:50:12.419 | INFO     | my_mcp_tools.mcp_tools:read_project_file:694 - 从文件 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf成功读取（预览100字）:文 件 编 号
382-B230168C-A-01
船闸 千伏变电站 号 号主变扩建
110 2 3
工程
初步设计说明书
智 方 设 计 股 份 有 限 公 司
工 程 设 计 证 书 ： 甲 级 
2025-08-11 15:50:12.419 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf' (token: b0a99df37196479298e43d218640fb63), 有效期至: Mon Aug 11 23:50:12 2025
2025-08-11 15:50:12.420 | DEBUG    | my_mcp_tools.mcp_tools:read_project_file:707 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf' 已在会话中注册, token: b0a99df37196479298e43d218640fb63
2025-08-11 15:50:12.430 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/b0a99df37196479298e43d218640fb63/382-B230168C-A-01 初步设计说明书.pdf
2025-08-11 15:50:12.444 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:50:12.692 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-01 初步设计说明书_8c943f04.pdf' 与Token关联文件名 '382-B230168C-A-01 初步设计说明书.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 15:50:12.692 | DEBUG    | api.route:download_file_via_token:193 - Token 'b0a99df37196479298e43d218640fb63' 验证成功。准备下载文件: '382-B230168C-A-01 初步设计说明书.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', URL文件名: '382-B230168C-A-01 初步设计说明书_8c943f04.pdf')
2025-08-11 15:50:12.695 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-01 初步设计说明书_8c943f04.pdf' 与Token关联文件名 '382-B230168C-A-01 初步设计说明书.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 15:50:12.695 | DEBUG    | api.route:download_file_via_token:193 - Token 'b0a99df37196479298e43d218640fb63' 验证成功。准备下载文件: '382-B230168C-A-01 初步设计说明书.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', URL文件名: '382-B230168C-A-01 初步设计说明书_8c943f04.pdf')
2025-08-11 15:50:26.128 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_e-37wnfDR_mMzrj9-xAjgQ', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf", "file_category": "普通文档"}'}}]
2025-08-11 15:50:26.129 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf", "file_category": "普通文档"}
2025-08-11 15:50:26.176 | INFO     | my_mcp_tools.mcp_tools:read_project_file:635 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf', Category: '普通文档'
2025-08-11 15:50:26.176 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf (相对路径: 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf)，分隔符: '	'
2025-08-11 15:50:28.210 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: 382-B230168C-A-02 主要设备材料清册.pdf, 内容长度: 14465
2025-08-11 15:50:28.211 | INFO     | my_mcp_tools.mcp_tools:read_project_file:694 - 从文件 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf成功读取（预览100字）:文 件 编 号
382-B230168C-A-02
船闸 110 千伏变电站 2 号 3 号主变扩建工程
初步设计
要设备材料清册
智方设计股份有限公司
工程设计证书：甲级第 A132005184 号
2025-08-11 15:50:28.211 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf' (token: fa399ed0fa68466495eaf1b767eaf045), 有效期至: Mon Aug 11 23:50:28 2025
2025-08-11 15:50:28.211 | DEBUG    | my_mcp_tools.mcp_tools:read_project_file:707 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf' 已在会话中注册, token: fa399ed0fa68466495eaf1b767eaf045
2025-08-11 15:50:28.217 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/fa399ed0fa68466495eaf1b767eaf045/382-B230168C-A-02 主要设备材料清册.pdf
2025-08-11 15:50:28.227 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:50:28.367 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-02 主要设备材料清册_c067a4f8.pdf' 与Token关联文件名 '382-B230168C-A-02 主要设备材料清册.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 15:50:28.367 | DEBUG    | api.route:download_file_via_token:193 - Token 'fa399ed0fa68466495eaf1b767eaf045' 验证成功。准备下载文件: '382-B230168C-A-02 主要设备材料清册.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf', URL文件名: '382-B230168C-A-02 主要设备材料清册_c067a4f8.pdf')
2025-08-11 15:50:28.370 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-02 主要设备材料清册_c067a4f8.pdf' 与Token关联文件名 '382-B230168C-A-02 主要设备材料清册.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 15:50:28.370 | DEBUG    | api.route:download_file_via_token:193 - Token 'fa399ed0fa68466495eaf1b767eaf045' 验证成功。准备下载文件: '382-B230168C-A-02 主要设备材料清册.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf', URL文件名: '382-B230168C-A-02 主要设备材料清册_c067a4f8.pdf')
2025-08-11 15:50:52.161 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_350eroc8SwKqqJdH7mZacw', 'type': 'function', 'function': {'name': 'write_review_doc', 'arguments': '{"user": "admin", "get_manual": false, "template_type": "主变扩建工程模板", "project_name": "江苏苏州船闸110千伏变电站2号3号主变扩建工程", "content": "{\\"line_protection_model_config\\": \\"本期110kV船闸变T接于胥口~石湖线，配置光纤纵联电流差动保护1套。\\", \\"fault_recorder_config\\": \\"配置故障录波器柜1面\\", \\"substation_name\\": \\"船闸变\\", \\"energy_terminal_config\\": \\"主变各侧配置0.2s级数字量单表，10kV各配置0.5s级模拟量单表，本期完善电能量采集终端装置1套\\", \\"switch_config\\": \\"完善间隔层、过程层交换机\\", \\"protection_config\\": \\"本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能。\\", \\"MV_LV_equipment_config\\": \\"本期10kV线路、分段、接地变、站用变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置。\\", \\"online_monitoring\\": \\"本期主变油色谱在线监测装置，视频监控系统扩容。\\", \\"Miscellaneous\\": \\"\\", \\"hint\\": \\"本期工程涉及2号主变增容改造和3号主变新建，需注意接地方式改造（消弧线圈改为小电阻接地），以及设备容量匹配问题。\\"}"}'}}]
2025-08-11 15:50:52.161 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: write_review_doc with args: {"user": "admin", "get_manual": false, "template_type": "主变扩建工程模板", "project_name": "江苏苏州船闸110千伏变电站2号3号主变扩建工程", "content": "{\"line_protection_model_config\": \"本期110kV船闸变T接于胥口~石湖线，配置光纤纵联电流差动保护1套。\", \"fault_recorder_config\": \"配置故障录波器柜1面\", \"substation_name\": \"船闸变\", \"energy_terminal_config\": \"主变各侧配置0.2s级数字量单表，10kV各配置0.5s级模拟量单表，本期完善电能量采集终端装置1套\", \"switch_config\": \"完善间隔层、过程层交换机\", \"protection_config\": \"本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能。\", \"MV_LV_equipment_config\": \"本期10kV线路、分段、接地变、站用变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置。\", \"online_monitoring\": \"本期主变油色谱在线监测装置，视频监控系统扩容。\", \"Miscellaneous\": \"\", \"hint\": \"本期工程涉及2号主变增容改造和3号主变新建，需注意接地方式改造（消弧线圈改为小电阻接地），以及设备容量匹配问题。\"}"}
2025-08-11 15:50:52.206 | DEBUG    | my_mcp_tools.mcp_tools:write_review_doc:981 - 获取到的content：{"line_protection_model_config": "本期110kV船闸变T接于胥口~石湖线，配置光纤纵联电流差动保护1套。", "fault_recorder_config": "配置故障录波器柜1面", "substation_name": "船闸变", "energy_terminal_config": "主变各侧配置0.2s级数字量单表，10kV各配置0.5s级模拟量单表，本期完善电能量采集终端装置1套", "switch_config": "完善间隔层、过程层交换机", "protection_config": "本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能。", "MV_LV_equipment_config": "本期10kV线路、分段、接地变、站用变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置。", "online_monitoring": "本期主变油色谱在线监测装置，视频监控系统扩容。", "Miscellaneous": "", "hint": "本期工程涉及2号主变增容改造和3号主变新建，需注意接地方式改造（消弧线圈改为小电阻接地），以及设备容量匹配问题。"}
2025-08-11 15:50:52.206 | DEBUG    | my_mcp_tools.mcp_tools:write_review_doc:993 - 评审意见输出目标2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计
2025-08-11 15:50:52.257 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' (token: 2e06f1dd432a4bf6abd98012abea6d42), 有效期至: Mon Aug 11 23:50:52 2025
2025-08-11 15:50:52.258 | INFO     | my_mcp_tools.mcp_tools:write_review_doc:1024 - 成功生成评审意见文档: 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx
2025-08-11 15:50:52.264 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/2e06f1dd432a4bf6abd98012abea6d42/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx
2025-08-11 15:50:52.268 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-11 15:50:52.279 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见_1ebaddc2.docx' 与Token关联文件名 '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' 不匹配。将使用Token关联文件名。
2025-08-11 15:50:52.279 | ERROR    | api.route:download_file_via_token:185 - Token '2e06f1dd432a4bf6abd98012abea6d42' 指向的文件路径不存在或不是文件: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' (关联文件名: （二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx)
2025-08-11 15:59:06.805 | INFO     | sse_proxy.sse2websocket1:run:276 - 收到新对话开始事件，对话ID: 82c4ad38-474b-4bde-a149-d283cc60cfbd。清空历史记录。
2025-08-11 15:59:15.332 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '127.0.0.1'.
2025-08-11 15:59:15.332 | INFO     | api.admin:update_admin_config:164 - 从服务商 'zhipu' 的预设中加载了 API Key。
2025-08-11 15:59:15.333 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_API_BASE_URL' 已更新为: https://open.bigmodel.cn/api/paas/v4/
2025-08-11 15:59:15.333 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_MODEL_NAME' 已更新为: GLM-4.5
2025-08-11 15:59:15.333 | INFO     | api.admin:update_admin_config:180 - 运行时配置 'OPENAI_API_KEY' 已更新为: ******Yj8a
2025-08-11 15:59:15.336 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '127.0.0.1'.
2025-08-11 15:59:19.823 | INFO     | sse_proxy.sse2websocket1:run:276 - 收到新对话开始事件，对话ID: 07133d6d-799d-4303-a06a-cf4ab11c4b5a。清空历史记录。
2025-08-11 15:59:21.308 | INFO     | sse_proxy.sse2websocket1:run:276 - 收到新对话开始事件，对话ID: 989c7584-a8a1-449e-bb60-80ae05c8d7cc。清空历史记录。
2025-08-11 15:59:28.884 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 15:59:28.884 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 62a80425-c19e-449a-834c-5ff0ea64fe8f, 对话ID: 989c7584-a8a1-449e-bb60-80ae05c8d7cc, 查询: 帮我打开船闸的项目文件爱你
2025-08-11 15:59:28.884 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-11 15:59:31.729 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_d8f7c70ce8d94d4bba9ca259', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "船闸"}'}}]
2025-08-11 15:59:31.729 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "船闸"}
2025-08-11 15:59:31.777 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='船闸', 年份='None'
2025-08-11 15:59:31.777 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-11 15:59:31.794 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:755 - 模糊匹配查询到 1 个项目: ['江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 15:59:31.794 | INFO     | my_mcp_tools.mcp_tools:query_project_files:759 - 模糊匹配到唯一项目: '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'
2025-08-11 15:59:31.795 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 15:59:31.796 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 77 个文件。
2025-08-11 15:59:31.797 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-11 15:59:31.808 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-11 15:59:35.759 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_e1fda62027ef4ccaa07997bb', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf", "file_category": "普通文档"}'}}]
2025-08-11 15:59:35.759 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf", "file_category": "普通文档"}
2025-08-11 15:59:35.805 | INFO     | my_mcp_tools.mcp_tools:read_project_file:635 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', Category: '普通文档'
2025-08-11 15:59:35.805 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf (相对路径: 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf)，分隔符: '	'
2025-08-11 15:59:45.774 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: 382-B230168C-A-01 初步设计说明书.pdf, 内容长度: 57141
2025-08-11 15:59:45.774 | INFO     | my_mcp_tools.mcp_tools:read_project_file:694 - 从文件 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf成功读取（预览100字）:文 件 编 号
382-B230168C-A-01
船闸 千伏变电站 号 号主变扩建
110 2 3
工程
初步设计说明书
智 方 设 计 股 份 有 限 公 司
工 程 设 计 证 书 ： 甲 级 
2025-08-11 15:59:45.774 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf' (token: c91fe950f0194c01a9bf646fadd5f017), 有效期至: Mon Aug 11 23:59:45 2025
2025-08-11 15:59:45.775 | DEBUG    | my_mcp_tools.mcp_tools:read_project_file:707 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf' 已在会话中注册, token: c91fe950f0194c01a9bf646fadd5f017
2025-08-11 15:59:45.793 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-11 16:00:09.920 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 62a80425-c19e-449a-834c-5ff0ea64fe8f 用户 admin 断开连接
2025-08-11 16:00:09.920 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 16:00:09.920 | INFO     | core.session:disconnect_websocket:108 - 用户 'admin' 的 WebSocket 已断开。
2025-08-11 16:00:10.021 | INFO     | __main__:combined_lifespan:130 - COMBINED LIFESPAN END - PID: 2115361 - 服务器关闭中...
2025-08-11 16:00:10.021 | INFO     | database.document_service:shutdown:478 - 正在关闭 DocumentQueryService...
2025-08-11 16:00:10.031 | INFO     | database.document_service:shutdown:483 - Watchdog 监控已停止。
2025-08-11 16:00:10.031 | INFO     | database.document_service:shutdown:491 - 后台更新任务已取消。
2025-08-11 16:00:10.032 | INFO     | database.document_service:shutdown:496 - 数据库连接已关闭。
2025-08-11 16:00:10.032 | INFO     | database.document_service:shutdown:498 - DocumentQueryService 已成功关闭。
2025-08-11 16:00:10.032 | INFO     | __main__:combined_lifespan:134 - 统一文档查询服务已关闭。
2025-08-11 16:00:10.032 | INFO     | __main__:combined_lifespan:139 - APScheduler 调度器已关闭。
2025-08-11 16:00:10.032 | INFO     | __main__:combined_lifespan:140 - Custom application resources cleaned up.
2025-08-11 16:00:18.489 | INFO     | __main__:<module>:35 - Loguru 日志系统已初始化。
2025-08-11 16:00:18.489 | INFO     | __main__:<module>:36 - 项目根目录配置为: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 16:00:18.489 | INFO     | __main__:<module>:37 - 数据库路径配置为: data/document_service.db
2025-08-11 16:00:18.489 | INFO     | __main__:<module>:38 - 表格列读取配置已加载: {'变电站安装工程概算表': (2, 6), '变电站建筑工程概算表': (2, 6), '电缆输电线路安装工程概算表': (2, 6), '电缆输电线路建筑工程概算表': (2, 6)}
2025-08-11 16:00:18.489 | INFO     | __main__:<module>:39 - kkFileView 服务地址配置为: http://127.0.0.1:8012/kkfileview
2025-08-11 16:00:18.489 | INFO     | __main__:<module>:42 - Dify Agent API Key: ********kGHe
2025-08-11 16:00:18.489 | INFO     | __main__:<module>:43 - Session Secret Key: ********f3aa
2025-08-11 16:00:18.489 | INFO     | __main__:<module>:44 - 服务器ipv6地址为: http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8888
2025-08-11 16:00:18.490 | INFO     | __main__:<module>:151 - FastAPI 应用已实例化并注册到 app_state。
2025-08-11 16:00:18.490 | INFO     | __main__:<module>:154 - CORS中间件已添加，允许所有来源。
2025-08-11 16:00:18.499 | INFO     | __main__:<module>:189 - MCP 服务器 '项目文件检索服务器' 已挂载到 FastAPI 应用的 '/mcp/' 路径。
2025-08-11 16:00:18.515 | INFO     | __main__:combined_lifespan:64 - COMBINED LIFESPAN START - PID: 2128552 - 服务器启动中...
2025-08-11 16:00:18.549 | INFO     | __main__:combined_lifespan:69 - HTTPX 客户端已创建并注册到 app_state。
2025-08-11 16:00:18.549 | INFO     | utils.utils:check_embedding_service_health:28 - 正在检查嵌入模型服务，目标URL: http://127.0.0.1:8001/v1/models
2025-08-11 16:00:18.556 | INFO     | utils.utils:check_embedding_service_health:37 - 嵌入模型服务可用，模型列表: ['/home/zhouxiang/models/BAAI_bge-m3']
2025-08-11 16:00:18.556 | INFO     | core.session:__init__:79 - SessionStateManager已初始化。整体HTTP不活动超时: 3600秒
2025-08-11 16:00:18.556 | INFO     | __main__:combined_lifespan:77 - SessionStateManager 已实例化并注册到 app_state。
2025-08-11 16:00:18.556 | INFO     | database.document_service:__init__:164 - 有效文档根目录: {'项目文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/Projects1'), '规范文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/规程规范'), '管理文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/管理文件')}
2025-08-11 16:00:18.556 | DEBUG    | database.document_service:_init_db:180 - 初始化数据库
2025-08-11 16:00:18.557 | DEBUG    | database.document_service:_init_db:201 - 数据库初始化完成
2025-08-11 16:00:18.557 | INFO     | database.document_service:__init__:177 - DocumentQueryService 初始化完成
2025-08-11 16:00:18.557 | INFO     | database.document_service:full_scan:333 - 开始全量扫描...
2025-08-11 16:00:18.557 | INFO     | database.document_service:full_scan:336 - 正在扫描 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 16:00:23.808 | INFO     | database.document_service:full_scan:336 - 正在扫描 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 16:00:24.124 | INFO     | database.document_service:full_scan:336 - 正在扫描 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 16:00:24.125 | INFO     | database.document_service:full_scan:341 - 全量扫描完成，共处理文件数: 1581
2025-08-11 16:00:24.125 | DEBUG    | database.document_service:_start_watchdog:344 - 启动文件监控 Watchdog
2025-08-11 16:00:24.125 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-11 16:00:24.125 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-11 16:00:24.125 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-11 16:00:24.144 | INFO     | database.document_service:_start_watchdog:432 - Watchdog 已启动
2025-08-11 16:00:24.145 | INFO     | database.document_service:start:474 - DocumentQueryService 已启动
2025-08-11 16:00:24.145 | INFO     | __main__:combined_lifespan:83 - 统一文档查询服务 (DocumentQueryService) 已启动。
2025-08-11 16:00:24.145 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/Projects1', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 16:00:24.145 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/规程规范', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-11 16:00:24.145 | INFO     | __main__:combined_lifespan:88 - 项目和规程的文件服务已初始化。
2025-08-11 16:00:24.146 | INFO     | __main__:combined_lifespan:93 - AsyncIOScheduler 已实例化并注册到 app_state。
2025-08-11 16:00:24.146 | INFO     | __main__:combined_lifespan:97 - FastMCP lifespan context entered.
2025-08-11 16:00:24.147 | INFO     | __main__:combined_lifespan:117 - 处理不活动用户会话任务已添加到APScheduler (每 60s)。
2025-08-11 16:00:24.147 | INFO     | __main__:combined_lifespan:120 - 清理用户会话中已打开文件token任务已添加到APScheduler (每 120s)。
2025-08-11 16:00:24.147 | INFO     | __main__:combined_lifespan:123 - APScheduler 调度器已启动。
2025-08-11 16:00:24.147 | INFO     | __main__:combined_lifespan:124 - 所有初始化完成... yield
2025-08-11 16:00:24.147 | DEBUG    | database.document_service:_debounced_update_loop:435 - 启动去抖更新循环
2025-08-11 16:00:49.059 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: 13088d0a-af17-47d5-badc-9c56f522b2c5, IP: 127.0.0.1) 登录/状态更新成功。
2025-08-11 16:00:49.059 | INFO     | api.route:login:76 - 用户 'admin' (IP: 127.0.0.1, Session: 13088d0a-af17-47d5-badc-9c56f522b2c5) 登录成功。
2025-08-11 16:00:49.152 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: 13088d0a-af17-47d5-badc-9c56f522b2c5) 的 WebSocket 已连接并关联。
2025-08-11 16:00:49.245 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-11 16:00:51.581 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '127.0.0.1'.
2025-08-11 16:00:56.758 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '127.0.0.1'.
2025-08-11 16:00:56.759 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_API_BASE_URL' 已更新为: https://open.bigmodel.cn/api/paas/v4/
2025-08-11 16:00:56.759 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_MODEL_NAME' 已更新为: GLM-4.5
2025-08-11 16:00:56.773 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '127.0.0.1'.
2025-08-11 16:00:59.408 | INFO     | sse_proxy.sse2websocket1:run:276 - 收到新对话开始事件，对话ID: b5f76b66-854e-4a73-ba62-be2a0504d481。清空历史记录。
2025-08-11 16:01:18.203 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 16:01:18.203 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 13088d0a-af17-47d5-badc-9c56f522b2c5, 对话ID: b5f76b66-854e-4a73-ba62-be2a0504d481, 查询: 帮我生成船闸项目的评审意见
2025-08-11 16:01:18.203 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-11 16:01:21.499 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_fc2b1fdd2645424294df52b1', 'type': 'function', 'function': {'name': 'write_review_doc', 'arguments': '{"user": "admin", "get_manual": true}'}}]
2025-08-11 16:01:21.499 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: write_review_doc with args: {"user": "admin", "get_manual": true}
2025-08-11 16:01:21.555 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-11 16:01:35.091 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 16:01:35.091 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 13088d0a-af17-47d5-badc-9c56f522b2c5, 对话ID: b5f76b66-854e-4a73-ba62-be2a0504d481, 查询: 检索项目文件后生成
2025-08-11 16:01:35.091 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-11 16:01:38.806 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_1ab817b9d1574e8bbbb2d33a', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "船闸"}'}}]
2025-08-11 16:01:38.807 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "船闸"}
2025-08-11 16:01:38.852 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='船闸', 年份='None'
2025-08-11 16:01:38.853 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-11 16:01:38.867 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:755 - 模糊匹配查询到 1 个项目: ['江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 16:01:38.867 | INFO     | my_mcp_tools.mcp_tools:query_project_files:759 - 模糊匹配到唯一项目: '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'
2025-08-11 16:01:38.868 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 16:01:38.870 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 77 个文件。
2025-08-11 16:01:38.870 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-11 16:01:38.879 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-11 16:01:42.595 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_21c6f0d6cc024aa8b8321a3b', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf", "file_category": "普通文档"}'}}]
2025-08-11 16:01:42.595 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf", "file_category": "普通文档"}
2025-08-11 16:01:42.640 | INFO     | my_mcp_tools.mcp_tools:read_project_file:635 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', Category: '普通文档'
2025-08-11 16:01:42.640 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf (相对路径: 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf)，分隔符: '	'
2025-08-11 16:01:52.488 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: 382-B230168C-A-01 初步设计说明书.pdf, 内容长度: 57141
2025-08-11 16:01:52.489 | INFO     | my_mcp_tools.mcp_tools:read_project_file:694 - 从文件 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf成功读取（预览100字）:文 件 编 号
382-B230168C-A-01
船闸 千伏变电站 号 号主变扩建
110 2 3
工程
初步设计说明书
智 方 设 计 股 份 有 限 公 司
工 程 设 计 证 书 ： 甲 级 
2025-08-11 16:01:52.489 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf' (token: aab3b03b4d4d4deb86a18d50071beb3d), 有效期至: Tue Aug 12 00:01:52 2025
2025-08-11 16:01:52.489 | DEBUG    | my_mcp_tools.mcp_tools:read_project_file:707 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf' 已在会话中注册, token: aab3b03b4d4d4deb86a18d50071beb3d
2025-08-11 16:01:52.498 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/aab3b03b4d4d4deb86a18d50071beb3d/382-B230168C-A-01 初步设计说明书.pdf
2025-08-11 16:01:52.513 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-11 16:01:52.780 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-01 初步设计说明书_5194d300.pdf' 与Token关联文件名 '382-B230168C-A-01 初步设计说明书.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 16:01:52.781 | DEBUG    | api.route:download_file_via_token:193 - Token 'aab3b03b4d4d4deb86a18d50071beb3d' 验证成功。准备下载文件: '382-B230168C-A-01 初步设计说明书.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', URL文件名: '382-B230168C-A-01 初步设计说明书_5194d300.pdf')
2025-08-11 16:01:52.783 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-01 初步设计说明书_5194d300.pdf' 与Token关联文件名 '382-B230168C-A-01 初步设计说明书.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 16:01:52.784 | DEBUG    | api.route:download_file_via_token:193 - Token 'aab3b03b4d4d4deb86a18d50071beb3d' 验证成功。准备下载文件: '382-B230168C-A-01 初步设计说明书.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-01 初步设计说明书.pdf', URL文件名: '382-B230168C-A-01 初步设计说明书_5194d300.pdf')
2025-08-11 16:02:01.240 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_3191cd5f22714dd9846ab36b', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf", "file_category": "普通文档"}'}}]
2025-08-11 16:02:01.240 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf", "file_category": "普通文档"}
2025-08-11 16:02:01.287 | INFO     | my_mcp_tools.mcp_tools:read_project_file:635 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf', Category: '普通文档'
2025-08-11 16:02:01.287 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf (相对路径: 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf)，分隔符: '	'
2025-08-11 16:02:03.303 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: 382-B230168C-A-02 主要设备材料清册.pdf, 内容长度: 14465
2025-08-11 16:02:03.304 | INFO     | my_mcp_tools.mcp_tools:read_project_file:694 - 从文件 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf成功读取（预览100字）:文 件 编 号
382-B230168C-A-02
船闸 110 千伏变电站 2 号 3 号主变扩建工程
初步设计
要设备材料清册
智方设计股份有限公司
工程设计证书：甲级第 A132005184 号
2025-08-11 16:02:03.304 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf' (token: c7a198dbdef748b9bc485c253c0b7763), 有效期至: Tue Aug 12 00:02:03 2025
2025-08-11 16:02:03.304 | DEBUG    | my_mcp_tools.mcp_tools:read_project_file:707 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf' 已在会话中注册, token: c7a198dbdef748b9bc485c253c0b7763
2025-08-11 16:02:03.310 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/c7a198dbdef748b9bc485c253c0b7763/382-B230168C-A-02 主要设备材料清册.pdf
2025-08-11 16:02:03.317 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-11 16:02:03.461 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-02 主要设备材料清册_0947b7f9.pdf' 与Token关联文件名 '382-B230168C-A-02 主要设备材料清册.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 16:02:03.461 | DEBUG    | api.route:download_file_via_token:193 - Token 'c7a198dbdef748b9bc485c253c0b7763' 验证成功。准备下载文件: '382-B230168C-A-02 主要设备材料清册.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf', URL文件名: '382-B230168C-A-02 主要设备材料清册_0947b7f9.pdf')
2025-08-11 16:02:03.464 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-02 主要设备材料清册_0947b7f9.pdf' 与Token关联文件名 '382-B230168C-A-02 主要设备材料清册.pdf' 不匹配。将使用Token关联文件名。
2025-08-11 16:02:03.464 | DEBUG    | api.route:download_file_via_token:193 - Token 'c7a198dbdef748b9bc485c253c0b7763' 验证成功。准备下载文件: '382-B230168C-A-02 主要设备材料清册.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/收口/船闸110千伏变电站2号3号主变扩建工程/★初步设计（20240723--经研院审查后收口版）PDF/382-B230168C-A-02 主要设备材料清册.pdf', URL文件名: '382-B230168C-A-02 主要设备材料清册_0947b7f9.pdf')
2025-08-11 16:02:25.811 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_6cf80cb0fc164322be2e0167', 'type': 'function', 'function': {'name': 'write_review_doc', 'arguments': '{"user": "admin", "get_manual": false, "project_name": "江苏苏州船闸110千伏变电站2号3号主变扩建工程", "content": "{\\"line_protection_model_config\\": \\"110kV胥口~石湖T接船闸变电站110千伏线路：两侧各配置光纤纵联电流差动保护1套。\\", \\"fault_recorder_config\\": \\"配置故障录波器柜1面。\\", \\"substation_name\\": \\"船闸\\", \\"energy_terminal_config\\": \\"主变各侧配置0.2s级数字量单表，10kV各配置0.5s级模拟量单表，本期完善电能量采集终端装置1套。\\", \\"switch_config\\": \\"完善间隔层、过程层交换机。\\", \\"protection_config\\": \\"本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能。\\", \\"MV_LV_equipment_config\\": \\"本期10kV线路、分段、接地变、站用变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置。\\", \\"online_monitoring\\": \\"本期主变油色谱在线监测装置，避雷器在线监测装置。\\", \\"Miscellaneous\\": \\"本期将2号主变消弧线圈接地改造为小电阻接地，新上3号主变10kV采用小电阻接地。\\", \\"hint\\": \\"1. 本期工程不涉及110kV线路保护配置，船闸变为线路变压器组接线。\\\\n2. 2号主变增容改造后的保护配置需与前期设备协调。\\\\n3. 接地变小电阻装置的保护配置需满足运行要求。\\\\n4. 电能量采集终端装置本期维持现状，新增表计接入现有系统。\\"}"}'}}]
2025-08-11 16:02:25.811 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: write_review_doc with args: {"user": "admin", "get_manual": false, "project_name": "江苏苏州船闸110千伏变电站2号3号主变扩建工程", "content": "{\"line_protection_model_config\": \"110kV胥口~石湖T接船闸变电站110千伏线路：两侧各配置光纤纵联电流差动保护1套。\", \"fault_recorder_config\": \"配置故障录波器柜1面。\", \"substation_name\": \"船闸\", \"energy_terminal_config\": \"主变各侧配置0.2s级数字量单表，10kV各配置0.5s级模拟量单表，本期完善电能量采集终端装置1套。\", \"switch_config\": \"完善间隔层、过程层交换机。\", \"protection_config\": \"本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能。\", \"MV_LV_equipment_config\": \"本期10kV线路、分段、接地变、站用变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置。\", \"online_monitoring\": \"本期主变油色谱在线监测装置，避雷器在线监测装置。\", \"Miscellaneous\": \"本期将2号主变消弧线圈接地改造为小电阻接地，新上3号主变10kV采用小电阻接地。\", \"hint\": \"1. 本期工程不涉及110kV线路保护配置，船闸变为线路变压器组接线。\\n2. 2号主变增容改造后的保护配置需与前期设备协调。\\n3. 接地变小电阻装置的保护配置需满足运行要求。\\n4. 电能量采集终端装置本期维持现状，新增表计接入现有系统。\"}"}
2025-08-11 16:02:25.866 | DEBUG    | my_mcp_tools.mcp_tools:write_review_doc:982 - 获取到的content：{"line_protection_model_config": "110kV胥口~石湖T接船闸变电站110千伏线路：两侧各配置光纤纵联电流差动保护1套。", "fault_recorder_config": "配置故障录波器柜1面。", "substation_name": "船闸", "energy_terminal_config": "主变各侧配置0.2s级数字量单表，10kV各配置0.5s级模拟量单表，本期完善电能量采集终端装置1套。", "switch_config": "完善间隔层、过程层交换机。", "protection_config": "本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能。", "MV_LV_equipment_config": "本期10kV线路、分段、接地变、站用变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置。", "online_monitoring": "本期主变油色谱在线监测装置，避雷器在线监测装置。", "Miscellaneous": "本期将2号主变消弧线圈接地改造为小电阻接地，新上3号主变10kV采用小电阻接地。", "hint": "1. 本期工程不涉及110kV线路保护配置，船闸变为线路变压器组接线。\n2. 2号主变增容改造后的保护配置需与前期设备协调。\n3. 接地变小电阻装置的保护配置需满足运行要求。\n4. 电能量采集终端装置本期维持现状，新增表计接入现有系统。"}
2025-08-11 16:02:25.866 | DEBUG    | my_mcp_tools.mcp_tools:write_review_doc:994 - 评审意见输出目标2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计
2025-08-11 16:02:25.951 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' (token: a1c0e4277c59447e8fcd23ed5f917ba2), 有效期至: Tue Aug 12 00:02:25 2025
2025-08-11 16:02:25.951 | INFO     | my_mcp_tools.mcp_tools:write_review_doc:1025 - 成功生成评审意见文档: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx
2025-08-11 16:02:25.958 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/a1c0e4277c59447e8fcd23ed5f917ba2/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx
2025-08-11 16:02:25.962 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-11 16:02:25.971 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见_7f293dc2.docx' 与Token关联文件名 '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' 不匹配。将使用Token关联文件名。
2025-08-11 16:02:25.971 | DEBUG    | api.route:download_file_via_token:193 - Token 'a1c0e4277c59447e8fcd23ed5f917ba2' 验证成功。准备下载文件: '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx', URL文件名: '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见_7f293dc2.docx')
2025-08-11 16:02:29.317 | DEBUG    | database.document_service:_debounced_update_loop:449 - 开始批量更新 1 个文件...位于目录{'/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx': 1754899345.9513235}
2025-08-11 16:02:29.319 | INFO     | database.document_service:_debounced_update_loop:468 - 已更新至数据库
2025-08-11 16:03:11.921 | DEBUG    | api.route:search_project_files:319 - 在 /api/projects/search 中，用户 'admin' 的WebSocket连接状态: connected=True, websocket_obj_exists=True
2025-08-11 16:03:11.921 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') LIKE ? with params: ['项目文件', '%船闸%']
2025-08-11 16:03:11.923 | DEBUG    | api.route:search_project_files:332 - find_params={'document_type': '项目文件', 'project_name': '%船闸%'}, find_document nums:78
2025-08-11 16:03:11.924 | INFO     | api.route:search_project_files:357 - len(project_list) == 1
2025-08-11 16:03:11.924 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计']
2025-08-11 16:03:11.925 | DEBUG    | api.route:search_project_files:369 - 即将为用户 'admin' 更新工作目录 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 78 个文件。
2025-08-11 16:03:11.925 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计'，包含 78 个文件。
2025-08-11 16:03:11.926 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-11 16:03:17.204 | DEBUG    | core.session:register_editing_file:252 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' 的新编辑会话开始，生成新 file_key: 579e5d6ebd2c
2025-08-11 16:03:17.204 | DEBUG    | core.session:register_editing_file:258 - 注册编辑文件成功, user:'admin', user_id:'4a824cd8', file_path:'2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx', file_key:'579e5d6ebd2c'
2025-08-11 16:03:17.204 | INFO     | api.onlyoffice:open_document:81 - OnlyOffice协同配置: user='admin', user_id='4a824cd8', file_key='579e5d6ebd2c', title='（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx'
2025-08-11 16:15:31.703 | DEBUG    | core.session:register_editing_file:239 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' 已在编辑中，复用 file_key: 579e5d6ebd2c
2025-08-11 16:15:31.703 | DEBUG    | core.session:register_editing_file:258 - 注册编辑文件成功, user:'admin', user_id:'7fe7b148', file_path:'2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx', file_key:'579e5d6ebd2c'
2025-08-11 16:15:31.703 | INFO     | api.onlyoffice:open_document:81 - OnlyOffice协同配置: user='admin', user_id='7fe7b148', file_key='579e5d6ebd2c', title='（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx'
2025-08-11 16:15:32.809 | DEBUG    | api.onlyoffice:onlyoffice_callback:163 - 接收到OnlyOffice回调请求...
2025-08-11 16:15:32.809 | DEBUG    | api.onlyoffice:onlyoffice_callback:174 - 回调数据: status=1, file_key='579e5d6ebd2c', url='None'
2025-08-11 16:15:32.809 | DEBUG    | api.onlyoffice:onlyoffice_callback:179 - 状态码为 1，非保存操作，忽略。
2025-08-11 16:15:32.857 | INFO     | core.session:get_downloadable_file_info:439 - 下载token 'cc0e9ddf57c14e519bd0e1212241099c' (文件: （二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx, 用户: admin) 在 working_directory 中验证成功。
2025-08-11 16:15:32.858 | DEBUG    | api.route:download_file_via_token:193 - Token 'cc0e9ddf57c14e519bd0e1212241099c' 验证成功。准备下载文件: '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx', URL文件名: '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx')
2025-08-11 16:15:51.462 | DEBUG    | api.onlyoffice:onlyoffice_callback:163 - 接收到OnlyOffice回调请求...
2025-08-11 16:15:51.475 | DEBUG    | api.onlyoffice:onlyoffice_callback:174 - 回调数据: status=1, file_key='579e5d6ebd2c', url='None'
2025-08-11 16:15:51.475 | DEBUG    | api.onlyoffice:onlyoffice_callback:179 - 状态码为 1，非保存操作，忽略。
2025-08-11 16:16:20.434 | DEBUG    | api.onlyoffice:onlyoffice_callback:163 - 接收到OnlyOffice回调请求...
2025-08-11 16:16:20.434 | DEBUG    | api.onlyoffice:onlyoffice_callback:174 - 回调数据: status=6, file_key='579e5d6ebd2c', url='http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8080/cache/files/data/579e5d6ebd2c_1518/output.docx/output.docx?md5=Niix5GYniOvFMOmf1ar0MA&expires=1754901081&shardkey=579e5d6ebd2c&filename=output.docx'
2025-08-11 16:16:20.434 | DEBUG    | core.session:get_editing_file:219 - 成功获取文件编辑file_key:579e5d6ebd2c,文件路径:2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx
2025-08-11 16:16:20.435 | INFO     | api.onlyoffice:onlyoffice_callback:198 - 准备将文件保存到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx
2025-08-11 16:16:20.486 | SUCCESS  | api.onlyoffice:onlyoffice_callback:212 - 文档 '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' 已通过回调成功保存。
2025-08-11 16:16:20.487 | INFO     | database.document_service:_delete_document:315 - 文档已从数据库删除: 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/tmpph2c39dc
2025-08-11 16:16:23.695 | DEBUG    | database.document_service:_debounced_update_loop:449 - 开始批量更新 2 个文件...位于目录{'/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/tmpph2c39dc': 1754900180.4867513, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx': 1754900180.4873536}
2025-08-11 16:16:23.696 | DEBUG    | database.document_service:upsert_document:293 - 跳过空文档或元信息失败: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/tmpph2c39dc
2025-08-11 16:16:23.698 | INFO     | database.document_service:_debounced_update_loop:468 - 已更新至数据库
2025-08-11 16:16:52.552 | DEBUG    | api.onlyoffice:onlyoffice_callback:163 - 接收到OnlyOffice回调请求...
2025-08-11 16:16:52.553 | DEBUG    | api.onlyoffice:onlyoffice_callback:174 - 回调数据: status=2, file_key='579e5d6ebd2c', url='http://[240e:479:668:3c1c:41db:d6b1:cb76:39a6]:8080/cache/files/data/579e5d6ebd2c_4520/output.docx/output.docx?md5=7WUiKE0bBmbubD6kNOvr4Q&expires=1754901113&shardkey=579e5d6ebd2c&filename=output.docx'
2025-08-11 16:16:52.553 | DEBUG    | core.session:get_editing_file:219 - 成功获取文件编辑file_key:579e5d6ebd2c,文件路径:2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx
2025-08-11 16:16:52.553 | INFO     | api.onlyoffice:onlyoffice_callback:198 - 准备将文件保存到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx
2025-08-11 16:16:52.584 | SUCCESS  | api.onlyoffice:onlyoffice_callback:212 - 文档 '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' 已通过回调成功保存。
2025-08-11 16:16:52.585 | INFO     | database.document_service:_delete_document:315 - 文档已从数据库删除: 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/tmpv3uvt6h5
2025-08-11 16:16:55.712 | DEBUG    | database.document_service:_debounced_update_loop:449 - 开始批量更新 2 个文件...位于目录{'/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/tmpv3uvt6h5': 1754900212.584193, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx': 1754900212.5847363}
2025-08-11 16:16:55.713 | DEBUG    | database.document_service:upsert_document:293 - 跳过空文档或元信息失败: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/tmpv3uvt6h5
2025-08-11 16:16:55.714 | INFO     | database.document_service:_debounced_update_loop:468 - 已更新至数据库
2025-08-11 16:18:01.666 | DEBUG    | core.session:register_editing_file:239 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' 已在编辑中，复用 file_key: 579e5d6ebd2c
2025-08-11 16:18:01.666 | DEBUG    | core.session:register_editing_file:258 - 注册编辑文件成功, user:'admin', user_id:'b791c977', file_path:'2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx', file_key:'579e5d6ebd2c'
2025-08-11 16:18:01.666 | INFO     | api.onlyoffice:open_document:81 - OnlyOffice协同配置: user='admin', user_id='b791c977', file_key='579e5d6ebd2c', title='（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx'
2025-08-11 16:19:07.586 | DEBUG    | core.session:register_editing_file:252 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/送审/★初步设计（20240531--内审后修改版）/382-B230168C-A-01 初步设计说明书.docx' 的新编辑会话开始，生成新 file_key: 89c22c25cbb4
2025-08-11 16:19:07.586 | DEBUG    | core.session:register_editing_file:258 - 注册编辑文件成功, user:'admin', user_id:'c824c917', file_path:'2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/送审/★初步设计（20240531--内审后修改版）/382-B230168C-A-01 初步设计说明书.docx', file_key:'89c22c25cbb4'
2025-08-11 16:19:07.586 | INFO     | api.onlyoffice:open_document:81 - OnlyOffice协同配置: user='admin', user_id='c824c917', file_key='89c22c25cbb4', title='382-B230168C-A-01 初步设计说明书.docx'
2025-08-11 16:19:08.229 | DEBUG    | api.onlyoffice:onlyoffice_callback:163 - 接收到OnlyOffice回调请求...
2025-08-11 16:19:08.229 | DEBUG    | api.onlyoffice:onlyoffice_callback:174 - 回调数据: status=1, file_key='89c22c25cbb4', url='None'
2025-08-11 16:19:08.230 | DEBUG    | api.onlyoffice:onlyoffice_callback:179 - 状态码为 1，非保存操作，忽略。
2025-08-11 16:19:08.276 | INFO     | core.session:get_downloadable_file_info:439 - 下载token '0bbe3396de184d92b13c5a6a7eed1ac0' (文件: 382-B230168C-A-01 初步设计说明书.docx, 用户: admin) 在 working_directory 中验证成功。
2025-08-11 16:19:08.277 | DEBUG    | api.route:download_file_via_token:193 - Token '0bbe3396de184d92b13c5a6a7eed1ac0' 验证成功。准备下载文件: '382-B230168C-A-01 初步设计说明书.docx' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/送审/★初步设计（20240531--内审后修改版）/382-B230168C-A-01 初步设计说明书.docx', URL文件名: '382-B230168C-A-01 初步设计说明书.docx')
2025-08-11 16:19:45.394 | DEBUG    | api.onlyoffice:onlyoffice_callback:163 - 接收到OnlyOffice回调请求...
2025-08-11 16:19:45.394 | DEBUG    | api.onlyoffice:onlyoffice_callback:174 - 回调数据: status=2, file_key='89c22c25cbb4', url='http://[240e:479:668:3c1c:48a4:f2b:a8ce:23b9]:8080/cache/files/data/89c22c25cbb4_5244/output.docx/output.docx?md5=yYfFGeenozkFGQy7_KLy7A&expires=1754901286&shardkey=89c22c25cbb4&filename=output.docx'
2025-08-11 16:19:45.394 | DEBUG    | core.session:get_editing_file:219 - 成功获取文件编辑file_key:89c22c25cbb4,文件路径:2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/送审/★初步设计（20240531--内审后修改版）/382-B230168C-A-01 初步设计说明书.docx
2025-08-11 16:19:45.394 | INFO     | api.onlyoffice:onlyoffice_callback:198 - 准备将文件保存到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/送审/★初步设计（20240531--内审后修改版）/382-B230168C-A-01 初步设计说明书.docx
2025-08-11 16:19:45.571 | SUCCESS  | api.onlyoffice:onlyoffice_callback:212 - 文档 '382-B230168C-A-01 初步设计说明书.docx' 已通过回调成功保存。
2025-08-11 16:19:45.572 | INFO     | database.document_service:_delete_document:315 - 文档已从数据库删除: 2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/送审/★初步设计（20240531--内审后修改版）/tmprqpcbrtx
2025-08-11 16:19:47.797 | DEBUG    | database.document_service:_debounced_update_loop:449 - 开始批量更新 2 个文件...位于目录{'/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/送审/★初步设计（20240531--内审后修改版）/tmprqpcbrtx': 1754900385.5715623, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/送审/★初步设计（20240531--内审后修改版）/382-B230168C-A-01 初步设计说明书.docx': 1754900385.5720797}
2025-08-11 16:19:47.797 | DEBUG    | database.document_service:upsert_document:293 - 跳过空文档或元信息失败: /media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/送审/★初步设计（20240531--内审后修改版）/tmprqpcbrtx
2025-08-11 16:19:47.827 | INFO     | database.document_service:_debounced_update_loop:468 - 已更新至数据库
2025-08-11 16:19:57.172 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/0bbe3396de184d92b13c5a6a7eed1ac0/382-B230168C-A-01 初步设计说明书.docx
2025-08-11 16:19:57.197 | INFO     | core.session:get_downloadable_file_info:439 - 下载token '0bbe3396de184d92b13c5a6a7eed1ac0' (文件: 382-B230168C-A-01 初步设计说明书.docx, 用户: admin) 在 working_directory 中验证成功。
2025-08-11 16:19:57.197 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '382-B230168C-A-01 初步设计说明书_92e2564a.docx' 与Token关联文件名 '382-B230168C-A-01 初步设计说明书.docx' 不匹配。将使用Token关联文件名。
2025-08-11 16:19:57.198 | DEBUG    | api.route:download_file_via_token:193 - Token '0bbe3396de184d92b13c5a6a7eed1ac0' 验证成功。准备下载文件: '382-B230168C-A-01 初步设计说明书.docx' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/送审/★初步设计（20240531--内审后修改版）/382-B230168C-A-01 初步设计说明书.docx', URL文件名: '382-B230168C-A-01 初步设计说明书_92e2564a.docx')
2025-08-11 16:20:26.427 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/cc0e9ddf57c14e519bd0e1212241099c/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx
2025-08-11 16:20:26.433 | INFO     | core.session:get_downloadable_file_info:439 - 下载token 'cc0e9ddf57c14e519bd0e1212241099c' (文件: （二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx, 用户: admin) 在 working_directory 中验证成功。
2025-08-11 16:20:26.433 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见_9440dc26.docx' 与Token关联文件名 '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' 不匹配。将使用Token关联文件名。
2025-08-11 16:20:26.433 | DEBUG    | api.route:download_file_via_token:193 - Token 'cc0e9ddf57c14e519bd0e1212241099c' 验证成功。准备下载文件: '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx', URL文件名: '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见_9440dc26.docx')
2025-08-11 16:20:41.651 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/cc0e9ddf57c14e519bd0e1212241099c/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx
2025-08-11 16:20:41.657 | INFO     | core.session:get_downloadable_file_info:439 - 下载token 'cc0e9ddf57c14e519bd0e1212241099c' (文件: （二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx, 用户: admin) 在 working_directory 中验证成功。
2025-08-11 16:20:41.657 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见_7af4b8f8.docx' 与Token关联文件名 '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' 不匹配。将使用Token关联文件名。
2025-08-11 16:20:41.658 | DEBUG    | api.route:download_file_via_token:193 - Token 'cc0e9ddf57c14e519bd0e1212241099c' 验证成功。准备下载文件: '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx', URL文件名: '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见_7af4b8f8.docx')
2025-08-11 16:20:47.659 | DEBUG    | core.session:register_editing_file:252 - 文件 '2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' 的新编辑会话开始，生成新 file_key: b6c3d72227a3
2025-08-11 16:20:47.659 | DEBUG    | core.session:register_editing_file:258 - 注册编辑文件成功, user:'admin', user_id:'90bf62fe', file_path:'2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx', file_key:'b6c3d72227a3'
2025-08-11 16:20:47.659 | INFO     | api.onlyoffice:open_document:81 - OnlyOffice协同配置: user='admin', user_id='90bf62fe', file_key='b6c3d72227a3', title='（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx'
2025-08-11 16:20:48.257 | DEBUG    | api.onlyoffice:onlyoffice_callback:163 - 接收到OnlyOffice回调请求...
2025-08-11 16:20:48.258 | DEBUG    | api.onlyoffice:onlyoffice_callback:174 - 回调数据: status=1, file_key='b6c3d72227a3', url='None'
2025-08-11 16:20:48.258 | DEBUG    | api.onlyoffice:onlyoffice_callback:179 - 状态码为 1，非保存操作，忽略。
2025-08-11 16:20:48.291 | INFO     | core.session:get_downloadable_file_info:439 - 下载token 'cc0e9ddf57c14e519bd0e1212241099c' (文件: （二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx, 用户: admin) 在 working_directory 中验证成功。
2025-08-11 16:20:48.291 | DEBUG    | api.route:download_file_via_token:193 - Token 'cc0e9ddf57c14e519bd0e1212241099c' 验证成功。准备下载文件: '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2024/江苏苏州船闸110千伏变电站2号3号主变扩建工程初步设计/过程文件/评审意见草稿/（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx', URL文件名: '（二次）江苏苏州船闸110千伏变电站2号3号主变扩建工程评审意见.docx')
2025-08-11 16:21:12.806 | DEBUG    | api.onlyoffice:onlyoffice_callback:163 - 接收到OnlyOffice回调请求...
2025-08-11 16:21:12.806 | DEBUG    | api.onlyoffice:onlyoffice_callback:174 - 回调数据: status=4, file_key='b6c3d72227a3', url='None'
2025-08-11 16:21:12.806 | DEBUG    | api.onlyoffice:onlyoffice_callback:179 - 状态码为 4，非保存操作，忽略。
2025-08-11 17:21:24.148 | INFO     | core.session:process_inactive_sessions:487 - 检测到 1 个不活动会话，将执行登出: admin
2025-08-11 17:21:24.148 | INFO     | core.session:process_inactive_sessions:493 - APScheduler: 用户 'admin' (会话 13088d0a-af17-47d5-badc-9c56f522b2c5) 因不活动被自动登出。
2025-08-11 17:21:24.148 | INFO     | core.session:process_inactive_sessions:495 - APScheduler: 尝试关闭用户 'admin' 的不活动WebSocket连接。
2025-08-11 17:21:24.148 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 13088d0a-af17-47d5-badc-9c56f522b2c5 用户 admin 断开连接
2025-08-11 17:21:24.148 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-11 17:25:13.194 | INFO     | __main__:combined_lifespan:130 - COMBINED LIFESPAN END - PID: 2128552 - 服务器关闭中...
2025-08-11 17:25:13.194 | INFO     | database.document_service:shutdown:478 - 正在关闭 DocumentQueryService...
2025-08-11 17:25:13.202 | INFO     | database.document_service:shutdown:483 - Watchdog 监控已停止。
2025-08-11 17:25:13.202 | INFO     | database.document_service:shutdown:491 - 后台更新任务已取消。
2025-08-11 17:25:13.202 | INFO     | database.document_service:shutdown:496 - 数据库连接已关闭。
2025-08-11 17:25:13.202 | INFO     | database.document_service:shutdown:498 - DocumentQueryService 已成功关闭。
2025-08-11 17:25:13.202 | INFO     | __main__:combined_lifespan:134 - 统一文档查询服务已关闭。
2025-08-11 17:25:13.202 | INFO     | __main__:combined_lifespan:139 - APScheduler 调度器已关闭。
2025-08-11 17:25:13.202 | INFO     | __main__:combined_lifespan:140 - Custom application resources cleaned up.
2025-08-12 11:41:20.649 | INFO     | __main__:<module>:35 - Loguru 日志系统已初始化。
2025-08-12 11:41:20.649 | INFO     | __main__:<module>:36 - 项目根目录配置为: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-12 11:41:20.649 | INFO     | __main__:<module>:37 - 数据库路径配置为: data/document_service.db
2025-08-12 11:41:20.649 | INFO     | __main__:<module>:38 - 表格列读取配置已加载: {'变电站安装工程概算表': (2, 6), '变电站建筑工程概算表': (2, 6), '电缆输电线路安装工程概算表': (2, 6), '电缆输电线路建筑工程概算表': (2, 6)}
2025-08-12 11:41:20.649 | INFO     | __main__:<module>:39 - kkFileView 服务地址配置为: http://127.0.0.1:8012/kkfileview
2025-08-12 11:41:20.650 | INFO     | __main__:<module>:42 - Dify Agent API Key: ********kGHe
2025-08-12 11:41:20.650 | INFO     | __main__:<module>:43 - Session Secret Key: ********279a
2025-08-12 11:41:20.650 | INFO     | __main__:<module>:44 - 服务器ipv6地址为: http://[240e:479:668:3c1c:48a4:f2b:a8ce:23b9]:8888
2025-08-12 11:41:20.650 | INFO     | __main__:<module>:151 - FastAPI 应用已实例化并注册到 app_state。
2025-08-12 11:41:20.650 | INFO     | __main__:<module>:154 - CORS中间件已添加，允许所有来源。
2025-08-12 11:41:20.661 | INFO     | __main__:<module>:189 - MCP 服务器 '项目文件检索服务器' 已挂载到 FastAPI 应用的 '/mcp/' 路径。
2025-08-12 11:41:20.676 | INFO     | __main__:combined_lifespan:64 - COMBINED LIFESPAN START - PID: 3176385 - 服务器启动中...
2025-08-12 11:41:20.710 | INFO     | __main__:combined_lifespan:69 - HTTPX 客户端已创建并注册到 app_state。
2025-08-12 11:41:20.710 | INFO     | utils.utils:check_embedding_service_health:28 - 正在检查嵌入模型服务，目标URL: http://127.0.0.1:8001/v1/models
2025-08-12 11:41:20.716 | INFO     | utils.utils:check_embedding_service_health:37 - 嵌入模型服务可用，模型列表: ['/home/zhouxiang/models/BAAI_bge-m3']
2025-08-12 11:41:20.717 | INFO     | core.session:__init__:79 - SessionStateManager已初始化。整体HTTP不活动超时: 3600秒
2025-08-12 11:41:20.717 | INFO     | __main__:combined_lifespan:77 - SessionStateManager 已实例化并注册到 app_state。
2025-08-12 11:41:20.717 | INFO     | database.document_service:__init__:164 - 有效文档根目录: {'项目文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/Projects1'), '规范文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/规程规范'), '管理文件': PosixPath('/media/zhouxiang/FC7C74827C743A0A/管理文件')}
2025-08-12 11:41:20.717 | DEBUG    | database.document_service:_init_db:180 - 初始化数据库
2025-08-12 11:41:20.717 | DEBUG    | database.document_service:_init_db:201 - 数据库初始化完成
2025-08-12 11:41:20.717 | INFO     | database.document_service:__init__:177 - DocumentQueryService 初始化完成
2025-08-12 11:41:20.717 | INFO     | database.document_service:full_scan:333 - 开始全量扫描...
2025-08-12 11:41:20.717 | INFO     | database.document_service:full_scan:336 - 正在扫描 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-12 11:41:26.074 | INFO     | database.document_service:full_scan:336 - 正在扫描 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-12 11:41:26.393 | INFO     | database.document_service:full_scan:336 - 正在扫描 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-12 11:41:26.394 | INFO     | database.document_service:full_scan:341 - 全量扫描完成，共处理文件数: 1582
2025-08-12 11:41:26.394 | DEBUG    | database.document_service:_start_watchdog:344 - 启动文件监控 Watchdog
2025-08-12 11:41:26.394 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '项目文件' 目录: /media/zhouxiang/FC7C74827C743A0A/Projects1
2025-08-12 11:41:26.394 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '规范文件' 目录: /media/zhouxiang/FC7C74827C743A0A/规程规范
2025-08-12 11:41:26.394 | INFO     | database.document_service:_start_watchdog:430 - 正在监控 '管理文件' 目录: /media/zhouxiang/FC7C74827C743A0A/管理文件
2025-08-12 11:41:26.414 | INFO     | database.document_service:_start_watchdog:432 - Watchdog 已启动
2025-08-12 11:41:26.414 | INFO     | database.document_service:start:474 - DocumentQueryService 已启动
2025-08-12 11:41:26.414 | INFO     | __main__:combined_lifespan:83 - 统一文档查询服务 (DocumentQueryService) 已启动。
2025-08-12 11:41:26.415 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/Projects1', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-12 11:41:26.415 | INFO     | core.file_service:__init__:38 - FileService 初始化完成。根目录: '/media/zhouxiang/FC7C74827C743A0A/规程规范', 临时目录: '/home/zhouxiang/mcp_file_server/tempfile'
2025-08-12 11:41:26.415 | INFO     | __main__:combined_lifespan:88 - 项目和规程的文件服务已初始化。
2025-08-12 11:41:26.416 | INFO     | __main__:combined_lifespan:93 - AsyncIOScheduler 已实例化并注册到 app_state。
2025-08-12 11:41:26.416 | INFO     | __main__:combined_lifespan:97 - FastMCP lifespan context entered.
2025-08-12 11:41:26.417 | INFO     | __main__:combined_lifespan:117 - 处理不活动用户会话任务已添加到APScheduler (每 60s)。
2025-08-12 11:41:26.417 | INFO     | __main__:combined_lifespan:120 - 清理用户会话中已打开文件token任务已添加到APScheduler (每 120s)。
2025-08-12 11:41:26.417 | INFO     | __main__:combined_lifespan:123 - APScheduler 调度器已启动。
2025-08-12 11:41:26.417 | INFO     | __main__:combined_lifespan:124 - 所有初始化完成... yield
2025-08-12 11:41:26.417 | DEBUG    | database.document_service:_debounced_update_loop:435 - 启动去抖更新循环
2025-08-12 11:43:02.809 | DEBUG    | core.auth:verify_active_session:24 - verify_active_session: HTTP session中缺少用户名或session_id。
2025-08-12 11:43:27.784 | DEBUG    | core.auth:verify_active_session:24 - verify_active_session: HTTP session中缺少用户名或session_id。
2025-08-12 11:43:40.470 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: 00bcaa9e-584c-41d0-971e-39e9b79e1dbe, IP: 240e:479:668:3c1c:60eb:9218:7ef0:f2ac) 登录/状态更新成功。
2025-08-12 11:43:40.470 | INFO     | api.route:login:76 - 用户 'admin' (IP: 240e:479:668:3c1c:60eb:9218:7ef0:f2ac, Session: 00bcaa9e-584c-41d0-971e-39e9b79e1dbe) 登录成功。
2025-08-12 11:43:40.570 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: 00bcaa9e-584c-41d0-971e-39e9b79e1dbe) 的 WebSocket 已连接并关联。
2025-08-12 11:43:40.646 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-12 11:44:04.156 | INFO     | api.upload:handle_project_upload:140 - 用户 'admin' 开始上传项目 '送审' 到年份 '2025' (覆盖: False)。
2025-08-12 11:44:04.167 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf
2025-08-12 11:44:04.169 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-02 黄河变主要设备材料清册（内审后）.pdf
2025-08-12 11:44:04.174 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-03-常州市2024年市区电网接线示意图.pdf
2025-08-12 11:44:04.180 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-04-常州市2026年市区电网接线示意图.pdf
2025-08-12 11:44:04.182 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-05-电气主接线图.pdf
2025-08-12 11:44:04.184 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-06-电气总平面布置图.pdf
2025-08-12 11:44:04.186 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-07-电缆层电气平面布置图.pdf
2025-08-12 11:44:04.188 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-08-一层电气平面布置图.pdf
2025-08-12 11:44:04.189 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-09-二层电气平面布置图.pdf
2025-08-12 11:44:04.191 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-10-电气断面布置图.pdf
2025-08-12 11:44:04.192 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-11-110kV屋内配电装置配置接线图.pdf
2025-08-12 11:44:04.194 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-12-110kV屋内配电装置平断面布置图.pdf
2025-08-12 11:44:04.196 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-13-10kV屋内配电装置配置接线图.pdf
2025-08-12 11:44:04.214 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-14-10kV屋内配电装置平断面布置图.pdf
2025-08-12 11:44:04.215 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-15-主变压器室平面布置图.pdf
2025-08-12 11:44:04.217 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-16-主变压器室断面图.pdf
2025-08-12 11:44:04.219 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-17-电缆层一次电缆敷设平面布置图.pdf
2025-08-12 11:44:04.221 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-18 黄河二次设备室布置图-Model.pdf
2025-08-12 11:44:04.222 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-19 110kVGIS室二次设备平面布置图-Model.pdf
2025-08-12 11:44:04.224 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-20 黄河继电保护配置图-Model.pdf
2025-08-12 11:44:04.226 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-21 全站计算机监控系统配置图-Model.pdf
2025-08-12 11:44:04.228 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-22 全站站控层网络组网方案示意图-Model.pdf
2025-08-12 11:44:04.230 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-23 110kV过程层网络组网方案示意图-Model.pdf
2025-08-12 11:44:04.232 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-24 主变间隔互感器及合并单元配置图-Model.pdf
2025-08-12 11:44:04.233 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-25 110kV系统互感器及合并单元配置图-Model.pdf
2025-08-12 11:44:04.235 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-26 10kV系统互感器配置图-Model.pdf
2025-08-12 11:44:04.237 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-27 直流馈线柜原理接线图-Model.pdf
2025-08-12 11:44:04.238 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-28 交流站用电系统接线图-Model.pdf
2025-08-12 11:44:04.240 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-29 UPS电源柜原理接线图-Model.pdf
2025-08-12 11:44:04.241 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-30- 土建总平面布置图（改造前）.pdf
2025-08-12 11:44:04.243 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-31- 土建总平面布置图（改造后）.pdf
2025-08-12 11:44:04.244 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-32-土建一层平面布置图.pdf
2025-08-12 11:44:04.246 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-33-土建二层平面布置图.pdf
2025-08-12 11:44:04.248 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/HN-B2024-02C-A-图纸目录-2.pdf
2025-08-12 11:44:04.249 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/HN-B2024-02C-A-图纸目录.pdf
2025-08-12 11:44:04.251 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/江苏常州黄河110千伏变电站3号主变扩建工程概算书（内审修改）.xlsx
2025-08-12 11:44:04.251 | INFO     | core.file_service:save_uploaded_directory_async:214 - 已成功将 36 个文件保存到目录: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审
2025-08-12 11:44:04.251 | INFO     | api.upload:handle_project_upload:152 - 成功上传 36 个文件到 '2025/送审/送审'。
2025-08-12 11:44:04.253 | INFO     | core.file_service:create_placeholder_file_async:163 - 已成功创建占位文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/收口/placeholder.txt
2025-08-12 11:44:04.254 | INFO     | core.file_service:create_placeholder_file_async:163 - 已成功创建占位文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/过程文件/placeholder.txt
2025-08-12 11:44:04.254 | INFO     | api.upload:handle_project_upload:157 - 已成功创建辅助目录的占位文件: '2025/送审/收口' 和 '2025/送审/过程文件'。
2025-08-12 11:44:06.485 | DEBUG    | database.document_service:_debounced_update_loop:449 - 开始批量更新 38 个文件...位于目录{'/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf': 1754970244.1665876, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-02 黄河变主要设备材料清册（内审后）.pdf': 1754970244.1697736, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-03-常州市2024年市区电网接线示意图.pdf': 1754970244.1741767, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-04-常州市2026年市区电网接线示意图.pdf': 1754970244.1792312, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-05-电气主接线图.pdf': 1754970244.1821096, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-06-电气总平面布置图.pdf': 1754970244.1845632, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-07-电缆层电气平面布置图.pdf': 1754970244.1860647, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-08-一层电气平面布置图.pdf': 1754970244.1880345, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-09-二层电气平面布置图.pdf': 1754970244.1894073, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-10-电气断面布置图.pdf': 1754970244.1914942, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-11-110kV屋内配电装置配置接线图.pdf': 1754970244.1928616, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-12-110kV屋内配电装置平断面布置图.pdf': 1754970244.1946363, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-13-10kV屋内配电装置配置接线图.pdf': 1754970244.1960776, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-14-10kV屋内配电装置平断面布置图.pdf': 1754970244.213882, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-15-主变压器室平面布置图.pdf': 1754970244.2158566, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-16-主变压器室断面图.pdf': 1754970244.2175257, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-17-电缆层一次电缆敷设平面布置图.pdf': 1754970244.2190628, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-18 黄河二次设备室布置图-Model.pdf': 1754970244.2210386, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-19 110kVGIS室二次设备平面布置图-Model.pdf': 1754970244.2227154, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-20 黄河继电保护配置图-Model.pdf': 1754970244.2244575, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-21 全站计算机监控系统配置图-Model.pdf': 1754970244.2262454, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-22 全站站控层网络组网方案示意图-Model.pdf': 1754970244.2282016, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-23 110kV过程层网络组网方案示意图-Model.pdf': 1754970244.2301974, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-24 主变间隔互感器及合并单元配置图-Model.pdf': 1754970244.2320387, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-25 110kV系统互感器及合并单元配置图-Model.pdf': 1754970244.233498, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-26 10kV系统互感器配置图-Model.pdf': 1754970244.2354226, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-27 直流馈线柜原理接线图-Model.pdf': 1754970244.236915, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-28 交流站用电系统接线图-Model.pdf': 1754970244.238465, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-29 UPS电源柜原理接线图-Model.pdf': 1754970244.2399726, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-30- 土建总平面布置图（改造前）.pdf': 1754970244.2417636, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-31- 土建总平面布置图（改造后）.pdf': 1754970244.243244, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-32-土建一层平面布置图.pdf': 1754970244.2448325, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-33-土建二层平面布置图.pdf': 1754970244.2463417, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/HN-B2024-02C-A-图纸目录-2.pdf': 1754970244.2482321, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/HN-B2024-02C-A-图纸目录.pdf': 1754970244.2499442, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/送审/送审/黄河3号主变扩建工程初设外审/江苏常州黄河110千伏变电站3号主变扩建工程概算书（内审修改）.xlsx': 1754970244.251371, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/收口/placeholder.txt': 1754970244.2531517, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/送审/过程文件/placeholder.txt': 1754970244.254459}
2025-08-12 11:44:06.578 | INFO     | database.document_service:_debounced_update_loop:468 - 已更新至数据库
2025-08-12 11:44:17.553 | DEBUG    | api.route:search_project_files:319 - 在 /api/projects/search 中，用户 'admin' 的WebSocket连接状态: connected=True, websocket_obj_exists=True
2025-08-12 11:44:17.554 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') LIKE ? with params: ['项目文件', '%黄河%']
2025-08-12 11:44:17.555 | DEBUG    | api.route:search_project_files:332 - find_params={'document_type': '项目文件', 'project_name': '%黄河%'}, find_document nums:0
2025-08-12 11:45:37.760 | INFO     | database.document_service:_delete_directory_contents:328 - 目录内容已从数据库删除: 2025/送审
2025-08-12 11:46:10.131 | INFO     | api.upload:handle_project_upload:140 - 用户 'admin' 开始上传项目 '黄河3号主变扩建工程初设外审' 到年份 '2025' (覆盖: False)。
2025-08-12 11:46:10.141 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf
2025-08-12 11:46:10.144 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-02 黄河变主要设备材料清册（内审后）.pdf
2025-08-12 11:46:10.150 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-03-常州市2024年市区电网接线示意图.pdf
2025-08-12 11:46:10.155 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-04-常州市2026年市区电网接线示意图.pdf
2025-08-12 11:46:10.159 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-05-电气主接线图.pdf
2025-08-12 11:46:10.161 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-06-电气总平面布置图.pdf
2025-08-12 11:46:10.163 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-07-电缆层电气平面布置图.pdf
2025-08-12 11:46:10.166 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-08-一层电气平面布置图.pdf
2025-08-12 11:46:10.168 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-09-二层电气平面布置图.pdf
2025-08-12 11:46:10.169 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-10-电气断面布置图.pdf
2025-08-12 11:46:10.171 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-11-110kV屋内配电装置配置接线图.pdf
2025-08-12 11:46:10.172 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-12-110kV屋内配电装置平断面布置图.pdf
2025-08-12 11:46:10.174 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-13-10kV屋内配电装置配置接线图.pdf
2025-08-12 11:46:10.176 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-14-10kV屋内配电装置平断面布置图.pdf
2025-08-12 11:46:10.177 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-15-主变压器室平面布置图.pdf
2025-08-12 11:46:10.178 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-16-主变压器室断面图.pdf
2025-08-12 11:46:10.180 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-17-电缆层一次电缆敷设平面布置图.pdf
2025-08-12 11:46:10.182 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-18 黄河二次设备室布置图-Model.pdf
2025-08-12 11:46:10.183 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-19 110kVGIS室二次设备平面布置图-Model.pdf
2025-08-12 11:46:10.185 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-20 黄河继电保护配置图-Model.pdf
2025-08-12 11:46:10.186 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-21 全站计算机监控系统配置图-Model.pdf
2025-08-12 11:46:10.188 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-22 全站站控层网络组网方案示意图-Model.pdf
2025-08-12 11:46:10.190 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-23 110kV过程层网络组网方案示意图-Model.pdf
2025-08-12 11:46:10.191 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-24 主变间隔互感器及合并单元配置图-Model.pdf
2025-08-12 11:46:10.193 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-25 110kV系统互感器及合并单元配置图-Model.pdf
2025-08-12 11:46:10.195 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-26 10kV系统互感器配置图-Model.pdf
2025-08-12 11:46:10.197 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-27 直流馈线柜原理接线图-Model.pdf
2025-08-12 11:46:10.199 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-28 交流站用电系统接线图-Model.pdf
2025-08-12 11:46:10.201 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-29 UPS电源柜原理接线图-Model.pdf
2025-08-12 11:46:10.202 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-30- 土建总平面布置图（改造前）.pdf
2025-08-12 11:46:10.204 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-31- 土建总平面布置图（改造后）.pdf
2025-08-12 11:46:10.205 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-32-土建一层平面布置图.pdf
2025-08-12 11:46:10.206 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-33-土建二层平面布置图.pdf
2025-08-12 11:46:10.208 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/HN-B2024-02C-A-图纸目录-2.pdf
2025-08-12 11:46:10.209 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/HN-B2024-02C-A-图纸目录.pdf
2025-08-12 11:46:10.211 | DEBUG    | core.file_service:save_uploaded_file_async:71 - 已成功保存上传的文件到: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/江苏常州黄河110千伏变电站3号主变扩建工程概算书（内审修改）.xlsx
2025-08-12 11:46:10.211 | INFO     | core.file_service:save_uploaded_directory_async:214 - 已成功将 36 个文件保存到目录: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审
2025-08-12 11:46:10.211 | INFO     | api.upload:handle_project_upload:152 - 成功上传 36 个文件到 '2025/黄河3号主变扩建工程初设外审/送审'。
2025-08-12 11:46:10.212 | INFO     | core.file_service:create_placeholder_file_async:163 - 已成功创建占位文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/收口/placeholder.txt
2025-08-12 11:46:10.236 | INFO     | core.file_service:create_placeholder_file_async:163 - 已成功创建占位文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/过程文件/placeholder.txt
2025-08-12 11:46:10.237 | INFO     | api.upload:handle_project_upload:157 - 已成功创建辅助目录的占位文件: '2025/黄河3号主变扩建工程初设外审/收口' 和 '2025/黄河3号主变扩建工程初设外审/过程文件'。
2025-08-12 11:46:12.634 | DEBUG    | database.document_service:_debounced_update_loop:449 - 开始批量更新 38 个文件...位于目录{'/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf': 1754970370.1403406, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-02 黄河变主要设备材料清册（内审后）.pdf': 1754970370.143917, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-03-常州市2024年市区电网接线示意图.pdf': 1754970370.1494396, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-04-常州市2026年市区电网接线示意图.pdf': 1754970370.1552193, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-05-电气主接线图.pdf': 1754970370.1588023, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-06-电气总平面布置图.pdf': 1754970370.1613576, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-07-电缆层电气平面布置图.pdf': 1754970370.1633534, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-08-一层电气平面布置图.pdf': 1754970370.165933, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-09-二层电气平面布置图.pdf': 1754970370.1681664, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-10-电气断面布置图.pdf': 1754970370.169599, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-11-110kV屋内配电装置配置接线图.pdf': 1754970370.171048, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-12-110kV屋内配电装置平断面布置图.pdf': 1754970370.1727064, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-13-10kV屋内配电装置配置接线图.pdf': 1754970370.1745462, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-14-10kV屋内配电装置平断面布置图.pdf': 1754970370.1760414, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-15-主变压器室平面布置图.pdf': 1754970370.1773348, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-16-主变压器室断面图.pdf': 1754970370.1786814, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-17-电缆层一次电缆敷设平面布置图.pdf': 1754970370.1804826, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-18 黄河二次设备室布置图-Model.pdf': 1754970370.1819339, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-19 110kVGIS室二次设备平面布置图-Model.pdf': 1754970370.1834424, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-20 黄河继电保护配置图-Model.pdf': 1754970370.185015, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-21 全站计算机监控系统配置图-Model.pdf': 1754970370.1868942, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-22 全站站控层网络组网方案示意图-Model.pdf': 1754970370.188237, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-23 110kV过程层网络组网方案示意图-Model.pdf': 1754970370.1900015, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-24 主变间隔互感器及合并单元配置图-Model.pdf': 1754970370.1915493, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-25 110kV系统互感器及合并单元配置图-Model.pdf': 1754970370.19367, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-26 10kV系统互感器配置图-Model.pdf': 1754970370.1952298, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-27 直流馈线柜原理接线图-Model.pdf': 1754970370.197037, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-28 交流站用电系统接线图-Model.pdf': 1754970370.1990752, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-29 UPS电源柜原理接线图-Model.pdf': 1754970370.2011397, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-30- 土建总平面布置图（改造前）.pdf': 1754970370.202647, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-31- 土建总平面布置图（改造后）.pdf': 1754970370.2040546, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-32-土建一层平面布置图.pdf': 1754970370.2054238, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-33-土建二层平面布置图.pdf': 1754970370.206783, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/HN-B2024-02C-A-图纸目录-2.pdf': 1754970370.2082832, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/HN-B2024-02C-A-图纸目录.pdf': 1754970370.2096722, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/江苏常州黄河110千伏变电站3号主变扩建工程概算书（内审修改）.xlsx': 1754970370.2115293, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/收口/placeholder.txt': 1754970370.2131693, '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/过程文件/placeholder.txt': 1754970370.2368398}
2025-08-12 11:46:12.719 | INFO     | database.document_service:_debounced_update_loop:468 - 已更新至数据库
2025-08-12 11:46:56.132 | DEBUG    | api.route:search_project_files:319 - 在 /api/projects/search 中，用户 'admin' 的WebSocket连接状态: connected=True, websocket_obj_exists=True
2025-08-12 11:46:56.133 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') LIKE ? with params: ['项目文件', '%黄河%']
2025-08-12 11:46:56.134 | DEBUG    | api.route:search_project_files:332 - find_params={'document_type': '项目文件', 'project_name': '%黄河%'}, find_document nums:38
2025-08-12 11:46:56.134 | INFO     | api.route:search_project_files:357 - len(project_list) == 1
2025-08-12 11:46:56.134 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '黄河3号主变扩建工程初设外审']
2025-08-12 11:46:56.135 | DEBUG    | api.route:search_project_files:369 - 即将为用户 'admin' 更新工作目录 '2025/黄河3号主变扩建工程初设外审'，包含 38 个文件。
2025-08-12 11:46:56.135 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2025/黄河3号主变扩建工程初设外审'，包含 38 个文件。
2025-08-12 11:46:56.136 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-12 11:47:05.615 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 11:47:05.615 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe, 对话ID: c329f483-03ae-40c3-8b79-bdfa52c07319, 查询: 帮我打开黄河扩主变工程
2025-08-12 11:47:05.615 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-12 11:47:16.456 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_2bf946fc7f384a01ba6e5e72', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "黄河扩主变工程"}'}}]
2025-08-12 11:47:16.457 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "黄河扩主变工程"}
2025-08-12 11:47:16.503 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='黄河扩主变工程', 年份='None'
2025-08-12 11:47:16.503 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-12 11:47:16.516 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:755 - 模糊匹配查询到 0 个项目: []
2025-08-12 11:47:16.516 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:773 - 使用向量检索辅助判断，候选项目数: 19
2025-08-12 11:47:16.516 | DEBUG    | my_mcp_tools.mcp_tools:_get_embeddings:159 - 正在调用嵌入模型: base_url='http://127.0.0.1:8001/v1', model='/home/zhouxiang/models/BAAI_bge-m3'
2025-08-12 11:47:16.736 | DEBUG    | my_mcp_tools.mcp_tools:_find_similar_items_with_scores:189 - 向量检索 Top-3 结果: [('黄河3号主变扩建工程初设外审', 0.7418282846368032), ('东余变主变扩建工程', 0.7169611624821655), ('白衣河输变电工程初设收口版', 0.5902042821540817)]
2025-08-12 11:47:16.743 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-12 11:47:30.250 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 11:47:30.250 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe, 对话ID: c329f483-03ae-40c3-8b79-bdfa52c07319, 查询: 1
2025-08-12 11:47:30.250 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-12 11:47:31.959 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_7aPOVxFNQt2_qh_fRsAQVQ', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "黄河3号主变扩建工程初设外审"}'}}]
2025-08-12 11:47:31.959 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "黄河3号主变扩建工程初设外审"}
2025-08-12 11:47:32.009 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='黄河3号主变扩建工程初设外审', 年份='None'
2025-08-12 11:47:32.009 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-12 11:47:32.020 | INFO     | my_mcp_tools.mcp_tools:query_project_files:744 - 精确匹配到项目: '黄河3号主变扩建工程初设外审'
2025-08-12 11:47:32.021 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '黄河3号主变扩建工程初设外审']
2025-08-12 11:47:32.022 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2025/黄河3号主变扩建工程初设外审'，包含 38 个文件。
2025-08-12 11:47:32.022 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-12 11:47:32.029 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-12 11:47:41.465 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 11:47:41.466 | INFO     | sse_proxy.sse2websocket1:run:265 - 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe 用户 admin 中止响应流任务
2025-08-12 11:47:41.466 | INFO     | sse_proxy.sse2websocket1:_start:101 - 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe 被取消
2025-08-12 11:47:42.762 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 11:47:42.762 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe, 对话ID: c329f483-03ae-40c3-8b79-bdfa52c07319, 查询: 帮我生成评审意见
2025-08-12 11:47:42.762 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-12 11:47:49.464 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_07IcwLq6Ty-OotBydaOa8g', 'type': 'function', 'function': {'name': 'write_review_doc', 'arguments': '{"user": "admin", "template_type": "主变扩建工程模板", "project_name": "黄河3号主变扩建工程初设外审", "get_manual": true}'}}]
2025-08-12 11:47:49.464 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: write_review_doc with args: {"user": "admin", "template_type": "主变扩建工程模板", "project_name": "黄河3号主变扩建工程初设外审", "get_manual": true}
2025-08-12 11:47:49.520 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-12 11:47:55.747 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_08dccdeaa8f24285bf348b8a', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf", "file_category": "普通文档"}'}}]
2025-08-12 11:47:55.747 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf", "file_category": "普通文档"}
2025-08-12 11:47:55.798 | INFO     | my_mcp_tools.mcp_tools:read_project_file:635 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf', Category: '普通文档'
2025-08-12 11:47:55.798 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf (相对路径: 2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf)，分隔符: '	'
2025-08-12 11:48:03.083 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf, 内容长度: 90950
2025-08-12 11:48:03.083 | INFO     | my_mcp_tools.mcp_tools:read_project_file:694 - 从文件 2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf成功读取（预览100字）:黄河110千伏变电站3号主变扩建工程 初步设计说明书
检索号：B2024-02C
编 号：B2024-02C-A-01
黄河 千伏变电站 号主变扩建工程
110 3
初步设计说明书
江苏海能电力设计咨
2025-08-12 11:48:03.083 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' (token: 88e0c7f772f3415b85aa6537d1ef1f72), 有效期至: Tue Aug 12 19:48:03 2025
2025-08-12 11:48:03.084 | DEBUG    | my_mcp_tools.mcp_tools:read_project_file:707 - 文件 '2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' 已在会话中注册, token: 88e0c7f772f3415b85aa6537d1ef1f72
2025-08-12 11:48:03.110 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-12 11:48:03.141 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/88e0c7f772f3415b85aa6537d1ef1f72/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf
2025-08-12 11:48:04.051 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）_e931aa63.pdf' 与Token关联文件名 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' 不匹配。将使用Token关联文件名。
2025-08-12 11:48:04.051 | DEBUG    | api.route:download_file_via_token:193 - Token '88e0c7f772f3415b85aa6537d1ef1f72' 验证成功。准备下载文件: 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf', URL文件名: 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）_e931aa63.pdf')
2025-08-12 11:48:04.053 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）_e931aa63.pdf' 与Token关联文件名 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' 不匹配。将使用Token关联文件名。
2025-08-12 11:48:04.053 | DEBUG    | api.route:download_file_via_token:193 - Token '88e0c7f772f3415b85aa6537d1ef1f72' 验证成功。准备下载文件: 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf', URL文件名: 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）_e931aa63.pdf')
2025-08-12 11:48:22.065 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_376ce047f3a347258154d5b9', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-02 黄河110千伏变电站3号主变扩建工程材料清册（内审后）.xlsx", "file_category": "普通文档"}'}}]
2025-08-12 11:48:22.066 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-02 黄河110千伏变电站3号主变扩建工程材料清册（内审后）.xlsx", "file_category": "普通文档"}
2025-08-12 11:48:22.118 | INFO     | my_mcp_tools.mcp_tools:read_project_file:635 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-02 黄河110千伏变电站3号主变扩建工程材料清册（内审后）.xlsx', Category: '普通文档'
2025-08-12 11:48:22.118 | ERROR    | my_mcp_tools.mcp_tools:read_project_file:639 - 请求的文件路径不存在: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-02 黄河110千伏变电站3号主变扩建工程材料清册（内审后）.xlsx
2025-08-12 11:48:22.124 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-12 11:48:40.393 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_zEo3TXrRTvC04Ju-s8L8vQ', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-02 黄河110千伏变电站3号主变扩建工程材料清册（内审后）.pdf", "file_category": "普通文档"}'}}]
2025-08-12 11:48:40.394 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-02 黄河110千伏变电站3号主变扩建工程材料清册（内审后）.pdf", "file_category": "普通文档"}
2025-08-12 11:48:40.439 | INFO     | my_mcp_tools.mcp_tools:read_project_file:635 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-02 黄河110千伏变电站3号主变扩建工程材料清册（内审后）.pdf', Category: '普通文档'
2025-08-12 11:48:40.440 | ERROR    | my_mcp_tools.mcp_tools:read_project_file:639 - 请求的文件路径不存在: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-02 黄河110千伏变电站3号主变扩建工程材料清册（内审后）.pdf
2025-08-12 11:48:40.445 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-12 11:48:57.173 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: []
2025-08-12 11:48:57.174 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-12 11:49:13.946 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: []
2025-08-12 11:49:13.946 | WARNING  | sse_proxy.sse2websocket1:_handle_stream:115 - 递归深度超过最大限制(5)，终止工具调用
2025-08-12 11:49:41.570 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 11:49:41.570 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe, 对话ID: c329f483-03ae-40c3-8b79-bdfa52c07319, 查询: 重新打开材料清册
2025-08-12 11:49:41.570 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-12 11:49:57.965 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: []
2025-08-12 11:49:57.966 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-12 11:50:26.377 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': '1', 'type': 'function', 'function': {'name': '', 'arguments': '{}'}}]
2025-08-12 11:50:26.377 | WARNING  | sse_proxy.sse2websocket1:_execute_tool_calls:187 - 无效的工具调用，缺少名称或ID: {'id': '1', 'type': 'function', 'function': {'name': '', 'arguments': '{}'}}
2025-08-12 11:50:26.377 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-12 11:50:42.999 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: []
2025-08-12 11:50:42.999 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5-Flash
2025-08-12 11:50:51.977 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 11:50:51.977 | INFO     | sse_proxy.sse2websocket1:run:265 - 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe 用户 admin 中止响应流任务
2025-08-12 11:50:51.977 | INFO     | sse_proxy.sse2websocket1:_start:101 - 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe 被取消
2025-08-12 11:50:58.610 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:60eb:9218:7ef0:f2ac'.
2025-08-12 11:51:05.084 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:60eb:9218:7ef0:f2ac'.
2025-08-12 11:51:05.085 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_API_BASE_URL' 已更新为: https://open.bigmodel.cn/api/paas/v4/
2025-08-12 11:51:05.085 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_MODEL_NAME' 已更新为: GLM-4.5
2025-08-12 11:51:05.102 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:60eb:9218:7ef0:f2ac'.
2025-08-12 11:51:09.000 | INFO     | sse_proxy.sse2websocket1:run:276 - 收到新对话开始事件，对话ID: 2a9a7e97-d0b1-4489-a627-184c6de04ce8。清空历史记录。
2025-08-12 11:51:18.498 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 11:51:18.498 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe, 对话ID: 2a9a7e97-d0b1-4489-a627-184c6de04ce8, 查询: 打开黄河扩主变项目
2025-08-12 11:51:18.498 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-12 11:51:21.570 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_6d9faea1fbde461bbc7e33a2', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "黄河扩主变"}'}}]
2025-08-12 11:51:21.570 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "黄河扩主变"}
2025-08-12 11:51:21.615 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='黄河扩主变', 年份='None'
2025-08-12 11:51:21.616 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-12 11:51:21.630 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:755 - 模糊匹配查询到 0 个项目: []
2025-08-12 11:51:21.630 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:773 - 使用向量检索辅助判断，候选项目数: 19
2025-08-12 11:51:21.630 | DEBUG    | my_mcp_tools.mcp_tools:_get_embeddings:159 - 正在调用嵌入模型: base_url='http://127.0.0.1:8001/v1', model='/home/zhouxiang/models/BAAI_bge-m3'
2025-08-12 11:51:21.848 | DEBUG    | my_mcp_tools.mcp_tools:_find_similar_items_with_scores:189 - 向量检索 Top-3 结果: [('黄河3号主变扩建工程初设外审', 0.633338868676049), ('东余变主变扩建工程', 0.590819464320008), ('扬州品祚扩主变', 0.5182553128789842)]
2025-08-12 11:51:21.856 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-12 11:51:32.117 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 11:51:32.117 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe, 对话ID: 2a9a7e97-d0b1-4489-a627-184c6de04ce8, 查询: 1
2025-08-12 11:51:32.117 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-12 11:51:33.756 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_304338c5bbab448fbbe25319', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "黄河3号主变扩建工程初设外审"}'}}]
2025-08-12 11:51:33.756 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "黄河3号主变扩建工程初设外审"}
2025-08-12 11:51:33.810 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='黄河3号主变扩建工程初设外审', 年份='None'
2025-08-12 11:51:33.811 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-12 11:51:33.826 | INFO     | my_mcp_tools.mcp_tools:query_project_files:744 - 精确匹配到项目: '黄河3号主变扩建工程初设外审'
2025-08-12 11:51:33.826 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '黄河3号主变扩建工程初设外审']
2025-08-12 11:51:33.828 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2025/黄河3号主变扩建工程初设外审'，包含 38 个文件。
2025-08-12 11:51:33.828 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-12 11:51:33.835 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-12 11:51:44.000 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 11:51:44.000 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe, 对话ID: 2a9a7e97-d0b1-4489-a627-184c6de04ce8, 查询: 帮我生成评审意见
2025-08-12 11:51:44.001 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-12 11:51:46.188 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_87c8eea417194735ae897aa1', 'type': 'function', 'function': {'name': 'write_review_doc', 'arguments': '{"user": "admin", "get_manual": true}'}}]
2025-08-12 11:51:46.188 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: write_review_doc with args: {"user": "admin", "get_manual": true}
2025-08-12 11:51:46.253 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-12 11:51:48.809 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': 'call_c693cfeb840c4f4da69f54af', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf", "file_category": "普通文档"}'}}]
2025-08-12 11:51:48.810 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf", "file_category": "普通文档"}
2025-08-12 11:51:48.864 | INFO     | my_mcp_tools.mcp_tools:read_project_file:635 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf', Category: '普通文档'
2025-08-12 11:51:48.865 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf (相对路径: 2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf)，分隔符: '	'
2025-08-12 11:51:56.190 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf, 内容长度: 90950
2025-08-12 11:51:56.191 | INFO     | my_mcp_tools.mcp_tools:read_project_file:694 - 从文件 2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf成功读取（预览100字）:黄河110千伏变电站3号主变扩建工程 初步设计说明书
检索号：B2024-02C
编 号：B2024-02C-A-01
黄河 千伏变电站 号主变扩建工程
110 3
初步设计说明书
江苏海能电力设计咨
2025-08-12 11:51:56.191 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' (token: 4dad79a8cad84fefb5ca7915abb36758), 有效期至: Tue Aug 12 19:51:56 2025
2025-08-12 11:51:56.191 | DEBUG    | my_mcp_tools.mcp_tools:read_project_file:707 - 文件 '2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' 已在会话中注册, token: 4dad79a8cad84fefb5ca7915abb36758
2025-08-12 11:51:56.216 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-12 11:51:56.238 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/4dad79a8cad84fefb5ca7915abb36758/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf
2025-08-12 11:51:57.109 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）_9ed26ec1.pdf' 与Token关联文件名 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' 不匹配。将使用Token关联文件名。
2025-08-12 11:51:57.109 | DEBUG    | api.route:download_file_via_token:193 - Token '4dad79a8cad84fefb5ca7915abb36758' 验证成功。准备下载文件: 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf', URL文件名: 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）_9ed26ec1.pdf')
2025-08-12 11:51:57.111 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）_9ed26ec1.pdf' 与Token关联文件名 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' 不匹配。将使用Token关联文件名。
2025-08-12 11:51:57.111 | DEBUG    | api.route:download_file_via_token:193 - Token '4dad79a8cad84fefb5ca7915abb36758' 验证成功。准备下载文件: 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf', URL文件名: 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）_9ed26ec1.pdf')
2025-08-12 11:52:26.189 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 11:52:26.189 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe, 对话ID: 2a9a7e97-d0b1-4489-a627-184c6de04ce8, 查询: 继续
2025-08-12 11:52:26.189 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-12 12:34:01.336 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 12:34:01.337 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe, 对话ID: 2a9a7e97-d0b1-4489-a627-184c6de04ce8, 查询: 使用以上参数调用工具生成
2025-08-12 12:34:01.337 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-12 12:34:30.415 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 12:34:30.416 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe, 对话ID: 2a9a7e97-d0b1-4489-a627-184c6de04ce8, 查询: write_review工具生成
2025-08-12 12:34:30.416 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-12 12:34:53.110 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 12:34:53.111 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe, 对话ID: 2a9a7e97-d0b1-4489-a627-184c6de04ce8, 查询: 看下你的调用格式，不对
2025-08-12 12:34:53.111 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:GLM-4.5
2025-08-12 12:35:26.542 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:60eb:9218:7ef0:f2ac'.
2025-08-12 12:35:26.542 | INFO     | api.admin:update_admin_config:164 - 从服务商 'kimi' 的预设中加载了 API Key。
2025-08-12 12:35:26.542 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_API_BASE_URL' 已更新为: https://api.moonshot.cn/v1
2025-08-12 12:35:26.542 | INFO     | api.admin:update_admin_config:183 - 运行时配置 'OPENAI_MODEL_NAME' 已更新为: kimi-k2-0711-preview
2025-08-12 12:35:26.542 | INFO     | api.admin:update_admin_config:180 - 运行时配置 'OPENAI_API_KEY' 已更新为: ******XvEL
2025-08-12 12:35:26.552 | DEBUG    | api.admin:admin_access:38 - Admin access granted for user 'admin' from IP '240e:479:668:3c1c:60eb:9218:7ef0:f2ac'.
2025-08-12 12:35:30.651 | INFO     | sse_proxy.sse2websocket1:run:276 - 收到新对话开始事件，对话ID: 5a9df1c7-5eff-4bf2-aac2-d38e6c4a68f7。清空历史记录。
2025-08-12 12:35:38.510 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 12:35:38.510 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe, 对话ID: 5a9df1c7-5eff-4bf2-aac2-d38e6c4a68f7, 查询: 帮我打开黄河扩主变项目文件
2025-08-12 12:35:38.510 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:kimi-k2-0711-preview
2025-08-12 12:35:45.091 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': '17', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "黄河扩主变"}'}}]
2025-08-12 12:35:45.091 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "黄河扩主变"}
2025-08-12 12:35:45.145 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='黄河扩主变', 年份='None'
2025-08-12 12:35:45.146 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-12 12:35:45.156 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:755 - 模糊匹配查询到 0 个项目: []
2025-08-12 12:35:45.156 | DEBUG    | my_mcp_tools.mcp_tools:query_project_files:773 - 使用向量检索辅助判断，候选项目数: 19
2025-08-12 12:35:45.157 | DEBUG    | my_mcp_tools.mcp_tools:_get_embeddings:159 - 正在调用嵌入模型: base_url='http://127.0.0.1:8001/v1', model='/home/zhouxiang/models/BAAI_bge-m3'
2025-08-12 12:35:45.378 | DEBUG    | my_mcp_tools.mcp_tools:_find_similar_items_with_scores:189 - 向量检索 Top-3 结果: [('黄河3号主变扩建工程初设外审', 0.633338868676049), ('东余变主变扩建工程', 0.590819464320008), ('扬州品祚扩主变', 0.5182553128789842)]
2025-08-12 12:35:45.384 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:kimi-k2-0711-preview
2025-08-12 12:35:54.383 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': '40', 'type': 'function', 'function': {'name': 'query_project_files', 'arguments': '{"user": "admin", "project_name": "黄河3号主变扩建工程初设外审"}'}}]
2025-08-12 12:35:54.383 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_project_files with args: {"user": "admin", "project_name": "黄河3号主变扩建工程初设外审"}
2025-08-12 12:35:54.428 | INFO     | my_mcp_tools.mcp_tools:query_project_files:726 - 工具调用 (新版): query_project_files, 项目关键字='黄河3号主变扩建工程初设外审', 年份='None'
2025-08-12 12:35:54.429 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? with params: ['项目文件']
2025-08-12 12:35:54.440 | INFO     | my_mcp_tools.mcp_tools:query_project_files:744 - 精确匹配到项目: '黄河3号主变扩建工程初设外审'
2025-08-12 12:35:54.440 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '黄河3号主变扩建工程初设外审']
2025-08-12 12:35:54.441 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2025/黄河3号主变扩建工程初设外审'，包含 38 个文件。
2025-08-12 12:35:54.442 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-12 12:35:54.448 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:kimi-k2-0711-preview
2025-08-12 12:36:05.753 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': '120', 'type': 'function', 'function': {'name': 'read_project_file', 'arguments': '{"user": "admin", "relative_file_path": "2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf", "file_category": "普通文档"}'}}]
2025-08-12 12:36:05.753 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: read_project_file with args: {"user": "admin", "relative_file_path": "2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf", "file_category": "普通文档"}
2025-08-12 12:36:05.801 | INFO     | my_mcp_tools.mcp_tools:read_project_file:635 - 工具调用 (LLM): read_project_file. User: 'admin', Path: '2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf', Category: '普通文档'
2025-08-12 12:36:05.801 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:83 - MCP Tool: 尝试解析文件: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf (相对路径: 2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf)，分隔符: '	'
2025-08-12 12:36:13.000 | DEBUG    | my_mcp_tools.mcp_tools:_get_file_content:88 - MCP Tool: 解析完成，文件: B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf, 内容长度: 90950
2025-08-12 12:36:13.001 | INFO     | my_mcp_tools.mcp_tools:read_project_file:694 - 从文件 2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf成功读取（预览100字）:黄河110千伏变电站3号主变扩建工程 初步设计说明书
检索号：B2024-02C
编 号：B2024-02C-A-01
黄河 千伏变电站 号主变扩建工程
110 3
初步设计说明书
江苏海能电力设计咨
2025-08-12 12:36:13.001 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' (token: 12d8a3455c4341cb87584050bbdce069), 有效期至: Tue Aug 12 20:36:13 2025
2025-08-12 12:36:13.001 | DEBUG    | my_mcp_tools.mcp_tools:read_project_file:707 - 文件 '2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' 已在会话中注册, token: 12d8a3455c4341cb87584050bbdce069
2025-08-12 12:36:13.028 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:kimi-k2-0711-preview
2025-08-12 12:36:13.032 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/12d8a3455c4341cb87584050bbdce069/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf
2025-08-12 12:36:13.845 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）_91ee1919.pdf' 与Token关联文件名 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' 不匹配。将使用Token关联文件名。
2025-08-12 12:36:13.845 | DEBUG    | api.route:download_file_via_token:193 - Token '12d8a3455c4341cb87584050bbdce069' 验证成功。准备下载文件: 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf', URL文件名: 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）_91ee1919.pdf')
2025-08-12 12:36:13.847 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）_91ee1919.pdf' 与Token关联文件名 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' 不匹配。将使用Token关联文件名。
2025-08-12 12:36:13.847 | DEBUG    | api.route:download_file_via_token:193 - Token '12d8a3455c4341cb87584050bbdce069' 验证成功。准备下载文件: 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/送审/黄河3号主变扩建工程初设外审/B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）.pdf', URL文件名: 'B2024-02C-A-01 黄河110千伏变电站3号主变扩建工程初步设计说明书（内审后）_91ee1919.pdf')
2025-08-12 12:36:28.320 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 12:36:28.321 | INFO     | sse_proxy.sse2websocket1:run:265 - 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe 用户 admin 中止响应流任务
2025-08-12 12:36:28.321 | INFO     | sse_proxy.sse2websocket1:_start:101 - 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe 被取消
2025-08-12 12:36:32.271 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 12:36:32.271 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe, 对话ID: 5a9df1c7-5eff-4bf2-aac2-d38e6c4a68f7, 查询: 帮我生成评审意见
2025-08-12 12:36:32.271 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:kimi-k2-0711-preview
2025-08-12 12:36:45.276 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': '143', 'type': 'function', 'function': {'name': 'write_review_doc', 'arguments': '{"user": "admin", "template_type": "主变扩建工程模板", "get_manual": true}'}}]
2025-08-12 12:36:45.276 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: write_review_doc with args: {"user": "admin", "template_type": "主变扩建工程模板", "get_manual": true}
2025-08-12 12:36:45.337 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:kimi-k2-0711-preview
2025-08-12 12:37:16.348 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': '556', 'type': 'function', 'function': {'name': 'write_review_doc', 'arguments': '{"user": "admin", "template_type": "主变扩建工程模板", "get_manual": false, "project_name": "黄河3号主变扩建工程", "content": "{\\n    \\"line_protection_model_config\\": \\"110kV备用线路：配置单套光纤电流差动保护1套，本期仅投距离保护，带有完整的后备保护及重合闸功能。\\",\\n    \\"fault_recorder_config\\": \\"故障录波装置前期已配置，满足本期接入数据需求。\\",\\n    \\"substation_name\\": \\"黄河变\\",\\n    \\"energy_terminal_config\\": \\"主变各侧配置0.2S级数字量关口计量表，110kV线路配置0.5S级数字量电能表，10kV线路、电容器、接地变配置0.5S级模拟量电能表，接入前期电能量采集终端。\\",\\n    \\"switch_config\\": \\"完善间隔层、过程层交换机。\\",\\n    \\"protection_config\\": \\"本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能。\\",\\n    \\"MV_LV_equipment_config\\": \\"本期10kV线路、分段、接地变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置。\\",\\n    \\"online_monitoring\\": \\"本期新增一次设备状态监测系统1套，包含GIS绝缘气体密度监测、避雷器泄漏电流监测、开关触头测温等功能。\\",\\n    \\"Miscellaneous\\": \\"本期新增装配式消防水池1座，新增消防设施。\\",\\n    \\"hint\\": \\"1. 主变为利旧搬迁设备（景区2号主变），需注意设备状态评估和运输方案确认；2. 110kV母线保护本期不新增，维持现状；3. 10kV母线保护通过主变后备保护实现，未配置独立母线保护。\\"\\n}"}'}}]
2025-08-12 12:37:16.348 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: write_review_doc with args: {"user": "admin", "template_type": "主变扩建工程模板", "get_manual": false, "project_name": "黄河3号主变扩建工程", "content": "{\n    \"line_protection_model_config\": \"110kV备用线路：配置单套光纤电流差动保护1套，本期仅投距离保护，带有完整的后备保护及重合闸功能。\",\n    \"fault_recorder_config\": \"故障录波装置前期已配置，满足本期接入数据需求。\",\n    \"substation_name\": \"黄河变\",\n    \"energy_terminal_config\": \"主变各侧配置0.2S级数字量关口计量表，110kV线路配置0.5S级数字量电能表，10kV线路、电容器、接地变配置0.5S级模拟量电能表，接入前期电能量采集终端。\",\n    \"switch_config\": \"完善间隔层、过程层交换机。\",\n    \"protection_config\": \"本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能。\",\n    \"MV_LV_equipment_config\": \"本期10kV线路、分段、接地变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置。\",\n    \"online_monitoring\": \"本期新增一次设备状态监测系统1套，包含GIS绝缘气体密度监测、避雷器泄漏电流监测、开关触头测温等功能。\",\n    \"Miscellaneous\": \"本期新增装配式消防水池1座，新增消防设施。\",\n    \"hint\": \"1. 主变为利旧搬迁设备（景区2号主变），需注意设备状态评估和运输方案确认；2. 110kV母线保护本期不新增，维持现状；3. 10kV母线保护通过主变后备保护实现，未配置独立母线保护。\"\n}"}
2025-08-12 12:37:16.406 | DEBUG    | my_mcp_tools.mcp_tools:write_review_doc:982 - 获取到的content：{
    "line_protection_model_config": "110kV备用线路：配置单套光纤电流差动保护1套，本期仅投距离保护，带有完整的后备保护及重合闸功能。",
    "fault_recorder_config": "故障录波装置前期已配置，满足本期接入数据需求。",
    "substation_name": "黄河变",
    "energy_terminal_config": "主变各侧配置0.2S级数字量关口计量表，110kV线路配置0.5S级数字量电能表，10kV线路、电容器、接地变配置0.5S级模拟量电能表，接入前期电能量采集终端。",
    "switch_config": "完善间隔层、过程层交换机。",
    "protection_config": "本期主变电气量保护双重化配置，非电量保护单套配置，每套电气量保护均具有完整的主、后备保护功能。",
    "MV_LV_equipment_config": "本期10kV线路、分段、接地变、无功补偿装置各配置保护测控装置1套，其中分段配置备自投装置。",
    "online_monitoring": "本期新增一次设备状态监测系统1套，包含GIS绝缘气体密度监测、避雷器泄漏电流监测、开关触头测温等功能。",
    "Miscellaneous": "本期新增装配式消防水池1座，新增消防设施。",
    "hint": "1. 主变为利旧搬迁设备（景区2号主变），需注意设备状态评估和运输方案确认；2. 110kV母线保护本期不新增，维持现状；3. 10kV母线保护通过主变后备保护实现，未配置独立母线保护。"
}
2025-08-12 12:37:16.406 | DEBUG    | my_mcp_tools.mcp_tools:write_review_doc:994 - 评审意见输出目标2025/黄河3号主变扩建工程初设外审
2025-08-12 12:37:16.462 | INFO     | core.session:update_opened_file:310 - 用户 'admin' 已打开文件 '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/过程文件/评审意见草稿/（二次）黄河3号主变扩建工程评审意见.docx' (token: a10e7a6730d84edb8216aba1f9b93cf8), 有效期至: Tue Aug 12 20:37:16 2025
2025-08-12 12:37:16.463 | INFO     | my_mcp_tools.mcp_tools:write_review_doc:1025 - 成功生成评审意见文档: /media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/过程文件/评审意见草稿/（二次）黄河3号主变扩建工程评审意见.docx
2025-08-12 12:37:16.469 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:kimi-k2-0711-preview
2025-08-12 12:37:16.487 | DEBUG    | api.kkfileview:kkfileview_preview_encoder_proxy:31 - 用户 'admin' 请求预览文件，原始 kkFileView 目标 URL (来自前端): http://host.docker.internal:8888/download/a10e7a6730d84edb8216aba1f9b93cf8/（二次）黄河3号主变扩建工程评审意见.docx
2025-08-12 12:37:16.493 | WARNING  | api.route:download_file_via_token:182 - 下载请求中URL文件名 '（二次）黄河3号主变扩建工程评审意见_70fd80e3.docx' 与Token关联文件名 '（二次）黄河3号主变扩建工程评审意见.docx' 不匹配。将使用Token关联文件名。
2025-08-12 12:37:16.493 | DEBUG    | api.route:download_file_via_token:193 - Token 'a10e7a6730d84edb8216aba1f9b93cf8' 验证成功。准备下载文件: '（二次）黄河3号主变扩建工程评审意见.docx' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/过程文件/评审意见草稿/（二次）黄河3号主变扩建工程评审意见.docx', URL文件名: '（二次）黄河3号主变扩建工程评审意见_70fd80e3.docx')
2025-08-12 12:37:19.031 | DEBUG    | database.document_service:_debounced_update_loop:449 - 开始批量更新 1 个文件...位于目录{'/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/过程文件/评审意见草稿/（二次）黄河3号主变扩建工程评审意见.docx': 1754973436.4626727}
2025-08-12 12:37:19.033 | INFO     | database.document_service:_debounced_update_loop:468 - 已更新至数据库
2025-08-12 12:37:33.005 | DEBUG    | api.route:search_project_files:319 - 在 /api/projects/search 中，用户 'admin' 的WebSocket连接状态: connected=True, websocket_obj_exists=True
2025-08-12 12:37:33.005 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') LIKE ? with params: ['项目文件', '%黄河%']
2025-08-12 12:37:33.006 | DEBUG    | api.route:search_project_files:332 - find_params={'document_type': '项目文件', 'project_name': '%黄河%'}, find_document nums:39
2025-08-12 12:37:33.007 | INFO     | api.route:search_project_files:357 - len(project_list) == 1
2025-08-12 12:37:33.007 | DEBUG    | database.document_service:_db_query:535 - 执行数据库查询: SELECT * FROM indexed_files WHERE document_type = ? AND json_extract(metadata, '$.project_name') = ? with params: ['项目文件', '黄河3号主变扩建工程初设外审']
2025-08-12 12:37:33.008 | DEBUG    | api.route:search_project_files:369 - 即将为用户 'admin' 更新工作目录 '2025/黄河3号主变扩建工程初设外审'，包含 39 个文件。
2025-08-12 12:37:33.008 | INFO     | core.session:update_opened_dir:379 - 用户 'admin' 的工作目录已更新为 '2025/黄河3号主变扩建工程初设外审'，包含 39 个文件。
2025-08-12 12:37:33.008 | INFO     | core.session:update_opened_dir:399 - 已向用户 'admin' 发送工作目录更新通知。
2025-08-12 12:37:56.466 | DEBUG    | api.route:download_file_via_token:193 - Token 'a10e7a6730d84edb8216aba1f9b93cf8' 验证成功。准备下载文件: '（二次）黄河3号主变扩建工程评审意见.docx' (路径: '/media/zhouxiang/FC7C74827C743A0A/Projects1/2025/黄河3号主变扩建工程初设外审/过程文件/评审意见草稿/（二次）黄河3号主变扩建工程评审意见.docx', URL文件名: '（二次）黄河3号主变扩建工程评审意见.docx')
2025-08-12 13:38:26.418 | INFO     | core.session:process_inactive_sessions:487 - 检测到 1 个不活动会话，将执行登出: admin
2025-08-12 13:38:26.418 | INFO     | core.session:process_inactive_sessions:493 - APScheduler: 用户 'admin' (会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe) 因不活动被自动登出。
2025-08-12 13:38:26.418 | INFO     | core.session:process_inactive_sessions:495 - APScheduler: 尝试关闭用户 'admin' 的不活动WebSocket连接。
2025-08-12 13:38:26.434 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 00bcaa9e-584c-41d0-971e-39e9b79e1dbe 用户 admin 断开连接
2025-08-12 13:38:26.434 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 14:56:37.937 | WARNING  | core.auth:verify_active_session:31 - verify_active_session: 用户 'admin'在SessionStateManager中未找到。可能是会话已过期被清理。
2025-08-12 15:38:59.043 | DEBUG    | core.auth:verify_active_session:24 - verify_active_session: HTTP session中缺少用户名或session_id。
2025-08-12 15:39:02.209 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: b1333aac-a721-46b1-9bbe-56b425018e1b, IP: 240e:479:668:3c1c:60eb:9218:7ef0:f2ac) 登录/状态更新成功。
2025-08-12 15:39:02.210 | INFO     | api.route:login:76 - 用户 'admin' (IP: 240e:479:668:3c1c:60eb:9218:7ef0:f2ac, Session: b1333aac-a721-46b1-9bbe-56b425018e1b) 登录成功。
2025-08-12 15:39:02.329 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: b1333aac-a721-46b1-9bbe-56b425018e1b) 的 WebSocket 已连接并关联。
2025-08-12 15:39:02.542 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-12 15:39:26.849 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 15:39:26.850 | INFO     | sse_proxy.sse2websocket1:run:299 - 启动OpenAI转发：用户 admin, 会话 b1333aac-a721-46b1-9bbe-56b425018e1b, 对话ID: ed3bea54-493b-4171-9e44-6a5b9c9b763b, 查询: 找下知识库，PMU的采集单元和处理单元怎么配置的
2025-08-12 15:39:26.850 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:kimi-k2-0711-preview
2025-08-12 15:39:36.170 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': '23', 'type': 'function', 'function': {'name': 'query_specification_knowledge_base', 'arguments': '{"user_query": "PMU采集单元和处理单元配置要求", "knowledge_base_name": "二次"}'}}]
2025-08-12 15:39:36.171 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_specification_knowledge_base with args: {"user_query": "PMU采集单元和处理单元配置要求", "knowledge_base_name": "二次"}
2025-08-12 15:39:36.233 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:254 - 工具调用: query_specification_knowledge_base, 知识库: 二次, 用户查询: 'PMU采集单元和处理单元配置要求...', top_k: 5
2025-08-12 15:39:36.235 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:267 - 正在从 http://127.0.0.1/v1/datasets 获取知识库ID，参数: {'keyword': '二次', 'page': 1, 'limit': 10}
2025-08-12 15:39:37.432 | INFO     | my_mcp_tools.mcp_tools:query_specification_knowledge_base:281 - 成功获取到知识库 '二次' 的ID: eaee81cc-3cb5-4649-89b0-9e702a659131
2025-08-12 15:39:37.432 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:295 - 正在向 http://127.0.0.1/v1/datasets/eaee81cc-3cb5-4649-89b0-9e702a659131/retrieve 发起检索请求。Payload (部分): query='PMU采集单元和处理单元配置要求...', top_k=5
2025-08-12 15:39:38.348 | INFO     | my_mcp_tools.mcp_tools:query_specification_knowledge_base:302 - 从知识库 '二次' 检索到 5 条结果。
2025-08-12 15:39:38.360 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:kimi-k2-0711-preview
2025-08-12 15:39:45.900 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': '52', 'type': 'function', 'function': {'name': 'query_specification_knowledge_base', 'arguments': '{"user_query": "同步相量测量装置 PMU 采集单元 处理单元 配置", "knowledge_base_name": "二次"}'}}]
2025-08-12 15:39:45.900 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_specification_knowledge_base with args: {"user_query": "同步相量测量装置 PMU 采集单元 处理单元 配置", "knowledge_base_name": "二次"}
2025-08-12 15:39:45.945 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:254 - 工具调用: query_specification_knowledge_base, 知识库: 二次, 用户查询: '同步相量测量装置 PMU 采集单元 处理单元 配置...', top_k: 5
2025-08-12 15:39:45.945 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:267 - 正在从 http://127.0.0.1/v1/datasets 获取知识库ID，参数: {'keyword': '二次', 'page': 1, 'limit': 10}
2025-08-12 15:39:46.040 | INFO     | my_mcp_tools.mcp_tools:query_specification_knowledge_base:281 - 成功获取到知识库 '二次' 的ID: eaee81cc-3cb5-4649-89b0-9e702a659131
2025-08-12 15:39:46.041 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:295 - 正在向 http://127.0.0.1/v1/datasets/eaee81cc-3cb5-4649-89b0-9e702a659131/retrieve 发起检索请求。Payload (部分): query='同步相量测量装置 PMU 采集单元 处理单元 配置...', top_k=5
2025-08-12 15:39:46.387 | INFO     | my_mcp_tools.mcp_tools:query_specification_knowledge_base:302 - 从知识库 '二次' 检索到 2 条结果。
2025-08-12 15:39:46.394 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:kimi-k2-0711-preview
2025-08-12 15:39:54.090 | INFO     | sse_proxy.sse2websocket1:_handle_stream:154 - 触发工具调用: [{'id': '82', 'type': 'function', 'function': {'name': 'query_specification_knowledge_base', 'arguments': '{"user_query": "同步相量测量装置 PMU 采集器 集中器 配置要求", "knowledge_base_name": "二次"}'}}]
2025-08-12 15:39:54.090 | INFO     | sse_proxy.sse2websocket1:_execute_tool_calls:190 - 执行工具调用: query_specification_knowledge_base with args: {"user_query": "同步相量测量装置 PMU 采集器 集中器 配置要求", "knowledge_base_name": "二次"}
2025-08-12 15:39:54.144 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:254 - 工具调用: query_specification_knowledge_base, 知识库: 二次, 用户查询: '同步相量测量装置 PMU 采集器 集中器 配置要求...', top_k: 5
2025-08-12 15:39:54.144 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:267 - 正在从 http://127.0.0.1/v1/datasets 获取知识库ID，参数: {'keyword': '二次', 'page': 1, 'limit': 10}
2025-08-12 15:39:54.230 | INFO     | my_mcp_tools.mcp_tools:query_specification_knowledge_base:281 - 成功获取到知识库 '二次' 的ID: eaee81cc-3cb5-4649-89b0-9e702a659131
2025-08-12 15:39:54.230 | DEBUG    | my_mcp_tools.mcp_tools:query_specification_knowledge_base:295 - 正在向 http://127.0.0.1/v1/datasets/eaee81cc-3cb5-4649-89b0-9e702a659131/retrieve 发起检索请求。Payload (部分): query='同步相量测量装置 PMU 采集器 集中器 配置要求...', top_k=5
2025-08-12 15:39:54.510 | INFO     | my_mcp_tools.mcp_tools:query_specification_knowledge_base:302 - 从知识库 '二次' 检索到 2 条结果。
2025-08-12 15:39:54.517 | DEBUG    | sse_proxy.sse2websocket1:_handle_stream:119 - 调用openai_client,model:kimi-k2-0711-preview
2025-08-12 15:40:00.345 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-12 15:40:00.345 | INFO     | sse_proxy.sse2websocket1:run:265 - 会话 b1333aac-a721-46b1-9bbe-56b425018e1b 用户 admin 中止响应流任务
2025-08-12 15:40:00.345 | INFO     | sse_proxy.sse2websocket1:_start:101 - 会话 b1333aac-a721-46b1-9bbe-56b425018e1b 被取消
2025-08-12 16:39:26.418 | INFO     | core.session:process_inactive_sessions:487 - 检测到 1 个不活动会话，将执行登出: admin
2025-08-12 16:39:26.418 | INFO     | core.session:process_inactive_sessions:493 - APScheduler: 用户 'admin' (会话 b1333aac-a721-46b1-9bbe-56b425018e1b) 因不活动被自动登出。
2025-08-12 16:39:26.418 | INFO     | core.session:process_inactive_sessions:495 - APScheduler: 尝试关闭用户 'admin' 的不活动WebSocket连接。
2025-08-12 16:39:26.444 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 b1333aac-a721-46b1-9bbe-56b425018e1b 用户 admin 断开连接
2025-08-12 16:39:26.444 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-13 11:12:43.203 | WARNING  | core.auth:verify_active_session:31 - verify_active_session: 用户 'admin'在SessionStateManager中未找到。可能是会话已过期被清理。
2025-08-13 11:12:47.420 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: 28198e2e-5b97-44c4-9755-0acc6f0a48b6, IP: 240e:478:640:3611:a92e:9b4e:cee6:ed6e) 登录/状态更新成功。
2025-08-13 11:12:47.420 | INFO     | api.route:login:76 - 用户 'admin' (IP: 240e:478:640:3611:a92e:9b4e:cee6:ed6e, Session: 28198e2e-5b97-44c4-9755-0acc6f0a48b6) 登录成功。
2025-08-13 11:12:49.949 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: 28198e2e-5b97-44c4-9755-0acc6f0a48b6) 的 WebSocket 已连接并关联。
2025-08-13 11:12:50.034 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-13 11:40:26.028 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 28198e2e-5b97-44c4-9755-0acc6f0a48b6 用户 admin 断开连接
2025-08-13 11:40:26.028 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-13 11:40:26.028 | INFO     | core.session:disconnect_websocket:108 - 用户 'admin' 的 WebSocket 已断开。
2025-08-13 12:13:26.417 | INFO     | core.session:process_inactive_sessions:487 - 检测到 1 个不活动会话，将执行登出: admin
2025-08-13 12:13:26.417 | INFO     | core.session:process_inactive_sessions:493 - APScheduler: 用户 'admin' (会话 28198e2e-5b97-44c4-9755-0acc6f0a48b6) 因不活动被自动登出。
2025-08-13 14:28:45.320 | WARNING  | core.session:logout_user:160 - 尝试登出不存在或已登出的用户: admin
2025-08-13 14:28:45.320 | INFO     | api.route:logout:87 - HTTP会话已清除 (用户: admin)。
2025-08-13 14:28:45.614 | WARNING  | core.auth:verify_active_session:31 - verify_active_session: 用户 'admin'在SessionStateManager中未找到。可能是会话已过期被清理。
2025-08-13 14:28:49.374 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: 710155c3-1ef7-469b-bb25-c7b16c152c63, IP: 240e:479:8800:4ab8:995e:c2c2:e311:6ae) 登录/状态更新成功。
2025-08-13 14:28:49.374 | INFO     | api.route:login:76 - 用户 'admin' (IP: 240e:479:8800:4ab8:995e:c2c2:e311:6ae, Session: 710155c3-1ef7-469b-bb25-c7b16c152c63) 登录成功。
2025-08-13 14:28:49.611 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: 710155c3-1ef7-469b-bb25-c7b16c152c63) 的 WebSocket 已连接并关联。
2025-08-13 14:28:49.687 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-13 14:58:12.690 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 710155c3-1ef7-469b-bb25-c7b16c152c63 用户 admin 断开连接
2025-08-13 14:58:12.690 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-13 14:58:12.690 | INFO     | core.session:disconnect_websocket:108 - 用户 'admin' 的 WebSocket 已断开。
2025-08-13 15:29:26.417 | INFO     | core.session:process_inactive_sessions:487 - 检测到 1 个不活动会话，将执行登出: admin
2025-08-13 15:29:26.417 | INFO     | core.session:process_inactive_sessions:493 - APScheduler: 用户 'admin' (会话 710155c3-1ef7-469b-bb25-c7b16c152c63) 因不活动被自动登出。
2025-08-14 13:41:19.816 | INFO     | core.session:attempt_login:142 - 用户 'admin' (会话: 79031944-a677-4054-bf68-66d648da92f4, IP: 127.0.0.1) 登录/状态更新成功。
2025-08-14 13:41:19.816 | INFO     | api.route:login:76 - 用户 'admin' (IP: 127.0.0.1, Session: 79031944-a677-4054-bf68-66d648da92f4) 登录成功。
2025-08-14 13:41:19.913 | INFO     | core.session:connect_websocket:93 - 用户 'admin' (会话: 79031944-a677-4054-bf68-66d648da92f4) 的 WebSocket 已连接并关联。
2025-08-14 13:41:20.012 | DEBUG    | sse_proxy.sse2websocket1:run:243 - 获取到的工具列表: ['query_specification_knowledge_base', 'diff_project_file', 'read_project_file', 'query_project_files', 'open_specification_files', 'write_review_doc']
2025-08-14 13:41:30.292 | DEBUG    | core.session:logout_user:152 - 用户 'admin' (会话: 79031944-a677-4054-bf68-66d648da92f4) 已从状态管理器登出。
2025-08-14 13:41:30.292 | DEBUG    | core.session:logout_user:154 - 用户 'admin' 登出时，其WebSocket连接处于活动状态，将尝试关闭。
2025-08-14 13:41:30.293 | INFO     | api.route:logout:87 - HTTP会话已清除 (用户: admin)。
2025-08-14 13:41:30.293 | DEBUG    | sse_proxy.sse2websocket1:run:304 - WebSocket 会话 79031944-a677-4054-bf68-66d648da92f4 用户 admin 断开连接
2025-08-14 13:41:30.293 | DEBUG    | sse_proxy.sse2websocket1:_stop:94 - OpenAIWebSocketProxy._stop stop_event.set()
2025-08-14 13:44:20.225 | INFO     | __main__:combined_lifespan:130 - COMBINED LIFESPAN END - PID: 3176385 - 服务器关闭中...
2025-08-14 13:44:20.225 | INFO     | database.document_service:shutdown:478 - 正在关闭 DocumentQueryService...
2025-08-14 13:44:20.238 | INFO     | database.document_service:shutdown:483 - Watchdog 监控已停止。
2025-08-14 13:44:20.238 | INFO     | database.document_service:shutdown:491 - 后台更新任务已取消。
2025-08-14 13:44:20.242 | INFO     | database.document_service:shutdown:496 - 数据库连接已关闭。
2025-08-14 13:44:20.242 | INFO     | database.document_service:shutdown:498 - DocumentQueryService 已成功关闭。
2025-08-14 13:44:20.242 | INFO     | __main__:combined_lifespan:134 - 统一文档查询服务已关闭。
2025-08-14 13:44:20.243 | INFO     | __main__:combined_lifespan:139 - APScheduler 调度器已关闭。
2025-08-14 13:44:20.243 | INFO     | __main__:combined_lifespan:140 - Custom application resources cleaned up.
