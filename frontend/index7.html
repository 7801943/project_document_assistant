
<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å·¥ä½œå°</title>

    <script type="text/javascript" src="/static/base64.min.js" defer></script>
    <!-- Added from botui.html -->
    <script src="/static/marked.min.js"></script>
    <script src="/static/upload/upload_standard.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <!-- jsTree theme -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.16/themes/default/style.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>

    <div class="app-wrapper">
        <header class="app-header">
            <div class="title-container"> <!-- Title and status in a container -->
                <div class="title"><span id="user-name">æˆ‘</span>çš„å·¥ä½œå°</div>
                <span id="login-status-indicator"></span>
            </div>
            <div class="header-actions">
                <button id="upload-spec-button" class="auth-button login" style="margin-right: 10px;" title="ä¸Šä¼ è§„ç¨‹æ–‡ä»¶">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-arrow-up-fill" viewBox="0 0 16 16">
                        <path d="M8 2a5.53 5.53 0 0 0-3.594 1.342c-.766.66-1.321 1.52-1.464 2.383C1.266 6.095 0 7.555 0 9.318 0 11.366 1.708 13 3.781 13h8.906C14.502 13 16 11.57 16 9.773c0-1.636-1.242-2.969-2.834-3.194C12.923 3.999 10.69 2 8 2m2.354 5.146a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0z"/>
                    </svg>
                    <span style="margin-left: 8px;">ä¸Šä¼ è§„ç¨‹æ–‡ä»¶</span>
                </button>
                <!-- <button id="test-onlyoffice-button" class="auth-button login" style="background-color: #dc3545; margin-right: 10px;" title="æµ‹è¯•OnlyOfficeæ¥å£">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bug-fill" viewBox="0 0 16 16">
                        <path d="M4.978.855a.5.5 0 1 0-.956.29l.41 1.352A5 5 0 0 0 3 5h10a5 5 0 0 0-1.432-2.503l.41-1.352a.5.5 0 1 0-.956-.29l-.291.956A5 5 0 0 0 8 1a5 5 0 0 0-2.731.811z"/>
                        <path d="M13 6v1H8.5v-.03a2 2 0 0 1 1.482-1.862l.434-.174A2 2 0 0 1 12.5 5.97V6zM7.5 7H3V6h1.522a2 2 0 0 1 1.897-1.443l.482-.193A2 2 0 0 1 8.5 5.97V6v1zM13 8v2H8.5v-2zm-5.5 0v2H3V8zm1.146 3.354a.5.5 0 0 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0l1.5-1.5a.5.5 0 0 0-.708-.708L8.5 12.293z"/>
                    </svg>
                    <span style="margin-left: 8px;">æµ‹è¯•æ¥å£</span>
                </button> -->
                <button id="theme-toggle" class="theme-toggle-button" title="åˆ‡æ¢ä¸»é¢˜">
                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m-4.646.354a.5.5 0 0 1-.708 0l-1.414-1.414a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708m9.193 0a.5.5 0 0 1 0-.708l1.414-1.414a.5.5 0 0 1 .708.707l-1.414 1.414a.5.5 0 0 1-.708 0m-9.193-9.193a.5.5 0 0 1-.708-.707l1.414-1.414a.5.5 0 1 1 .707.707L3.354 5.354a.5.5 0 0 1 0-.708M13.646 5.354a.5.5 0 0 1 0 .707L12.232 7.5a.5.5 0 0 1-.707-.707L13.646 5.354a.5.5 0 0 1 .708 0M1.5 8a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2A.5.5 0 0 1 1.5 8m13 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5"/></svg>
                    <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"/></svg>
                </button>
                <a id="auth-button" href="/logout" class="auth-button logout"> <!-- Changed class and added id -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/><path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/></svg>
                    <span id="auth-button-text">ç™»å‡º</span> <!-- Added id -->
                </a>
            </div>
        </header>
        <main class="main-container">
            <div class="left-panel">
                <nav class="tab-navigation" id="tab-navigation-container">
                    <button id="workdir-tab-button" class="tab-button" title="æŸ¥çœ‹å·¥ä½œç›®å½•">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-folder" viewBox="0 0 16 16">
                            <path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996.816l.637 7a1 1 0 0 0 .995.816h10.348a1 1 0 0 0 .995-.816l.637-7A1 1 0 0 0 13.81 4H2.19zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139C1.72 3.72 1.94 4 2.19 4h11.62c.25-1 .47.28.72.28.006.139l.006.139a1 1 0 0 0-1-.981H9.828a1 1 0 0 0-.707-.293z"/>
                        </svg>
                        <span>å·¥ä½œç›®å½•</span>
                    </button>
                    <div id="tab-container"></div>
                </nav>
                <div class="content-viewer" id="content-viewer">
                    <div id="placeholder" class="placeholder" style="display: flex; width: 100%; height: 100%;"><span>è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œé¢„è§ˆ</span></div>
                    <div id="workdir-viewer" style="display: none; height: 100%; padding: 10px; box-sizing: border-box;">
                        <!-- The file tree will be loaded here -->
                    </div>
                </div>
            </div>
            <div id="resizer" class="resizer-overlay">
                <button id="collapse-left" class="panel-toggle floating-btn left-btn" title="éšè—å·¦ä¾§">ã€ˆ</button>
                <button id="collapse-right" class="panel-toggle floating-btn right-btn" title="éšè—å³ä¾§">ã€‰</button>
            </div>
            <div class="right-panel">
                <nav class="tab-navigation" id="right-tab-navigation-container">
                    <button id="chat-tab-button" class="tab-button active" title="AIèŠå¤©">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-robot" viewBox="0 0 16 16">
                            <path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5M3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.6 26.6 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.93.93 0 0 1-.765.935c-.845.147-2.34.346-4.235.346s-3.39-.2-4.235-.346A.93.93 0 0 1 3 9.219z"/>
                            <path d="M4.5 9a.5.5 0 0 0 .5.5h6a.5.5 0 0 0 0-1h-6a.5.5 0 0 0-.5.5M12.292 3.412a.5.5 0 0 1 .208.666l-1.21 2.422a.5.5 0 0 1-.866-.434l1.21-2.422a.5.5 0 0 1 .658-.232m-8.584 0a.5.5 0 0 0 .208.666l1.21 2.422a.5.5 0 0 0 .866-.434l-1.21-2.422a.5.5 0 0 0-.658-.232"/>
                            <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1M3 8a5 5 0 0 1 10 0v1.256A4.5 4.5 0 0 1 8 15a4.5 4.5 0 0 1-5-4.744z"/>
                        </svg>
                        <span>AIåŠ©æ‰‹</span>
                    </button>
                    <button id="onlyoffice-tab-button" class="tab-button" title="åœ¨çº¿ç¼–è¾‘">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                            <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.121l6.813-6.813z"/>
                            <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                        </svg>
                        <span>åœ¨çº¿ç¼–è¾‘</span>
                    </button>
                </nav>
                <div class="content-viewer" id="right-content-viewer">
                    <div id="right-panel-container" style="display: block; width: 100%; height: 100%;">
                        <!-- èŠå¤©ç»„ä»¶å°†åŠ¨æ€åŠ è½½äºæ­¤ -->
                    </div>
                    <div id="onlyoffice-viewer" style="display: none; width: 100%; height: 100%;">
                        <!-- OnlyOffice ç¼–è¾‘å™¨å°†åŠ¨æ€åŠ è½½äºæ­¤ -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Upload Spec Modal Container -->
    <div id="upload-modal-container"></div>

    <!-- jsTree libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.16/jstree.min.js"></script>

<script>
    // --- Global State & DOM Refs from index4.html ---
    const appState = {
        openFiles: {},
        activeFile: null,
        sessionId: null,
        isLoggedIn: false, // æ–°å¢ç™»å½•çŠ¶æ€
        activeView: 'placeholder', // æ–°å¢ï¼šè¿½è¸ªå½“å‰è§†å›¾ 'placeholder', 'iframe', 'workdir'
    };
    // const chatbotIframe = document.getElementById('chatbot-iframe'); // Removed as iframe is replaced
    const tabContainer = document.getElementById('tab-container');
    const workdirTabButton = document.getElementById('workdir-tab-button');
    const placeholder = document.getElementById('placeholder');
    const contentViewer = document.getElementById('content-viewer'); // æ–°å¢ï¼šiframe çš„å®¹å™¨
    const workdirViewer = document.getElementById('workdir-viewer');
    const loginStatusIndicator = document.getElementById('login-status-indicator');
    const authButton = document.getElementById('auth-button');
    const authButtonText = document.getElementById('auth-button-text');
    const leftPanel = document.querySelector('.left-panel'); // è·å–å·¦ä¾§é¢æ¿
    const rightPanel = document.querySelector('.right-panel'); // è·å–å³ä¾§é¢æ¿
    const chatTabButton = document.getElementById('chat-tab-button'); // è·å–èŠå¤©æŒ‰é’®
    const onlyofficeTabButton = document.getElementById('onlyoffice-tab-button'); // æ–°å¢ï¼šè·å–åœ¨çº¿ç¼–è¾‘æŒ‰é’®
    const chatContainer = document.getElementById('right-panel-container'); // è·å–èŠå¤©å®¹å™¨
    const onlyofficeViewer = document.getElementById('onlyoffice-viewer'); // æ–°å¢ï¼šè·å–åœ¨çº¿ç¼–è¾‘è§†å›¾
    const collapseLeftBtn = document.getElementById('collapse-left');
    const collapseRightBtn = document.getElementById('collapse-right');
    let chatSocket = null; // èŠå¤©ä¸“ç”¨çš„ WebSocket
    let current_conversation_id = null; // ç”¨äºè·Ÿè¸ªå½“å‰å¤šè½®å¯¹è¯çš„ID
    // Chat-related DOM elements will be initialized after the component is loaded
    let botui_messageWindow, botui_chatForm, botui_chatInput, botui_sendButton, botui_stopAIButton, botui_newChatButton;
    let isStreaming = false;
    let currentBotMessageElement = null;
    let current_task_id = null;
    let panelState = 'default'; // å¯ä»¥æ˜¯ 'default', 'left-collapsed', 'right-collapsed'
    // ç™»å½•æ¨¡æ€æ¡†ç›¸å…³å…ƒç´ ï¼ˆå·²ç§»é™¤ï¼‰

    // Upload Modal DOM elements are now self-contained in upload_form.html
    // The trigger button is static
    const uploadSpecButton = document.getElementById('upload-spec-button');
    // The hide function needs to be global for the self-contained script to call it
    window.hideUploadModal = hideUploadModal;


    const MAX_WEBSOCKET_RETRIES = 5;
    const WEBSOCKET_RETRY_INTERVAL = 5000;

    let chatWebsocketRetryCount = 0; // æ–°å¢: ç”¨äº chatSocket
    let chatWebsocketRetryTimer = null; // æ–°å¢: ç”¨äº chatSocket

    // --- Theme Management from index4.html (controls everything) ---
    const themeToggle = document.getElementById('theme-toggle'); // This is index4.html's main theme toggle
    const getPreferredTheme = () => localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    const setTheme = (theme) => {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        // The chat component's theme should update automatically via CSS using html[data-theme='dark']
    };

    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        setTheme(currentTheme === 'dark' ? 'light' : 'dark');
    });

    function updatePanelLayout() {
        switch (panelState) {
            case 'left-collapsed':
                // å·¦ä¾§æ”¶èµ· (0%)ï¼Œå³ä¾§å æ»¡ (100%)
                leftPanel.style.flex = '0 0 0%';
                rightPanel.style.flex = '1 1 100%';
                leftPanel.style.visibility = 'hidden';
                rightPanel.style.visibility = 'visible';
                collapseLeftBtn.innerText = 'ã€ˆ'; // æŒ‡å‘å³ï¼Œè¡¨ç¤ºå¯å±•å¼€
                collapseRightBtn.innerText = 'ã€‰'; // æŒ‡å‘å·¦ï¼Œè¡¨ç¤ºå¯æ¢å¤
                break;
            case 'right-collapsed':
                // å³ä¾§æ”¶èµ· (0%)ï¼Œå·¦ä¾§å æ»¡ (100%)
                leftPanel.style.flex = '1 1 100%';
                rightPanel.style.flex = '0 0 0%';
                leftPanel.style.visibility = 'visible';
                rightPanel.style.visibility = 'hidden';
                collapseLeftBtn.innerText = 'ã€ˆ'; // æŒ‡å‘å³ï¼Œè¡¨ç¤ºå¯æ¢å¤
                collapseRightBtn.innerText = 'ã€‰'; // æŒ‡å‘å·¦ï¼Œè¡¨ç¤ºå¯å±•å¼€
                break;
            default: // 'default' çŠ¶æ€, 50%/50%
                leftPanel.style.flex = '1 1 50%';
                rightPanel.style.flex = '1 1 50%';
                leftPanel.style.visibility = 'visible';
                rightPanel.style.visibility = 'visible';
                collapseLeftBtn.innerText = 'ã€ˆ'; // æŒ‡å‘å·¦ï¼Œè¡¨ç¤ºå¯æ”¶ç¼©
                collapseRightBtn.innerText = 'ã€‰'; // æŒ‡å‘å³ï¼Œè¡¨ç¤ºå¯æ”¶ç¼©
                break;
        }
        // è§¦å‘ resize äº‹ä»¶ï¼Œé€šçŸ¥éœ€è¦JSè®¡ç®—å°ºå¯¸çš„ç»„ä»¶ï¼ˆå¦‚ç¼–è¾‘å™¨ã€å›¾è¡¨ï¼‰æ›´æ–°å…¶å¸ƒå±€
        window.dispatchEvent(new Event('resize'));
    }

    collapseLeftBtn.addEventListener('click', () => {
        // å¦‚æœå½“å‰æ˜¯50/50ï¼Œåˆ™æ”¶èµ·å·¦è¾¹
        // å¦‚æœå½“å‰æ˜¯ä»»ä½•ä¸€ç§æ”¶èµ·çŠ¶æ€ï¼Œéƒ½æ¢å¤ä¸º50/50
        panelState = (panelState === 'default') ? 'left-collapsed' : 'default';
        updatePanelLayout();
    });

    collapseRightBtn.addEventListener('click', () => {
        // å¦‚æœå½“å‰æ˜¯50/50ï¼Œåˆ™æ”¶èµ·å³è¾¹
        // å¦‚æœå½“å‰æ˜¯ä»»ä½•ä¸€ç§æ”¶èµ·çŠ¶æ€ï¼Œéƒ½æ¢å¤ä¸º50/50
        panelState = (panelState === 'default') ? 'right-collapsed' : 'default';
        updatePanelLayout();
    });
    // --- Viewer Logic from index4.html ---
    function showViewer(type, filename) {
        appState.activeView = type;

        // éšè—æ‰€æœ‰ä¸»è§†å›¾åŒºåŸŸ
        placeholder.style.display = 'none';
        workdirViewer.style.display = 'none';
        contentViewer.querySelectorAll('iframe').forEach(frame => frame.style.display = 'none');

        // æ˜¾ç¤ºæŒ‡å®šçš„è§†å›¾
        if (type === 'placeholder') {
            placeholder.style.display = 'flex';
            placeholder.querySelector('span').textContent = filename; // filename is now the message
        } else if (type === 'workdir') {
            workdirViewer.style.display = 'block';
        } else if (type === 'iframe' && filename) { // Both markdown and others use iframe now
            const frame = contentViewer.querySelector(`iframe[data-filename="${filename}"]`);
            if (frame) {
                frame.style.display = 'block';
            } else {
                placeholder.style.display = 'flex';
                placeholder.querySelector('span').textContent = `æ­£åœ¨åŠ è½½ ${filename}...`;
            }
        }

        // æ›´æ–°å·¥ä½œç›®å½•æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
        workdirTabButton.classList.toggle('active', type === 'workdir');

        // å¦‚æœä¸æ˜¯æŸ¥çœ‹æ–‡ä»¶ï¼Œåˆ™æ¸…é™¤æ–‡ä»¶æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
        if (type !== 'iframe') {
            if (appState.activeFile) {
                appState.activeFile = null;
                renderTabs();
            }
        }
    }

    function viewFile(filename) {
        const file = appState.openFiles[filename];
        if (!file) {
            console.error(`Attempting to view a non-existent file: ${filename}`);
            showViewer('placeholder', `æ— æ³•æ‰¾åˆ°æ–‡ä»¶ ${filename} çš„æ•°æ®ã€‚`);
            return;
        }

        if (file.type === 'markdown') {
            viewMarkdownFile(filename);
        } else {
            viewIframeFile(filename);
        }
    }

    async function viewMarkdownFile(filename) {
        const file = appState.openFiles[filename];
        appState.activeFile = filename;
        renderTabs();

        showViewer('iframe', filename); // Markdownä¹Ÿä½¿ç”¨iframe

        let frame = contentViewer.querySelector(`iframe[data-filename="${filename}"]`);
        if (!frame) {
            console.log(`Creating new iframe for Markdown: ${filename}`);
            try {
                const justTheFilename = filename.substring(filename.lastIndexOf('/') + 1);
                const fileDownloadUrl = `/download/${file.token}/${encodeURIComponent(justTheFilename)}`;

                // å°†ä¸‹è½½é“¾æ¥ä½œä¸ºå‚æ•°ä¼ é€’ç»™ markdown.html
                const previewUrl = `/static/markdown.html?fileUrl=${encodeURIComponent(fileDownloadUrl)}`;

                const newFrame = document.createElement('iframe');
                newFrame.dataset.filename = filename;
                newFrame.style.cssText = 'width: 100%; height: 100%; border: none; display: none;';
                newFrame.src = previewUrl;
                contentViewer.appendChild(newFrame);

            } catch (error) {
                console.error(`Error preparing markdown preview for "${filename}":`, error);
                showViewer('placeholder', `å‡†å¤‡Markdowné¢„è§ˆ "${filename}" å‡ºé”™: ${error.message}`);
                return;
            }
        }
        showViewer('iframe', filename);
        console.log(`Displaying iframe for markdown: ${filename}`);
    }

    function viewIframeFile(filename) {
        const file = appState.openFiles[filename];
        appState.activeFile = filename;
        renderTabs();

        showViewer('iframe', filename);

        let frame = contentViewer.querySelector(`iframe[data-filename="${filename}"]`);
        if (!frame) {
            console.log(`Creating new iframe for: ${filename}`);
            try {
                const fastapiBaseUrl = window.location.origin;
                //const justTheFilename = filename.substring(filename.lastIndexOf('/') + 1);
                // æ³¨æ„ï¼šè¿™é‡Œçš„ä¸‹è½½URLæ˜¯ç»™kkfileviewä»£ç†çš„ï¼Œå®ƒéœ€è¦ä¸€ä¸ªå®Œæ•´çš„URL
                const justTheFilename = filename.substring(filename.lastIndexOf('/') + 1);
                const fileDownloadUrl = `http://host.docker.internal:8888/download/${file.token}/${encodeURIComponent(justTheFilename)}`;

                // 3. æ„é€ æŒ‡å‘åç«¯ kkFileView ä»£ç†çš„ URL
                //    åç«¯ä»£ç†æ˜¯ /api/v1/kkfileview/onlinePreview
                //    å®ƒæœŸæœ›ä¸€ä¸ª file_url å‚æ•°ï¼Œå…¶å€¼æ˜¯ä¸Šé¢æ„é€ çš„ fileDownloadUrl
                //    æ ¹æ®æ‚¨çš„åé¦ˆå’Œ forward_test.html çš„æ³¨é‡Šï¼ŒfileDownloadUrl åœ¨è¿™é‡Œä¸åº”å†æ¬¡è¢« encodeURIComponent
                const previewProxyUrl = `${fastapiBaseUrl}/kkfileview/onlinePreview?file_url=${fileDownloadUrl}`;
                console.log(`[KKFileView] è¯·æ±‚é¢„è§ˆä»£ç† (iframe.src): ${previewProxyUrl} ,ä¼ é€’ç»™ä»£ç†çš„ file_url å‚æ•°å€¼: ${fileDownloadUrl}`);

                const newFrame = document.createElement('iframe');
                newFrame.dataset.filename = filename;
                newFrame.style.cssText = 'width: 100%; height: 100%; border: none; display: none;';
                newFrame.src = previewProxyUrl;
                contentViewer.appendChild(newFrame);
            } catch (error) {
                console.error(`Error preparing file preview for "${filename}":`, error);
                showViewer('placeholder', `å‡†å¤‡æ–‡ä»¶é¢„è§ˆ "${filename}" å‡ºé”™: ${error.message}`);
                return;
            }
        }
        showViewer('iframe', filename);
        console.log(`Displaying iframe for: ${filename}`);
    }

    // --- OnlyOffice ç¼–è¾‘å™¨é€»è¾‘ (ç”Ÿäº§ç‰ˆæœ¬) ---
    function openFileInOnlyOffice(filePath, fileToken) {
        try {
            // 1. åˆ‡æ¢åˆ°åœ¨çº¿ç¼–è¾‘è§†å›¾
            showRightPanelView('onlyoffice');

            // 2. å‡†å¤‡å¹¶åŠ è½½ iframeï¼Œå°†æ–‡ä»¶è·¯å¾„å’Œtokenä½œä¸ºå‚æ•°ä¼ é€’
            const editorUrl = `/onlyoffice/editor?filepath=${encodeURIComponent(filePath)}&token=${encodeURIComponent(fileToken)}`;

            // ç§»é™¤æ—§çš„ç¼–è¾‘å™¨ iframe (å¦‚æœæœ‰)
            const existingFrame = onlyofficeViewer.querySelector('iframe');
            if (existingFrame) {
                existingFrame.remove();
            }

            // åˆ›å»ºæ–°çš„ iframe
            const iframe = document.createElement('iframe');
            iframe.src = editorUrl;
            iframe.style.cssText = 'width: 100%; height: 100%; border: none;';
            iframe.title = `åœ¨çº¿ç¼–è¾‘ - ${filePath}`;

            onlyofficeViewer.appendChild(iframe);
            console.log(`Loading OnlyOffice editor for ${filePath} via URL: ${editorUrl}`);

        } catch (error) {
            console.error(`æ‰“å¼€ OnlyOffice ç¼–è¾‘å™¨å¤±è´¥ for ${filePath}:`, error);
            alert(`æ— æ³•æ‰“å¼€åœ¨çº¿ç¼–è¾‘å™¨: ${error.message}`);
            showRightPanelView('chat');
        }
    }

    // --- æ–°å¢ï¼šç›´æ¥æµ‹è¯•åç«¯ /test_button_clicked æ¥å£çš„å‡½æ•° ---
    async function testOnlyOfficeEditor() { // ä¿®æ”¹ä¸º async å‡½æ•°
        console.log("æ­£åœ¨è°ƒç”¨åç«¯ /test_button_clicked ç«¯ç‚¹...");
        try {
            const response = await fetch('/test_button_clicked'); // å‘é€ GET è¯·æ±‚
            if (response.ok) {
                const text = await response.text(); // è·å–å“åº”æ–‡æœ¬
                console.log("åç«¯ /test_button_clicked ç«¯ç‚¹è¿”å›æˆåŠŸ:");
                console.log(text); // æ‰“å°åˆ°æ§åˆ¶å°
            } else {
                const errorText = await response.text();
                console.error("åç«¯ /test_button_clicked ç«¯ç‚¹è¿”å›é”™è¯¯:", response.status, errorText);
                alert(`æµ‹è¯•æŒ‰é’®ç‚¹å‡»å¤±è´¥: ${response.status} - ${errorText}`);
            }
        } catch (error) {
            console.error("è°ƒç”¨åç«¯ /test_button_clicked ç«¯ç‚¹æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯:", error);
            alert(`æµ‹è¯•æŒ‰é’®ç‚¹å‡»å¤±è´¥: ç½‘ç»œé”™è¯¯ - ${error.message}`);
        }
        // ç§»é™¤ä¸ OnlyOffice ç›¸å…³çš„è§†å›¾åˆ‡æ¢å’Œ iframe é€»è¾‘ï¼Œå› ä¸ºåªæ˜¯æµ‹è¯•æ¥å£
        // showRightPanelView('chat'); // ä¿æŒåœ¨èŠå¤©è§†å›¾æˆ–ä¸åˆ‡æ¢è§†å›¾
    }

    // --- Tab Management Logic from index4.html ---
    function renderTabs() {
        tabContainer.innerHTML = '';
        const openFilenames = Object.keys(appState.openFiles);
        openFilenames.forEach(filename => {
            const file = appState.openFiles[filename];
            const button = document.createElement('button');
            button.className = 'tab-button';
            button.dataset.filename = filename;
            // æ–°å¢ï¼šå°†å®Œæ•´è·¯å¾„ä½œä¸º tooltip
            button.title = filename;
            if (filename === appState.activeFile) button.classList.add('active');
            const icon = window.ICONS[file.format] || window.ICONS.default;
            // æ–°å¢ï¼šä»å®Œæ•´è·¯å¾„ä¸­æå–æ–‡ä»¶å
            const shortFilename = filename.substring(filename.lastIndexOf('/') + 1);
            button.innerHTML = `${icon}<span>${shortFilename}</span><span class="close-tab" title="å…³é—­æ ‡ç­¾é¡µ">&times;</span>`;
            button.addEventListener('click', (e) => {
                if (e.target.classList.contains('close-tab')) return;
                viewFile(filename);
            });
            button.querySelector('.close-tab').addEventListener('click', (e) => {
                e.stopPropagation();
                closeTab(filename);
            });
            tabContainer.appendChild(button);
        });
        const activeTab = tabContainer.querySelector('.active');
        if (activeTab) {
            activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    }

    function closeTab(filename) {
        const file = appState.openFiles[filename];
        if (file) {
            // æ‰€æœ‰æ–‡ä»¶ç±»å‹éƒ½ä½¿ç”¨iframe
            const frame = contentViewer.querySelector(`iframe[data-filename="${filename}"]`);
            if (frame) {
                frame.remove();
                console.log(`Removed iframe for: ${filename}`);
            }

            delete appState.openFiles[filename];

            if (appState.activeFile === filename) {
                const remainingFiles = Object.keys(appState.openFiles);
                if (remainingFiles.length > 0) {
                    const newActiveFile = remainingFiles[remainingFiles.length - 1];
                    viewFile(newActiveFile);
                } else {
                    appState.activeFile = null;
                    showViewer('placeholder', 'æ‰€æœ‰æ–‡ä»¶éƒ½å·²å…³é—­ã€‚');
                }
            }
            renderTabs();
            updateWorkdirButtonStates();
        }
    }

    // --- WebSocket Logic for Chat ---
    function connectChatWebSocket() {
        if (!appState.sessionId) {
            console.error("æ— æ³•è¿æ¥èŠå¤©WebSocketï¼šç¼ºå°‘session_idã€‚");
            return;
        }
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        // æ–°çš„èŠå¤©WebSocketç«¯ç‚¹
        //
        const chatWsUrl = `${protocol}//${window.location.host}/ws/v2/chat?session_id=${appState.sessionId}`;
        //const chatWsUrl = `${protocol}//${window.location.host}/ws_chat_stream?session_id=${appState.sessionId}`;
        console.log(`æ­£åœ¨è¿æ¥åˆ°èŠå¤© WebSocket: ${chatWsUrl}`);
        chatSocket = new WebSocket(chatWsUrl);

        chatSocket.onopen = () => {
            console.log("èŠå¤©WebSocket è¿æ¥å·²å»ºç«‹ã€‚");
            chatWebsocketRetryCount = 0;
            clearTimeout(chatWebsocketRetryTimer);
        };

        chatSocket.onmessage = (event) => {
            // console.debug("æ”¶åˆ°èŠå¤©WebSocketæ¶ˆæ¯:", event.data);
            try {
                const message = JSON.parse(event.data);
                if (message.type === 'chat_event_batch' && message.payload && Array.isArray(message.payload)) {
                    if (!isStreaming) return; // ç«‹å³åœæ­¢å¤„ç†æ¶ˆæ¯
                    message.payload.forEach(eventData => {
                        // console.debug("å¤„ç†èŠå¤©äº‹ä»¶:", eventData);

                        // Bug 2 ä¿®å¤ï¼šæ›´æ—©åœ°æ•è· task_id å¹¶å¯ç”¨åœæ­¢æŒ‰é’®
                        // æ— è®ºäº‹ä»¶ç±»å‹å¦‚ä½•ï¼Œåªè¦ task_id å‡ºç°å¹¶ä¸”æˆ‘ä»¬è¿˜æ²¡æœ‰å®ƒï¼Œå°±æ•è·å®ƒ
                        if (eventData.task_id && !current_task_id) {
                            current_task_id = eventData.task_id;
                            console.log("Captured task_id:", current_task_id);
                            botui_stopAIButton.disabled = false; // ç«‹å³å¯ç”¨æŒ‰é’®
                        }

                        if (eventData.answer) {
                            botui_appendToCurrentBotMessage(eventData.answer);
                            // æ­¤å¤„çš„é‡å¤å¯ç”¨é€»è¾‘å·²ç§»è‡³ä¸Šé¢ï¼Œç¡®ä¿åªæ‰§è¡Œä¸€æ¬¡
                        } else if (eventData.event === 'agent_thought') {
                            // task_id çš„æ•è·é€»è¾‘å·²ç§»è‡³ä¸Šæ–¹ï¼Œæ­¤å¤„ä¿ç•™å…¶ä»–é€»è¾‘
                            const summaryParts = [];
                            let contentText = "";
                            if (eventData.thought) {
                                summaryParts.push('æ€è€ƒå†…å®¹');
                                contentText += `æ€è€ƒå†…å®¹: ${eventData.thought}\n`;
                            }
                            if (eventData.tool) {
                                summaryParts.push('è°ƒç”¨å·¥å…·');
                                contentText += `è°ƒç”¨å·¥å…·: ${eventData.tool}\n`;
                                if(eventData.tool_input) contentText += `å·¥å…·è¾“å…¥: ${eventData.tool_input}\n`;
                            }
                            if (eventData.observation) {
                                if (!eventData.tool) summaryParts.push('å·¥å…·ç»“æœ');
                                contentText += `å·¥å…·ç»“æœ: ${eventData.observation}\n`;
                            }
                            if (summaryParts.length > 0 || contentText.trim()) {
                                const summaryText = summaryParts.length > 0 ? summaryParts.join('ã€') : 'Agent æ€è€ƒæ­¥éª¤';
                                // å…ˆç»“æŸå½“å‰çš„æ°”æ³¡
                                botui_finalizeCurrentBotMessage();
                                // å†æ·»åŠ å·¥å…·ä¿¡æ¯
                                // æŠŠå·¥å…·è°ƒç”¨ï¼Œå·¥å…·ç»“æœï¼Œå…¨éƒ¨æ”¾åˆ°ä¸€ä¸ªæŠ˜å æ¡†é‡Œ
                                if(eventData.observation){
                                botui_addCollapsibleMessage(`${summaryText} (ç‚¹å‡»å±•å¼€)`, contentText.trim());
                                }
                            }
                        } else if (eventData.event === 'message_end') {
                            if (eventData.conversation_id) botui_conversation_id = eventData.conversation_id;
                            botui_finalizeCurrentBotMessage();
                            current_task_id = null; // Clear task_id as stream ended
                            botui_stopAIButton.disabled = true; // Disable button
                            botui_sendButton.disabled = false; // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                        } else if (eventData.conversation_id) {
                            botui_conversation_id = eventData.conversation_id;
                        }
                    });
                } else if (message.type === 'stop_request_processed') {
                    console.log("Stop request processed by server:", message);
                    botui_addMessage(`<i>å·²å‘é€åœæ­¢æŒ‡ä»¤ (ä»»åŠ¡: ${message.task_id}, çŠ¶æ€: ${message.status})</i>`, 'bot');
                    if (message.status === 'success') {
                        // Stream should stop via Dify, message_end will handle UI cleanup
                        // botui_stopAIButton.style.display = 'none'; // Handled by message_end
                        // current_task_id = null; // Handled by message_end
                    }
                    botui_stopAIButton.disabled = true; // åœæ­¢æŒ‰é’®åº”è¢«ç¦ç”¨ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡æµå¼€å§‹
                    botui_sendButton.disabled = false; // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                } else if (message.type === 'error') {
                    console.error("èŠå¤©WebSocketæ”¶åˆ°é”™è¯¯æ¶ˆæ¯:", message.content, message.details || '');
                    botui_addMessage(`ğŸ˜¥ **èŠå¤©æœåŠ¡å™¨é”™è¯¯**: ${message.content}${message.details ? ` (${message.details})` : ''}`, 'bot');
                    botui_finalizeCurrentBotMessage();
                    current_task_id = null;
                    botui_stopAIButton.disabled = true; // Disable button
                    botui_sendButton.disabled = false; // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                } else if (message.type === 'file_open_request' && message.payload) { // æ–°å¢å¯¹ file_open_request çš„å¤„ç†
                    console.log("èŠå¤©WebSocketæ”¶åˆ° file_open_request:", message.payload);
                    handleFileOpenRequest(message.payload); // å¤ç”¨ç°æœ‰çš„å¤„ç†å‡½æ•°
                } else if (message.type === 'directory_update' && message.payload) {
                    console.log("èŠå¤©WebSocketæ”¶åˆ° directory_update:", message.payload);
                    handleDirectoryUpdate(message.payload);
                } else {
                    console.warn("æ”¶åˆ°æœªçŸ¥çš„èŠå¤©WebSocketæ¶ˆæ¯ç±»å‹:", message);
                }
            } catch (e) {
                console.error("å¤„ç†èŠå¤©WebSocketæ¶ˆæ¯æ—¶å‡ºé”™:", e, "åŸå§‹æ•°æ®:", event.data);
            }
        };

        chatSocket.onclose = (event) => {
            console.warn(`èŠå¤©WebSocket è¿æ¥å·²å…³é—­ã€‚ä»£ç : ${event.code}, åŸå› : '${event.reason}'`);
            clearTimeout(chatWebsocketRetryTimer);

            // Bug 3: å¦‚æœæ˜¯æœåŠ¡å™¨å› ä¸º session_id æ— æ•ˆè€Œä¸»åŠ¨å…³é—­ï¼Œåˆ™ä¸é‡è¿
            if (event.code === 1008 || event.code === 1011) {
                console.error(`æœåŠ¡å™¨å…³é—­è¿æ¥ (ä»£ç : ${event.code})ï¼ŒåŸå› : "${event.reason}"ã€‚åœæ­¢é‡è¿ã€‚`);
                botui_addMessage(`ä¸æœåŠ¡å™¨çš„è¿æ¥å·²æ–­å¼€: ${event.reason} è¯·å°è¯•é‡æ–°ç™»å½•ã€‚`, 'bot');
                updateLoginStatusUI(false); // æ›´æ–°UIåˆ°æœªç™»å½•çŠ¶æ€ï¼Œä»¥æç¤ºç”¨æˆ·é‡æ–°ç™»å½•
                return; // æ˜ç¡®é˜»æ­¢åç»­çš„é‡è¿é€»è¾‘
            }

            if (event.code === 1000 || event.code === 1001 || event.code === 1005) {
                console.log(`èŠå¤©WebSocket normally closed. Code: ${event.code}, Reason: '${event.reason}'`);
                if (appState.isLoggedIn) {
                    console.warn("èŠå¤©WebSocket closed normally but unexpectedly while logged in.");
                    handleChatWebSocketDisconnect(); // è°ƒç”¨æ–°çš„å¤„ç†å‡½æ•°
                }
                return;
            }
            console.warn(`èŠå¤©WebSocket abnormally closed. Code: ${event.code}, Reason: '${event.reason}'`);
            handleChatWebSocketDisconnect(); // è°ƒç”¨æ–°çš„å¤„ç†å‡½æ•°
        };

        chatSocket.onerror = (error) => {
            console.error("èŠå¤©WebSocket å‘ç”Ÿé”™è¯¯:", error);
            if (chatSocket) chatSocket.close();
        };
    }


    function handleFileOpenRequest(fileInfo) {
        const { filename, download_token, format } = fileInfo;
        const isMarkdown = filename.toLowerCase().endsWith('.md') || filename.toLowerCase().endsWith('.markdown');
        // æ³¨æ„ï¼šè¿™é‡Œçš„é€»è¾‘ä¸å†éœ€è¦ï¼Œå› ä¸ºâ€œæ‰“å¼€â€æŒ‰é’®ç°åœ¨ç”¨äºé¢„è§ˆï¼Œâ€œç¼–è¾‘â€æŒ‰é’®ç”¨äºç¼–è¾‘
        // const isOfficeDoc = ['docx', 'xlsx', 'pptx', 'doc', 'xls', 'ppt'].includes(format);

        // if (isOfficeDoc) {
        //     openFileInOnlyOffice(filename, download_token);
        //     return;
        // }

        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²åœ¨æ‰“å¼€çš„æ ‡ç­¾é¡µä¸­
        if (appState.openFiles[filename]) {
            console.log(`File ${filename} is already open. Switching to its tab.`);
            viewFile(filename); // åˆ‡æ¢åˆ°å·²æœ‰çš„æ ‡ç­¾é¡µ
        } else {
            // å¦‚æœæ–‡ä»¶æœªæ‰“å¼€ï¼Œåˆ™æ·»åŠ åˆ°çŠ¶æ€å¹¶æŸ¥çœ‹
            console.log(`Opening new file: ${filename}`);
            appState.openFiles[filename] = {
                format: format,
                token: download_token,
                type: isMarkdown ? 'markdown' : 'iframe' // å¢åŠ ç±»å‹åŒºåˆ†
            };
            viewFile(filename);
        }
        // æ— è®ºæ–‡ä»¶æ˜¯æ–°æ‰“å¼€è¿˜æ˜¯å·²æ‰“å¼€ï¼Œéƒ½æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateWorkdirButtonStates();
    }

    function updateWorkdirButtonStates() {
        if (window.WorkdirManager) {
            window.WorkdirManager.updateNodeStates(appState.openFiles);
        }
    }

    // å¤„ç†ç›®å½•æ›´æ–°
    function handleDirectoryUpdate(payload) {
        if (window.WorkdirManager) {
            window.WorkdirManager.updateData(payload);
        }
        showViewer('workdir');
    }

    // --- Upload Modal Logic (Simplified for Self-Contained Component) ---
    async function showUploadModal() {
        if (!appState.isLoggedIn) {
            alert("è¯·å…ˆç™»å½•å†ä¸Šä¼ æ–‡ä»¶ã€‚");
            window.location.href = '/static/login.html';
            return;
        }

        const modalContainer = document.getElementById('upload-modal-container');

        // å¦‚æœæ¨¡æ€æ¡†çš„ HTML è¿˜æ²¡åŠ è½½ï¼Œåˆ™åŠ è½½å®ƒ
        if (modalContainer.innerHTML.trim() === '') {
            try {
                const templateResponse = await fetch('/static/upload/upload_standard.html');
                if (!templateResponse.ok) {
                    throw new Error(`æ— æ³•åŠ è½½ä¸Šä¼ è¡¨å•æ¨¡æ¿: ${templateResponse.statusText}`);
                }
                modalContainer.innerHTML = await templateResponse.text();

                // ä¸ºæ–°åŠ è½½çš„æ¨¡æ€æ¡†ç»‘å®šå…³é—­äº‹ä»¶
                const modal = document.getElementById('upload-spec-modal');
                const closeButton = modal.querySelector('.modal-close-button');
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) hideUploadModal();
                });
                if(closeButton) {
                    closeButton.addEventListener('click', hideUploadModal);
                }

                // JS è„šæœ¬ (standard_upload.js) ä¼šè‡ªåŠ¨åˆå§‹åŒ–è¡¨å•
                // æ‰‹åŠ¨è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
                if (typeof initStandardUploadForm === 'function') {
                    initStandardUploadForm();
                } else {
                    console.error('initStandardUploadForm function not found.');
                }

            } catch (error) {
                console.error('æ˜¾ç¤ºä¸Šä¼ æ¨¡å—å¤±è´¥:', error);
                alert(`é”™è¯¯: ${error.message}`);
                modalContainer.innerHTML = ''; // æ¸…ç†ä»¥å¤‡é‡è¯•
                return; // å‡ºé”™åˆ™ä¸ç»§ç»­
            }
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = modalContainer.querySelector('#upload-spec-modal');
        if (modal) {
            modal.style.display = 'flex';
        }
    }

    function hideUploadModal() {
        const modalContainer = document.getElementById('upload-modal-container');
        const modal = modalContainer.querySelector('#upload-spec-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    function hideLoginModal() {
        // ä¸ºå…¼å®¹æ€§ä¿ç•™ï¼Œä½†ç°åœ¨ä¸åšä»»ä½•äº‹
    }

    // --- UI Update for Login Status ---
    function updateLoginStatusUI(isLoggedIn) {
        appState.isLoggedIn = isLoggedIn;
        if (isLoggedIn) {
            loginStatusIndicator.textContent = 'ï¼ˆå·²ç™»å½•ï¼‰';
            authButtonText.textContent = 'ç™»å‡º';
            authButton.href = '/logout'; // Standard logout link
            authButton.classList.remove('login');
            authButton.classList.add('logout');
            authButton.onclick = async (e) => { // Handle logout click
                e.preventDefault();
                    const currentSessionId = appState.sessionId; // Store before clearing
                    try {
                        // åç«¯ /logout æ˜¯ GET è¯·æ±‚
                        await fetch('/logout', { method: 'GET' });
                    } catch (error) {
                        console.error("Logout request failed:", error);
                    } finally {
                        appState.sessionId = null; // Clear session ID
                        sessionStorage.removeItem('session_id');
                        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                            chatSocket.close(1000, "User logged out");
                        }
                        chatSocket = null;
                        updateLoginStatusUI(false); // Update UI to logged out state
                        // showViewer('placeholder', 'æ‚¨å·²ç™»å‡ºã€‚è¯·é‡æ–°ç™»å½•ä»¥ç»§ç»­ã€‚');
                    // botui_messageWindow.innerHTML = ''; // Do not clear chat messages
                    // botui_conversation_id = null; // Do not reset conversation
                }
            };
        } else {
            loginStatusIndicator.textContent = 'ï¼ˆæœªç™»å½•ï¼‰';
            authButtonText.textContent = 'ç™»å½•';
            authButton.href = '/static/login.html'; // ç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µé¢
            authButton.classList.remove('logout');
            authButton.classList.add('login');
            authButton.onclick = null; // ç§»é™¤æ—§çš„ onclick äº‹ä»¶å¤„ç†å™¨
            // å†…å®¹ï¼ˆæ ‡ç­¾é¡µã€iframeã€èŠå¤©ï¼‰åœ¨ç™»å‡ºæˆ–æ–­å¼€è¿æ¥æ—¶ä¸ä¼šç«‹å³æ¸…é™¤ã€‚
            // å®ƒä»¬å°†åœ¨æ–°çš„æˆåŠŸç™»å½•åæˆ–é€šè¿‡å…¶ä»–æ“ä½œæ˜ç¡®æ¸…é™¤æ—¶è¿›è¡Œå¤„ç†ã€‚
            showViewer('placeholder', 'è¯·ç™»å½•ä»¥ä½¿ç”¨æˆ‘çš„å·¥ä½œå°ã€‚'); // å ä½ç¬¦ä»ç„¶å¯ä»¥æ›´æ–°
        }
    }

    // --- WebSocket Disconnect Handling for Chat Socket ---
    function handleChatWebSocketDisconnect() {
        console.warn("èŠå¤©WebSocket disconnected or failed to connect.");
        if (chatSocket && (chatSocket.readyState === WebSocket.OPEN || chatSocket.readyState === WebSocket.CONNECTING)) {
            try { chatSocket.close(); } catch(e) { console.warn("Error closing chatSocket:", e); }
        }
        chatSocket = null;

        if (appState.isLoggedIn) {
            if (chatWebsocketRetryCount < MAX_WEBSOCKET_RETRIES) {
                chatWebsocketRetryCount++;
                console.log(`Attempting to reconnect èŠå¤©WebSocket (attempt ${chatWebsocketRetryCount}/${MAX_WEBSOCKET_RETRIES}) in ${WEBSOCKET_RETRY_INTERVAL / 1000} seconds...`);
                clearTimeout(chatWebsocketRetryTimer);
                chatWebsocketRetryTimer = setTimeout(connectChatWebSocket, WEBSOCKET_RETRY_INTERVAL);
            } else {
                console.error(`èŠå¤©WebSocket reconnection failed after ${MAX_WEBSOCKET_RETRIES} attempts.`);
                botui_addMessage("ä¸èŠå¤©æœåŠ¡å™¨çš„è¿æ¥å·²æ–­å¼€ï¼ŒèŠå¤©åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚æ‚¨å¯ä»¥å°è¯•åˆ·æ–°é¡µé¢æˆ–ç¨åé‡è¯•ã€‚", "bot");
            }
        } else {
            console.log("èŠå¤©WebSocket not attempting reconnection as user is not logged in.");
        }
    }

    // --- App Initialization (Revised) ---
    async function checkLoginStatusAndInitialize(isAfterLoginAttempt = false) {
        try {
            const response = await fetch('/api/user/status');
            if (response.ok) {
                const userData = await response.json();
                const previousSessionId = appState.sessionId;
                sessionStorage.setItem('session_id', userData.session_id);
                appState.sessionId = userData.session_id;

                // âœ… è®¾ç½®ç”¨æˆ·ååˆ°æ ‡é¢˜ä¸­
                const userNameSpan = document.getElementById("user-name");
                if (userNameSpan && userData.username) {
                    userNameSpan.textContent = userData.username;
                }

                updateLoginStatusUI(true); // è®¾ç½®ä¸ºå·²ç™»å½•çŠ¶æ€

                if (isAfterLoginAttempt && previousSessionId && previousSessionId !== appState.sessionId) {
                    // If logged in as a new/different user, clear old state
                    console.log("New user session detected after login. Clearing previous state.");
                    appState.openFiles = {};
                    appState.activeFile = null;
                    renderTabs();
                    if (!fileViewerIframe.src.includes('about:blank')) fileViewerIframe.src = 'about:blank';
                    botui_messageWindow.innerHTML = '';
                    botui_conversation_id = null;
                }

                connectChatWebSocket();    // è¿æ¥èŠå¤©ä¸“ç”¨ WebSocket

                if (isAfterLoginAttempt) { // If this was after a successful login
                     showViewer('placeholder', 'ç™»å½•æˆåŠŸï¼æˆ‘çš„å·¥ä½œå°å·²å°±ç»ªã€‚');
                }
            } else if (response.status === 401) {
                // ç”¨æˆ·æœªç™»å½•æˆ–ä¼šè¯æ— æ•ˆï¼Œæ¢å¤ä¸ºUIæ›´æ–°å’Œæ¨¡æ€æ¡†é€»è¾‘
                updateLoginStatusUI(false);
                // ä¸å†é‡å®šå‘ï¼Œè€Œæ˜¯ä¾èµ–UIæç¤ºç”¨æˆ·ç™»å½•
            } else {
                throw new Error(`è·å–ç”¨æˆ·çŠ¶æ€å¤±è´¥: ${response.status}`);
            }
        } catch (error) {
            console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€æˆ–åˆå§‹åŒ–åº”ç”¨æ—¶å‡ºé”™:', error);
            // å‘ç”Ÿé”™è¯¯æ—¶ï¼ŒåŒæ ·æ›´æ–°UIï¼Œè€Œä¸æ˜¯é‡å®šå‘
            updateLoginStatusUI(false);
            botui_addMessage(`æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨è¿›è¡ŒçŠ¶æ€æ£€æŸ¥: ${error.message}`, 'bot');
        }

        // Common initialization steps regardless of login status (e.g., loading non-user-specific resources)
        // Get chatbot API config is now handled within the chat component if needed, or can be passed.
        // For now, we assume the global `dynamic_bot_api_url` and `dynamic_bot_api_key` are sufficient.
        // If these need to be fetched, it should be done before or during chat component initialization.

        if (!isAfterLoginAttempt && !appState.isLoggedIn) {
             showViewer('placeholder', 'è¯·ç™»å½•ä»¥ä½¿ç”¨æˆ‘çš„å·¥ä½œå°ã€‚');
        } else if (!isAfterLoginAttempt && appState.isLoggedIn) {
             // ç™»å½•æˆåŠŸåï¼Œä¸å†æ˜¾ç¤ºâ€œæˆ‘çš„å·¥ä½œå°å·²å°±ç»ªâ€ï¼Œè€Œæ˜¯ç”± init å‡½æ•°ç»Ÿä¸€å¤„ç†
             // showViewer('placeholder', 'æˆ‘çš„å·¥ä½œå°å·²å°±ç»ªã€‚');
        }
        // renderTabs(); // Already called in init
    }

    // --- é¢æ¿åˆ‡æ¢é€»è¾‘ ---
    function toggleRightPanelVisibility() {
        // å¦‚æœå·¦ä¾§é¢æ¿å½“å‰æ˜¯éšè—çš„ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆæ˜¾ç¤ºå®ƒ
        if (leftPanel.classList.contains('hidden')) {
            leftPanel.classList.remove('hidden');
            rightPanel.classList.remove('expanded'); // ç¡®ä¿å³ä¾§æ¢å¤æ­£å¸¸å¤§å°
        }
        // ç°åœ¨ï¼Œåˆ‡æ¢å³ä¾§é¢æ¿çš„å¯è§æ€§
        const isRightHidden = rightPanel.classList.toggle('hidden');
        // æ ¹æ®å³ä¾§é¢æ¿æ˜¯å¦éšè—ï¼Œæ¥å†³å®šæ˜¯å¦å±•å¼€å·¦ä¾§é¢æ¿
        leftPanel.classList.toggle('expanded', isRightHidden);
    }

    function toggleLeftPanelVisibility() {
        // å¦‚æœå³ä¾§é¢æ¿å½“å‰æ˜¯éšè—çš„ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆæ˜¾ç¤ºå®ƒ
        if (rightPanel.classList.contains('hidden')) {
            rightPanel.classList.remove('hidden');
            leftPanel.classList.remove('expanded'); // ç¡®ä¿å·¦ä¾§æ¢å¤æ­£å¸¸å¤§å°
        }
        // ç°åœ¨ï¼Œåˆ‡æ¢å·¦ä¾§é¢æ¿çš„å¯è§æ€§
        const isLeftHidden = leftPanel.classList.toggle('hidden');
        // æ ¹æ®å·¦ä¾§é¢æ¿æ˜¯å¦éšè—ï¼Œæ¥å†³å®šæ˜¯å¦å±•å¼€å³ä¾§é¢æ¿
        rightPanel.classList.toggle('expanded', isLeftHidden);
    }

    // --- å³ä¾§é¢æ¿æ ‡ç­¾é¡µé€»è¾‘ (å…¨å±€ä½œç”¨åŸŸ) ---
    function showRightPanelView(viewName) {
        // éšè—æ‰€æœ‰è§†å›¾
        chatContainer.style.display = 'none';
        onlyofficeViewer.style.display = 'none';

        // æ¿€æ´»å¯¹åº”çš„æŒ‰é’®
        chatTabButton.classList.remove('active');
        onlyofficeTabButton.classList.remove('active');

        // æ˜¾ç¤ºç›®æ ‡è§†å›¾å’Œæ¿€æ´»æŒ‰é’®
        if (viewName === 'chat') {
            chatContainer.style.display = 'block';
            chatTabButton.classList.add('active');
        } else if (viewName === 'onlyoffice') {
            onlyofficeViewer.style.display = 'block';
            onlyofficeTabButton.classList.add('active');
        }

        // å¦‚æœå³ä¾§é¢æ¿æ˜¯éšè—çš„ï¼Œåˆ™æ˜¾ç¤ºå®ƒ
        if (rightPanel.classList.contains('hidden')) {
            toggleRightPanelVisibility();
        }
    }

    async function loadWorkdirViewer() {
        try {
            const response = await fetch('/static/workdir/workdir_viewer.html');
            if (!response.ok) throw new Error('Failed to load workdir viewer HTML');
            const html = await response.text();
            workdirViewer.innerHTML = html;

            const script = document.createElement('script');
            script.src = '/static/workdir/workdir_viewer.js';
            script.onload = () => {
                console.log("WorkdirManager script loaded.");
                if (window.WorkdirManager) {
                    window.WorkdirManager.initialize('#file-tree-container', {
                        open: handleFileOpenRequest,
                        edit: openFileInOnlyOffice,
                        llmRead: (filePath) => {
                            const query = `è¯·è¯»å–æ–‡ä»¶ï¼Œè·¯å¾„æ˜¯ ${filePath}`;
                            botui_addMessage(query, 'user');
                            botui_streamMessageViaWebSocket(query);
                        },
                        // æ–°å¢ï¼šæä¾›ä¸€ä¸ªåˆ·æ–°æ–‡ä»¶åˆ—è¡¨çš„å›è°ƒ
                        refresh: async () => {
                            try {
                                // è¿™ä¸ªè¯·æ±‚ä¼šé€šè¿‡WebSocketè§¦å‘ä¸€ä¸ªdirectory_updateäº‹ä»¶
                                const response = await fetch('/api/projects/search');
                                if (!response.ok) {
                                     throw new Error('Failed to trigger directory refresh');
                                }
                                const data = await response.json();
                                // ç›´æ¥ä½¿ç”¨è¿”å›çš„æ•°æ®æ›´æ–°è§†å›¾
                                if (window.WorkdirManager) {
                                    window.WorkdirManager.updateData(data.files);
                                }
                            } catch (error) {
                                console.error("Failed to refresh workdir:", error);
                                alert("åˆ·æ–°å·¥ä½œç›®å½•å¤±è´¥ã€‚");
                            }
                        }
                    });
                }
            };
            document.body.appendChild(script);
        } catch (error) {
            console.error('Error loading workdir viewer:', error);
            workdirViewer.innerHTML = '<p>Error loading file tree.</p>';
        }
    }

    async function init() {
        setTheme(getPreferredTheme());
        await Promise.all([
            loadChatComponent(),
            loadWorkdirViewer()
        ]);

        // æ–°å¢ï¼šä¸ºçº¢è‰²åŒºåŸŸä¸­çš„æ–°åˆ‡æ¢æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬


        // æµ‹è¯•æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
        const testOnlyOfficeButton = document.getElementById('test-onlyoffice-button');
        if (testOnlyOfficeButton) {
            testOnlyOfficeButton.addEventListener('click', testOnlyOfficeEditor);
        }

        chatTabButton.addEventListener('click', () => showRightPanelView('chat'));
        onlyofficeTabButton.addEventListener('click', () => showRightPanelView('onlyoffice'));

        // é»˜è®¤æ˜¾ç¤ºèŠå¤©è§†å›¾
        showRightPanelView('chat');

        // åˆå§‹åŒ–æ—¶ç”Ÿæˆæˆ–åŠ è½½ conversation_id
        // å¦‚æœ sessionStorage ä¸­æœ‰ï¼Œåˆ™åŠ è½½ï¼›å¦åˆ™ç”Ÿæˆæ–°çš„
        current_conversation_id = sessionStorage.getItem('current_conversation_id') || generateUUID();
        sessionStorage.setItem('current_conversation_id', current_conversation_id);
        console.log("Initial Conversation ID:", current_conversation_id);

        // ä¸ºå·¥ä½œç›®å½•æ ‡ç­¾é¡µæŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        workdirTabButton.addEventListener('click', () => {
            if (appState.activeView !== 'workdir') {
                showViewer('workdir');
            } else {
                // å¦‚æœå½“å‰å·²æ˜¯å·¥ä½œç›®å½•è§†å›¾ï¼Œåˆ™åˆ‡æ¢å›é»˜è®¤å ä½ç¬¦
                showViewer('placeholder', 'æˆ‘çš„å·¥ä½œå°å·²å°±ç»ªã€‚');
            }
        });


        uploadSpecButton.onclick = showUploadModal; // ä¸ºé™æ€ä¸Šä¼ æŒ‰é’®é™„åŠ ç›‘å¬å™¨
        await checkLoginStatusAndInitialize();
        renderTabs(); // åˆå§‹æ ‡ç­¾é¡µæ¸²æŸ“
        updatePanelLayout(); // åˆå§‹åŒ–é¢æ¿å¸ƒå±€

        // æ ¹æ®ç™»å½•çŠ¶æ€å†³å®šé»˜è®¤æ˜¾ç¤ºå“ªä¸ªè§†å›¾
        if (appState.isLoggedIn) {
            showViewer('workdir'); // å¦‚æœå·²ç™»å½•ï¼Œé»˜è®¤æ˜¾ç¤ºå·¥ä½œç›®å½•
        } else {
            showViewer('placeholder', 'è¯·ç™»å½•ä»¥ä½¿ç”¨æˆ‘çš„å·¥ä½œå°ã€‚'); // å¦‚æœæœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æç¤º
        }
    }

    // --- ICONS from index4.html ---
    window.ICONS = {
        pdf: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/><path d="M4.603 14.087a.8.8 0 0 1-1.214-.886l.66-1.98a.52.52 0 0 1 .184-.282l.062-.052.062-.052a.5.5 0 0 1 .736.646l-.119.119a.11.11 0 0 0-.03.076l-.23.69zM5.53 12.042a.51.51 0 0 1 .707.707l-1.464 1.464a.51.51 0 0 1-.707-.707z"/></svg>`,
        docx: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.88 15.84c-.45.08-.91.16-1.38.16H2.5A1.5 1.5 0 0 1 1 14.5V3.5A1.5 1.5 0 0 1 2.5 2H10v2h2v1.5a.5.5 0 0 0 1 0V4h.5a.5.5 0 0 0 .29-.91L11.15.29a.5.5 0 0 0-.85.35V2.5A1.5 1.5 0 0 1 9 1H2.5A2.5 2.5 0 0 0 0 3.5v11A2.5 2.5 0 0 0 2.5 17h6.08c.55 0 1.07-.1 1.55-.27l.5-.27c.45-.25.85-.58 1.17-1a.5.5 0 0 0-.85-.52c-.25.3-.57.54-.9.74l-.5.27Z"/><path d="M16 12h-3a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1m-3-2h3v1h-3z"/></svg>`,
        xlsx: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.18 4.603L1.18 8.603h2.825L8 4.306zm3.593 0L5.18 10.297h2.825L12 5.006zM13.18 4.603L9.18 8.603h2.825L16 4.306zM13.18 10.297L9.18 14.297h2.825L16 9.006z"/><path d="M1.18 8.603a.5.5 0 0 0 .306.491l6.98 3.293a.5.5 0 0 0 .468 0l6.98-3.293a.5.5 0 0 0 .306-.491L9.18 1.497a.5.5 0 0 0-.468 0zM8.944 1.151l6.98 3.293L8.944 7.739 1.964 4.444zM1.964 9.098l6.98 3.293 6.98-3.293-6.98-3.294z"/></svg>`,
        default: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5zM4 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1z"/></svg>`
    };

    // --- Chat Component Loader ---
    async function loadChatComponent() {
        try {
            const response = await fetch('/static/agent-chat/ai_chat_component.html');
            if (!response.ok) throw new Error('Failed to load chat HTML');
            const html = await response.text();
            const chatWrapper = document.getElementById('right-panel-container');
            chatWrapper.innerHTML = html;

            // Now that the HTML is loaded, we can initialize the chat script
            const script = document.createElement('script');
            script.src = '/static/agent-chat/ai_chat.js';
            script.defer = true;
            script.onload = () => {
                console.log("ai_chat.js loaded, initializing DOM elements.");
                if (typeof initializeChatDOMElements === 'function') {
                    initializeChatDOMElements();
                } else {
                    console.error("initializeChatDOMElements function not found after loading script.");
                }
            };
            document.body.appendChild(script);
        } catch (error) {
            console.error('Error loading chat component:', error);
            document.getElementById('right-panel-container').innerHTML = '<p>Error loading chat component.</p>';
        }
    }


    window.addEventListener('load', init);

    // æ–°å¢ï¼šåœ¨æµè§ˆå™¨å…³é—­æˆ–åˆ·æ–°å‰è‡ªåŠ¨ç™»å‡º
    window.addEventListener('beforeunload', function(e) {
        // ä»…å½“ç”¨æˆ·å·²ç™»å½•æ—¶æ‰§è¡Œ
        if (appState.isLoggedIn) {
            // ä½¿ç”¨ fetch çš„ keepalive é€‰é¡¹æ¥ç¡®ä¿è¯·æ±‚åœ¨é¡µé¢å¸è½½æ—¶ä¹Ÿèƒ½å‘é€
            // è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œä½† keepalive ç¡®ä¿å®ƒä¼šå®Œæˆ
            fetch('/logout', {
                method: 'GET',
                keepalive: true
            });
            // æ³¨æ„ï¼šæˆ‘ä»¬åœ¨è¿™é‡Œä¸å¤„ç†UIæ›´æ–°æˆ–æ¸…ç† sessionStorageï¼Œ
            // å› ä¸ºé¡µé¢å³å°†å…³é—­ï¼Œè¿™äº›æ“ä½œæ²¡æœ‰æ„ä¹‰ã€‚
            // sessionStorage ä¼šåœ¨æµè§ˆå™¨å…³é—­æ—¶è‡ªåŠ¨æ¸…é™¤ã€‚
        }
    });

    // UUID ç”Ÿæˆå‡½æ•°ï¼Œç”¨äºå…¼å®¹ä¸æ”¯æŒ crypto.randomUUID çš„ç¯å¢ƒ
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
</script>
</body>
</html>
