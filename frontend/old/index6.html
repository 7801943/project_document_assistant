<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的工作台</title>
    
    <script type="text/javascript" src="/static/base64.min.js" defer></script>
    <!-- Added from botui.html -->
    <script src="/static/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* Styles from index4.html */
        :root, html[data-theme='light'] {
            --primary-color: #0d6efd;
            --bg-color: #e9ecef; /* 明亮模式背景稍微调暗 */
            --rgb-bg-color: 233, 236, 239;
            --panel-color: #f8f9fa; /* 面板颜色也相应调整 */
            --rgb-panel-color: 248, 249, 250;
            --border-color: #dee2e6;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --header-height: 60px;
            
            /* PDF.js viewer variables override */
            --sidebar-width: 250px;
            --toolbar-bg-color: var(--panel-color);
            --toolbar-border-color: var(--border-color);
            --body-bg-color: var(--bg-color); /* pdf.js body-bg-color */
            --page-bg-color: var(--panel-color);
            --main-color: var(--text-primary);
            --sidebar-toolbar-bg-color: var(--bg-color);
            --doorhanger-bg-color: var(--panel-color);
            --doorhanger-border-color: var(--border-color);
            --field-bg-color: var(--bg-color);
            --field-border-color: var(--border-color);
            --toggled-btn-bg-color: var(--primary-color);
        }
        html[data-theme='dark'] {
            --primary-color: #0d6efd;
            --bg-color: #121212; /* index4 dark bg */
            --rgb-bg-color: 18, 18, 18;
            --panel-color: #1e1e1e; /* index4 dark panel */
            --rgb-panel-color: 30, 30, 30;
            --border-color: #343a40;
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.15);

            /* PDF.js viewer variables override */
            --toolbar-bg-color: var(--panel-color);
            --toolbar-border-color: var(--border-color);
            --body-bg-color: var(--bg-color); /* pdf.js body-bg-color */
            --page-bg-color: var(--panel-color);
            --main-color: var(--text-primary);
            --sidebar-toolbar-bg-color: var(--bg-color);
            --doorhanger-bg-color: var(--panel-color);
            --doorhanger-border-color: var(--border-color);
            --field-bg-color: var(--bg-color);
            --field-border-color: var(--border-color);
            --toggled-btn-bg-color: var(--primary-color);
        }
        body, html { /* This body style is from index4.html, botui.html's body style is removed */
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            font-family: "Inter", "Segoe UI", "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif; /* index4 font, botui uses Inter too */
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        .app-wrapper { display: flex; flex-direction: column; height: 100%; }
        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            height: var(--header-height); padding: 0 24px;
            background-color: var(--panel-color);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; transition: background-color 0.3s, border-color 0.3s;
        }
        .app-header .title-container { display: flex; align-items: center; } /* 新增容器 */
        .app-header .title { font-size: 1.25rem; font-weight: 600; }
        #login-status-indicator { margin-left: 15px; font-size: 0.9em; font-weight: 500; color: var(--text-secondary); }
        .header-actions { display: flex; align-items: center; gap: 16px; }
        .theme-toggle-button { /* This is index4.html's theme toggle button */
            background: none; border: 1px solid var(--border-color); color: var(--text-secondary);
            width: 38px; height: 38px; border-radius: 6px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s ease;
        }
        .theme-toggle-button:hover { background-color: var(--bg-color); color: var(--primary-color); }
        .theme-toggle-button .moon-icon { display: none; }
        html[data-theme='dark'] .theme-toggle-button .sun-icon { display: none; }
        html[data-theme='dark'] .theme-toggle-button .moon-icon { display: block; }
        
        .auth-button { /* 原 logout-button，现为 auth-button */
            display: flex; align-items: center; gap: 8px; padding: 8px 16px;
            color: var(--text-secondary); background-color: transparent;
            border: 1px solid var(--border-color); border-radius: 6px;
            text-decoration: none; font-weight: 500; transition: all 0.2s ease;
            cursor: pointer; /* 确保在 JS 控制 href 时仍显示为可点击 */
        }
        .auth-button:hover { background-color: var(--bg-color); color: var(--primary-color); }
        .auth-button.login { border-color: var(--primary-color); color: var(--primary-color); } /* 登录按钮蓝色样式 */
        .auth-button.logout { border-color: #dc3545; color: #dc3545; } /* 登出按钮红色样式 */
        .auth-button.logout:hover { background-color: var(--bg-color); color: #bb2d3b; }


        .main-container { display: flex; height: calc(100vh - var(--header-height)); }
        .left-panel {
            flex: 0 0 65%; display: flex; flex-direction: column;
            background-color: var(--panel-color);
            border-right: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .right-panel { flex: 1 1 auto; display: flex; /* botui container will be child of this */ }
        .tab-navigation {
            display: flex; flex-shrink: 0; overflow-x: auto;
            border-bottom: 1px solid var(--border-color);
            padding: 0 16px; background-color: var(--panel-color);
        }
        .tab-button {
            display: flex; align-items: center; flex-shrink: 0; gap: 8px; padding: 12px 16px;
            cursor: pointer; border: none; border-bottom: 3px solid transparent; background-color: transparent;
            font-size: 15px; color: var(--text-secondary); transition: all 0.2s;
        }
        .tab-button:hover { color: var(--primary-color); }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }
        .close-tab {
            margin-left: 10px; border-radius: 50%; width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; line-height: 1; transition: background-color 0.2s;
        }
        html[data-theme='light'] .close-tab:hover { background-color: #e9ecef; }
        html[data-theme='dark'] .close-tab:hover { background-color: #343a40; }
        
        .content-viewer { flex-grow: 1; position: relative; overflow: hidden; background-color: var(--bg-color); }
        /* #chatbot-iframe style removed as iframe is removed */
        .placeholder { display: flex; justify-content: center; align-items: center; height: 100%; color: var(--text-secondary); flex-direction: column; gap: 10px; }

        /* Styles from botui.html - START */
        /*
           The :root and html[data-theme='dark'] variables from botui.html are integrated here.
           If variable names match index4.html, index4.html's definitions (above) will take precedence for global theme.
           botui.html's specific component styles will use these variables.
           The primary theme (bg-color, text-primary, panel-color, border-color) will be driven by index4.html's definitions.
        */
        :root { /* botui.html's :root variables, may be complemented by index4's */
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; /* Consistent with index4 */
            /* --color-bg: #f0f2f5; /* Controlled by index4's --bg-color */
            --color-container-bg: var(--panel-color); /* For chat container specific background if needed, or use var(--panel-color) */
            --color-message-window-bg: var(--panel-color); /* Specific to message window, 保持与面板一致 */
            --color-form-bg: #f8f9fa; /* Specific to chat form */
            /* --color-text-main: #333333; /* Controlled by index4's --text-primary */
            --color-text-light: #555555; /* For lighter text within chat */
            /* --color-border: #e0e0e0; /* Controlled by index4's --border-color */
            --color-user-bubble-bg: #007bff;
            --color-user-bubble-text: #ffffff;
            --color-bot-bubble-bg: #e9ecef;
            --color-bot-bubble-text: #333333;
            --color-agent-bubble-bg: #f8f9fa;
            --color-link: #0066cc;
            --shadow-main: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        html[data-theme='dark'] { /* botui.html's dark theme variables, complementing index4's */
            /* --color-bg: #121212; /* Controlled by index4's --bg-color */
            --color-container-bg: #1e1e1e; /* For chat container specific background, or use var(--panel-color) */
            --color-message-window-bg: #1e1e1e; /* Specific to message window */
            --color-form-bg: #2c2c2c; /* Specific to chat form */
            /* --color-text-main: #e0e0e0; /* Controlled by index4's --text-primary */
            --color-text-light: #bbbbbb; /* For lighter text within chat */
            /* --color-border: #3a3a3a; /* Controlled by index4's --border-color */
            --color-user-bubble-bg: #377dff;
            --color-user-bubble-text: #ffffff;
            --color-bot-bubble-bg: #333333;
            --color-bot-bubble-text: #e0e0e0;
            --color-agent-bubble-bg: #2c2c2c;
            --color-link: #58a6ff;
            --shadow-main: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        /* body style from botui.html is removed */
        #chat-container { /* This is the main container for botui content */
            position: relative; 
            width: 100%; 
            height: 100%; 
            background-color: var(--panel-color); /* Use index4's panel color for consistency */
            /* border-radius: 12px; /* Optional */
            box-shadow: var(--shadow-main); /* Uses botui's shadow var */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        #message-window {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: var(--color-message-window-bg); /* Uses specific var, should adapt to theme */
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: background-color 0.2s;
        }
        .message {
            padding: 8px 14px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.6;
            word-wrap: break-word;
            word-break: break-all; 
            font-size: 0.95em;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .message a { color: var(--color-link); text-decoration: underline; }
        .user-message a { color: var(--color-user-bubble-text); font-weight: 500; }
        .user-message {
            background-color: var(--color-user-bubble-bg);
            color: var(--color-user-bubble-text);
            align-self: flex-end;
            border-bottom-right-radius: 6px;
        }
        .bot-message {
            background-color: var(--color-bot-bubble-bg);
            color: var(--color-bot-bubble-text);
            align-self: flex-start;
            border-bottom-left-radius: 6px;
        }
        .bot-message h1, .bot-message h2, .bot-message h3, .bot-message h4 { margin: 0.8em 0 0.4em 0; line-height: 1.3; }
        .bot-message h3 { font-size: 1.1em; font-weight: 600; }
        .bot-message p { margin: 0 0 0.5em 0; }
        .bot-message p:last-child { margin-bottom: 0; }
        .bot-message ul, .bot-message ol { padding-left: 25px; margin: 0.5em 0; }
        .bot-message li { margin-bottom: 0.2em; }
        .bot-message strong { font-weight: 600; }
        .bot-message code { font-family: monospace; background-color: rgba(0,0,0,0.08); padding: 2px 5px; border-radius: 4px; }
        .agent-thought { background-color: var(--color-agent-bubble-bg); border: 1px solid var(--border-color); color: var(--color-text-light); align-self: center; width: 90%; max-width: 90%; font-size: 0.8em; border-radius: 8px; padding: 0; }
        .agent-thought summary { padding: 8px 15px; font-weight: 500; cursor: pointer; outline: none; }
        .agent-thought .collapsible-content { padding: 5px 15px 10px 15px; margin: 0; font-size: 0.9em; line-height: 1.4; color: var(--text-primary); white-space: pre-wrap; background-color: transparent; border-top: 1px solid var(--border-color); }
        #chat-form { display: flex; padding: 10px; border-top: 1px solid var(--border-color); background-color: var(--color-form-bg); align-items: flex-end; }
        #chat-input {
            flex-grow: 1;
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 10px 15px;
            font-size: 0.9em;
            font-family: inherit; 
            background-color: var(--panel-color); /* Use index4's panel color for input bg */
            color: var(--text-primary); /* Use index4's text color for input text */
            resize: none;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.5;
        }
        #chat-input:focus { outline: none; border-color: var(--color-user-bubble-bg); } /* Uses botui's user bubble color for focus */
        #chat-form button { height: 42px; margin-left: 10px; padding: 10px 20px; background-color: var(--color-user-bubble-bg); color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 16px; transition: opacity 0.2s; }
        #chat-form button:hover { opacity: 0.8; }
        /* #theme-toggle style from botui.html is removed as the button itself is removed */
        .thinking span { display: inline-block; background-color: #999; width: 8px; height: 8px; border-radius: 50%; margin: 0 1px; animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        /* Styles from botui.html - END */

        /* Login Modal Styles */
        .login-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            /* Flexbox for centering */
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        .login-modal-content {
            background-color: var(--panel-color);
            color: var(--text-primary);
            margin: auto; /* Not strictly needed with flex, but good fallback */
            padding: 30px 40px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            text-align: center;
        }
        .login-modal-content h1 { margin-top: 0; margin-bottom: 25px; font-size: 1.8em; color: var(--text-primary); }
        .login-modal-content .form-group { margin-bottom: 20px; text-align: left; }
        .login-modal-content label { display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-secondary); }
        .login-modal-content input[type="text"],
        .login-modal-content input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            background-color: var(--bg-color); /* Use bg-color for inputs */
            color: var(--text-primary);
            font-size: 1em;
        }
        .login-modal-content input[type="text"]:focus,
        .login-modal-content input[type="password"]:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(var(--primary-color), 0.25); /* Check primary color format for rgba */
        }
        .login-modal-content .remember-group { display: flex; align-items: center; margin-bottom: 25px; justify-content: flex-start; }
        .login-modal-content .remember-group input[type="checkbox"] { width: auto; margin-right: 8px; }
        .login-modal-content .remember-group label { margin-bottom: 0; font-weight: normal; }

        .login-modal-content button[type="submit"] {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .login-modal-content button[type="submit"]:hover { background-color: #0b5ed7; /* Darker shade of primary */ }
        .login-modal-content .error-message { color: #dc3545; margin-top: 15px; text-align: center; font-weight: 500; min-height: 1.2em; }
        .close-modal-button {
            color: var(--text-secondary);
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.2s;
        }
        .close-modal-button:hover,
        .close-modal-button:focus {
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="app-wrapper">
        <header class="app-header">
            <div class="title-container"> <!-- Title and status in a container -->
                <div class="title">智能文档中心</div>
                <span id="login-status-indicator"></span>
            </div>
            <div class="header-actions">
                <button id="theme-toggle" class="theme-toggle-button" title="切换主题">
                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m-4.646.354a.5.5 0 0 1-.708 0l-1.414-1.414a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708m9.193 0a.5.5 0 0 1 0-.708l1.414-1.414a.5.5 0 0 1 .708.707l-1.414 1.414a.5.5 0 0 1-.708 0m-9.193-9.193a.5.5 0 0 1-.708-.707l1.414-1.414a.5.5 0 1 1 .707.707L3.354 5.354a.5.5 0 0 1 0-.708M13.646 5.354a.5.5 0 0 1 0 .707L12.232 7.5a.5.5 0 0 1-.707-.707L13.646 5.354a.5.5 0 0 1 .708 0M1.5 8a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2A.5.5 0 0 1 1.5 8m13 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5"/></svg>
                    <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"/></svg>
                </button>
                <a id="auth-button" href="/logout" class="auth-button logout"> <!-- Changed class and added id -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/><path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/></svg>
                    <span id="auth-button-text">登出</span> <!-- Added id -->
                </a>
            </div>
        </header>
        <main class="main-container">
            <div class="left-panel">
                <nav class="tab-navigation" id="tab-container"></nav>
                <div class="content-viewer">
                    <div id="placeholder" class="placeholder" style="display: flex; width: 100%; height: 100%;"><span>请选择一个文件进行预览</span></div>
                    <iframe id="file-viewer-iframe" style="display: none; width: 100%; height: 100%; border: none;"></iframe>
                </div>
            </div>
            <div class="right-panel">
                <!-- Content from botui.html's #chat-container, with its internal theme toggle button removed -->
                <div id="chat-container">
                    <!-- botui.html's theme-toggle button was here, now removed -->
                    <div id="message-window"></div>
                    <form id="chat-form">
                        <textarea id="chat-input" placeholder="请输入消息 (Shift+Enter 换行)" rows="1"></textarea>
                        <button type="submit" title="发送">发送</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

<script>
    // --- Global State & DOM Refs from index4.html ---
    const appState = {
        openFiles: {}, 
        activeFile: null,
        sessionId: null,
        isLoggedIn: false, // 新增登录状态
    };
    // const chatbotIframe = document.getElementById('chatbot-iframe'); // Removed as iframe is replaced
    const tabContainer = document.getElementById('tab-container');
    const placeholder = document.getElementById('placeholder');
    const fileViewerIframe = document.getElementById('file-viewer-iframe');
    const loginStatusIndicator = document.getElementById('login-status-indicator'); 
    const authButton = document.getElementById('auth-button'); 
    const authButtonText = document.getElementById('auth-button-text'); 
    let socket = null;

    // Login Modal DOM elements
    let loginModal, closeModalButton, modalLoginForm, modalUsernameInput, modalPasswordInput, modalRememberCheckbox, modalErrorBox;


    let websocketRetryCount = 0;
    const MAX_WEBSOCKET_RETRIES = 5;
    const WEBSOCKET_RETRY_INTERVAL = 5000; 
    let websocketRetryTimer = null;

    // --- Theme Management from index4.html (controls everything) ---
    const themeToggle = document.getElementById('theme-toggle'); // This is index4.html's main theme toggle
    const getPreferredTheme = () => localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    const setTheme = (theme) => {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        // The chat component's theme should update automatically via CSS using html[data-theme='dark']
    };
    
    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        setTheme(currentTheme === 'dark' ? 'light' : 'dark');
    });

    // --- Viewer Logic from index4.html ---
    function showViewer(type, message) {
        placeholder.style.display = type === 'placeholder' ? 'flex' : 'none';
        fileViewerIframe.style.display = type === 'iframe' ? 'block' : 'none';
        if (type === 'placeholder') {
            placeholder.querySelector('span').textContent = message;
        }
    }

    function viewFile(filename) {
        const file = appState.openFiles[filename];
        if (!file) {
            console.error(`Attempting to view a non-existent file: ${filename}`);
            showViewer('placeholder', `无法找到文件 ${filename} 的数据。`);
            return;
        }
        
        appState.activeFile = filename;
        renderTabs();
        showViewer('placeholder', `正在加载 ${filename}...`);

        try {
            // 1. FastAPI 后端的基础 URL (当前页面的 origin)
            const fastapiBaseUrl = window.location.origin;

            // 2. 构造文件的直接下载链接，适配新的后端格式 /download/{token}/{filename_basename}
            // filename 是包含相对路径的，例如 "2024/foo/bar.xlsx"
            // 我们需要提取纯文件名 "bar.xlsx"
            const justTheFilename = filename.substring(filename.lastIndexOf('/') + 1);
            const fileDownloadUrl = `http://host.docker.internal:8888/download/${file.token}/${encodeURIComponent(justTheFilename)}`; 

            // 3. 构造指向后端 kkFileView 代理的 URL
            //    后端代理是 /api/v1/kkfileview/onlinePreview
            //    它期望一个 file_url 参数，其值是上面构造的 fileDownloadUrl
            //    根据您的反馈和 forward_test.html 的注释，fileDownloadUrl 在这里不应再次被 encodeURIComponent
            const previewProxyUrl = `${fastapiBaseUrl}/kkfileview/onlinePreview?file_url=${fileDownloadUrl}`;

            console.log(`[KKFileView] 请求预览代理 (iframe.src): ${previewProxyUrl}`);
            console.log(`[KKFileView] 传递给代理的 file_url 参数值: ${fileDownloadUrl}`);

            // 4. 将代理 URL 设置给 iframe
            fileViewerIframe.src = previewProxyUrl;
            showViewer('iframe');

        } catch (error) {
            console.error(`Error preparing file preview for "${filename}":`, error);
            showViewer('placeholder', `准备文件预览 "${filename}" 出错: ${error.message}`);
        }
    }

    // --- Tab Management Logic from index4.html ---
    function renderTabs() {
        tabContainer.innerHTML = '';
        const openFilenames = Object.keys(appState.openFiles);
        openFilenames.forEach(filename => {
            const file = appState.openFiles[filename];
            const button = document.createElement('button');
            button.className = 'tab-button';
            button.dataset.filename = filename;
            if (filename === appState.activeFile) button.classList.add('active');
            const icon = window.ICONS[file.format] || window.ICONS.default;
            button.innerHTML = `${icon}<span>${filename}</span><span class="close-tab" title="关闭标签页">&times;</span>`;
            button.addEventListener('click', (e) => {
                if (e.target.classList.contains('close-tab')) return;
                viewFile(filename);
            });
            button.querySelector('.close-tab').addEventListener('click', (e) => {
                e.stopPropagation();
                closeTab(filename);
            });
            tabContainer.appendChild(button);
        });
        const activeTab = tabContainer.querySelector('.active');
        if (activeTab) {
            activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    }
    
    function closeTab(filename) {
        if (appState.openFiles[filename]) {
            delete appState.openFiles[filename];
            if (appState.activeFile === filename) {
                const remainingFiles = Object.keys(appState.openFiles);
                if (remainingFiles.length > 0) {
                    const newActiveFile = remainingFiles[remainingFiles.length - 1];
                    viewFile(newActiveFile);
                } else {
                    appState.activeFile = null;
                    showViewer('placeholder', '所有文件都已关闭。');
                }
            }
            renderTabs();
        }
    }

    // --- WebSocket Logic from index4.html ---
    function connectWebSocket() {
        if (!appState.sessionId) {
            console.error("无法连接WebSocket：缺少session_id。");
            return;
        }
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws?session_id=${appState.sessionId}`;
        console.log(`正在连接到 WebSocket: ${wsUrl}`);
        socket = new WebSocket(wsUrl);
        socket.onopen = () => {
            console.log("WebSocket 连接已建立。");
            websocketRetryCount = 0; 
            clearTimeout(websocketRetryTimer); 
        };
        socket.onmessage = (event) => {
            console.log("收到WebSocket消息:", event.data);
            try {
                const message = JSON.parse(event.data);
                if (message.type === 'file_open_request' && message.payload) {
                    handleFileOpenRequest(message.payload);
                }
            } catch (e) {
                console.error("处理WebSocket消息时出错:", e);
            }
        };
        socket.onclose = (event) => {
            console.warn(`WebSocket 连接已关闭。代码: ${event.code}, 原因: '${event.reason}'`);
            clearTimeout(websocketRetryTimer); 
            // 1000: Normal Closure; 1001: Going Away (e.g. server shutdown or browser navigation)
            // 1005: No Status Rcvd (often implies normal closure without explicit code)
            // 1006: Abnormal Closure (often network issues, or server process killed)
            if (event.code === 1000 || event.code === 1001 || event.code === 1005) { 
                console.log(`WebSocket normally closed. Code: ${event.code}, Reason: '${event.reason}'`);
                // If appState.isLoggedIn is true, it means this was likely an unexpected normal close.
                // If appState.isLoggedIn is false, it was likely due to logout.
                if (appState.isLoggedIn) { // If still marked as logged in, treat as unexpected disconnect
                    console.warn("WebSocket closed normally but unexpectedly while logged in.");
                    handleWebSocketDisconnect(); // Update UI to reflect disconnected state
                }
                return; // No automatic reconnection for normal closures
            }

            // For other close codes (abnormal, errors), attempt reconnection or show login
            console.warn(`WebSocket abnormally closed. Code: ${event.code}, Reason: '${event.reason}'`);
            handleWebSocketDisconnect(); // Centralized disconnect handling, which includes retry logic
        };
        socket.onerror = (error) => {
            console.error("WebSocket 发生错误:", error);
            socket.close(); 
        };
    }

    function handleFileOpenRequest(fileInfo) {
        const { filename, download_token, format } = fileInfo;
        appState.openFiles[filename] = { format: format, token: download_token };
        viewFile(filename); 
    }
    
    // --- Login Modal Logic ---
    function initLoginModalDOM() {
        loginModal = document.getElementById('login-modal');
        closeModalButton = loginModal.querySelector('.close-modal-button');
        modalLoginForm = document.getElementById('modal-login-form');
        modalUsernameInput = document.getElementById('modal-username');
        modalPasswordInput = document.getElementById('modal-password');
        modalRememberCheckbox = document.getElementById('modal-remember');
        modalErrorBox = loginModal.querySelector('.error-message');

        closeModalButton.onclick = hideLoginModal;
        window.onclick = (event) => { // Close if clicked outside content
            if (event.target == loginModal) {
                hideLoginModal();
            }
        };
        modalLoginForm.addEventListener('submit', handleModalLoginSubmit);
    }

    function showLoginModal() {
        if (!loginModal) initLoginModalDOM(); // Initialize DOM elements if not already done
        modalErrorBox.textContent = ''; // Clear previous errors
        loginModal.style.display = 'flex'; // Use flex for centering
        modalUsernameInput.focus();
    }

    function hideLoginModal() {
        if (loginModal) loginModal.style.display = 'none';
    }

    async function handleModalLoginSubmit(event) {
        event.preventDefault();
        modalErrorBox.textContent = '';
        const formData = new FormData(modalLoginForm);

        try {
            const response = await fetch('/login', { method: 'POST', body: formData });
            const result = await response.json();

            if (response.ok) {
                hideLoginModal();
                // Login successful, re-check status and initialize app parts
                await checkLoginStatusAndInitialize(true); // Pass true to indicate this is after a login attempt
            } else {
                modalErrorBox.textContent = result.message || '登录失败，请重试。';
            }
        } catch (error) {
            console.error('登录请求失败:', error);
            modalErrorBox.textContent = '发生网络错误，请检查您的连接。';
        }
    }
    
    // --- UI Update for Login Status ---
    function updateLoginStatusUI(isLoggedIn) {
        appState.isLoggedIn = isLoggedIn;
        if (isLoggedIn) {
            loginStatusIndicator.textContent = '（已登录）';
            authButtonText.textContent = '登出';
            authButton.href = '/logout'; // Standard logout link
            authButton.classList.remove('login');
            authButton.classList.add('logout');
            authButton.onclick = async (e) => { // Handle logout click
                e.preventDefault();
                try {
                    await fetch('/logout', { method: 'POST' }); // Assuming POST for logout
                } catch (error) {
                    console.error("Logout request failed:", error);
                } finally {
                    appState.sessionId = null; // Clear session ID
                    sessionStorage.removeItem('session_id');
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.close(1000, "User logged out"); // Normal closure
                    }
                    updateLoginStatusUI(false); // Update UI to logged out state
                    showViewer('placeholder', '您已登出。请重新登录以继续。');
                    botui_messageWindow.innerHTML = ''; // Clear chat messages
                    botui_conversation_id = null; // Reset conversation
                }
            };
        } else {
            loginStatusIndicator.textContent = '（未登录）';
            authButtonText.textContent = '登录';
            authButton.href = 'javascript:void(0);'; // Prevent navigation
            authButton.classList.remove('logout');
            authButton.classList.add('login');
            authButton.onclick = (e) => { // Show login modal on click
                e.preventDefault();
                showLoginModal();
            };
            // Optionally clear sensitive data or disable features
            appState.openFiles = {};
            appState.activeFile = null;
            renderTabs(); // Clear tabs
            if (!fileViewerIframe.src.includes('about:blank')) fileViewerIframe.src = 'about:blank'; // Clear iframe
            showViewer('placeholder', '请登录以使用智能文档中心。');
        }
    }

    // --- WebSocket Disconnect Handling ---
    function handleWebSocketDisconnect() {
        console.warn("WebSocket disconnected or failed to connect.");
        if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
            socket.close(); // Ensure it's closed before trying to reconnect or update UI
        }
        socket = null; // Clear the socket variable

        if (appState.isLoggedIn) { // Only try to reconnect if user was logged in
            if (websocketRetryCount < MAX_WEBSOCKET_RETRIES) {
                websocketRetryCount++;
                console.log(`Attempting to reconnect WebSocket (attempt ${websocketRetryCount}/${MAX_WEBSOCKET_RETRIES}) in ${WEBSOCKET_RETRY_INTERVAL / 1000} seconds...`);
                clearTimeout(websocketRetryTimer);
                websocketRetryTimer = setTimeout(connectWebSocket, WEBSOCKET_RETRY_INTERVAL);
            } else {
                console.error(`WebSocket reconnection failed after ${MAX_WEBSOCKET_RETRIES} attempts.`);
                // Update UI to reflect that connection is lost and requires manual login
                updateLoginStatusUI(false); // Set to logged-out state
                // No alert, user can see the "Login" button and status
                botui_addMessage("与服务器的连接已断开。如果问题持续，请尝试重新登录。", "bot");
            }
        } else {
            // If not logged in, no need to retry WebSocket. UI should already reflect "not logged in".
            console.log("WebSocket not attempting reconnection as user is not logged in.");
            updateLoginStatusUI(false); // Ensure UI is in logged-out state
        }
    }
    
    // --- App Initialization (Revised) ---
    async function checkLoginStatusAndInitialize(isAfterLoginAttempt = false) {
        try {
            const response = await fetch('/api/user/status');
            if (response.ok) {
                const userData = await response.json();
                sessionStorage.setItem('session_id', userData.session_id);
                appState.sessionId = userData.session_id;
                updateLoginStatusUI(true); // Set to logged-in state
                connectWebSocket(); // Connect WebSocket
                if (isAfterLoginAttempt) { // If this was after a successful login
                     showViewer('placeholder', '登录成功！智能文档中心已就绪。');
                }
            } else if (response.status === 401) {
                updateLoginStatusUI(false); // Set to logged-out state
                if (isAfterLoginAttempt) { // Login attempt failed from modal
                    modalErrorBox.textContent = '登录会话无效或已过期，请重试。';
                    showLoginModal(); // Re-show modal if login attempt failed to establish session
                } else {
                     showViewer('placeholder', '请登录以使用智能文档中心。');
                }
            } else {
                throw new Error(`获取用户状态失败: ${response.status}`);
            }
        } catch (error) {
            console.error('检查登录状态或初始化应用时出错:', error);
            updateLoginStatusUI(false); // Fallback to logged-out state
            showViewer('placeholder', `初始化失败: ${error.message} 请尝试刷新。`);
            // No automatic redirect to login.html, user can click "Login"
        }

        // Common initialization steps regardless of login status (e.g., loading non-user-specific resources)
        // Get chatbot API config (moved here to run even if not initially logged in, though chat might be disabled)
        try {
            const agentApiResponse = await fetch('/api/dify-agent-api');
            if (!agentApiResponse.ok) {
                throw new Error(`获取聊天机器人配置失败: ${agentApiResponse.status} ${agentApiResponse.statusText}`);
            }
            const agentApiData = await agentApiResponse.json();
            if (agentApiData.url && agentApiData.apikey) {
                dynamic_bot_api_url = agentApiData.url;
                dynamic_bot_api_key = agentApiData.apikey;
                console.log("聊天机器人配置已加载:", dynamic_bot_api_url);
            } else {
                console.error('未能从API获取有效的聊天机器人URL或API Key。');
                // Don't show placeholder error here if not logged in, as chat is likely disabled anyway
            }
        } catch (error) {
            console.error('获取聊天机器人配置时出错:', error);
        }
        
        if (!isAfterLoginAttempt && !appState.isLoggedIn) {
             showViewer('placeholder', '请登录以使用智能文档中心。');
        } else if (!isAfterLoginAttempt && appState.isLoggedIn) {
             showViewer('placeholder', '智能文档中心已就绪。');
        }
        // renderTabs(); // Already called in init
    }

    async function init() {
        setTheme(getPreferredTheme());
        // Create and append login modal to body before initializing DOM refs for it
        const loginModalHTML = `
        <div id="login-modal" class="login-modal">
            <div class="login-modal-content">
                <span class="close-modal-button">&times;</span>
                <h1>工作台登录</h1>
                <form id="modal-login-form">
                    <div class="form-group">
                        <label for="modal-username">用户名:</label>
                        <input type="text" id="modal-username" name="username" required value="admin">
                    </div>
                    <div class="form-group">
                        <label for="modal-password">密码:</label>
                        <input type="password" id="modal-password" name="password" required value="password">
                    </div>
                    <div class="remember-group">
                        <input type="checkbox" id="modal-remember" name="remember" value="true">
                        <label for="modal-remember" style="margin-left: 8px; margin-bottom: 0;">记住我</label>
                    </div>
                    <button type="submit">登 录</button>
                    <div class="error-message" id="modal-error-box"></div>
                </form>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', loginModalHTML);
        
        initLoginModalDOM(); // Initialize modal DOM elements once on load
        await checkLoginStatusAndInitialize();
        renderTabs(); // Initial tab render
    }
    
    // --- ICONS from index4.html ---
    window.ICONS = {
        pdf: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/><path d="M4.603 14.087a.8.8 0 0 1-1.214-.886l.66-1.98a.52.52 0 0 1 .184-.282l.062-.052.062-.052a.5.5 0 0 1 .736.646l-.119.119a.11.11 0 0 0-.03.076l-.23.69zM5.53 12.042a.51.51 0 0 1 .707.707l-1.464 1.464a.51.51 0 0 1-.707-.707z"/></svg>`,
        docx: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.88 15.84c-.45.08-.91.16-1.38.16H2.5A1.5 1.5 0 0 1 1 14.5V3.5A1.5 1.5 0 0 1 2.5 2H10v2h2v1.5a.5.5 0 0 0 1 0V4h.5a.5.5 0 0 0 .29-.91L11.15.29a.5.5 0 0 0-.85.35V2.5A1.5 1.5 0 0 1 9 1H2.5A2.5 2.5 0 0 0 0 3.5v11A2.5 2.5 0 0 0 2.5 17h6.08c.55 0 1.07-.1 1.55-.27l.5-.27c.45-.25.85-.58 1.17-1a.5.5 0 0 0-.85-.52c-.25.3-.57.54-.9.74l-.5.27Z"/><path d="M16 12h-3a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1m-3-2h3v1h-3z"/></svg>`,
        xlsx: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.18 4.603L1.18 8.603h2.825L8 4.306zm3.593 0L5.18 10.297h2.825L12 5.006zM13.18 4.603L9.18 8.603h2.825L16 4.306zM13.18 10.297L9.18 14.297h2.825L16 9.006z"/><path d="M1.18 8.603a.5.5 0 0 0 .306.491l6.98 3.293a.5.5 0 0 0 .468 0l6.98-3.293a.5.5 0 0 0 .306-.491L9.18 1.497a.5.5 0 0 0-.468 0zM8.944 1.151l6.98 3.293L8.944 7.739 1.964 4.444zM1.964 9.098l6.98 3.293 6.98-3.293-6.98-3.294z"/></svg>`,
        default: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5zM4 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1z"/></svg>`
    };

    // --- JavaScript from botui.html (integrated and prefixed) ---
    let dynamic_bot_api_url = null; // 将通过API获取
    let dynamic_bot_api_key = null; // 将通过API获取

    const botui_messageWindow = document.getElementById('message-window'); 
    const botui_chatForm = document.getElementById('chat-form');
    const botui_chatInput = document.getElementById('chat-input');
    
    let botui_conversation_id = null; 

    // botui.html's theme toggle JS logic is removed. index4.html's setTheme handles global theme.

    function botui_handleFormSubmission() {
        const query = botui_chatInput.value.trim();
        if (query) {
            botui_addMessage(query, 'user'); 
            botui_streamMessage(query); 
            botui_chatInput.value = '';
            botui_chatInput.style.height = 'auto'; 
        }
    }

    botui_chatForm.addEventListener('submit', (event) => {
        event.preventDefault();
        botui_handleFormSubmission();
    });

    botui_chatInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            botui_handleFormSubmission();
        }
    });

    botui_chatInput.addEventListener('input', () => { 
        botui_chatInput.style.height = 'auto';
        // Ensure scrollHeight is calculated correctly after content change
        requestAnimationFrame(() => {
             botui_chatInput.style.height = (botui_chatInput.scrollHeight) + 'px';
        });
    });
    
    function botui_addMessage(content, type, referenceNode = null) {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${type}-message`;
        if (type === 'user') {
            messageElement.textContent = content; // Use textContent for user messages to prevent XSS
        } else {
            messageElement.innerHTML = content; 
        }
        if (referenceNode) {
            botui_messageWindow.insertBefore(messageElement, referenceNode);
        } else {
            botui_messageWindow.appendChild(messageElement);
        }
        botui_scrollToBottom();
        return messageElement;
    }
    
    function botui_addCollapsibleMessage(summaryText, contentText, referenceNode = null) {
        if (!contentText) return;
        const detailsElement = document.createElement('details');
        detailsElement.className = 'message agent-thought';
        const summaryElement = document.createElement('summary');
        summaryElement.textContent = summaryText;
        const contentDiv = document.createElement('div');
        contentDiv.className = 'collapsible-content';
        contentDiv.innerHTML = marked.parse(contentText); 
        detailsElement.appendChild(summaryElement);
        detailsElement.appendChild(contentDiv);
        if (referenceNode) {
            botui_messageWindow.insertBefore(detailsElement, referenceNode);
        } else {
            botui_messageWindow.appendChild(detailsElement);
        }
        setTimeout(botui_scrollToBottom, 0); 
    }

    function botui_scrollToBottom() {
        botui_messageWindow.scrollTop = botui_messageWindow.scrollHeight;
    }

    async function botui_streamMessage(query) { 
        if (!dynamic_bot_api_url || !dynamic_bot_api_key) {
            console.error("聊天机器人配置未加载，无法发送消息。");
            botui_addMessage("😥 **错误**: 聊天机器人配置未加载，请稍后再试或联系管理员。", 'bot');
            return;
        }

        const thinkingHTML = `<div class="thinking"><span></span><span></span><span></span></div>`;
        const botMessageElement = botui_addMessage(thinkingHTML, 'bot');
        let fullAnswerText = "";

        try {
            const response = await fetch(dynamic_bot_api_url, { 
                method: 'POST',
                headers: { "Authorization": `Bearer ${dynamic_bot_api_key}`, "Content-Type": "application/json" }, 
                body: JSON.stringify({
                    "query": query, "user": "user_001", "response_mode": "streaming",
                    "conversation_id": botui_conversation_id || null, "inputs": {}
                })
            });

            if (!response.ok) throw new Error(`请求失败: ${response.status} ${response.statusText}`);
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = '';

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); 

                for (const line of lines) {
                    if (!line.startsWith("data: ")) continue;

                    try {
                        const evt = JSON.parse(line.substring(6));
                        const evt_type = evt.event;

                        if (evt.answer) {
                            fullAnswerText += evt.answer;
                            botMessageElement.innerHTML = marked.parse(fullAnswerText);
                        } else if (evt_type === "agent_thought") {
                            const summaryParts = [];
                            let contentText = "";
                            if (evt.thought) {
                                summaryParts.push('思考内容');
                                contentText += `思考内容: ${evt.thought}\n`;
                            }
                            if (evt.tool) {
                                summaryParts.push('调用工具');
                                contentText += `调用工具: ${evt.tool}\n`;
                                if(evt.tool_input) contentText += `工具输入: ${evt.tool_input}\n`;
                                // 用户问题：在这里发起 POST 请求到另一个服务器
                                // console.log("在此处可以添加对其他服务器的 POST 请求，使用 evt.tool 和 evt.tool_input");
                            }
                            if (evt.observation) {
                                if (!evt.tool) summaryParts.push('工具结果');
                                contentText += `工具结果: ${evt.observation}\n`;
                                //只在有调用结果的时候才显示面板
                                const summaryText = summaryParts.length > 0 ? summaryParts.join('、') : 'Agent 思考步骤';
                                botui_addCollapsibleMessage(`${summaryText} (点击展开)`, contentText.trim(), botMessageElement);
                            }
                            //const summaryText = summaryParts.length > 0 ? summaryParts.join('、') : 'Agent 思考步骤';
                            //botui_addCollapsibleMessage(`${summaryText} (点击展开)`, contentText.trim(), botMessageElement);
                        } else if (evt_type === "message_end") {
                            if (evt.conversation_id) botui_conversation_id = evt.conversation_id;
                        }
                        
                        if (evt.conversation_id) { 
                            botui_conversation_id = evt.conversation_id;
                        }

                    } catch (e) {
                        console.error("解析 JSON 失败:", e, "原始数据:", line);
                    }
                    botui_scrollToBottom();
                }
            }
        } catch (error) {
            botMessageElement.innerHTML = marked.parse(`😥 **抱歉，出错了**: \n\n\`\`\`\n${error.message}\n\`\`\``);
            // Consider a more specific error style if needed
            // botMessageElement.style.backgroundColor = '#ffcdd2'; 
        }
    }
    // --- End of JavaScript from botui.html ---

    window.addEventListener('load', init);
</script>
</body>
</html>
