
<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å·¥ä½œå°</title>

    <script type="text/javascript" src="/static/base64.min.js" defer></script>
    <!-- Added from botui.html -->
    <script src="/static/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* Styles from index4.html */
        :root, html[data-theme='light'] {
            --primary-color: #0d6efd;
            --bg-color: #e9ecef; /* æ˜äº®æ¨¡å¼èƒŒæ™¯ç¨å¾®è°ƒæš— */
            --rgb-bg-color: 233, 236, 239;
            --panel-color: #f8f9fa; /* é¢æ¿é¢œè‰²ä¹Ÿç›¸åº”è°ƒæ•´ */
            --rgb-panel-color: 248, 249, 250;
            --border-color: #dee2e6;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --header-height: 60px;

            /* PDF.js viewer variables override */
            --sidebar-width: 250px;
            --toolbar-bg-color: var(--panel-color);
            --toolbar-border-color: var(--border-color);
            --body-bg-color: var(--bg-color); /* pdf.js body-bg-color */
            --page-bg-color: var(--panel-color);
            --main-color: var(--text-primary);
            --sidebar-toolbar-bg-color: var(--bg-color);
            --doorhanger-bg-color: var(--panel-color);
            --doorhanger-border-color: var(--border-color);
            --field-bg-color: var(--bg-color);
            --field-border-color: var(--border-color);
            --toggled-btn-bg-color: var(--primary-color);
        }
        html[data-theme='dark'] {
            --primary-color: #0d6efd;
            --bg-color: #121212; /* index4 dark bg */
            --rgb-bg-color: 18, 18, 18;
            --panel-color: #1e1e1e; /* index4 dark panel */
            --rgb-panel-color: 30, 30, 30;
            --border-color: #343a40;
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.15);

            /* PDF.js viewer variables override */
            --toolbar-bg-color: var(--panel-color);
            --toolbar-border-color: var(--border-color);
            --body-bg-color: var(--bg-color); /* pdf.js body-bg-color */
            --page-bg-color: var(--panel-color);
            --main-color: var(--text-primary);
            --sidebar-toolbar-bg-color: var(--bg-color);
            --doorhanger-bg-color: var(--panel-color);
            --doorhanger-border-color: var(--border-color);
            --field-bg-color: var(--bg-color);
            --field-border-color: var(--border-color);
            --toggled-btn-bg-color: var(--primary-color);
        }
        body, html { /* This body style is from index4.html, botui.html's body style is removed */
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            font-family: "Inter", "Segoe UI", "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif; /* index4 font, botui uses Inter too */
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        .app-wrapper { display: flex; flex-direction: column; height: 100%; }
        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            height: var(--header-height); padding: 0 24px;
            background-color: var(--panel-color);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; transition: background-color 0.3s, border-color 0.3s;
        }
        .app-header .title-container { display: flex; align-items: center; } /* æ–°å¢å®¹å™¨ */
        .app-header .title { font-size: 1.25rem; font-weight: 600; }
        #login-status-indicator { margin-left: 15px; font-size: 0.9em; font-weight: 500; color: var(--text-secondary); }
        .header-actions { display: flex; align-items: center; gap: 16px; }
        .theme-toggle-button { /* This is index4.html's theme toggle button */
            background-color: var(--primary-color); /* ä¿®æ”¹ä¸ºå®ä½“èƒŒæ™¯ */
            border: none; /* ç§»é™¤è¾¹æ¡† */
            color: white; /* ä¿®æ”¹å›¾æ ‡é¢œè‰²ä»¥é€‚åº”èƒŒæ™¯ */
            width: 38px; height: 38px; border-radius: 6px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s ease;
        }
        .theme-toggle-button:hover { background-color: #0b5ed7; /* æ›´æ·±çš„è“è‰² for hover */ color: white; }
        .theme-toggle-button .moon-icon { display: none; }
        html[data-theme='dark'] .theme-toggle-button .sun-icon { display: none; }
        html[data-theme='dark'] .theme-toggle-button .moon-icon { display: block; }

        .auth-button { /* åŸ logout-buttonï¼Œç°ä¸º auth-button */
            display: flex; align-items: center; gap: 8px; padding: 8px 16px;
            /* color: var(--text-secondary); */ /* å°†ç”±å…·ä½“ç±»è®¾ç½® */
            /* background-color: transparent; */ /* å°†ç”±å…·ä½“ç±»è®¾ç½® */
            border: none; /* ä¸ºå®ä½“å¤–è§‚ç§»é™¤è¾¹æ¡† */
            border-radius: 6px;
            text-decoration: none; font-weight: 500; transition: all 0.2s ease;
            cursor: pointer; /* ç¡®ä¿åœ¨ JS æ§åˆ¶ href æ—¶ä»æ˜¾ç¤ºä¸ºå¯ç‚¹å‡» */
        }
        /* .auth-button:hover { background-color: var(--bg-color); color: var(--primary-color); } */ /* å·²ç§»é™¤é€šç”¨ hover */
        .auth-button.login { background-color: var(--primary-color); color: white; } /* ç™»å½•æŒ‰é’®è“è‰²æ ·å¼ - å®ä½“ */
        .auth-button.login:hover { background-color: #0b5ed7; /* æ›´æ·±çš„è“è‰² */ color: white; }
        .auth-button.logout { background-color: #dc3545; color: white; } /* ç™»å‡ºæŒ‰é’®çº¢è‰²æ ·å¼ - å®ä½“ */
        .auth-button.logout:hover { background-color: #bb2d3b; /* æ›´æ·±çš„çº¢è‰² */ color: white; }


        .main-container { display: flex; height: calc(100vh - var(--header-height)); }
        .left-panel {
            flex: 0 0 65%; display: flex; flex-direction: column;
            background-color: var(--panel-color);
            border-right: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .right-panel { flex: 1 1 auto; display: flex; /* botui container will be child of this */ }
        .tab-navigation {
            display: flex; flex-shrink: 0; overflow-x: auto;
            border-bottom: 1px solid var(--border-color);
            padding: 0 16px; background-color: var(--panel-color);
        }
        #tab-container { /* æ–°å¢æ ·å¼ */
            display: flex;
        }
        .tab-button {
            display: flex; align-items: center; flex-shrink: 0; gap: 8px; padding: 12px 16px;
            cursor: pointer; border: none; border-bottom: 3px solid transparent; background-color: transparent;
            font-size: 15px; color: var(--text-secondary); transition: all 0.2s;
        }
        .tab-button:hover { color: var(--primary-color); }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }
        .close-tab {
            margin-left: 10px; border-radius: 50%; width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; line-height: 1; transition: background-color 0.2s;
        }
        html[data-theme='light'] .close-tab:hover { background-color: #e9ecef; }
        html[data-theme='dark'] .close-tab:hover { background-color: #343a40; }

        .content-viewer { flex-grow: 1; position: relative; overflow: hidden; background-color: var(--bg-color); }
        /* #chatbot-iframe style removed as iframe is removed */
        .placeholder { display: flex; justify-content: center; align-items: center; height: 100%; color: var(--text-secondary); flex-direction: column; gap: 10px; }

        /* æ–°å¢å·¥ä½œç›®å½•è§†å›¾æ ·å¼ */
        #workdir-viewer {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
            box-sizing: border-box;
        }
        #workdir-viewer h3 {
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .workdir-file-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .workdir-file-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .workdir-file-list li:hover {
            background-color: rgba(var(--rgb-panel-color), 0.5);
        }
        .workdir-file-list .file-name {
            font-size: 1em;
        }
        .workdir-file-list .open-file-btn {
            padding: 5px 12px;
            border: 1px solid var(--border-color);
            background-color: var(--panel-color);
            color: var(--text-primary);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .workdir-file-list .open-file-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .workdir-file-list .llm-read-btn {
            padding: 5px 12px;
            margin-left: 8px;
            border: 1px solid #198754;
            background-color: #198754;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .workdir-file-list .llm-read-btn:hover {
            background-color: #157347;
            border-color: #146c43;
        }


        /* Styles from botui.html - START */
        /*
           The :root and html[data-theme='dark'] variables from botui.html are integrated here.
           If variable names match index4.html, index4.html's definitions (above) will take precedence for global theme.
           botui.html's specific component styles will use these variables.
           The primary theme (bg-color, text-primary, panel-color, border-color) will be driven by index4.html's definitions.
        */
        :root { /* botui.html's :root variables, may be complemented by index4's */
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; /* Consistent with index4 */
            /* --color-bg: #f0f2f5; /* Controlled by index4's --bg-color */
            --color-container-bg: var(--panel-color); /* For chat container specific background if needed, or use var(--panel-color) */
            --color-message-window-bg: var(--panel-color); /* Specific to message window, ä¿æŒä¸é¢æ¿ä¸€è‡´ */
            --color-form-bg: #f8f9fa; /* Specific to chat form */
            /* --color-text-main: #333333; /* Controlled by index4's --text-primary */
            --color-text-light: #555555; /* For lighter text within chat */
            /* --color-border: #e0e0e0; /* Controlled by index4's --border-color */
            --color-user-bubble-bg: #007bff;
            --color-user-bubble-text: #ffffff;
            --color-bot-bubble-bg: #e9ecef;
            --color-bot-bubble-text: #333333;
            --color-agent-bubble-bg: #f8f9fa;
            --color-link: #0066cc;
            --shadow-main: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        html[data-theme='dark'] { /* botui.html's dark theme variables, complementing index4's */
            /* --color-bg: #121212; /* Controlled by index4's --bg-color */
            --color-container-bg: #1e1e1e; /* For chat container specific background, or use var(--panel-color) */
            --color-message-window-bg: #1e1e1e; /* Specific to message window */
            --color-form-bg: #2c2c2c; /* Specific to chat form */
            /* --color-text-main: #e0e0e0; /* Controlled by index4's --text-primary */
            --color-text-light: #bbbbbb; /* For lighter text within chat */
            /* --color-border: #3a3a3a; /* Controlled by index4's --border-color */
            --color-user-bubble-bg: #377dff;
            --color-user-bubble-text: #ffffff;
            --color-bot-bubble-bg: #333333;
            --color-bot-bubble-text: #e0e0e0;
            --color-agent-bubble-bg: #2c2c2c;
            --color-link: #58a6ff;
            --shadow-main: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        /* body style from botui.html is removed */
        #chat-container { /* This is the main container for botui content */
            position: relative;
            width: 100%;
            height: 100%;
            background-color: var(--panel-color); /* Use index4's panel color for consistency */
            /* border-radius: 12px; /* Optional */
            box-shadow: var(--shadow-main); /* Uses botui's shadow var */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        #chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        #chat-title {
            font-weight: 600;
            font-size: 1.1em;
        }
        #new-chat-button {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }
        #new-chat-button:hover {
            background-color: var(--bg-color);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        #message-window {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: var(--color-message-window-bg); /* Uses specific var, should adapt to theme */
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: background-color 0.2s;
        }
        .message {
            padding: 8px 14px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.6;
            word-wrap: break-word;
            word-break: break-all;
            font-size: 0.95em;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .message a { color: var(--color-link); text-decoration: underline; }
        .user-message a { color: var(--color-user-bubble-text); font-weight: 500; }
        .user-message {
            background-color: var(--color-user-bubble-bg);
            color: var(--color-user-bubble-text);
            align-self: flex-end;
            border-bottom-right-radius: 6px;
        }
        .bot-message {
            background-color: var(--color-bot-bubble-bg);
            color: var(--color-bot-bubble-text);
            align-self: flex-start;
            border-bottom-left-radius: 6px;
        }
        .bot-message h1, .bot-message h2, .bot-message h3, .bot-message h4 { margin: 0.8em 0 0.4em 0; line-height: 1.3; }
        .bot-message h3 { font-size: 1.1em; font-weight: 600; }
        .bot-message p { margin: 0 0 0.5em 0; }
        .bot-message p:last-child { margin-bottom: 0; }
        .bot-message ul, .bot-message ol { padding-left: 25px; margin: 0.5em 0; }
        .bot-message li { margin-bottom: 0.2em; }
        .bot-message strong { font-weight: 600; }
        .bot-message pre, .bot-message code {
            font-family: monospace;
            background-color: rgba(0,0,0,0.08);
            padding: 2px 5px;
            border-radius: 4px;
            white-space: pre-wrap; /* å…³é”®ï¼šä¿ç•™æ ¼å¼ä½†å…è®¸æ¢è¡Œ */
            word-break: break-all;   /* å…³é”®ï¼šåœ¨é•¿å•è¯æˆ–URLå†…éƒ¨å¼ºåˆ¶æ¢è¡Œ */
        }
        .bot-message pre {
            padding: 10px;
            margin: 0.5em 0;
            overflow-x: auto; /* å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ·»åŠ æ°´å¹³æ»šåŠ¨æ¡ */
        }
        .agent-thought { background-color: var(--color-agent-bubble-bg); border: 1px solid var(--border-color); color: var(--color-text-light); align-self: center; width: 90%; max-width: 90%; font-size: 0.8em; border-radius: 8px; padding: 0; }
        .agent-thought summary { padding: 8px 15px; font-weight: 500; cursor: pointer; outline: none; }
        .agent-thought .collapsible-content { padding: 5px 15px 10px 15px; margin: 0; font-size: 0.9em; line-height: 1.4; color: var(--text-primary); white-space: pre-wrap; background-color: transparent; border-top: 1px solid var(--border-color); }
        #chat-form { display: flex; padding: 10px; border-top: 1px solid var(--border-color); background-color: var(--color-form-bg); align-items: flex-end; }
        #chat-input {
            flex-grow: 1;
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 10px 15px;
            font-size: 0.9em;
            font-family: inherit;
            background-color: var(--panel-color); /* Use index4's panel color for input bg */
            color: var(--text-primary); /* Use index4's text color for input text */
            resize: none;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.5;
        }
        #chat-input:focus { outline: none; border-color: var(--color-user-bubble-bg); } /* Uses botui's user bubble color for focus */
        #chat-form button { height: 42px; margin-left: 10px; padding: 10px 20px; background-color: var(--color-user-bubble-bg); color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 16px; transition: opacity 0.2s; }
        #chat-form button:hover { opacity: 0.8; }
        #chat-form button:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #chat-form button:disabled:hover {
            opacity: 0.7; /* ç¡®ä¿ç¦ç”¨æ—¶æ‚¬åœçŠ¶æ€ä¸æ”¹å˜é€æ˜åº¦ */
        }

        #stop-ai-button {
            /* Styles for the stop button, matching send button where appropriate */
            padding: 0px 15px; /* Adjusted padding to vertically center text with fixed height */
            height: 42px;    /* Match send button height */
            border: none;
            border-radius: 20px; /* Match send button */
            cursor: pointer;
            font-size: 16px;   /* Match send button */
            transition: opacity 0.2s, background-color 0.2s;
            /* margin-left: 5px; is already in its inline style */
            /* Enabled state background-color (#ffc107) and color (black) are in its inline style */
        }

        #stop-ai-button:disabled {
            background-color: #cccccc !important; /* Light grey for disabled. !important overrides inline style. */
            color: #666666 !important;       /* Darker grey text for disabled. !important overrides inline style. */
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* #theme-toggle style from botui.html is removed as the button itself is removed */
        .thinking span { display: inline-block; background-color: #999; width: 8px; height: 8px; border-radius: 50%; margin: 0 1px; animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        /* Styles from botui.html - END */

        /* Login Modal Styles */
        .login-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            /* Flexbox for centering */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login-modal-content {
            background-color: var(--panel-color);
            color: var(--text-primary);
            margin: auto; /* Not strictly needed with flex, but good fallback */
            padding: 30px 40px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            text-align: center;
        }
        .login-modal-content h1 { margin-top: 0; margin-bottom: 25px; font-size: 1.8em; color: var(--text-primary); }
        .login-modal-content .form-group { margin-bottom: 20px; text-align: left; }
        .login-modal-content label { display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-secondary); }
        .login-modal-content input[type="text"],
        .login-modal-content input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            background-color: var(--bg-color); /* Use bg-color for inputs */
            color: var(--text-primary);
            font-size: 1em;
        }
        .login-modal-content input[type="text"]:focus,
        .login-modal-content input[type="password"]:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(var(--primary-color), 0.25); /* Check primary color format for rgba */
        }
        .login-modal-content .remember-group { display: flex; align-items: center; margin-bottom: 25px; justify-content: flex-start; }
        .login-modal-content .remember-group input[type="checkbox"] { width: auto; margin-right: 8px; }
        .login-modal-content .remember-group label { margin-bottom: 0; font-weight: normal; }

        .login-modal-content button[type="submit"] {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .login-modal-content button[type="submit"]:hover { background-color: #0b5ed7; /* Darker shade of primary */ }
        .login-modal-content .error-message { color: #dc3545; margin-top: 15px; text-align: center; font-weight: 500; min-height: 1.2em; }
        .close-modal-button {
            color: var(--text-secondary);
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.2s;
        }
        .close-modal-button:hover,
        .close-modal-button:focus {
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer;
        }

        /* Upload Modal Styles (reusing login modal styles where possible) */
        #upload-spec-modal .form-group {
            margin-bottom: 15px;
        }
        #upload-spec-modal input[type="file"] {
            padding: 8px;
        }
        #upload-spec-modal .progress-area {
            margin-top: 20px;
            text-align: center;
        }
        #upload-spec-modal .progress-bar-container {
            width: 100%;
            background-color: var(--bg-color);
            border-radius: 4px;
            border: 1px solid var(--border-color);
            height: 20px;
            overflow: hidden;
        }
        #upload-spec-modal .progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }
        #upload-spec-modal .progress-text {
            margin-top: 5px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>

    <div class="app-wrapper">
        <header class="app-header">
            <div class="title-container"> <!-- Title and status in a container -->
                <div class="title">æˆ‘çš„å·¥ä½œå°</div>
                <span id="login-status-indicator"></span>
            </div>
            <div class="header-actions">
                <button id="upload-spec-button" class="auth-button login" style="background-color: #198754; margin-right: 10px;" title="ä¸Šä¼ æœ¬åœ°è§„ç¨‹ç›®å½•">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-arrow-up-fill" viewBox="0 0 16 16">
                        <path d="M8 2a5.53 5.53 0 0 0-3.594 1.342c-.766.66-1.321 1.52-1.464 2.383C1.266 6.095 0 7.555 0 9.318 0 11.366 1.708 13 3.781 13h8.906C14.502 13 16 11.57 16 9.773c0-1.636-1.242-2.969-2.834-3.194C12.923 3.999 10.69 2 8 2m2.354 5.146a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0z"/>
                    </svg>
                    <span style="margin-left: 8px;">ä¸Šä¼ è§„ç¨‹</span>
                </button>
                <button id="theme-toggle" class="theme-toggle-button" title="åˆ‡æ¢ä¸»é¢˜">
                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m-4.646.354a.5.5 0 0 1-.708 0l-1.414-1.414a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708m9.193 0a.5.5 0 0 1 0-.708l1.414-1.414a.5.5 0 0 1 .708.707l-1.414 1.414a.5.5 0 0 1-.708 0m-9.193-9.193a.5.5 0 0 1-.708-.707l1.414-1.414a.5.5 0 1 1 .707.707L3.354 5.354a.5.5 0 0 1 0-.708M13.646 5.354a.5.5 0 0 1 0 .707L12.232 7.5a.5.5 0 0 1-.707-.707L13.646 5.354a.5.5 0 0 1 .708 0M1.5 8a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2A.5.5 0 0 1 1.5 8m13 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5"/></svg>
                    <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"/></svg>
                </button>
                <a id="auth-button" href="/logout" class="auth-button logout"> <!-- Changed class and added id -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/><path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/></svg>
                    <span id="auth-button-text">ç™»å‡º</span> <!-- Added id -->
                </a>
            </div>
        </header>
        <main class="main-container">
            <div class="left-panel">
                <nav class="tab-navigation" id="tab-navigation-container">
                    <button id="workdir-tab-button" class="tab-button" title="æŸ¥çœ‹å·¥ä½œç›®å½•">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-folder" viewBox="0 0 16 16">
                            <path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996.816l.637 7a1 1 0 0 0 .995.816h10.348a1 1 0 0 0 .995-.816l.637-7A1 1 0 0 0 13.81 4H2.19zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139C1.72 3.72 1.94 4 2.19 4h11.62c.25-1 .47.28.72.28.006.139l.006.139a1 1 0 0 0-1-.981H9.828a1 1 0 0 0-.707-.293z"/>
                        </svg>
                        <span>å·¥ä½œç›®å½•</span>
                    </button>
                    <div id="tab-container"></div>
                </nav>
                <div class="content-viewer">
                    <div id="placeholder" class="placeholder" style="display: flex; width: 100%; height: 100%;"><span>è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œé¢„è§ˆ</span></div>
                    <iframe id="file-viewer-iframe" style="display: none; width: 100%; height: 100%; border: none;"></iframe>
                    <div id="workdir-viewer" style="display: none;">
                        <h3 id="workdir-path">å·¥ä½œç›®å½•</h3>
                        <ul id="workdir-file-list" class="workdir-file-list">
                            <!-- æ–‡ä»¶åˆ—è¡¨å°†åŠ¨æ€å¡«å……äºæ­¤ -->
                        </ul>
                    </div>
                </div>
            </div>
            <div class="right-panel">
                <!-- Content from botui.html's #chat-container, with its internal theme toggle button removed -->
                <div id="chat-container">
                    <div id="chat-header">
                        <span id="chat-title">èŠå¤©</span>
                        <button id="new-chat-button" title="å¼€å§‹ä¸€ä¸ªæ–°çš„å¯¹è¯">æ–°å¯¹è¯</button>
                    </div>
                    <!-- botui.html's theme-toggle button was here, now removed -->
                    <div id="message-window"></div>
                    <form id="chat-form">
                        <textarea id="chat-input" placeholder="è¯·è¾“å…¥æ¶ˆæ¯ (Shift+Enter æ¢è¡Œ)" rows="1"></textarea>
                        <button type="submit" title="å‘é€" id="send-button">å‘é€</button>
                        <button type="button" title="åœæ­¢AIè¾“å‡º" id="stop-ai-button" style="margin-left: 5px; background-color: #ffc107; color: black;" disabled>åœæ­¢</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Upload Spec Modal Container -->
    <div id="upload-modal-container"></div>


<script>
    // --- Global State & DOM Refs from index4.html ---
    const appState = {
        openFiles: {},
        activeFile: null,
        sessionId: null,
        isLoggedIn: false, // æ–°å¢ç™»å½•çŠ¶æ€
        activeView: 'placeholder', // æ–°å¢ï¼šè¿½è¸ªå½“å‰è§†å›¾ 'placeholder', 'iframe', 'workdir'
    };
    // const chatbotIframe = document.getElementById('chatbot-iframe'); // Removed as iframe is replaced
    const tabContainer = document.getElementById('tab-container');
    const workdirTabButton = document.getElementById('workdir-tab-button');
    const placeholder = document.getElementById('placeholder');
    const fileViewerIframe = document.getElementById('file-viewer-iframe');
    const workdirViewer = document.getElementById('workdir-viewer');
    const loginStatusIndicator = document.getElementById('login-status-indicator');
    const authButton = document.getElementById('auth-button');
    const authButtonText = document.getElementById('auth-button-text');
    let chatSocket = null; // æ–°å¢èŠå¤©ä¸“ç”¨çš„ WebSocket

    // Login Modal DOM elements
    let loginModal, closeModalButton, modalLoginForm, modalUsernameInput, modalPasswordInput, modalRememberCheckbox, modalErrorBox;

    // Upload Modal DOM elements (will be initialized dynamically)
    let uploadSpecModal, closeUploadModalButton, uploadSpecForm, uploadCategoryInput,
        uploadSpecNameInput, uploadFilesInput, uploadOverwriteCheckbox, uploadErrorBox,
        uploadProgressArea, uploadProgressBar, uploadProgressText;
    // The trigger button is static
    const uploadSpecButton = document.getElementById('upload-spec-button');


    const MAX_WEBSOCKET_RETRIES = 5;
    const WEBSOCKET_RETRY_INTERVAL = 5000;

    let chatWebsocketRetryCount = 0; // æ–°å¢: ç”¨äº chatSocket
    let chatWebsocketRetryTimer = null; // æ–°å¢: ç”¨äº chatSocket

    // --- Theme Management from index4.html (controls everything) ---
    const themeToggle = document.getElementById('theme-toggle'); // This is index4.html's main theme toggle
    const getPreferredTheme = () => localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    const setTheme = (theme) => {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        // The chat component's theme should update automatically via CSS using html[data-theme='dark']
    };

    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        setTheme(currentTheme === 'dark' ? 'light' : 'dark');
    });

    // --- Viewer Logic from index4.html ---
    function showViewer(type, message) {
        appState.activeView = type;
        placeholder.style.display = type === 'placeholder' ? 'flex' : 'none';
        fileViewerIframe.style.display = type === 'iframe' ? 'block' : 'none';
        workdirViewer.style.display = type === 'workdir' ? 'block' : 'none';

        if (type === 'placeholder') {
            placeholder.querySelector('span').textContent = message;
        }
        // æ›´æ–°å·¥ä½œç›®å½•æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
        workdirTabButton.classList.toggle('active', type === 'workdir');
        // å¦‚æœä¸æ˜¯æŸ¥çœ‹æ–‡ä»¶ï¼Œåˆ™æ¸…é™¤æ–‡ä»¶æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
        if (type !== 'iframe') {
            appState.activeFile = null;
            renderTabs();
        }
    }

    function viewFile(filename) {
        const file = appState.openFiles[filename];
        if (!file) {
            console.error(`Attempting to view a non-existent file: ${filename}`);
            showViewer('placeholder', `æ— æ³•æ‰¾åˆ°æ–‡ä»¶ ${filename} çš„æ•°æ®ã€‚`);
            return;
        }

        appState.activeFile = filename;
        renderTabs();
        showViewer('placeholder', `æ­£åœ¨åŠ è½½ ${filename}...`);

        try {
            // 1. FastAPI åç«¯çš„åŸºç¡€ URL (å½“å‰é¡µé¢çš„ origin)
            const fastapiBaseUrl = window.location.origin;

            // 2. æ„é€ æ–‡ä»¶çš„ç›´æ¥ä¸‹è½½é“¾æ¥ï¼Œé€‚é…æ–°çš„åç«¯æ ¼å¼ /download/{token}/{filename_basename}
            // filename æ˜¯åŒ…å«ç›¸å¯¹è·¯å¾„çš„ï¼Œä¾‹å¦‚ "2024/foo/bar.xlsx"
            // æˆ‘ä»¬éœ€è¦æå–çº¯æ–‡ä»¶å "bar.xlsx"
            const justTheFilename = filename.substring(filename.lastIndexOf('/') + 1);
            const fileDownloadUrl = `http://host.docker.internal:8888/download/${file.token}/${encodeURIComponent(justTheFilename)}`;

            // 3. æ„é€ æŒ‡å‘åç«¯ kkFileView ä»£ç†çš„ URL
            //    åç«¯ä»£ç†æ˜¯ /api/v1/kkfileview/onlinePreview
            //    å®ƒæœŸæœ›ä¸€ä¸ª file_url å‚æ•°ï¼Œå…¶å€¼æ˜¯ä¸Šé¢æ„é€ çš„ fileDownloadUrl
            //    æ ¹æ®æ‚¨çš„åé¦ˆå’Œ forward_test.html çš„æ³¨é‡Šï¼ŒfileDownloadUrl åœ¨è¿™é‡Œä¸åº”å†æ¬¡è¢« encodeURIComponent
            const previewProxyUrl = `${fastapiBaseUrl}/kkfileview/onlinePreview?file_url=${fileDownloadUrl}`;

            console.log(`[KKFileView] è¯·æ±‚é¢„è§ˆä»£ç† (iframe.src): ${previewProxyUrl}`);
            console.log(`[KKFileView] ä¼ é€’ç»™ä»£ç†çš„ file_url å‚æ•°å€¼: ${fileDownloadUrl}`);

            // 4. å°†ä»£ç† URL è®¾ç½®ç»™ iframe
            fileViewerIframe.src = previewProxyUrl;
            showViewer('iframe');

        } catch (error) {
            console.error(`Error preparing file preview for "${filename}":`, error);
            showViewer('placeholder', `å‡†å¤‡æ–‡ä»¶é¢„è§ˆ "${filename}" å‡ºé”™: ${error.message}`);
        }
    }

    // --- Tab Management Logic from index4.html ---
    function renderTabs() {
        tabContainer.innerHTML = '';
        const openFilenames = Object.keys(appState.openFiles);
        openFilenames.forEach(filename => {
            const file = appState.openFiles[filename];
            const button = document.createElement('button');
            button.className = 'tab-button';
            button.dataset.filename = filename;
            // æ–°å¢ï¼šå°†å®Œæ•´è·¯å¾„ä½œä¸º tooltip
            button.title = filename;
            if (filename === appState.activeFile) button.classList.add('active');
            const icon = window.ICONS[file.format] || window.ICONS.default;
            // æ–°å¢ï¼šä»å®Œæ•´è·¯å¾„ä¸­æå–æ–‡ä»¶å
            const shortFilename = filename.substring(filename.lastIndexOf('/') + 1);
            button.innerHTML = `${icon}<span>${shortFilename}</span><span class="close-tab" title="å…³é—­æ ‡ç­¾é¡µ">&times;</span>`;
            button.addEventListener('click', (e) => {
                if (e.target.classList.contains('close-tab')) return;
                viewFile(filename);
            });
            button.querySelector('.close-tab').addEventListener('click', (e) => {
                e.stopPropagation();
                closeTab(filename);
            });
            tabContainer.appendChild(button);
        });
        const activeTab = tabContainer.querySelector('.active');
        if (activeTab) {
            activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    }

    function closeTab(filename) {
        if (appState.openFiles[filename]) {
            delete appState.openFiles[filename];
            if (appState.activeFile === filename) {
                const remainingFiles = Object.keys(appState.openFiles);
                if (remainingFiles.length > 0) {
                    const newActiveFile = remainingFiles[remainingFiles.length - 1];
                    viewFile(newActiveFile);
                } else {
                    appState.activeFile = null;
                    showViewer('placeholder', 'æ‰€æœ‰æ–‡ä»¶éƒ½å·²å…³é—­ã€‚');
                }
            }
            renderTabs();
        }
    }

    // --- WebSocket Logic for Chat ---
    function connectChatWebSocket() {
        if (!appState.sessionId) {
            console.error("æ— æ³•è¿æ¥èŠå¤©WebSocketï¼šç¼ºå°‘session_idã€‚");
            return;
        }
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        // æ–°çš„èŠå¤©WebSocketç«¯ç‚¹
        const chatWsUrl = `${protocol}//${window.location.host}/ws_chat_stream?session_id=${appState.sessionId}`;
        console.log(`æ­£åœ¨è¿æ¥åˆ°èŠå¤© WebSocket: ${chatWsUrl}`);
        chatSocket = new WebSocket(chatWsUrl);

        chatSocket.onopen = () => {
            console.log("èŠå¤©WebSocket è¿æ¥å·²å»ºç«‹ã€‚");
            chatWebsocketRetryCount = 0;
            clearTimeout(chatWebsocketRetryTimer);
        };

        chatSocket.onmessage = (event) => {
            // console.debug("æ”¶åˆ°èŠå¤©WebSocketæ¶ˆæ¯:", event.data);
            try {
                const message = JSON.parse(event.data);
                if (message.type === 'chat_event_batch' && message.payload && Array.isArray(message.payload)) {
                    if (!isStreaming) return; // ç«‹å³åœæ­¢å¤„ç†æ¶ˆæ¯
                    message.payload.forEach(eventData => {
                        // console.debug("å¤„ç†èŠå¤©äº‹ä»¶:", eventData);
                        if (eventData.answer) {
                            botui_appendToCurrentBotMessage(eventData.answer);
                            if (current_task_id) {
                                botui_stopAIButton.disabled = false; // Enable button
                            }
                        } else if (eventData.event === 'agent_thought') {
                            if (eventData.task_id && !current_task_id) { // Capture task_id if not already set for this stream
                                current_task_id = eventData.task_id;
                                console.log("Captured task_id:", current_task_id);
                                botui_stopAIButton.disabled = false; // Enable button
                            }
                            const summaryParts = [];
                            let contentText = "";
                            if (eventData.thought) {
                                summaryParts.push('æ€è€ƒå†…å®¹');
                                contentText += `æ€è€ƒå†…å®¹: ${eventData.thought}\n`;
                            }
                            if (eventData.tool) {
                                summaryParts.push('è°ƒç”¨å·¥å…·');
                                contentText += `è°ƒç”¨å·¥å…·: ${eventData.tool}\n`;
                                if(eventData.tool_input) contentText += `å·¥å…·è¾“å…¥: ${eventData.tool_input}\n`;
                            }
                            if (eventData.observation) {
                                if (!eventData.tool) summaryParts.push('å·¥å…·ç»“æœ');
                                contentText += `å·¥å…·ç»“æœ: ${eventData.observation}\n`;
                            }
                            if (summaryParts.length > 0 || contentText.trim()) {
                                const summaryText = summaryParts.length > 0 ? summaryParts.join('ã€') : 'Agent æ€è€ƒæ­¥éª¤';
                                // å…ˆç»“æŸå½“å‰çš„æ°”æ³¡
                                botui_finalizeCurrentBotMessage();
                                // å†æ·»åŠ å·¥å…·ä¿¡æ¯
                                // æŠŠå·¥å…·è°ƒç”¨ï¼Œå·¥å…·ç»“æœï¼Œå…¨éƒ¨æ”¾åˆ°ä¸€ä¸ªæŠ˜å æ¡†é‡Œ
                                if(eventData.observation){
                                botui_addCollapsibleMessage(`${summaryText} (ç‚¹å‡»å±•å¼€)`, contentText.trim());
                                }
                            }
                        } else if (eventData.event === 'message_end') {
                            if (eventData.conversation_id) botui_conversation_id = eventData.conversation_id;
                            botui_finalizeCurrentBotMessage();
                            current_task_id = null; // Clear task_id as stream ended
                            botui_stopAIButton.disabled = true; // Disable button
                            botui_sendButton.disabled = false; // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                        } else if (eventData.conversation_id) {
                            botui_conversation_id = eventData.conversation_id;
                        }
                    });
                } else if (message.type === 'stop_request_processed') {
                    console.log("Stop request processed by server:", message);
                    botui_addMessage(`<i>å·²å‘é€åœæ­¢æŒ‡ä»¤ (ä»»åŠ¡: ${message.task_id}, çŠ¶æ€: ${message.status})</i>`, 'bot');
                    if (message.status === 'success') {
                        // Stream should stop via Dify, message_end will handle UI cleanup
                        // botui_stopAIButton.style.display = 'none'; // Handled by message_end
                        // current_task_id = null; // Handled by message_end
                    }
                    botui_stopAIButton.disabled = true; // åœæ­¢æŒ‰é’®åº”è¢«ç¦ç”¨ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡æµå¼€å§‹
                    botui_sendButton.disabled = false; // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                } else if (message.type === 'error') {
                    console.error("èŠå¤©WebSocketæ”¶åˆ°é”™è¯¯æ¶ˆæ¯:", message.content, message.details || '');
                    botui_addMessage(`ğŸ˜¥ **èŠå¤©æœåŠ¡å™¨é”™è¯¯**: ${message.content}${message.details ? ` (${message.details})` : ''}`, 'bot');
                    botui_finalizeCurrentBotMessage();
                    current_task_id = null;
                    botui_stopAIButton.disabled = true; // Disable button
                    botui_sendButton.disabled = false; // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                } else if (message.type === 'file_open_request' && message.payload) { // æ–°å¢å¯¹ file_open_request çš„å¤„ç†
                    console.log("èŠå¤©WebSocketæ”¶åˆ° file_open_request:", message.payload);
                    handleFileOpenRequest(message.payload); // å¤ç”¨ç°æœ‰çš„å¤„ç†å‡½æ•°
                } else if (message.type === 'directory_update' && message.payload) {
                    console.log("èŠå¤©WebSocketæ”¶åˆ° directory_update:", message.payload);
                    handleDirectoryUpdate(message.payload);
                } else {
                    console.warn("æ”¶åˆ°æœªçŸ¥çš„èŠå¤©WebSocketæ¶ˆæ¯ç±»å‹:", message);
                }
            } catch (e) {
                console.error("å¤„ç†èŠå¤©WebSocketæ¶ˆæ¯æ—¶å‡ºé”™:", e, "åŸå§‹æ•°æ®:", event.data);
            }
        };

        chatSocket.onclose = (event) => {
            console.warn(`èŠå¤©WebSocket è¿æ¥å·²å…³é—­ã€‚ä»£ç : ${event.code}, åŸå› : '${event.reason}'`);
            clearTimeout(chatWebsocketRetryTimer);

            // Bug 3: å¦‚æœæ˜¯æœåŠ¡å™¨å› ä¸º session_id æ— æ•ˆè€Œä¸»åŠ¨å…³é—­ï¼Œåˆ™ä¸é‡è¿
            if (event.code === 1008 || event.code === 1011) {
                console.error(`æœåŠ¡å™¨å…³é—­è¿æ¥ (ä»£ç : ${event.code})ï¼ŒåŸå› : "${event.reason}"ã€‚åœæ­¢é‡è¿ã€‚`);
                botui_addMessage(`ä¸æœåŠ¡å™¨çš„è¿æ¥å·²æ–­å¼€: ${event.reason} è¯·å°è¯•é‡æ–°ç™»å½•ã€‚`, 'bot');
                updateLoginStatusUI(false); // æ›´æ–°UIåˆ°æœªç™»å½•çŠ¶æ€ï¼Œä»¥æç¤ºç”¨æˆ·é‡æ–°ç™»å½•
                return; // æ˜ç¡®é˜»æ­¢åç»­çš„é‡è¿é€»è¾‘
            }

            if (event.code === 1000 || event.code === 1001 || event.code === 1005) {
                console.log(`èŠå¤©WebSocket normally closed. Code: ${event.code}, Reason: '${event.reason}'`);
                if (appState.isLoggedIn) {
                    console.warn("èŠå¤©WebSocket closed normally but unexpectedly while logged in.");
                    handleChatWebSocketDisconnect(); // è°ƒç”¨æ–°çš„å¤„ç†å‡½æ•°
                }
                return;
            }
            console.warn(`èŠå¤©WebSocket abnormally closed. Code: ${event.code}, Reason: '${event.reason}'`);
            handleChatWebSocketDisconnect(); // è°ƒç”¨æ–°çš„å¤„ç†å‡½æ•°
        };

        chatSocket.onerror = (error) => {
            console.error("èŠå¤©WebSocket å‘ç”Ÿé”™è¯¯:", error);
            if (chatSocket) chatSocket.close();
        };
    }


    function handleFileOpenRequest(fileInfo) {
        const { filename, download_token, format } = fileInfo;
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²åœ¨æ‰“å¼€çš„æ ‡ç­¾é¡µä¸­
        if (appState.openFiles[filename]) {
            console.log(`File ${filename} is already open. Switching to its tab.`);
            viewFile(filename); // åˆ‡æ¢åˆ°å·²æœ‰çš„æ ‡ç­¾é¡µ
            return; // ç»“æŸå‡½æ•°ï¼Œä¸é‡å¤æ·»åŠ 
        }
        // å¦‚æœæ–‡ä»¶æœªæ‰“å¼€ï¼Œåˆ™æ·»åŠ åˆ°çŠ¶æ€å¹¶æŸ¥çœ‹
        console.log(`Opening new file: ${filename}`);
        appState.openFiles[filename] = { format: format, token: download_token };
        viewFile(filename);
    }

    function handleDirectoryUpdate(payload) {
        const pathElement = document.getElementById('workdir-path');
        const listElement = document.getElementById('workdir-file-list');

        if (!pathElement || !listElement) {
            console.error('å·¥ä½œç›®å½•è§†å›¾çš„å¿…è¦å…ƒç´ æœªæ‰¾åˆ°ã€‚');
            return;
        }

        // æ›´æ–°ç›®å½•è·¯å¾„å¹¶æ˜¾ç¤ºè§†å›¾
        pathElement.textContent = 'å½“å‰å·¥ä½œç›®å½•: ' + payload.directory;
        showViewer('workdir');

        // æ¸…ç©ºæ—§çš„æ–‡ä»¶åˆ—è¡¨
        listElement.innerHTML = '';

        // å¡«å……æ–°çš„æ–‡ä»¶åˆ—è¡¨
        if (payload.files && payload.files.length > 0) {
            payload.files.forEach(file => {
                const listItem = document.createElement('li');

                const fileNameSpan = document.createElement('span');
                fileNameSpan.className = 'file-name';
                fileNameSpan.textContent = file.file_path; // éœ€æ±‚2ï¼šæ˜¾ç¤ºå®Œæ•´è·¯å¾„
                fileNameSpan.title = file.file_path;

                const buttonContainer = document.createElement('div');

                const openButton = document.createElement('button');
                openButton.textContent = 'æ‰“å¼€';
                openButton.className = 'open-file-btn';
                openButton.dataset.token = file.download_token;
                openButton.dataset.format = file.format;
                openButton.dataset.filepath = file.file_path;

                const llmReadButton = document.createElement('button');
                llmReadButton.textContent = 'LLMè¯»å–';
                llmReadButton.className = 'llm-read-btn';
                llmReadButton.dataset.filepath = file.file_path;

                buttonContainer.appendChild(openButton);
                buttonContainer.appendChild(llmReadButton);

                listItem.appendChild(fileNameSpan);
                listItem.appendChild(buttonContainer);
                listElement.appendChild(listItem);
            });
        } else {
            const emptyMessage = document.createElement('li');
            emptyMessage.textContent = 'ç›®å½•ä¸ºç©ºæˆ–ä¸åŒ…å«æ–‡ä»¶ã€‚';
            listElement.appendChild(emptyMessage);
        }
    }


    // --- Login Modal Logic ---
    function initLoginModalDOM() {
        loginModal = document.getElementById('login-modal');
        closeModalButton = loginModal.querySelector('.close-modal-button');
        modalLoginForm = document.getElementById('modal-login-form');
        modalUsernameInput = document.getElementById('modal-username');
        modalPasswordInput = document.getElementById('modal-password');
        modalRememberCheckbox = document.getElementById('modal-remember');
        modalErrorBox = loginModal.querySelector('.error-message');

        closeModalButton.onclick = hideLoginModal;
        modalLoginForm.addEventListener('submit', handleModalLoginSubmit);
    }

    // --- Upload Modal Logic (Dynamic Loading) ---
    function initUploadModalDOM() {
        // This function now re-initializes DOM variables and attaches event listeners
        // after the modal HTML has been injected.
        uploadSpecModal = document.getElementById('upload-spec-modal');
        if (!uploadSpecModal) return false; // Guard against errors if modal not found

        closeUploadModalButton = document.getElementById('close-upload-modal-button');
        uploadSpecForm = document.getElementById('upload-spec-form');
        uploadCategoryInput = document.getElementById('upload-category');
        uploadSpecNameInput = document.getElementById('upload-spec-name');
        uploadFilesInput = document.getElementById('upload-files');
        uploadOverwriteCheckbox = document.getElementById('upload-overwrite');
        uploadErrorBox = document.getElementById('upload-error-box');
        uploadProgressArea = uploadSpecModal.querySelector('.progress-area');
        uploadProgressBar = document.getElementById('upload-progress-bar');
        uploadProgressText = document.getElementById('upload-progress-text');

        closeUploadModalButton.onclick = hideUploadModal;
        uploadSpecForm.addEventListener('submit', (e) => handleUploadFormSubmit(e));

        // Add a listener to the modal itself to handle clicks outside the content area
        uploadSpecModal.addEventListener('click', (event) => {
            if (event.target === uploadSpecModal) {
                hideUploadModal();
            }
        });

        return true;
    }

    async function showUploadModal() {
        if (!appState.isLoggedIn) {
            alert("è¯·å…ˆç™»å½•å†ä¸Šä¼ æ–‡ä»¶ã€‚");
            showLoginModal();
            return;
        }

        // Check if modal is already open or loaded
        if (document.getElementById('upload-spec-modal')) {
            uploadSpecModal.style.display = 'flex';
            return;
        }

        try {
            // Fetch form HTML and categories from the new unified endpoint
            const response = await fetch('/api/upload-info');
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `æ— æ³•åŠ è½½ä¸Šä¼ æ¨¡å—: ${response.statusText}`);
            }
            const data = await response.json();

            // Inject the HTML into the container
            const modalContainer = document.getElementById('upload-modal-container');
            modalContainer.innerHTML = data.form_html;

            // Initialize DOM elements and attach listeners
            if (!initUploadModalDOM()) {
                throw new Error("æ— æ³•åˆå§‹åŒ–ä¸Šä¼ æ¨¡å—çš„DOMå…ƒç´ ã€‚");
            }

            // Populate categories
            const selectElement = document.getElementById('upload-category');
            data.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                selectElement.appendChild(option);
            });

            // Finally, show the modal
            uploadSpecModal.style.display = 'flex';

        } catch (error) {
            console.error('æ˜¾ç¤ºä¸Šä¼ æ¨¡å—å¤±è´¥:', error);
            alert(`é”™è¯¯: ${error.message}`);
        }
    }

    function hideUploadModal() {
        const modalContainer = document.getElementById('upload-modal-container');
        // Instead of just hiding, we remove the content to ensure it's fresh next time
        modalContainer.innerHTML = '';
        // Reset variables to avoid stale references
        uploadSpecModal = null;
    }

    async function handleUploadFormSubmit(event, isRetry = false) {
        event.preventDefault();
        if (!uploadSpecForm) return; // Guard if form not initialized

        uploadErrorBox.textContent = '';
        uploadProgressArea.style.display = 'block';
        uploadProgressBar.style.width = '0%';
        uploadProgressText.textContent = 'å‡†å¤‡ä¸Šä¼ ...';

        const formData = new FormData();
        formData.append('category', uploadCategoryInput.value);
        formData.append('spec_name', uploadSpecNameInput.value);
        if (uploadOverwriteCheckbox.checked || isRetry) {
            formData.append('overwrite', 'true');
        }

        const files = uploadFilesInput.files;
        if (files.length === 0) {
            uploadErrorBox.textContent = 'è¯·é€‰æ‹©æ–‡ä»¶æˆ–ç›®å½•ã€‚';
            uploadProgressArea.style.display = 'none';
            return;
        }

        // æ™ºèƒ½åˆ¤æ–­æ˜¯æ–‡ä»¶ä¸Šä¼ è¿˜æ˜¯ç›®å½•ä¸Šä¼ 
        // webkitRelativePath åªæœ‰åœ¨é€‰æ‹©ç›®å½•æ—¶æ‰æœ‰å€¼
        const isDirectoryUpload = files.length > 0 && files[0].webkitRelativePath;

        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
            // å¦‚æœæ˜¯ç›®å½•ä¸Šä¼ ï¼Œä½¿ç”¨ relativePathï¼›å¦åˆ™ï¼Œä½¿ç”¨æ–‡ä»¶å
            const path = isDirectoryUpload ? files[i].webkitRelativePath : files[i].name;
            formData.append('file_paths', path);
        }

        uploadProgressText.textContent = `æ­£åœ¨ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶...`;

        try {
            const response = await fetch('/upload-directory/', {
                method: 'POST',
                body: formData,
                // Note: Do not set Content-Type header for FormData, browser does it with boundary
            });

            const result = await response.json();

            if (response.ok) {
                uploadProgressBar.style.width = '100%';
                uploadProgressText.textContent = 'ä¸Šä¼ æˆåŠŸï¼';
                setTimeout(() => {
                    hideUploadModal();
                    alert(`è§„ç¨‹ '${uploadCategoryInput.value}/${uploadSpecNameInput.value}' ä¸Šä¼ æˆåŠŸ!`);
                }, 1000);
            } else if (response.status === 409 && result.exists) {
                // 409 Conflict: Directory exists
                uploadProgressArea.style.display = 'none';
                // ä½¿ç”¨æ›´æ¸…æ™°çš„ç¡®è®¤æ¶ˆæ¯
                const userConfirmed = confirm(result.message + "\n\næ˜¯å¦è¦è¦†ç›–å·²å­˜åœ¨çš„å†…å®¹ï¼Ÿ");
                if (userConfirmed) {
                    // Retry the submission with overwrite flag set
                    handleUploadFormSubmit(event, true);
                } else {
                    uploadErrorBox.textContent = 'ä¸Šä¼ å·²å–æ¶ˆã€‚';
                }
            } else {
                // Other errors
                throw new Error(result.detail || result.message || 'æœªçŸ¥é”™è¯¯');
            }
        } catch (error) {
            console.error('ä¸Šä¼ å¤±è´¥:', error);
            uploadErrorBox.textContent = `ä¸Šä¼ å¤±è´¥: ${error.message}`;
            uploadProgressArea.style.display = 'none';
        }
    }

    function showLoginModal() {
        if (!loginModal) initLoginModalDOM(); // Initialize DOM elements if not already done
        modalErrorBox.textContent = ''; // Clear previous errors
        loginModal.style.display = 'flex'; // Use flex for centering
        modalUsernameInput.focus();
    }

    function hideLoginModal() {
        if (loginModal) loginModal.style.display = 'none';
    }

    async function handleModalLoginSubmit(event) {
        event.preventDefault();
        modalErrorBox.textContent = '';
        const formData = new FormData(modalLoginForm);

        try {
            const response = await fetch('/login', { method: 'POST', body: formData });
            const result = await response.json();

            if (response.ok) {
                hideLoginModal();
                // Login successful, re-check status and initialize app parts
                await checkLoginStatusAndInitialize(true); // Pass true to indicate this is after a login attempt
            } else {
                modalErrorBox.textContent = result.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚';
            }
        } catch (error) {
            console.error('ç™»å½•è¯·æ±‚å¤±è´¥:', error);
            modalErrorBox.textContent = 'å‘ç”Ÿç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„è¿æ¥ã€‚';
        }
    }

    // --- UI Update for Login Status ---
    function updateLoginStatusUI(isLoggedIn) {
        appState.isLoggedIn = isLoggedIn;
        if (isLoggedIn) {
            loginStatusIndicator.textContent = 'ï¼ˆå·²ç™»å½•ï¼‰';
            authButtonText.textContent = 'ç™»å‡º';
            authButton.href = '/logout'; // Standard logout link
            authButton.classList.remove('login');
            authButton.classList.add('logout');
            authButton.onclick = async (e) => { // Handle logout click
                e.preventDefault();
                    const currentSessionId = appState.sessionId; // Store before clearing
                    try {
                        // åç«¯ /logout æ˜¯ GET è¯·æ±‚
                        await fetch('/logout', { method: 'GET' });
                    } catch (error) {
                        console.error("Logout request failed:", error);
                    } finally {
                        appState.sessionId = null; // Clear session ID
                        sessionStorage.removeItem('session_id');
                        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                            chatSocket.close(1000, "User logged out");
                        }
                        chatSocket = null;
                        updateLoginStatusUI(false); // Update UI to logged out state
                        // showViewer('placeholder', 'æ‚¨å·²ç™»å‡ºã€‚è¯·é‡æ–°ç™»å½•ä»¥ç»§ç»­ã€‚');
                    // botui_messageWindow.innerHTML = ''; // Do not clear chat messages
                    // botui_conversation_id = null; // Do not reset conversation
                }
            };
        } else {
            loginStatusIndicator.textContent = 'ï¼ˆæœªç™»å½•ï¼‰';
            authButtonText.textContent = 'ç™»å½•';
            authButton.href = 'javascript:void(0);'; // Prevent navigation
            authButton.classList.remove('logout');
            authButton.classList.add('login');
            authButton.onclick = (e) => { // Show login modal on click
                e.preventDefault();
                showLoginModal();
            };
            // Content (tabs, iframe, chat) is NOT cleared immediately on logout or disconnect.
            // It will be handled/cleared upon a new successful login or if explicitly cleared by other actions.
            // appState.openFiles = {}; // Do not clear
            // appState.activeFile = null; // Do not clear
            // renderTabs(); // Do not clear tabs
            // if (!fileViewerIframe.src.includes('about:blank')) fileViewerIframe.src = 'about:blank'; // Do not clear iframe
            showViewer('placeholder', 'è¯·ç™»å½•ä»¥ä½¿ç”¨æˆ‘çš„å·¥ä½œå°ã€‚'); // Placeholder can still update
        }
    }

    // --- WebSocket Disconnect Handling for Chat Socket ---
    function handleChatWebSocketDisconnect() {
        console.warn("èŠå¤©WebSocket disconnected or failed to connect.");
        if (chatSocket && (chatSocket.readyState === WebSocket.OPEN || chatSocket.readyState === WebSocket.CONNECTING)) {
            try { chatSocket.close(); } catch(e) { console.warn("Error closing chatSocket:", e); }
        }
        chatSocket = null;

        if (appState.isLoggedIn) {
            if (chatWebsocketRetryCount < MAX_WEBSOCKET_RETRIES) {
                chatWebsocketRetryCount++;
                console.log(`Attempting to reconnect èŠå¤©WebSocket (attempt ${chatWebsocketRetryCount}/${MAX_WEBSOCKET_RETRIES}) in ${WEBSOCKET_RETRY_INTERVAL / 1000} seconds...`);
                clearTimeout(chatWebsocketRetryTimer);
                chatWebsocketRetryTimer = setTimeout(connectChatWebSocket, WEBSOCKET_RETRY_INTERVAL);
            } else {
                console.error(`èŠå¤©WebSocket reconnection failed after ${MAX_WEBSOCKET_RETRIES} attempts.`);
                botui_addMessage("ä¸èŠå¤©æœåŠ¡å™¨çš„è¿æ¥å·²æ–­å¼€ï¼ŒèŠå¤©åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚æ‚¨å¯ä»¥å°è¯•åˆ·æ–°é¡µé¢æˆ–ç¨åé‡è¯•ã€‚", "bot");
            }
        } else {
            console.log("èŠå¤©WebSocket not attempting reconnection as user is not logged in.");
        }
    }

    // --- App Initialization (Revised) ---
    async function checkLoginStatusAndInitialize(isAfterLoginAttempt = false) {
        try {
            const response = await fetch('/api/user/status');
            if (response.ok) {
                const userData = await response.json();
                const previousSessionId = appState.sessionId;
                sessionStorage.setItem('session_id', userData.session_id);
                appState.sessionId = userData.session_id;
                updateLoginStatusUI(true); // Set to logged-in state
                hideLoginModal(); // ç¡®ä¿ç™»å½•æˆåŠŸåæ¨¡æ€æ¡†æ˜¯éšè—çš„

                if (isAfterLoginAttempt && previousSessionId && previousSessionId !== appState.sessionId) {
                    // If logged in as a new/different user, clear old state
                    console.log("New user session detected after login. Clearing previous state.");
                    appState.openFiles = {};
                    appState.activeFile = null;
                    renderTabs();
                    if (!fileViewerIframe.src.includes('about:blank')) fileViewerIframe.src = 'about:blank';
                    botui_messageWindow.innerHTML = '';
                    botui_conversation_id = null;
                }

                connectChatWebSocket();    // è¿æ¥èŠå¤©ä¸“ç”¨ WebSocket

                if (isAfterLoginAttempt) { // If this was after a successful login
                     showViewer('placeholder', 'ç™»å½•æˆåŠŸï¼æˆ‘çš„å·¥ä½œå°å·²å°±ç»ªã€‚');
                }
            } else if (response.status === 401) {
                // ç”¨æˆ·æœªç™»å½•æˆ–ä¼šè¯æ— æ•ˆï¼Œæ¢å¤ä¸ºUIæ›´æ–°å’Œæ¨¡æ€æ¡†é€»è¾‘
                updateLoginStatusUI(false);
                // ä¸å†é‡å®šå‘ï¼Œè€Œæ˜¯ä¾èµ–UIæç¤ºç”¨æˆ·ç™»å½•
            } else {
                throw new Error(`è·å–ç”¨æˆ·çŠ¶æ€å¤±è´¥: ${response.status}`);
            }
        } catch (error) {
            console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€æˆ–åˆå§‹åŒ–åº”ç”¨æ—¶å‡ºé”™:', error);
            // å‘ç”Ÿé”™è¯¯æ—¶ï¼ŒåŒæ ·æ›´æ–°UIï¼Œè€Œä¸æ˜¯é‡å®šå‘
            updateLoginStatusUI(false);
            botui_addMessage(`æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨è¿›è¡ŒçŠ¶æ€æ£€æŸ¥: ${error.message}`, 'bot');
        }

        // Common initialization steps regardless of login status (e.g., loading non-user-specific resources)
        // Get chatbot API config (moved here to run even if not initially logged in, though chat might be disabled)
        try {
            const agentApiResponse = await fetch('/api/dify-agent-api');
            if (!agentApiResponse.ok) {
                throw new Error(`è·å–èŠå¤©æœºå™¨äººé…ç½®å¤±è´¥: ${agentApiResponse.status} ${agentApiResponse.statusText}`);
            }
            const agentApiData = await agentApiResponse.json();
            if (agentApiData.url && agentApiData.apikey) {
                dynamic_bot_api_url = agentApiData.url;
                dynamic_bot_api_key = agentApiData.apikey;
                console.log("èŠå¤©æœºå™¨äººé…ç½®å·²åŠ è½½:", dynamic_bot_api_url);
            } else {
                console.error('æœªèƒ½ä»APIè·å–æœ‰æ•ˆçš„èŠå¤©æœºå™¨äººURLæˆ–API Keyã€‚');
                // Don't show placeholder error here if not logged in, as chat is likely disabled anyway
            }
        } catch (error) {
            console.error('è·å–èŠå¤©æœºå™¨äººé…ç½®æ—¶å‡ºé”™:', error);
        }

        if (!isAfterLoginAttempt && !appState.isLoggedIn) {
             showViewer('placeholder', 'è¯·ç™»å½•ä»¥ä½¿ç”¨æˆ‘çš„å·¥ä½œå°ã€‚');
        } else if (!isAfterLoginAttempt && appState.isLoggedIn) {
             showViewer('placeholder', 'æˆ‘çš„å·¥ä½œå°å·²å°±ç»ªã€‚');
        }
        // renderTabs(); // Already called in init
    }

    async function init() {
        setTheme(getPreferredTheme());

        // ä¸ºå·¥ä½œç›®å½•æ ‡ç­¾é¡µæŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        workdirTabButton.addEventListener('click', () => {
            if (appState.activeView !== 'workdir') {
                showViewer('workdir');
            } else {
                // å¦‚æœå½“å‰å·²æ˜¯å·¥ä½œç›®å½•è§†å›¾ï¼Œåˆ™åˆ‡æ¢å›é»˜è®¤å ä½ç¬¦
                showViewer('placeholder', 'æˆ‘çš„å·¥ä½œå°å·²å°±ç»ªã€‚');
            }
        });

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ–‡ä»¶æ‰“å¼€å’ŒLLMè¯»å–æŒ‰é’®çš„ç‚¹å‡»
        document.addEventListener('click', function(event) {
            const button = event.target;
            if (button && button.classList.contains('open-file-btn')) {
                const fileInfo = {
                    filename: button.dataset.filepath, // ä½¿ç”¨å®Œæ•´è·¯å¾„ä½œä¸ºå”¯ä¸€æ ‡è¯†
                    download_token: button.dataset.token,
                    format: button.dataset.format
                };
                handleFileOpenRequest(fileInfo);
            } else if (button && button.classList.contains('llm-read-btn')) {
                const filePath = button.dataset.filepath;
                if (filePath) {
                    const query = `è¯·è¯»å–æ–‡ä»¶ï¼Œè·¯å¾„æ˜¯ ${filePath}`;
                    // ç›´æ¥è°ƒç”¨èŠå¤©å‡½æ•°
                    botui_addMessage(query, 'user');
                    botui_streamMessageViaWebSocket(query);
                }
            }
        });

        // Create and append login modal to body before initializing DOM refs for it
        const loginModalHTML = `
        <div id="login-modal" class="login-modal">
            <div class="login-modal-content">
                <span class="close-modal-button">&times;</span>
                <h1>å·¥ä½œå°ç™»å½•</h1>
                <form id="modal-login-form">
                    <div class="form-group">
                        <label for="modal-username">ç”¨æˆ·å:</label>
                        <input type="text" id="modal-username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-password">å¯†ç :</label>
                        <input type="password" id="modal-password" name="password" required>
                    </div>
                    <div class="remember-group">
                        <input type="checkbox" id="modal-remember" name="remember" value="true">
                        <label for="modal-remember" style="margin-left: 8px; margin-bottom: 0;">è®°ä½æˆ‘</label>
                    </div>
                    <button type="submit">ç™» å½•</button>
                    <div class="error-message" id="modal-error-box"></div>
                </form>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', loginModalHTML);

        initLoginModalDOM(); // Initialize static login modal DOM elements
        uploadSpecButton.onclick = showUploadModal; // Attach listener to the static upload button
        await checkLoginStatusAndInitialize();
        renderTabs(); // Initial tab render
    }

    // --- ICONS from index4.html ---
    window.ICONS = {
        pdf: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/><path d="M4.603 14.087a.8.8 0 0 1-1.214-.886l.66-1.98a.52.52 0 0 1 .184-.282l.062-.052.062-.052a.5.5 0 0 1 .736.646l-.119.119a.11.11 0 0 0-.03.076l-.23.69zM5.53 12.042a.51.51 0 0 1 .707.707l-1.464 1.464a.51.51 0 0 1-.707-.707z"/></svg>`,
        docx: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.88 15.84c-.45.08-.91.16-1.38.16H2.5A1.5 1.5 0 0 1 1 14.5V3.5A1.5 1.5 0 0 1 2.5 2H10v2h2v1.5a.5.5 0 0 0 1 0V4h.5a.5.5 0 0 0 .29-.91L11.15.29a.5.5 0 0 0-.85.35V2.5A1.5 1.5 0 0 1 9 1H2.5A2.5 2.5 0 0 0 0 3.5v11A2.5 2.5 0 0 0 2.5 17h6.08c.55 0 1.07-.1 1.55-.27l.5-.27c.45-.25.85-.58 1.17-1a.5.5 0 0 0-.85-.52c-.25.3-.57.54-.9.74l-.5.27Z"/><path d="M16 12h-3a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1m-3-2h3v1h-3z"/></svg>`,
        xlsx: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.18 4.603L1.18 8.603h2.825L8 4.306zm3.593 0L5.18 10.297h2.825L12 5.006zM13.18 4.603L9.18 8.603h2.825L16 4.306zM13.18 10.297L9.18 14.297h2.825L16 9.006z"/><path d="M1.18 8.603a.5.5 0 0 0 .306.491l6.98 3.293a.5.5 0 0 0 .468 0l6.98-3.293a.5.5 0 0 0 .306-.491L9.18 1.497a.5.5 0 0 0-.468 0zM8.944 1.151l6.98 3.293L8.944 7.739 1.964 4.444zM1.964 9.098l6.98 3.293 6.98-3.293-6.98-3.294z"/></svg>`,
        default: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5zM4 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1z"/></svg>`
    };

    // --- JavaScript from botui.html (integrated and prefixed) ---
    let dynamic_bot_api_url = null; // å°†é€šè¿‡APIè·å–
    let dynamic_bot_api_key = null; // å°†é€šè¿‡APIè·å–

    const botui_messageWindow = document.getElementById('message-window');
    const botui_chatForm = document.getElementById('chat-form');
    const botui_chatInput = document.getElementById('chat-input');
    const botui_sendButton = document.getElementById('send-button'); // send-button ID was added in HTML
    const botui_stopAIButton = document.getElementById('stop-ai-button'); // stop-ai-button ID was added in HTML
    const botui_newChatButton = document.getElementById('new-chat-button');

    let botui_conversation_id = null;
    let current_task_id = null; // To store the current Dify task_id
    let isStreaming = false; // æ–°å¢æµå¼ä¼ è¾“çŠ¶æ€
    let currentBotMessageElement = null; // Make this global for stop button logic and message appending

    // botui.html's theme toggle JS logic is removed. index4.html's setTheme handles global theme.

    function startNewConversation() {
        botui_conversation_id = null;
        botui_messageWindow.innerHTML = '';
        botui_addMessage("æ–°å¯¹è¯å·²å¼€å§‹ã€‚è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ã€‚", "bot");
        console.log("New conversation started. Conversation ID reset.");
        botui_chatInput.focus();
    }

    botui_newChatButton.addEventListener('click', startNewConversation);

    function botui_handleFormSubmission() {
        const query = botui_chatInput.value.trim();
        if (query) {
            botui_addMessage(query, 'user');
            current_task_id = null; // Reset task_id for new query
            botui_stopAIButton.disabled = true; // Disable button
            botui_sendButton.disabled = true; // ç¦ç”¨å‘é€æŒ‰é’®
            botui_streamMessageViaWebSocket(query);
            botui_chatInput.value = '';
            botui_chatInput.style.height = 'auto';
        }
    }

    botui_chatForm.addEventListener('submit', (event) => {
        event.preventDefault();
        botui_handleFormSubmission();
    });

    botui_stopAIButton.addEventListener('click', () => {
        if (current_task_id && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            console.log(`Requesting to stop AI task: ${current_task_id}`);
            console.log(`WebSocket state: ${chatSocket.readyState}`);
            console.log(`WebSocket bufferedAmount: ${chatSocket.bufferedAmount}`);
            isStreaming = false; // ç«‹å³åœæ­¢å‰ç«¯æ¸²æŸ“
            chatSocket.send(JSON.stringify({
                type: "stop_chat_stream",
                task_id: current_task_id,
                user: "user_001" // This should match the user ID sent in chat requests
            }));
            botui_stopAIButton.disabled = true; // Disable button after sending stop request
            setTimeout(() => {
                botui_addMessage('<i>æ­£åœ¨å°è¯•åœæ­¢AIè¾“å‡º...</i>', 'bot');
            }, 0);
        } else {
            console.warn("Cannot stop AI: No active task_id or WebSocket not open.");
            // Button is already visible, ensure it's disabled if no task_id
            if (!current_task_id) {
                botui_stopAIButton.disabled = true;
            }
        }
    });

    botui_chatInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            botui_handleFormSubmission();
        }
    });

    botui_chatInput.addEventListener('input', () => {
        botui_chatInput.style.height = 'auto';
        // Ensure scrollHeight is calculated correctly after content change
        requestAnimationFrame(() => {
             botui_chatInput.style.height = (botui_chatInput.scrollHeight) + 'px';
        });
    });

    function botui_addMessage(content, type, referenceNode = null) {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${type}-message`;
        if (type === 'user') {
            messageElement.textContent = content; // Use textContent for user messages to prevent XSS
        } else {
            messageElement.innerHTML = content;
        }
        if (referenceNode) {
            botui_messageWindow.insertBefore(messageElement, referenceNode);
        } else {
            botui_messageWindow.appendChild(messageElement);
        }
        botui_scrollToBottom();
        return messageElement;
    }

    function botui_addCollapsibleMessage(summaryText, contentText, referenceNode = null) {
        if (!contentText) return;
        const detailsElement = document.createElement('details');
        detailsElement.className = 'message agent-thought';
        const summaryElement = document.createElement('summary');
        summaryElement.textContent = summaryText;
        const contentDiv = document.createElement('div');
        contentDiv.className = 'collapsible-content';
        contentDiv.innerHTML = marked.parse(contentText);
        detailsElement.appendChild(summaryElement);
        detailsElement.appendChild(contentDiv);

        // ç¡®ä¿åœ¨ finalize ä¹‹åï¼Œæ–°çš„ collapsible message è¢«æ­£ç¡®æ·»åŠ 
        // å¦‚æœ referenceNode å­˜åœ¨ä¸”ä»åœ¨ DOM ä¸­ï¼Œåˆ™åœ¨å…¶å‰æ’å…¥
        if (referenceNode && referenceNode.parentNode === botui_messageWindow) {
            botui_messageWindow.insertBefore(detailsElement, referenceNode);
        } else {
            // å¦åˆ™ï¼Œç›´æ¥è¿½åŠ åˆ°æœ«å°¾
            botui_messageWindow.appendChild(detailsElement);
        }
        setTimeout(botui_scrollToBottom, 0);
    }

    function botui_scrollToBottom() {
        botui_messageWindow.scrollTop = botui_messageWindow.scrollHeight;
    }

    function botui_appendToCurrentBotMessage(textChunk) {
        if (!isStreaming) return; // å¦‚æœå·²åœæ­¢ï¼Œåˆ™ä¸å¤„ç†
        if (!currentBotMessageElement) {
            const thinkingHTML = `<div class="thinking"><span></span><span></span><span></span></div>`;
            currentBotMessageElement = botui_addMessage(thinkingHTML, 'bot');
            currentBotMessageElement.dataset.fullText = ""; // åˆå§‹åŒ–å®Œæ•´æ–‡æœ¬
        }

        const thinkingIndicator = currentBotMessageElement.querySelector('.thinking');
        if (thinkingIndicator) { // é¦–æ¬¡æ¥æ”¶åˆ°æ–‡æœ¬å—æ—¶ï¼Œç§»é™¤loadingåŠ¨ç”»
            currentBotMessageElement.innerHTML = ''; // æ¸…ç©ºloading
        }

        currentBotMessageElement.dataset.fullText += textChunk;
        currentBotMessageElement.innerHTML = marked.parse(currentBotMessageElement.dataset.fullText);
        botui_scrollToBottom();
    }

    function botui_getCurrentBotMessageElement() {
        return currentBotMessageElement;
    }

    function botui_finalizeCurrentBotMessage() {
        if (currentBotMessageElement && currentBotMessageElement.classList.contains('bot-message')) {
            const thinkingIndicator = currentBotMessageElement.querySelector('.thinking');
            // å¦‚æœæ¶ˆæ¯å…ƒç´ ä»ç„¶åªåŒ…å« thinking åŠ¨ç”»ï¼ˆå³æ²¡æœ‰æ”¶åˆ°ä»»ä½•æ–‡æœ¬ï¼‰ï¼Œ
            // å¯ä»¥é€‰æ‹©ç§»é™¤å®ƒæˆ–æ›¿æ¢ä¸ºä¸€ä¸ªâ€œæ— å›å¤â€çš„æç¤ºã€‚
            if (thinkingIndicator && (!currentBotMessageElement.dataset.fullText || currentBotMessageElement.dataset.fullText.trim() === '')) {
                 currentBotMessageElement.innerHTML = marked.parse("..."); // æˆ–å…¶ä»–å ä½ç¬¦ï¼Œæˆ–ç§»é™¤
            }
        }
        currentBotMessageElement = null; // é‡ç½®ï¼Œä»¥ä¾¿ä¸‹æ¬¡åˆ›å»ºæ–°æ¶ˆæ¯
        botui_scrollToBottom();
    }

    async function botui_streamMessageViaWebSocket(query) {
        if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
            console.warn("èŠå¤©WebSocketæœªè¿æ¥æˆ–æœªæ‰“å¼€ã€‚å°è¯•é‡æ–°è¿æ¥...");
            botui_addMessage("ä¸èŠå¤©æœåŠ¡å™¨çš„è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨å°è¯•é‡æ–°è¿æ¥...", "bot");
            // connectChatWebSocket(); // Let the existing onclose handler manage reconnections
            // Instead of direct reconnect, inform user and rely on onclose handler
            if (!chatWebsocketRetryTimer) { // Avoid queuing multiple reconnects if already trying
                 handleChatWebSocketDisconnect(); // Trigger the standard reconnect procedure
            }
            // Provide feedback that message might not be sent immediately
            botui_addMessage("è¿æ¥é—®é¢˜ï¼Œè¯·ç¨åæˆ–æ¶ˆæ¯å‘é€æˆåŠŸåé‡è¯•ã€‚", "bot");
            botui_sendButton.disabled = false; // å¦‚æœwebsocketæœªè¿æ¥ï¼Œé‡æ–°å¯ç”¨å‘é€æŒ‰é’®
            return;
        }

        isStreaming = true; // å¼€å§‹æµå¼ä¼ è¾“
        current_task_id = null; // Reset task_id for the new stream
        botui_stopAIButton.disabled = true; // Ensure stop button is disabled at the start of a new stream


        // Initialize a new bot message element for thinking animation and subsequent stream
        const thinkingHTML = `<div class="thinking"><span></span><span></span><span></span></div>`;
        currentBotMessageElement = botui_addMessage(thinkingHTML, 'bot'); // This is now a global var
        currentBotMessageElement.dataset.fullText = ""; // Initialize

        const payload = {
            query: query,
            user: "user_001", // å¯ä»¥æ ¹æ®å®é™…ç”¨æˆ·èº«ä»½è°ƒæ•´
            conversation_id: botui_conversation_id || null,
            inputs: {} // å…¶ä»–å¯èƒ½çš„è¾“å…¥å‚æ•°
        };

        try {
            console.log("é€šè¿‡WebSocketå‘é€èŠå¤©è¯·æ±‚:", payload);
            chatSocket.send(JSON.stringify(payload));
        } catch (error) {
            console.error("é€šè¿‡WebSocketå‘é€æ¶ˆæ¯å¤±è´¥:", error);
            if (currentBotMessageElement) {
                 currentBotMessageElement.innerHTML = marked.parse(`ğŸ˜¥ **æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºé”™äº†**: \n\n\`\`\`\n${error.message}\n\`\`\``);
            } else {
                botui_addMessage(`ğŸ˜¥ **æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºé”™äº†**: \n\n\`\`\`\n${error.message}\n\`\`\``, 'bot');
            }
            botui_finalizeCurrentBotMessage(); // ç¡®ä¿é‡ç½®
            botui_sendButton.disabled = false; // å‘é€å¤±è´¥æ—¶é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
        }
        // æ³¨æ„ï¼šWebSocketæ˜¯å¼‚æ­¥çš„ï¼Œæ¶ˆæ¯çš„æ¥æ”¶å’Œå¤„ç†åœ¨ chatSocket.onmessage ä¸­è¿›è¡Œ
    }
    // --- End of JavaScript from botui.html ---

    window.addEventListener('load', init);
</script>
</body>
</html>
